<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maddur Murugan Super Store</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Configuration for a More Colorful Interface
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // NEW THEME: ROYAL BLUE / BRIGHT ORANGE
                        'primary-dark': '#153A60',   // Dark Royal Blue (Header/Footer BG)
                        'primary': '#2A629A',        // Vibrant Blue (Secondary Header/Accents)
                        'accent': '#FF7F50',         // Coral/Bright Orange (Primary Buttons)
                        'accent-hover': '#FF6347',   // Tomato Red (Darker Orange)
                        'success': '#4CAF50',        // Bright Green (Success/Coins)
                        'info': '#2196F3',           // Blue (Info)
                        'danger': '#F44336',         // Red (Errors/Danger)
                        // --- NEW ADMIN COLOR ---
                        'banned': '#6B7280',         // Gray for Banned Status
                        'upi': '#6F42C1',            // Purple for UPI Payment
                        'upi-light': '#E9D8FD',      // Light Purple
                    },
                    boxShadow: {
                        // Updated shadow to match the blue theme
                        'vibrant': '0 10px 15px -3px rgba(21, 58, 96, 0.1), 0 4px 6px -2px rgba(21, 58, 96, 0.05)',
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'ping-slow': 'ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom styles for line clamping product names */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Custom input styling */
        .text-input-style {
            padding: 0.65rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 16px; /* Prevent iOS zoom on focus */
        }
        .text-input-style:focus {
            border-color: #2A629A; /* Primary Blue on focus */
            box-shadow: 0 0 0 3px rgba(42, 98, 154, 0.2);
        }
        /* Error Box Animation */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        /* UPI QR Code Styling */
        .upi-qr-container {
            position: relative;
            display: inline-block;
        }
        .upi-qr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: bold;
            color: #6F42C1;
            font-size: 1.2rem;
        }
        /* Payment App Buttons */
        .payment-app-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .payment-app-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .payment-app-btn.active {
            border-color: #6F42C1;
            background-color: #F3F0FF;
        }
        /* Loading animation for payment verification */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        /* Smooth transitions */
        .transition-all {
            transition: all 0.3s ease;
        }
        /* Progress bar styling */
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        /* Mobile-friendly improvements */
        @media (max-width: 768px) {
            /* Better touch targets */
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
            /* Hide scrollbar but allow scroll */
            .hide-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .hide-scrollbar::-webkit-scrollbar {
                display: none;
            }
            /* Safe area for bottom nav */
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
            /* Mobile card view for tables */
            .mobile-card {
                display: block;
                background: white;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 1px solid #e5e7eb;
            }
            .mobile-card-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .mobile-card-row:last-child {
                border-bottom: none;
            }
            .mobile-card-label {
                font-size: 12px;
                color: #6b7280;
                font-weight: 500;
            }
            .mobile-card-value {
                font-size: 14px;
                font-weight: 600;
                color: #1f2937;
            }
        }
        /* Bottom nav safe area */
        .bottom-nav-spacer {
            height: 70px;
        }
        @media (min-width: 768px) {
            .bottom-nav-spacer {
                height: 0;
            }
        }
        /* ===================== FESTIVAL BANNER ANIMATIONS ===================== */
        @keyframes bannerFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            33% { transform: translateY(-12px) rotate(3deg); }
            66% { transform: translateY(-6px) rotate(-2deg); }
        }
        @keyframes sparkleAnim {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }
        @keyframes bannerSlide {
            from { opacity: 0; transform: translateX(40px); }
            to   { opacity: 1; transform: translateX(0); }
        }
        @keyframes shimmerText {
            0%   { background-position: -200% center; }
            100% { background-position:  200% center; }
        }
        @keyframes confettiFall {
            0%   { transform: translateY(-10px) rotate(0deg);   opacity: 1; }
            100% { transform: translateY(80px)  rotate(360deg); opacity: 0; }
        }
        @keyframes ripple {
            0%   { transform: scale(0.8); opacity: 0.6; }
            100% { transform: scale(2.5); opacity: 0; }
        }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.3); }
            50%       { box-shadow: 0 0 30px rgba(255,255,255,0.7); }
        }
        .banner-float  { animation: bannerFloat  3s ease-in-out infinite; }
        .banner-slide  { animation: bannerSlide  0.5s ease-out forwards; }
        .banner-glow   { animation: glowPulse    2s ease-in-out infinite; }
        .sparkle       { animation: sparkleAnim  1.5s ease-in-out infinite; }
        .confetti-piece { animation: confettiFall 2s ease-in infinite; }
        .shimmer-text {
            background: linear-gradient(90deg, #fff 25%, rgba(255,255,255,0.4) 50%, #fff 75%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmerText 2s linear infinite;
        }
        /* Upload drop zone */
        .drop-zone-active { border-color: #2A629A !important; background: rgba(42,98,154,0.07) !important; }
        /* Grocery mode selector */
        .mode-btn-active { box-shadow: 0 4px 14px rgba(21,58,96,0.25); }

        /* ========================================================
           MODERN MOBILE DESIGN SYSTEM 2025
        ======================================================== */

        /* â”€â”€ Glassmorphism â”€â”€ */
        .glass {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            background: rgba(255,255,255,0.72);
            border: 1px solid rgba(255,255,255,0.45);
        }
        .glass-dark {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(21,58,96,0.82);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .glass-white {
            backdrop-filter: blur(12px);
            background: rgba(255,255,255,0.88);
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 8px 32px rgba(0,0,0,0.10);
        }

        /* â”€â”€ Gradient Text â”€â”€ */
        .gradient-text-orange {
            background: linear-gradient(135deg,#FF7F50,#FFD700,#FF6347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-text-blue {
            background: linear-gradient(135deg,#2A629A,#00BCD4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-text-rainbow {
            background: linear-gradient(135deg,#FF6B6B,#FF9F43,#FECA57,#48CAE4,#a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            background-size: 200% auto;
            animation: rainbowMove 3s linear infinite;
        }
        @keyframes rainbowMove {
            0%   { background-position: 0% center; }
            100% { background-position: 200% center; }
        }

        /* â”€â”€ Micro-interaction: Card Press (haptic feel) â”€â”€ */
        .card-press {
            transition: transform 0.12s cubic-bezier(0.34,1.56,0.64,1),
                        box-shadow 0.12s ease;
            cursor: pointer;
        }
        .card-press:active { transform: scale(0.95); }

        /* â”€â”€ Keyframe: Nav icon pop â”€â”€ */
        @keyframes navIconPop {
            0%  { transform: scale(1) translateY(0); }
            40% { transform: scale(1.4) translateY(-4px); }
            70% { transform: scale(0.9) translateY(0); }
            100%{ transform: scale(1) translateY(0); }
        }
        .nav-pop { animation: navIconPop 0.45s cubic-bezier(0.34,1.56,0.64,1) both; }

        /* â”€â”€ Keyframe: Slide Up â”€â”€ */
        @keyframes slideUpPop {
            from { transform: translateY(30px) scale(0.96); opacity: 0; }
            to   { transform: translateY(0)    scale(1);    opacity: 1; }
        }
        .slide-up-pop { animation: slideUpPop 0.45s cubic-bezier(0.34,1.56,0.64,1) both; }

        /* â”€â”€ Keyframe: Toast slide in â”€â”€ */
        @keyframes toastSlideIn {
            from { transform: translateX(110%) scale(0.88); opacity: 0; }
            to   { transform: translateX(0)     scale(1);    opacity: 1; }
        }
        @keyframes toastSlideOut {
            from { transform: translateX(0)     scale(1);    opacity: 1; }
            to   { transform: translateX(110%) scale(0.88);  opacity: 0; }
        }
        .toast-slide-in  { animation: toastSlideIn  0.45s cubic-bezier(0.34,1.56,0.64,1) both; }
        @keyframes toastProgress { from { width: 100%; } to { width: 0%; } }

        /* â”€â”€ Keyframe: Floating â”€â”€ */
        @keyframes floatBob {
            0%,100%{ transform: translateY(0px) rotate(0deg); }
            50%    { transform: translateY(-8px) rotate(2deg); }
        }
        .float-bob { animation: floatBob 3s ease-in-out infinite; }

        /* â”€â”€ Keyframe: Skeleton shimmer â”€â”€ */
        @keyframes skeletonShimmer {
            0%  { background-position: -200% 0; }
            100%{ background-position:  200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeletonShimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        /* â”€â”€ Keyframe: Badge bounce â”€â”€ */
        @keyframes badgeBounce {
            0%,100%{ transform: scale(1); }
            30%    { transform: scale(1.35); }
            60%    { transform: scale(0.9); }
        }
        .badge-bounce { animation: badgeBounce 0.6s cubic-bezier(0.34,1.56,0.64,1); }

        /* â”€â”€ Neon glow buttons â”€â”€ */
        .neon-green  { box-shadow: 0 0 16px rgba(76,175,80,0.55),  0 4px 24px rgba(76,175,80,0.25); }
        .neon-orange { box-shadow: 0 0 16px rgba(255,127,80,0.55), 0 4px 24px rgba(255,127,80,0.25); }
        .neon-blue   { box-shadow: 0 0 16px rgba(42,98,154,0.45),  0 4px 24px rgba(42,98,154,0.20); }
        .neon-red    { box-shadow: 0 0 16px rgba(244,67,54,0.45),  0 4px 24px rgba(244,67,54,0.20); }

        /* â”€â”€ Product card shine â”€â”€ */
        .card-shine { position: relative; overflow: hidden; }
        .card-shine::before {
            content: '';
            position: absolute;
            top: 0; left: -80%;
            width: 60%; height: 100%;
            background: linear-gradient(to right, transparent, rgba(255,255,255,0.55), transparent);
            transform: skewX(-20deg);
            transition: none;
            pointer-events: none;
            z-index: 1;
        }
        .card-shine:active::before { left: 150%; transition: left 0.5s ease; }

        /* â”€â”€ Gradient category pills â”€â”€ */
        .cat-pill-1 { background: linear-gradient(135deg,#4CAF50,#8BC34A); color:white; }
        .cat-pill-2 { background: linear-gradient(135deg,#2196F3,#00BCD4); color:white; }
        .cat-pill-3 { background: linear-gradient(135deg,#FF9800,#FFC107); color:white; }
        .cat-pill-4 { background: linear-gradient(135deg,#9C27B0,#E91E63); color:white; }
        .cat-pill-5 { background: linear-gradient(135deg,#F44336,#FF5722); color:white; }
        .cat-pill-6 { background: linear-gradient(135deg,#00BCD4,#009688); color:white; }
        .cat-pill-7 { background: linear-gradient(135deg,#FF6B6B,#FF9F43); color:white; }
        .cat-pill-8 { background: linear-gradient(135deg,#a29bfe,#6c5ce7); color:white; }

        /* â”€â”€ Modern input â”€â”€ */
        .input-vivid {
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 14px;
            padding: 12px 16px;
            font-size: 16px;
            width: 100%;
            transition: border-color 0.25s, box-shadow 0.25s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .input-vivid:focus {
            border-color: #FF7F50;
            box-shadow: 0 0 0 4px rgba(255,127,80,0.15), 0 4px 16px rgba(0,0,0,0.08);
            outline: none;
        }

        /* â”€â”€ Bottom nav redesign vars â”€â”€ */
        .mobile-nav-container {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            z-index: 50;
            padding: 0 12px 8px;
            padding-bottom: calc(8px + env(safe-area-inset-bottom, 0px));
        }
        .mobile-nav-pill {
            background: rgba(255,255,255,0.94);
            backdrop-filter: blur(24px) saturate(200%);
            -webkit-backdrop-filter: blur(24px) saturate(200%);
            border-radius: 28px;
            box-shadow: 0 -2px 0 rgba(0,0,0,0.04),
                        0 8px 40px rgba(0,0,0,0.18),
                        0 2px 12px rgba(0,0,0,0.08);
            border: 1.5px solid rgba(255,255,255,0.7);
            display: flex;
            align-items: center;
            justify-content: space-around;
            height: 62px;
            padding: 0 8px;
        }
        .mobile-nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 3px;
            height: 100%;
            border-radius: 22px;
            transition: all 0.25s cubic-bezier(0.34,1.56,0.64,1);
            position: relative;
            cursor: pointer;
            border: none;
            background: transparent;
            -webkit-tap-highlight-color: transparent;
        }
        .mobile-nav-item.active {
            background: linear-gradient(135deg,#153A60,#2A629A);
            box-shadow: 0 4px 16px rgba(21,58,96,0.35);
        }
        .mobile-nav-item.active .nav-icon-wrap { color: #FF7F50; }
        .mobile-nav-item.active .nav-label     { color: #FF7F50; font-weight: 800; }
        .mobile-nav-item:not(.active) .nav-icon-wrap { color: #9CA3AF; }
        .mobile-nav-item:not(.active) .nav-label     { color: #9CA3AF; }
        .mobile-nav-item:not(.active):active { transform: scale(0.88); }
        .nav-icon-wrap { font-size: 20px; line-height: 1; position: relative; }
        .nav-label     { font-size: 9px; font-weight: 600; letter-spacing: 0.3px; }

        /* â”€â”€ Cart badge â”€â”€ */
        .cart-badge {
            position: absolute;
            top: -6px; right: -8px;
            background: linear-gradient(135deg,#FF7F50,#FF6347);
            color: white;
            font-size: 9px; font-weight: 900;
            width: 18px; height: 18px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(255,99,71,0.5);
        }

        /* â”€â”€ Mobile product card â”€â”€ */
        @media (max-width: 768px) {
            .product-card-mobile {
                border-radius: 20px;
                background: white;
                box-shadow: 0 4px 20px rgba(0,0,0,0.08),
                            0 1px 4px rgba(0,0,0,0.06);
                overflow: hidden;
                transition: transform 0.15s ease, box-shadow 0.15s ease;
            }
            .product-card-mobile:active {
                transform: scale(0.96);
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            }
            .product-img-bg {
                background: linear-gradient(135deg,#f8faff,#f0f4ff);
                border-radius: 14px;
                padding: 8px;
                display: flex; align-items: center; justify-content: center;
            }
            .add-to-cart-btn-mobile {
                background: linear-gradient(135deg,#FF7F50,#FF6347);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 10px;
                font-weight: 800;
                font-size: 12px;
                width: 100%;
                box-shadow: 0 4px 14px rgba(255,127,80,0.4);
                transition: transform 0.12s ease, box-shadow 0.12s ease;
                -webkit-tap-highlight-color: transparent;
            }
            .add-to-cart-btn-mobile:active {
                transform: scale(0.95);
                box-shadow: 0 2px 6px rgba(255,127,80,0.3);
            }
            .price-tag-mobile {
                background: linear-gradient(135deg,#FF4757,#FF6B81);
                color: white;
                padding: 2px 10px;
                border-radius: 20px;
                font-weight: 900;
                font-size: 15px;
                display: inline-block;
                box-shadow: 0 2px 8px rgba(255,71,87,0.35);
            }
        }

        /* â”€â”€ Toast vivid â”€â”€ */
        .toast-vivid {
            border-radius: 18px;
            padding: 14px 18px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.22),
                        0 2px 8px rgba(0,0,0,0.12);
            display: flex; align-items: center; gap: 12px;
            max-width: 320px;
            min-width: 240px;
        }
        .toast-icon-circle {
            width: 36px; height: 36px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            background: rgba(255,255,255,0.25);
            font-size: 16px;
        }

        /* â”€â”€ Section title mobile â”€â”€ */
        .section-title-vivid {
            font-size: 20px;
            font-weight: 900;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* â”€â”€ Quick stat pill for home â”€â”€ */
        .quick-stat-pill {
            background: white;
            border-radius: 16px;
            padding: 12px 16px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: transform 0.15s ease;
        }
        .quick-stat-pill:active { transform: scale(0.96); }

        /* â”€â”€ Ripple effect on buttons â”€â”€ */
        @keyframes rippleEffect {
            0%  { transform: scale(0); opacity: 0.6; }
            100%{ transform: scale(4); opacity: 0; }
        }
        .ripple-btn { position: relative; overflow: hidden; }
        .ripple-btn::after {
            content: '';
            position: absolute;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.4);
            transform: scale(0);
            left: 50%; top: 50%;
            margin: -20px 0 0 -20px;
            pointer-events: none;
        }
        .ripple-btn:active::after { animation: rippleEffect 0.5s ease-out forwards; }

        /* â”€â”€ Mobile bottom spacing (larger for floating nav) â”€â”€ */
        .pb-mobile-nav { padding-bottom: 88px; }
        @media (min-width: 768px) { .pb-mobile-nav { padding-bottom: 0; } }

        /* â”€â”€ Header mobile gradient â”€â”€ */
        @media (max-width: 768px) {
            .header-mobile-gradient {
                background: linear-gradient(135deg,#0F2744 0%,#153A60 50%,#1e4d7a 100%) !important;
            }
        }

        /* â”€â”€ Category card colors â”€â”€ */
        .cat-card-green  { background: linear-gradient(135deg,#43E97B,#38F9D7); }
        .cat-card-blue   { background: linear-gradient(135deg,#4FACFE,#00F2FE); }
        .cat-card-orange { background: linear-gradient(135deg,#FA8231,#FFC200); }
        .cat-card-purple { background: linear-gradient(135deg,#A18CD1,#FBC2EB); }
        .cat-card-red    { background: linear-gradient(135deg,#FF416C,#FF4B2B); }
        .cat-card-teal   { background: linear-gradient(135deg,#0ED2F7,#08AEEA); }
        .cat-card-pink   { background: linear-gradient(135deg,#F953C6,#B91D73); }
        .cat-card-lime   { background: linear-gradient(135deg,#B7F8DB,#50A7C2); }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // =======================================================
        // 1. GLOBAL CONSTANTS & API SETUP
        // =======================================================

        // !!! IMPORTANT: REPLACE THIS URL WITH YOUR OWN GOOGLE APPS SCRIPT WEB APP URL HERE !!!
        const API_URL = "https://script.google.com/macros/s/AKfycbyhm4liE6vXEz49jTJ1kbbHXLU8Xr64-PdZQbH8HqH7QyR1Yz_CJ1OWKeuZQTnGAjQVQg/exec";

        // UPI Configuration - Update these with your actual UPI details
        const UPI_CONFIG = {
            upiId: 'murunmurugan80-2@okicici', // Replace with your actual UPI ID
            merchantName: 'Maddur Murugan Super Store',
            qrCodeBase: 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=',
            paymentApps: [
                { id: 'gpay', name: 'Google Pay', icon: 'fa-brands fa-google-pay', color: 'bg-white text-gray-800', deepLink: 'tez://upi/pay' },
                { id: 'phonepe', name: 'PhonePe', icon: 'fa-solid fa-mobile-screen', color: 'bg-purple-600 text-white', deepLink: 'phonepe://upi/pay' },
                { id: 'paytm', name: 'Paytm', icon: 'fa-solid fa-wallet', color: 'bg-blue-500 text-white', deepLink: 'paytmmp://upi/pay' },
                { id: 'whatsapp', name: 'WhatsApp', icon: 'fa-brands fa-whatsapp', color: 'bg-green-500 text-white', deepLink: 'whatsapp://send' }
            ]
        };

        // Email Notification Configuration
        const EMAIL_CONFIG = {
            storeName: 'Maddur Murugan Super Store',
            storeEmail: 'noreply@muruganstore.com', // Update with your store email
            adminEmail: 'admin@muruganstore.com', // Update with admin email
            storePhone: '+91 9047878046 / +91 7530089730',
            storeAddress: '123 Main Street, Chennai, Tamil Nadu 600001',
            storeWebsite: 'https://mmsuperstore.github.io/'
        };

        // =======================================================
        // DELIVERY POLICY CONFIGURATION
        // =======================================================
        const DELIVERY_POLICY = {
            minimumOrder: 500, // â‚¹500 minimum order
            freeDeliveryAbove: 500, // Free delivery above â‚¹500
            deliveryAreas: [
                { name: 'Minimum 5 km', code: 'VLR', charge: 0, minOrder: 500 },
            ],
            nonDeliveryAreas: [
                'Maximum 8 km',

            ]
        };

        const post = async (data) => {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors', // Essential for GAS
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' }, // MUST be text/plain for GAS to parse JSON body correctly
                    body: JSON.stringify(data)
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error("API Call Error:", error);
                return { status: 'error', message: 'Network or server error.' };
            }
        };

        const get = async (params) => {
            try {
                const query = new URLSearchParams(params).toString();
                const url = `${API_URL}?${query}`;
                const response = await fetch(url);
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error("API Call Error:", error);
                return { status: 'error', message: 'Network or server error.' };
            }
        };

        const formatCurrency = (amount) => {
            return `â‚¹${parseFloat(amount).toFixed(2)}`;
        };

        const getRole = (user) => user?.role || 'guest';
        const isUserBanned = (user) => user?.status === 'banned';

        // =======================================================
        // 2. REUSABLE UI COMPONENTS
        // =======================================================

        const Header = ({ user, setView, totalCartItems, openTicketCount }) => {
            const role = getRole(user);

            return (
                <header className="bg-primary-dark header-mobile-gradient text-white sticky top-0 z-50 shadow-vibrant">
                    <div className="flex items-center justify-between p-2 md:p-3 max-w-7xl mx-auto">
                        {/* Logo */}
                        <div className="flex items-center cursor-pointer flex-shrink-0 gap-2" onClick={() => setView('home')}>
                            <div className="w-9 h-9 rounded-xl flex items-center justify-center flex-shrink-0"
                                style={{ background: 'linear-gradient(135deg,#FF7F50,#FFD700)', boxShadow: '0 3px 10px rgba(255,127,80,0.5)' }}>
                                <i className="fa-solid fa-store text-primary-dark text-base"></i>
                            </div>
                            <div className="leading-tight">
                                <div className="text-base font-black tracking-tight" style={{ letterSpacing: '-0.5px' }}>
                                    <span className="gradient-text-orange">MMSS</span>
                                </div>
                                <div className="text-[9px] text-white/60 font-medium hidden sm:block" style={{ letterSpacing: '1px' }}>SUPER STORE</div>
                            </div>
                        </div>

                        {/* Search Bar - Hidden on mobile (use products page search) */}
                        <div className="flex-1 max-w-xl mx-4 hidden lg:flex">
                            <input type="text" placeholder="Search for products..." className="p-2 h-full rounded-l-md flex-grow text-gray-800 outline-none" />
                            <div className="bg-accent p-2 rounded-r-md hover:bg-accent-hover cursor-pointer transition">
                                <i className="fa-solid fa-magnifying-glass text-primary-dark"></i>
                            </div>
                        </div>

                        {/* Navigation Links */}
                        <div className="flex items-center space-x-2 md:space-x-4 text-sm font-semibold">
                            {/* Account & Lists */}
                            <div className="hover:text-accent cursor-pointer transition p-1 hidden md:block" onClick={() => setView(role === 'guest' ? 'login' : 'profile')}>
                                <p className="text-xs">Hello, {user?.name ? user.name.split(' ')[0] : 'Guest'}</p>
                                <p className="font-bold">{role === 'guest' ? 'Sign In' : 'Account'}</p>
                            </div>

                            {/* Orders - Desktop only */}
                            {role !== 'guest' && (
                                <div className="hover:text-accent cursor-pointer transition hidden lg:block p-1" onClick={() => setView('orders')}>
                                    <p className="text-xs">My</p>
                                    <p className="font-bold">Orders</p>
                                </div>
                            )}

                            {/* Admin Link - Desktop only with ticket badge */}
                            {role === 'admin' && (
                                <div className="hover:text-danger cursor-pointer transition hidden lg:block p-1 relative" onClick={() => setView('admin')}>
                                    <p className="text-xs text-danger">Panel</p>
                                    <p className="font-bold">Admin</p>
                                    {openTicketCount > 0 && (
                                        <span className="absolute -top-1 -right-1 bg-danger text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full animate-pulse">
                                            {openTicketCount > 9 ? '9+' : openTicketCount}
                                        </span>
                                    )}
                                </div>
                            )}

                            {/* Cart Icon - Always visible */}
                            <div className="flex items-center relative hover:text-accent cursor-pointer transition p-1" onClick={() => setView('cart')}>
                                <i className="fa-solid fa-cart-shopping text-xl md:text-2xl"></i>
                                {totalCartItems > 0 && (
                                    <span className="absolute -top-1 -right-1 bg-accent text-primary-dark text-[10px] md:text-xs font-bold w-4 h-4 md:w-5 md:h-5 flex items-center justify-center rounded-full">
                                        {totalCartItems > 9 ? '9+' : totalCartItems}
                                    </span>
                                )}
                                <span className="font-bold ml-1 hidden lg:inline">Cart</span>
                            </div>
                        </div>
                    </div>

                    {/* Secondary Navigation - Scrollable on mobile */}
                    <div className="bg-primary text-white p-2 flex items-center space-x-3 md:space-x-4 text-xs md:text-sm font-semibold overflow-x-auto hide-scrollbar shadow-inner">
                        <span className="flex items-center cursor-pointer text-accent hover:text-white transition whitespace-nowrap" onClick={() => setView('home')}>
                            <i className="fa-solid fa-house mr-1"></i> Home
                        </span>
                        <span className="cursor-pointer hover:text-accent transition whitespace-nowrap" onClick={() => setView('products')}>Products</span>
                        {role !== 'guest' && <span className="cursor-pointer hover:text-accent transition whitespace-nowrap" onClick={() => setView('grocerylist')}><i className="fa-solid fa-list-check mr-1"></i>Grocery List</span>}
                        <span className="cursor-pointer hover:text-accent transition whitespace-nowrap" onClick={() => setView('support')}>Support</span>
                        {role === 'admin' && <span className="cursor-pointer hover:text-danger transition text-danger/80 whitespace-nowrap" onClick={() => setView('admin')}>Admin</span>}
                    </div>
                </header>
            );
        };

        const MobileNavBar = ({ view, setView, totalCartItems, user }) => {
            const role = getRole(user);
            const [tapped, setTapped] = React.useState(null);

            const navItems = [
                { id: 'home',      icon: 'fa-house',              label: 'Home',    gradient: 'linear-gradient(135deg,#153A60,#2A629A)' },
                { id: 'products',  icon: 'fa-basket-shopping',    label: 'Shop',    gradient: 'linear-gradient(135deg,#FF7F50,#FF6347)' },
                ...(role !== 'guest' ? [{ id: 'grocerylist', icon: 'fa-list-check', label: 'List', gradient: 'linear-gradient(135deg,#43E97B,#38F9D7)' }] : []),
                { id: 'cart',      icon: 'fa-cart-shopping',      label: 'Cart',    gradient: 'linear-gradient(135deg,#FA8231,#FFC200)', count: totalCartItems },
                { id: role === 'guest' ? 'login' : 'profile', icon: role === 'guest' ? 'fa-right-to-bracket' : 'fa-user-circle', label: role === 'guest' ? 'Sign In' : 'Me', gradient: 'linear-gradient(135deg,#A18CD1,#FBC2EB)' },
                ...(role === 'admin' ? [{ id: 'admin', icon: 'fa-shield-halved', label: 'Admin', gradient: 'linear-gradient(135deg,#F953C6,#B91D73)' }] : [])
            ];

            const handleTap = (id) => {
                setTapped(id);
                setView(id);
                setTimeout(() => setTapped(null), 450);
            };

            return (
                <div className="mobile-nav-container md:hidden">
                    <div className="mobile-nav-pill">
                        {navItems.map(item => {
                            const isActive = view === item.id;
                            const isTapped = tapped === item.id;
                            return (
                                <button
                                    key={item.id}
                                    onClick={() => handleTap(item.id)}
                                    className={`mobile-nav-item ${isActive ? 'active' : ''}`}
                                    style={isActive ? { background: item.gradient } : {}}
                                >
                                    <div className={`nav-icon-wrap ${isTapped ? 'nav-pop' : ''}`}>
                                        <i className={`fa-solid ${item.icon}`}></i>
                                        {item.count > 0 && (
                                            <span className={`cart-badge ${isTapped ? 'badge-bounce' : ''}`}>
                                                {item.count > 9 ? '9+' : item.count}
                                            </span>
                                        )}
                                    </div>
                                    <span className="nav-label">{item.label}</span>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const ToastNotification = ({ message, type, onClose }) => {
            if (!message) return null;

            const config = {
                success: {
                    bg: 'linear-gradient(135deg,#43E97B,#38F9D7)',
                    icon: 'fa-circle-check',
                    shadow: '0 8px 32px rgba(67,233,123,0.45)',
                    emoji: 'âœ…'
                },
                error: {
                    bg: 'linear-gradient(135deg,#FF416C,#FF4B2B)',
                    icon: 'fa-circle-xmark',
                    shadow: '0 8px 32px rgba(255,65,108,0.45)',
                    emoji: 'âŒ'
                },
                warning: {
                    bg: 'linear-gradient(135deg,#FA8231,#FFC200)',
                    icon: 'fa-triangle-exclamation',
                    shadow: '0 8px 32px rgba(250,130,49,0.45)',
                    emoji: 'âš ï¸'
                },
                info: {
                    bg: 'linear-gradient(135deg,#4FACFE,#00F2FE)',
                    icon: 'fa-circle-info',
                    shadow: '0 8px 32px rgba(79,172,254,0.45)',
                    emoji: 'â„¹ï¸'
                },
            }[type] || {
                bg: 'linear-gradient(135deg,#153A60,#2A629A)',
                icon: 'fa-bell',
                shadow: '0 8px 32px rgba(21,58,96,0.4)',
                emoji: 'ðŸ””'
            };

            useEffect(() => {
                const timer = setTimeout(onClose, 3500);
                return () => clearTimeout(timer);
            }, [message, onClose]);

            return (
                <div
                    className="fixed top-4 right-4 z-[100] toast-slide-in"
                    style={{ maxWidth: '320px', minWidth: '220px' }}
                >
                    <div
                        className="toast-vivid text-white"
                        style={{ background: config.bg, boxShadow: config.shadow }}
                    >
                        <div className="toast-icon-circle">
                            <i className={`fa-solid ${config.icon} text-lg`}></i>
                        </div>
                        <p className="text-sm font-bold flex-1 leading-snug">{message}</p>
                        <button
                            onClick={onClose}
                            className="text-white/70 hover:text-white transition ml-1 flex-shrink-0"
                            style={{ fontSize: '18px', lineHeight: 1 }}
                        >
                            <i className="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    {/* Progress bar */}
                    <div style={{ height: '3px', borderRadius: '0 0 18px 18px', background: 'rgba(255,255,255,0.35)', overflow: 'hidden', marginTop: '-1px' }}>
                        <div style={{
                            height: '100%',
                            background: 'rgba(255,255,255,0.7)',
                            animation: 'toastProgress 3.5s linear forwards',
                            borderRadius: '0 0 18px 18px'
                        }}></div>
                    </div>
                </div>
            );
        };

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center py-12">
                <i className="fa-solid fa-spinner fa-spin fa-2xl text-primary"></i>
            </div>
        );

        // =======================================================
        // DELIVERY AREAS MODAL COMPONENT
        // =======================================================
        const DeliveryAreasModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-2xl w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <div className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4">
                                <h2 className="text-2xl font-bold text-primary-dark">Delivery Areas & Charges</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-danger transition">
                                    <i className="fa-solid fa-xmark text-xl"></i>
                                </button>
                            </div>

                            <div className="mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                                    <h3 className="text-lg font-bold text-primary-dark mb-2 flex items-center">
                                        <i className="fa-solid fa-info-circle mr-2 text-info"></i>
                                        Delivery Policy
                                    </h3>
                                    <ul className="text-sm text-gray-700 space-y-2">
                                        <li className="flex items-start">
                                            <i className="fa-solid fa-check-circle text-success mt-1 mr-2"></i>
                                            <span><strong>Minimum Order:</strong> â‚¹{DELIVERY_POLICY.minimumOrder} for all delivery areas</span>
                                        </li>
                                        <li className="flex items-start">
                                            <i className="fa-solid fa-check-circle text-success mt-1 mr-2"></i>
                                            <span><strong>Free Delivery:</strong> For orders above â‚¹{DELIVERY_POLICY.freeDeliveryAbove} in select areas</span>
                                        </li>
                                        <li className="flex items-start">
                                            <i className="fa-solid fa-check-circle text-success mt-1 mr-2"></i>
                                            <span><strong>Delivery Time:</strong> 1-2 hours during store hours (7 AM - 10 PM)</span>
                                        </li>
                                    </ul>
                                </div>

                                <h3 className="text-xl font-bold text-primary-dark mb-4">Serviceable Areas</h3>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {DELIVERY_POLICY.deliveryAreas.map(area => (
                                        <div key={area.code} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="font-bold text-gray-800">{area.name}</h4>
                                                <span className="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                                    {area.code}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <p className="text-sm text-gray-600">Delivery Charge:</p>
                                                    <p className={`text-lg font-bold ${area.charge === 0 ? 'text-success' : 'text-gray-800'}`}>
                                                        {area.charge === 0 ? 'FREE' : `â‚¹${area.charge}`}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-gray-600">Min. Order:</p>
                                                    <p className="text-lg font-bold text-danger">â‚¹{area.minOrder}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <h4 className="text-lg font-bold text-yellow-800 mb-2 flex items-center">
                                        <i className="fa-solid fa-exclamation-triangle mr-2"></i>
                                        Currently Not Serviced
                                    </h4>
                                    <p className="text-sm text-gray-700 mb-2">The following areas are currently not serviced:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {DELIVERY_POLICY.nonDeliveryAreas.map(area => (
                                            <span key={area} className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                                                {area}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="border-t pt-4">
                                <button
                                    onClick={onClose}
                                    className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // MINIMUM ORDER PROGRESS BAR COMPONENT
        // =======================================================
        const MinimumOrderProgress = ({ currentAmount }) => {
            const minAmount = DELIVERY_POLICY.minimumOrder;
            const progressPercentage = Math.min((currentAmount / minAmount) * 100, 100);
            const remainingAmount = Math.max(0, minAmount - currentAmount);
            const hasMinimum = currentAmount >= minAmount;

            return (
                <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="font-bold text-gray-800">Minimum Order Progress</h3>
                        <span className={`font-bold ${hasMinimum ? 'text-success' : 'text-accent-hover'}`}>
                            {formatCurrency(currentAmount)} / {formatCurrency(minAmount)}
                        </span>
                    </div>

                    {/* Progress Bar */}
                    <div className="progress-bar mb-3">
                        <div
                            className="progress-bar-fill bg-gradient-to-r from-blue-500 to-green-500"
                            style={{ width: `${progressPercentage}%` }}
                        ></div>
                    </div>

                    {/* Status Message */}
                    {hasMinimum ? (
                        <div className="bg-green-50 text-green-700 p-3 rounded-lg text-center">
                            <i className="fa-solid fa-check-circle mr-2"></i>
                            <strong>Congratulations!</strong> Your order meets the minimum requirement.
                        </div>
                    ) : (
                        <div className="bg-yellow-50 text-yellow-800 p-3 rounded-lg">
                            <div className="flex items-center justify-between">
                                <div>
                                    <i className="fa-solid fa-info-circle mr-2"></i>
                                    <span>Add <strong className="text-danger">{formatCurrency(remainingAmount)} more</strong> to place your order</span>
                                </div>
                                <div className="text-sm font-bold">
                                    {Math.round(progressPercentage)}%
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 3. AUTH VIEW (OTP & ERROR DISPLAY)
        // =======================================================
        const AuthView = ({ mode, setView, setUser, showToast }) => {
            const [step, setStep] = useState(1); // 1: Input Details, 2: Verify OTP
            const [form, setForm] = useState({ name: '', email: '', password: '', phone: '', otp: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [authError, setAuthError] = useState(null);

            // Forgot Password Flow State
            const [forgotStep, setForgotStep] = useState(0); // 0: hidden, 1: enter email, 2: enter OTP+new password
            const [forgotForm, setForgotForm] = useState({ email: '', otp: '', newPassword: '', confirmPassword: '' });

            useEffect(() => {
                setAuthError(null);
                setStep(1);
                setForgotStep(0);
                setForm(prev => ({ ...prev, name: '', password: '', phone: '', otp: '' }));
                setForgotForm({ email: '', otp: '', newPassword: '', confirmPassword: '' });
            }, [mode]);

            // Forgot Password Handlers
            const handleForgotPassword = async (e) => {
                e.preventDefault();
                setAuthError(null);
                if (!forgotForm.email) {
                    setAuthError("Please enter your email address.");
                    return;
                }
                setIsSubmitting(true);

                const res = await post({
                    action: 'forgotPassword',
                    email: forgotForm.email
                });

                setIsSubmitting(false);
                if (res.status === 'success') {
                    setForgotStep(2);
                    showToast("OTP sent to your email!", 'success');
                } else {
                    setAuthError(res.message || "Failed to send OTP. Check your email.");
                }
            };

            const handleVerifyPasswordReset = async (e) => {
                e.preventDefault();
                setAuthError(null);

                if (forgotForm.otp.length !== 6) {
                    setAuthError("OTP must be 6 digits.");
                    return;
                }
                if (forgotForm.newPassword.length < 6) {
                    setAuthError("Password must be at least 6 characters.");
                    return;
                }
                if (forgotForm.newPassword !== forgotForm.confirmPassword) {
                    setAuthError("Passwords do not match.");
                    return;
                }

                setIsSubmitting(true);

                const res = await post({
                    action: 'verifyPasswordReset',
                    email: forgotForm.email,
                    otp: forgotForm.otp,
                    newPassword: forgotForm.newPassword
                });

                setIsSubmitting(false);
                if (res.status === 'success') {
                    showToast("Password reset successful! Please sign in.", 'success');
                    setForgotStep(0);
                    setForgotForm({ email: '', otp: '', newPassword: '', confirmPassword: '' });
                } else {
                    setAuthError(res.message || "Password reset failed.");
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError(null);
                setIsSubmitting(true);

                const res = await post({
                    action: 'login',
                    email: form.email,
                    password: form.password,
                    notifyLogin: true
                });

                setIsSubmitting(false);
                if (res.status === 'success') {
                    if (isUserBanned(res.user)) {
                        setAuthError("Your account has been restricted. Please contact support.");
                        return;
                    }
                    setUser(res.user);
                    localStorage.setItem('muruganUser', JSON.stringify(res.user));
                    showToast(`Welcome back, ${res.user.name.split(' ')[0]}!`, 'success');

                    if (res.notificationSent) {
                        setTimeout(() => {
                            showToast('Login notification sent to your email.', 'info');
                        }, 1000);
                    }

                    setView('home');
                } else {
                    setAuthError(res.message || "Invalid credentials.");
                }
            };

            const handleRegisterRequest = async (e) => {
                e.preventDefault();
                setAuthError(null);
                if (form.password.length < 6) {
                    setAuthError("Password must be at least 6 characters.");
                    return;
                }
                setIsSubmitting(true);

                const res = await post({
                    action: 'sendOtp',
                    email: form.email,
                    name: form.name,
                    password: form.password,
                    phone: form.phone
                });
                setIsSubmitting(false);

                if (res.status === 'success') {
                    setStep(2);
                    showToast("OTP sent to your email!", 'success');
                } else {
                    setAuthError(res.message || "Registration failed.");
                }
            };

            const handleVerifyOTP = async (e) => {
                e.preventDefault();
                setAuthError(null);
                if (form.otp.length !== 6) {
                    setAuthError("OTP must be 6 digits.");
                    return;
                }
                setIsSubmitting(true);

                const res = await post({
                    action: 'verifyRegister',
                    email: form.email,
                    otp: form.otp,
                    sendWelcomeEmail: true
                });
                setIsSubmitting(false);

                if (res.status === 'success') {
                    setUser(res.user);
                    localStorage.setItem('muruganUser', JSON.stringify(res.user));
                    showToast("Account created successfully!", 'success');

                    if (res.welcomeEmailSent) {
                        setTimeout(() => {
                            showToast('Welcome email sent! Check your inbox.', 'info');
                        }, 1000);
                    }

                    setView('home');
                } else {
                    setAuthError(res.message || "Verification failed.");
                }
            };

            return (
                <div className="flex flex-col justify-center items-center min-h-screen bg-gray-100 p-4 pb-20 md:pb-4">
                    <div className="bg-white p-5 md:p-8 rounded-xl border border-gray-300 w-full max-w-sm shadow-2xl">
                        <h2 className="text-2xl md:text-3xl mb-4 font-extrabold text-primary-dark border-b-2 border-accent pb-2">
                            {mode === 'login' ? 'Sign-In' : step === 1 ? 'Create Account' : 'Verify Email'}
                        </h2>

                        {/* Error Display with Shake Animation */}
                        {authError && (
                            <div className="bg-danger/10 border-l-4 border-danger p-3 mb-4 rounded flex items-start animate-shake">
                                <i className="fa-solid fa-triangle-exclamation text-danger mt-1 mr-2"></i>
                                <div>
                                    <p className="text-sm text-danger font-bold">Error!</p>
                                    <p className="text-xs text-danger/80">{authError}</p>
                                </div>
                            </div>
                        )}

                        {mode === 'login' && forgotStep === 0 && (
                            <form onSubmit={handleLogin} className="flex flex-col gap-3">
                                <label className="text-sm font-bold text-gray-700">Email</label>
                                <input required type="email" className="text-input-style" value={form.email} onChange={e => setForm({...form, email:e.target.value})} />
                                <label className="text-sm font-bold text-gray-700">Password</label>
                                <input required type="password" className="text-input-style" value={form.password} onChange={e => setForm({...form, password:e.target.value})} />
                                <div className="flex items-center justify-between text-xs mt-1">
                                    <div className="flex items-center text-gray-600">
                                        <i className="fa-solid fa-envelope mr-1"></i>
                                        <span>You'll receive a login confirmation email</span>
                                    </div>
                                    <button type="button" onClick={() => { setForgotStep(1); setForgotForm({...forgotForm, email: form.email}); }} className="text-primary hover:underline font-semibold">
                                        Forgot Password?
                                    </button>
                                </div>
                                <button type="submit" disabled={isSubmitting} className="bg-accent p-3 rounded-md font-bold text-primary-dark hover:bg-accent-hover transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Signing in...' : 'Sign In'}
                                </button>
                            </form>
                        )}

                        {/* Forgot Password - Step 1: Enter Email */}
                        {mode === 'login' && forgotStep === 1 && (
                            <form onSubmit={handleForgotPassword} className="flex flex-col gap-3">
                                <div className="bg-info/10 text-info p-3 rounded text-sm mb-2 border border-info/30">
                                    <i className="fa-solid fa-key mr-2"></i>
                                    Enter your email to receive a password reset OTP.
                                </div>
                                <label className="text-sm font-bold text-gray-700">Email Address</label>
                                <input
                                    required
                                    type="email"
                                    className="text-input-style"
                                    placeholder="Enter your registered email"
                                    value={forgotForm.email}
                                    onChange={e => setForgotForm({...forgotForm, email: e.target.value})}
                                />
                                <button type="submit" disabled={isSubmitting} className="bg-primary text-white p-3 rounded-md font-bold hover:bg-primary-dark transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Sending OTP...' : 'Send Reset OTP'}
                                </button>
                                <button type="button" onClick={() => setForgotStep(0)} className="text-xs text-primary hover:underline mt-2 text-center">
                                    <i className="fa-solid fa-arrow-left mr-1"></i> Back to Sign In
                                </button>
                            </form>
                        )}

                        {/* Forgot Password - Step 2: Enter OTP & New Password */}
                        {mode === 'login' && forgotStep === 2 && (
                            <form onSubmit={handleVerifyPasswordReset} className="flex flex-col gap-3">
                                <div className="bg-primary/10 text-primary p-3 rounded text-sm mb-2 border border-primary/30">
                                    <i className="fa-solid fa-envelope mr-2"></i>
                                    OTP sent to <strong>{forgotForm.email}</strong>.
                                </div>
                                <label className="text-sm font-bold">Enter 6-Digit OTP</label>
                                <input
                                    required
                                    type="text"
                                    inputMode="numeric"
                                    pattern="\d{6}"
                                    maxLength="6"
                                    className="text-input-style text-center tracking-widest text-2xl font-mono"
                                    placeholder="XXXXXX"
                                    value={forgotForm.otp}
                                    onChange={e => setForgotForm({...forgotForm, otp: e.target.value.replace(/\D/g, '')})}
                                />
                                <label className="text-sm font-bold">New Password</label>
                                <input
                                    required
                                    type="password"
                                    className="text-input-style"
                                    placeholder="At least 6 characters"
                                    value={forgotForm.newPassword}
                                    onChange={e => setForgotForm({...forgotForm, newPassword: e.target.value})}
                                />
                                <label className="text-sm font-bold">Confirm New Password</label>
                                <input
                                    required
                                    type="password"
                                    className="text-input-style"
                                    placeholder="Re-enter new password"
                                    value={forgotForm.confirmPassword}
                                    onChange={e => setForgotForm({...forgotForm, confirmPassword: e.target.value})}
                                />
                                <button type="submit" disabled={isSubmitting} className="bg-success text-white p-3 rounded-md font-bold hover:bg-success/80 transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Resetting...' : 'Reset Password'}
                                </button>
                                <button type="button" onClick={() => setForgotStep(1)} className="text-xs text-primary hover:underline mt-2 text-center">
                                    <i className="fa-solid fa-arrow-left mr-1"></i> Change email
                                </button>
                            </form>
                        )}

                        {mode === 'register' && step === 1 && (
                            <form onSubmit={handleRegisterRequest} className="flex flex-col gap-3">
                                <label className="text-sm font-bold">Your Name</label>
                                <input required className="text-input-style" value={form.name} onChange={e => setForm({...form, name:e.target.value})} />
                                <label className="text-sm font-bold">Phone Number</label>
                                <input required type="tel" className="text-input-style" value={form.phone} onChange={e => setForm({...form, phone:e.target.value})} />
                                <label className="text-sm font-bold">Email</label>
                                <input required type="email" className="text-input-style" value={form.email} onChange={e => setForm({...form, email:e.target.value})} />
                                <label className="text-sm font-bold">Password</label>
                                <input required type="password" className="text-input-style" placeholder="At least 6 characters" value={form.password} onChange={e => setForm({...form, password:e.target.value})} />
                                <div className="flex items-center text-xs text-gray-600 mt-1">
                                    <i className="fa-solid fa-gift mr-1"></i>
                                    <span>You'll receive a welcome email with special offers!</span>
                                </div>
                                <button type="submit" disabled={isSubmitting} className="bg-accent p-3 rounded-md font-bold text-primary-dark hover:bg-accent-hover transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Sending OTP...' : 'Continue'}
                                </button>
                            </form>
                        )}

                        {mode === 'register' && step === 2 && (
                            <form onSubmit={handleVerifyOTP} className="flex flex-col gap-3">
                                <div className="bg-primary/10 text-primary p-3 rounded text-sm mb-2 border border-primary/30">
                                    <i className="fa-solid fa-envelope mr-2"></i>
                                    OTP sent to <strong>{form.email}</strong>.
                                </div>
                                <label className="text-sm font-bold">Enter 6-Digit OTP</label>
                                <input
                                    required
                                    type="text"
                                    inputMode="numeric"
                                    pattern="\d{6}"
                                    maxLength="6"
                                    className="text-input-style text-center tracking-widest text-2xl font-mono"
                                    placeholder="XXXXXX"
                                    value={form.otp}
                                    onChange={e => setForm({...form, otp:e.target.value.replace(/\D/g, '')})}
                                />
                                <button type="submit" disabled={isSubmitting} className="bg-success text-white p-3 rounded-md font-bold hover:bg-success/80 transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Verifying...' : 'Verify & Create Account'}
                                </button>
                                <button type="button" onClick={() => setStep(1)} className="text-xs text-primary hover:underline mt-2 text-center">
                                    <i className="fa-solid fa-arrow-left mr-1"></i> Change details
                                </button>
                            </form>
                        )}

                        {forgotStep === 0 && (
                            <div className="mt-6 border-t pt-4 text-center">
                                {mode === 'login' ? (
                                    <p className="text-sm">New here? <button onClick={() => setView('register')} className="text-primary hover:underline font-semibold">Create your account</button></p>
                                ) : (
                                    <p className="text-sm">Already have an account? <button onClick={() => setView('login')} className="text-primary hover:underline font-semibold">Sign In</button></p>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // =======================================================
        // 4. HOME VIEW WITH CUSTOMIZABLE SECTIONS
        // =======================================================

        const HomeView = ({ products, setView, setSelectedProduct, onQuickAddToCart, banners = [] }) => {
            // ============================================
            // EASILY CUSTOMIZE THESE VARIABLES BELOW
            // ============================================

            // 1. STORE INFORMATION (Change these values)
            const STORE_CONFIG = {
                name: "Maddur Murugan Super Store",
                tagline: "Serving you fresh since 2003",
                phone: "+91 7530089730",
                address: "1/309 Bazzer Street, Maddur, Tamil Nadu 631206",
                openingHours: "6:00 AM - 9:00 PM Daily",
                whatsappNumber: "919047878046" // Without + sign
            };

            // 2. CURRENT OFFERS & DEALS (Update these regularly)
            const CURRENT_OFFERS = [
                /*{
                    id: 1,
                    title: "Special Sunday Offer",
                    description: "Buy 1 Get 1 Free on Milk",
                    icon: "fa-gift",
                    color: "bg-red-500",
                    expires: "Today Only",
                    couponCode: "SUNDAYBOGO"
                },
                {
                    id: 2,
                    title: "Weekend Discount",
                    description: "Flat 15% OFF on Vegetables",
                    icon: "fa-carrot",
                    color: "bg-green-500",
                    expires: "Weekend Special",
                    couponCode: "VEGGIE15"
                },
                {
                    id: 3,
                    title: "New User Bonus",
                    description: "â‚¹50 OFF on First Order",
                    icon: "fa-user-plus",
                    color: "bg-blue-500",
                    expires: "For New Customers",
                    couponCode: "WELCOME50"
                },
                {
                    id: 4,
                    title: "Free Delivery",
                    description: "No delivery charges on orders above â‚¹300",
                    icon: "fa-truck",
                    color: "bg-purple-500",
                    expires: "Ongoing",
                    couponCode: "FREEDEL"
                }*/
            ];

            // 3. HERO BANNER CONTENT (Change images and text)
            const HERO_BANNERS = [
                {
                    id: 1,
                    title: "Fresh Groceries",
                    subtitle: "Direct from farm to your home",
                    image: "https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80",
                    buttonText: "Shop Now",
                    buttonColor: "bg-accent",
                    textColor: "text-white"
                },
                {
                    id: 2,
                    title: "Daily Essentials",
                    subtitle: "Everything you need at best prices",
                    image: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80",
                    buttonText: "View Products",
                    buttonColor: "bg-primary",
                    textColor: "text-white"
                },
                {
                    id: 3,
                    title: "Special Discounts",
                    subtitle: "Upto 50% OFF on selected items",
                    image: "https://images.unsplash.com/photo-1607082350899-7e105aa886ae?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80",
                    buttonText: "View Offers",
                    buttonColor: "bg-success",
                    textColor: "text-white"
                }
            ];

            // 4. FEATURED CATEGORIES (Update based on your inventory)
            const FEATURED_CATEGORIES = [
                {
                    name: "Fresh Vegetables",
                    icon: "fa-leaf",
                    color: "text-green-500",
                    bgColor: "bg-green-50",
                    gradientClass: "cat-card-green",
                    productCount: 24
                },
                {
                    name: "Dairy Products",
                    icon: "fa-cow",
                    color: "text-blue-500",
                    bgColor: "bg-blue-50",
                    gradientClass: "cat-card-blue",
                    productCount: 18
                },
                {
                    name: "Bakery Items",
                    icon: "fa-bread-slice",
                    color: "text-yellow-500",
                    bgColor: "bg-yellow-50",
                    gradientClass: "cat-card-orange",
                    productCount: 12
                },
                {
                    name: "Beverages",
                    icon: "fa-wine-bottle",
                    color: "text-purple-500",
                    bgColor: "bg-purple-50",
                    gradientClass: "cat-card-purple",
                    productCount: 30
                },
                {
                    name: "Snacks",
                    icon: "fa-cookie",
                    color: "text-red-500",
                    bgColor: "bg-red-50",
                    gradientClass: "cat-card-red",
                    productCount: 25
                },
                {
                    name: "Household",
                    icon: "fa-home",
                    color: "text-indigo-500",
                    bgColor: "bg-indigo-50",
                    gradientClass: "cat-card-teal",
                    productCount: 20
                }
            ];

            // 5. TESTIMONIALS (Add customer reviews)
            const TESTIMONIALS = [
                {
                    id: 1,
                    name: "Kumar",
                    comment: "Best quality vegetables at reasonable prices. Delivery is always on time!",
                    rating: 5,
                    date: "2 days ago",
                    avatarColor: "bg-blue-400"
                },
                {
                    id: 2,
                    name: "Priya ",
                    comment: "Love their customer service.",
                    rating: 5,
                    date: "1 week ago",
                    avatarColor: "bg-pink-400"
                },
                {
                    id: 3,
                    name: "Arun",
                    comment: "Great customer service and amazing offers every weekend.",
                    rating: 4,
                    date: "3 days ago",
                    avatarColor: "bg-green-400"
                }
            ];

            // 6. STATISTICS (Update your store stats)
            const STORE_STATS = [
                { icon: 'fa-heart', label: 'Happy Families', value: '2000+', color: 'text-red-500' },
                { icon: 'fa-truck-ramp-box', label: 'Daily Orders', value: '150+', color: 'text-blue-500' },
                { icon: 'fa-leaf', label: 'Fresh Stock', value: '100%', color: 'text-green-500' },
                { icon: 'fa-star', label: 'Top Rated', value: '4.9/5', color: 'text-yellow-500' }
            ];

            // 7. TIME-BASED GREETING (Automatic - no need to change)
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Good Morning" : hour < 17 ? "Good Afternoon" : "Good Evening";
            const wishIcon = hour < 12 ? "fa-sun" : hour < 17 ? "fa-cloud-sun" : "fa-moon";

            // Get featured products (first 8 products or customize)
            const featuredProducts = products.slice(0, 8);

            // State for hero banner rotation
            const [currentBanner, setCurrentBanner] = useState(0);
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);

            // Auto rotate banners every 5 seconds
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentBanner((prev) => (prev + 1) % HERO_BANNERS.length);
                }, 5000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="p-3 md:p-4 max-w-7xl mx-auto space-y-6 md:space-y-8 animate-fade-in pb-20 md:pb-4">

                    {/* =========================================== */}
                    {/* 0. FESTIVAL BANNER (if any active) */}
                    {/* =========================================== */}
                    <FestivalBanner banners={banners} setView={setView} />

                    {/* =========================================== */}
                    {/* 1. WHATSAPP FLOATING BUTTON */}
                    {/* =========================================== */}
                    <a
                        href="https://chat.whatsapp.com/FSSfwe6Rd5CDxlmgVffeEI"
                        target="_blank"
                        rel="noopener noreferrer"
                        className="fixed bottom-20 md:bottom-6 right-4 md:right-6 z-40 bg-[#25D366] text-white w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition-transform animate-bounce-slow"
                        title="Join our WhatsApp Group"
                    >
                        <i className="fa-brands fa-whatsapp text-2xl md:text-3xl"></i>
                    </a>

                    {/* =========================================== */}
                    {/* 2. PERSONALIZED WELCOME BAR */}
                    {/* =========================================== */}
                    <div className="relative overflow-hidden p-4 md:p-4 rounded-2xl flex flex-col md:flex-row items-start md:items-center justify-between border border-white/50 shadow-lg md:shadow-inner"
                        style={{ background: 'linear-gradient(135deg,#0F2744 0%,#153A60 60%,#1e6a3f 100%)' }}>
                        {/* Decorative blobs for mobile */}
                        <div className="absolute -top-6 -right-6 w-24 h-24 rounded-full opacity-20 md:hidden" style={{ background: 'radial-gradient(circle,#FFD700,transparent)' }}></div>
                        <div className="absolute -bottom-4 right-16 w-16 h-16 rounded-full opacity-15 md:hidden" style={{ background: 'radial-gradient(circle,#FF7F50,transparent)' }}></div>

                        <div className="flex items-center gap-3">
                            <div className="w-11 h-11 rounded-2xl flex items-center justify-center shadow-lg flex-shrink-0"
                                style={{ background: 'linear-gradient(135deg,#FFD700,#FFA500)' }}>
                                <i className={`fa-solid ${wishIcon} text-primary-dark text-xl animate-spin-slow`}></i>
                            </div>
                            <div>
                                <h2 className="text-lg md:text-xl font-black text-white">
                                    {greeting}! <span className="gradient-text-orange">Welcome to {STORE_CONFIG.name}</span>
                                </h2>
                                <p className="text-xs text-white/60 font-medium italic">"{STORE_CONFIG.tagline}"</p>
                            </div>
                        </div>
                        <div className="mt-3 md:mt-0 flex items-center gap-2 bg-white/10 backdrop-blur-sm px-4 py-2 rounded-full border border-white/20">
                            <i className="fa-solid fa-clock text-accent"></i>
                            <span className="text-sm font-bold text-white">{STORE_CONFIG.openingHours}</span>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 3. DELIVERY POLICY NOTICE */}
                    {/* =========================================== */}
                    <div className="relative overflow-hidden rounded-2xl p-4 shadow-md card-press"
                        style={{ background: 'linear-gradient(135deg,#FA8231,#FFC200)' }}>
                        <div className="absolute -right-4 -top-4 w-20 h-20 bg-white/10 rounded-full pointer-events-none"></div>
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <i className="fa-solid fa-truck-fast text-white text-lg"></i>
                                </div>
                                <div>
                                    <h3 className="font-black text-white">ðŸšš Free Delivery Available!</h3>
                                    <p className="text-xs text-white/80">
                                        Min order â‚¹{DELIVERY_POLICY.minimumOrder} â€¢ Free in select areas
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="bg-white text-orange-600 px-4 py-2 rounded-xl font-bold text-sm hover:bg-orange-50 transition whitespace-nowrap shadow-md"
                            >
                                <i className="fa-solid fa-map-location-dot mr-1.5"></i>
                                View Areas
                            </button>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 4. HERO BANNER CAROUSEL */}
                    {/* =========================================== */}
                    <div className="relative rounded-3xl overflow-hidden shadow-2xl h-64 md:h-96">
                        {/* Banner Images */}
                        {HERO_BANNERS.map((banner, index) => (
                            <div
                                key={banner.id}
                                className={`absolute inset-0 transition-opacity duration-1000 ${index === currentBanner ? 'opacity-100' : 'opacity-0'}`}
                            >
                                <div
                                    className="absolute inset-0 bg-cover bg-center"
                                    style={{ backgroundImage: `url(${banner.image})` }}
                                >
                                    <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-transparent"></div>
                                </div>

                                <div className="relative z-10 h-full flex items-center p-8 md:p-16">
                                    <div className="max-w-xl">
                                        <div className="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-1 rounded-full border border-white/30 mb-4">
                                            <span className="relative flex h-2 w-2">
                                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-accent"></span>
                                            </span>
                                            <span className="text-sm font-bold uppercase tracking-widest text-white">Featured Offer</span>
                                        </div>

                                        <h1 className={`text-4xl md:text-6xl font-black tracking-tighter leading-tight mb-4 ${banner.textColor}`}>
                                            {banner.title}
                                        </h1>

                                        <p className={`text-xl mb-6 ${banner.textColor}`}>
                                            {banner.subtitle}
                                        </p>

                                        <button
                                            onClick={() => setView('products')}
                                            className={`${banner.buttonColor} text-white px-8 py-3 rounded-xl font-bold text-lg hover:shadow-lg transition-all flex items-center gap-3`}
                                        >
                                            {banner.buttonText}
                                            <i className="fa-solid fa-arrow-right group-hover:translate-x-2 transition-transform"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}

                        {/* Banner Indicators */}
                        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                            {HERO_BANNERS.map((_, index) => (
                                <button
                                    key={index}
                                    onClick={() => setCurrentBanner(index)}
                                    className={`w-3 h-3 rounded-full transition-all ${index === currentBanner ? 'bg-white w-8' : 'bg-white/50 hover:bg-white/80'}`}
                                    aria-label={`Go to slide ${index + 1}`}
                                />
                            ))}
                        </div>

                        {/* Navigation Arrows */}
                        <button
                            onClick={() => setCurrentBanner((prev) => (prev - 1 + HERO_BANNERS.length) % HERO_BANNERS.length)}
                            className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition"
                        >
                            <i className="fa-solid fa-chevron-left"></i>
                        </button>
                        <button
                            onClick={() => setCurrentBanner((prev) => (prev + 1) % HERO_BANNERS.length)}
                            className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition"
                        >
                            <i className="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>

                    {/* =========================================== */}
                    {/* 5. QUICK OFFERS GRID */}
                    {/* =========================================== */}
                    <div>
                        <div className="flex items-center justify-between mb-4 md:mb-6">
                            <h2 className="text-xl md:text-3xl font-black text-primary-dark">
                                <span className="md:hidden">ðŸ”¥ Today's Offers</span>
                                <span className="hidden md:inline">Today's Best Offers</span>
                            </h2>
                            <button
                                onClick={() => setView('products')}
                                className="text-accent hover:text-accent-hover font-semibold flex items-center gap-1 text-sm md:text-base"
                            >
                                View All <i className="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                            {CURRENT_OFFERS.map((offer) => (
                                <div
                                    key={offer.id}
                                    className="bg-white rounded-2xl p-4 md:p-5 shadow-lg border border-gray-100 hover:shadow-xl transition-all duration-300 card-press"
                                >
                                    <div className="flex items-start justify-between mb-3">
                                        <div className={`${offer.color} text-white p-3 rounded-xl`}>
                                            <i className={`fa-solid ${offer.icon} text-xl`}></i>
                                        </div>
                                        <span className="text-xs font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                            {offer.expires}
                                        </span>
                                    </div>

                                    <h3 className="font-bold text-lg text-gray-800 mb-2">{offer.title}</h3>
                                    <p className="text-gray-600 mb-4">{offer.description}</p>

                                    {offer.couponCode && (
                                        <div className="flex items-center justify-between mt-4 pt-4 border-t">
                                            <span className="text-sm font-semibold text-gray-500">Use Code:</span>
                                            <span className="font-mono font-bold bg-gray-100 text-primary-dark px-3 py-1 rounded">
                                                {offer.couponCode}
                                            </span>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 6. STORE STATISTICS */}
                    {/* =========================================== */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                        {STORE_STATS.map((stat, index) => {
                            const gradients = [
                                'linear-gradient(135deg,#FF416C,#FF4B2B)',
                                'linear-gradient(135deg,#4FACFE,#00F2FE)',
                                'linear-gradient(135deg,#43E97B,#38F9D7)',
                                'linear-gradient(135deg,#FA8231,#FFC200)'
                            ];
                            return (
                                <div key={index} className="card-press relative overflow-hidden p-5 rounded-2xl text-center group shadow-lg"
                                    style={{ background: gradients[index] }}>
                                    <div className="absolute -top-4 -right-4 w-16 h-16 bg-white/10 rounded-full"></div>
                                    <div className="absolute -bottom-3 -left-3 w-12 h-12 bg-white/10 rounded-full"></div>
                                    <div className="relative z-10">
                                        <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mx-auto mb-2 group-hover:scale-110 transition-transform">
                                            <i className={`fa-solid ${stat.icon} text-white text-lg`}></i>
                                        </div>
                                        <h4 className="text-2xl font-black text-white">{stat.value}</h4>
                                        <p className="text-xs font-bold text-white/80 uppercase tracking-tighter mt-0.5">{stat.label}</p>
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* =========================================== */}
                    {/* 7. SHOP BY CATEGORY */}
                    {/* =========================================== */}
                    <div>
                        <div className="flex items-center justify-center gap-2 mb-6">
                            <h2 className="text-2xl md:text-3xl font-black text-primary-dark text-center">
                                <span className="md:hidden">
                                    <span className="gradient-text-orange">Shop</span> By Category
                                </span>
                                <span className="hidden md:inline">Shop By Category</span>
                            </h2>
                        </div>

                        <div className="grid grid-cols-3 sm:grid-cols-3 md:grid-cols-6 gap-3 md:gap-4">
                            {FEATURED_CATEGORIES.map((category, index) => (
                                <div
                                    key={index}
                                    onClick={() => setView('products')}
                                    className={`${category.gradientClass} card-press relative overflow-hidden p-3 md:p-4 rounded-2xl text-center cursor-pointer hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 group`}
                                >
                                    {/* Decorative circles */}
                                    <div className="absolute -top-3 -right-3 w-12 h-12 bg-white/10 rounded-full pointer-events-none"></div>
                                    <div className="absolute -bottom-2 -left-2 w-10 h-10 bg-white/10 rounded-full pointer-events-none"></div>

                                    <div className="relative z-10">
                                        <div className="w-12 h-12 md:w-14 md:h-14 bg-white/25 backdrop-blur-sm rounded-xl md:rounded-2xl flex items-center justify-center mx-auto mb-2 md:mb-3 group-hover:scale-110 transition-transform duration-300 shadow-lg">
                                            <i className={`fa-solid ${category.icon} text-white text-xl md:text-2xl`}></i>
                                        </div>
                                        <h3 className="font-bold text-white text-xs md:text-sm leading-tight">{category.name}</h3>
                                        <div className="mt-1.5 inline-flex items-center bg-white/20 rounded-full px-2 py-0.5">
                                            <span className="text-[9px] md:text-[10px] font-bold text-white">{category.productCount} items</span>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 8. FEATURED PRODUCTS */}
                    {/* =========================================== */}
                    <div className="space-y-5 md:space-y-8">
                        <div className="flex flex-col items-center gap-2">
                            <h2 className="text-2xl md:text-3xl font-black text-primary-dark uppercase">
                                <span className="md:hidden gradient-text-orange">âš¡ Hot Picks</span>
                                <span className="hidden md:inline">Our Products</span>
                            </h2>
                            <div className="w-24 h-1.5 rounded-full" style={{ background: 'linear-gradient(90deg,#FF7F50,#FFD700,#FF6347)' }}></div>
                            <p className="text-gray-500 text-sm md:text-base text-center">Handpicked fresh items just for you</p>
                        </div>

                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 md:gap-6">
                            {featuredProducts.map(product => (
                                <div key={product.id} className="transform hover:-translate-y-2 transition-transform duration-300">
                                    <ProductCard
                                        product={product}
                                        setSelectedProduct={setSelectedProduct}
                                        onQuickAddToCart={onQuickAddToCart}
                                    />
                                </div>
                            ))}
                        </div>

                        <div className="text-center">
                            <button
                                onClick={() => setView('products')}
                                className="card-press inline-flex items-center gap-2 text-primary-dark px-8 py-3 rounded-2xl font-black text-base md:text-lg shadow-lg transition-all"
                                style={{ background: 'linear-gradient(135deg,#FFD700,#FFA500)', boxShadow: '0 6px 24px rgba(255,165,0,0.45)' }}
                            >
                                <i className="fa-solid fa-basket-shopping"></i>
                                View All Products ({products.length})
                                <i className="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 9. CUSTOMER TESTIMONIALS */}
                    {/* =========================================== */}
                    <div className="relative overflow-hidden p-5 md:p-8 rounded-3xl"
                        style={{ background: 'linear-gradient(135deg,#0F2744 0%,#153A60 100%)' }}>
                        <div className="absolute top-0 right-0 w-40 h-40 rounded-full opacity-10" style={{ background: 'radial-gradient(circle,#FFD700,transparent)' }}></div>
                        <div className="absolute bottom-0 left-0 w-32 h-32 rounded-full opacity-10" style={{ background: 'radial-gradient(circle,#FF7F50,transparent)' }}></div>

                        <div className="relative z-10">
                            <h2 className="text-xl md:text-3xl font-black text-white mb-6 md:mb-8 text-center">
                                â­ <span className="gradient-text-orange">Customer Love</span>
                            </h2>

                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                {TESTIMONIALS.map(testimonial => (
                                    <div key={testimonial.id} className="bg-white/10 backdrop-blur-sm border border-white/20 p-5 rounded-2xl card-press">
                                        <div className="flex items-center mb-3">
                                            <div className={`${testimonial.avatarColor} w-11 h-11 rounded-xl flex items-center justify-center text-white font-black text-lg mr-3 shadow-lg`}>
                                                {testimonial.name.charAt(0)}
                                            </div>
                                            <div>
                                                <h4 className="font-bold text-white">{testimonial.name}</h4>
                                                <div className="flex">
                                                    {[...Array(5)].map((_, i) => (
                                                        <i
                                                            key={i}
                                                            className={`fa-solid fa-star text-xs ${i < testimonial.rating ? 'text-yellow-400' : 'text-white/20'}`}
                                                        ></i>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        <p className="text-white/80 text-sm italic mb-3">"{testimonial.comment}"</p>

                                        <div className="text-[10px] text-white/40 flex justify-between items-center">
                                            <span>{testimonial.date}</span>
                                            <i className="fa-solid fa-quote-right text-white/20"></i>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 10. STORE INFO & CONTACT */}
                    {/* =========================================== */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Store Info */}
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center">
                                <i className="fa-solid fa-store mr-2 text-accent"></i> Store Information
                            </h3>
                            <ul className="space-y-3">
                                <li className="flex items-center">
                                    <i className="fa-solid fa-clock text-gray-400 w-5 mr-3"></i>
                                    <span className="text-gray-700">{STORE_CONFIG.openingHours}</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-phone text-gray-400 w-5 mr-3"></i>
                                    <span className="text-gray-700">{STORE_CONFIG.phone}</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-location-dot text-gray-400 w-5 mr-3"></i>
                                    <span className="text-gray-700">{STORE_CONFIG.address}</span>
                                </li>
                            </ul>
                        </div>

                        {/* Why Choose Us */}
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center">
                                <i className="fa-solid fa-award mr-2 text-accent"></i> Why Choose Us
                            </h3>
                            <ul className="space-y-3">
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">100% Fresh Products</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">Free Home Delivery</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">Easy Returns & Refunds</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">24/7 Customer Support</span>
                                </li>
                            </ul>
                        </div>

                        {/* Quick Links */}
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center">
                                <i className="fa-solid fa-link mr-2 text-accent"></i> Quick Links
                            </h3>
                            <ul className="space-y-3">
                                <li>
                                    <button
                                        onClick={() => setView('products')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Browse All Products
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('grocerylist')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Send Grocery List
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('support')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Contact Support
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('orders')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Track Your Order
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('profile')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        My Account
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 11. FINAL GREETING & SOCIAL PROOF */}
                    {/* =========================================== */}
                    <div className="text-center py-10 bg-primary-dark rounded-[2rem] text-white overflow-hidden relative">
                        <div className="relative z-10">
                            <h3 className="text-2xl font-bold mb-4">Thank you for visiting {STORE_CONFIG.name}!</h3>
                            <p className="text-gray-300 mb-6 max-w-2xl mx-auto">
                                We're committed to providing you with the freshest groceries and best shopping experience.
                                Your satisfaction is our priority!
                            </p>

                            <div className="flex justify-center gap-4 text-2xl">
                                <a href="#" className="text-white hover:text-accent transition">
                                    <i className="fa-brands fa-facebook"></i>
                                </a>
                                <a href="#" className="text-white hover:text-accent transition">
                                    <i className="fa-brands fa-instagram"></i>
                                </a>
                                <a href="#" className="text-white hover:text-accent transition">
                                    <i className="fa-brands fa-twitter"></i>
                                </a>
                                <a
                                    href="https://chat.whatsapp.com/FZNXhC5nbbyGBWJPRlleUI"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-white hover:text-green-400 transition"
                                >
                                    <i className="fa-brands fa-whatsapp"></i>
                                </a>
                            </div>

                            <div className="mt-6 flex justify-center gap-4">
                                <i className="fa-solid fa-heart text-red-400 animate-pulse-slow"></i>
                                <i className="fa-solid fa-heart text-red-400 animate-pulse-slow delay-75"></i>
                                <i className="fa-solid fa-heart text-red-400 animate-pulse-slow delay-150"></i>
                            </div>
                        </div>

                        {/* Background Glow Effect */}
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-accent/5 blur-[120px]"></div>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 5. PRODUCT CARD COMPONENT
        // =======================================================

        const ProductCard = ({ product, setSelectedProduct, onQuickAddToCart }) => {
            const [adding, setAdding] = React.useState(false);

            const handleQuickAdd = (e) => {
                e.stopPropagation();
                setAdding(true);
                onQuickAddToCart(product, 1);
                setTimeout(() => setAdding(false), 700);
            };

            const isLowStock = product.stock !== undefined && Number(product.stock) <= 5 && Number(product.stock) > 0;
            const isOutOfStock = product.stock !== undefined && Number(product.stock) === 0;

            return (
                <>
                {/* â”€â”€ MOBILE CARD â”€â”€ */}
                <div
                    className="product-card-mobile card-shine md:hidden flex flex-col"
                    onClick={() => setSelectedProduct(product)}
                >
                    {/* Image area */}
                    <div className="product-img-bg mx-3 mt-3 mb-2 rounded-2xl relative overflow-hidden" style={{ height: '110px' }}>
                        <img
                            src={product.image || 'https://placehold.co/200x150?text=No+Image'}
                            alt={product.name}
                            className="w-full h-full object-contain"
                            style={{ zIndex: 1, position: 'relative' }}
                        />
                        {/* Stock badges */}
                        {isOutOfStock && (
                            <div className="absolute top-1 left-1 bg-red-500 text-white text-[9px] font-black px-2 py-0.5 rounded-full">OUT OF STOCK</div>
                        )}
                        {isLowStock && !isOutOfStock && (
                            <div className="absolute top-1 left-1 bg-orange-400 text-white text-[9px] font-black px-2 py-0.5 rounded-full">ONLY {product.stock} LEFT</div>
                        )}
                    </div>

                    {/* Info area */}
                    <div className="px-3 pb-1 flex-1">
                        <p className="text-[10px] font-bold text-gray-400 uppercase tracking-wider mb-0.5">{product.category}</p>
                        <h3 className="text-sm font-extrabold text-gray-900 line-clamp-2 leading-tight mb-1">{product.name}</h3>
                        <span className="price-tag-mobile">{formatCurrency(product.price)}</span>
                    </div>

                    {/* Add button */}
                    <div className="px-3 pb-3 pt-2">
                        <button
                            onClick={handleQuickAdd}
                            disabled={isOutOfStock}
                            className="add-to-cart-btn-mobile ripple-btn flex items-center justify-center gap-1.5 disabled:opacity-50"
                        >
                            {adding ? (
                                <><i className="fa-solid fa-check"></i> Added!</>
                            ) : (
                                <><i className="fa-solid fa-cart-plus"></i> Add to Cart</>
                            )}
                        </button>
                    </div>
                </div>

                {/* â”€â”€ DESKTOP CARD (unchanged) â”€â”€ */}
                <div className="hidden md:flex bg-white border p-4 rounded-xl shadow hover:shadow-lg transition duration-300 cursor-pointer flex-col justify-between transform hover:scale-[1.02] relative group" onClick={() => setSelectedProduct(product)}>
                    <img src={product.image || 'https://placehold.co/200x150?text=No+Image'} alt={product.name} className="w-full h-32 object-contain mb-3 rounded-md bg-gray-50" />
                    <div className="flex-1">
                        <h3 className="text-md font-semibold mb-1 line-clamp-2 text-primary-dark leading-tight">{product.name}</h3>
                        <p className="text-xs text-gray-500 mb-2">{product.category}</p>
                        <p className="text-xl font-extrabold text-danger">{formatCurrency(product.price)}</p>
                    </div>
                    <button onClick={handleQuickAdd} className="flex absolute bottom-4 right-4 bg-accent text-primary-dark p-2 rounded-full shadow-lg hover:bg-accent-hover transition transform translate-x-12 group-hover:translate-x-0 opacity-0 group-hover:opacity-100 ease-in-out duration-300 items-center justify-center">
                        <i className="fa-solid fa-cart-plus text-lg"></i>
                    </button>
                </div>
                </>
            );
        };

        // =======================================================
        // 6. PRODUCTS VIEW
        // =======================================================

        const ProductsView = ({ products, setSelectedProduct, onQuickAddToCart }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [sortOption, setSortOption] = useState('name-asc');
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);
            const categories = useMemo(() => ['All', ...new Set(products.map(p => p.category))], [products]);

            const filteredProducts = useMemo(() => {
                let filtered = products.filter(p =>
                    p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.description.toLowerCase().includes(searchTerm.toLowerCase())
                );
                if (selectedCategory !== 'All') filtered = filtered.filter(p => p.category === selectedCategory);

                return filtered.sort((a, b) => {
                    const priceA = parseFloat(a.price) || 0;
                    const priceB = parseFloat(b.price) || 0;

                    if (sortOption === 'price-asc') return priceA - priceB;
                    if (sortOption === 'price-desc') return priceB - priceA;
                    return sortOption === 'name-asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                });
            }, [products, searchTerm, selectedCategory, sortOption]);

            return (
                <div className="p-3 md:p-4 max-w-7xl mx-auto pb-20 md:pb-4">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 md:mb-6 gap-3">
                        <h1 className="text-2xl md:text-3xl font-bold text-primary-dark">
                            <i className="fa-solid fa-cubes mr-2 text-primary"></i>
                            Products <span className="text-lg text-gray-500">({filteredProducts.length})</span>
                        </h1>
                        <button
                            onClick={() => setShowDeliveryModal(true)}
                            className="bg-accent text-primary-dark px-4 py-2 rounded-lg font-semibold hover:bg-accent-hover transition flex items-center justify-center touch-target"
                        >
                            <i className="fa-solid fa-truck-fast mr-2"></i>
                            Delivery Areas
                        </button>
                    </div>

                    {/* Search and Filter - Mobile Optimized */}
                    <div className="bg-white p-3 md:p-4 rounded-xl shadow-md mb-4 md:mb-6 border border-gray-100">
                        <div className="relative mb-3">
                            <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input
                                type="text"
                                placeholder="Search products..."
                                className="text-input-style pl-10"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-2 md:gap-4">
                            <div>
                                <label className="text-xs font-semibold mb-1 block text-gray-600">Category</label>
                                <select className="text-input-style text-sm" value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)}>
                                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-semibold mb-1 block text-gray-600">Sort</label>
                                <select className="text-input-style text-sm" value={sortOption} onChange={(e) => setSortOption(e.target.value)}>
                                    <option value="name-asc">A-Z</option>
                                    <option value="name-desc">Z-A</option>
                                    <option value="price-asc">Price â†‘</option>
                                    <option value="price-desc">Price â†“</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Delivery Notice */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center">
                            <i className="fa-solid fa-info-circle text-blue-500 text-xl mr-3"></i>
                            <div>
                                <p className="font-semibold text-gray-800">Minimum Order: â‚¹{DELIVERY_POLICY.minimumOrder}</p>
                                <p className="text-sm text-gray-600">Add more items to reach the minimum order requirement for delivery.</p>
                            </div>
                        </div>
                    </div>

                    {filteredProducts.length === 0 ? <div className="text-center py-10 text-xl text-gray-500"><i className="fa-solid fa-face-frown mr-2"></i> No products found matching your criteria.</div> :
                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                            {filteredProducts.map(p => <ProductCard key={p.id} product={p} setSelectedProduct={setSelectedProduct} onQuickAddToCart={onQuickAddToCart} />)}
                        </div>
                    }

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 7. PRODUCT DETAIL MODAL
        // =======================================================

        const ProductDetailModal = ({ product, onClose, onAddToCart }) => {
            if (!product) return null;
            const [quantity, setQuantity] = useState(1);
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-end md:items-center p-0 md:p-4" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <div className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4">
                                <h2 className="text-3xl font-bold text-primary-dark">{product.name}</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-danger transition"><i className="fa-solid fa-xmark text-2xl"></i></button>
                            </div>
                            <div className="md:flex gap-8">
                                <div className="md:w-1/2">
                                    <img src={product.image || 'https://placehold.co/400x300?text=No+Image'} className="w-full h-80 object-contain mb-4 border-4 border-gray-100 p-4 rounded-lg bg-white" />
                                    <h3 className="text-xl font-bold mb-2 text-primary">Description</h3>
                                    <p className="text-sm text-gray-700 leading-relaxed">{product.description || "No detailed description available for this product."}</p>
                                </div>
                                <div className="md:w-1/2 bg-gray-50 p-6 rounded-xl border border-primary/10 mt-6 md:mt-0">
                                    <p className="text-xl text-gray-600 mb-2">Category: <span className="font-semibold text-primary">{product.category}</span></p>
                                    <p className="text-3xl font-extrabold text-danger my-4">Price: {formatCurrency(product.price)}</p>

                                    <div className="flex items-center space-x-4 my-6">
                                        <label className="font-bold text-lg">Quantity:</label>
                                        <input type="number" min="1" value={quantity} onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))} className="w-20 text-center border-2 border-primary/50 rounded-lg p-2 font-semibold text-primary-dark" />
                                    </div>
                                    <button onClick={() => { onAddToCart(product, quantity); setQuantity(1); }} className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold text-lg hover:bg-accent-hover transition shadow-md">
                                        <i className="fa-solid fa-cart-plus mr-2"></i> Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 8. CART VIEW
        // =======================================================

        const CartView = ({ cart, setCart, setView, showToast }) => {
            const subtotal = cart.reduce((sum, item) => sum + parseFloat(item.price) * item.quantity, 0);
            const hasMinimum = subtotal >= DELIVERY_POLICY.minimumOrder;
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);

            const updateQuantity = (id, newQty) => {
                if (newQty <= 0) {
                    setCart(cart.filter(item => item.id !== id));
                    showToast('Item removed.', 'warning');
                } else {
                    setCart(cart.map(item => item.id === id ? { ...item, quantity: newQty } : item));
                }
            };

            if (cart.length === 0) return (
                <div className="text-center py-16 md:py-20 px-4 pb-24 md:pb-20">
                    <i className="fa-solid fa-cart-arrow-down fa-4x md:fa-5x text-primary/30 mb-4 md:mb-6"></i>
                    <h1 className="text-2xl md:text-3xl font-bold text-primary-dark">Your Cart is Empty!</h1>
                    <p className="text-gray-600 mt-2 mb-4 md:mb-6">Time to fill it with awesome products.</p>
                    <button
                        onClick={() => setView('home')}
                        className="bg-primary text-white px-6 md:px-8 py-3 rounded-lg font-bold text-base md:text-lg hover:bg-primary-dark transition shadow-lg touch-target"
                    >
                        <i className="fa-solid fa-arrow-left mr-2"></i> Back to Home
                    </button>
                </div>
            );

            return (
                <div className="p-3 md:p-4 max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 pb-24 md:pb-4">
                    {/* Left Column: Cart Items */}
                    <div className="lg:col-span-2 space-y-3 md:space-y-4">
                        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2 md:mb-4">
                            <h1 className="text-xl md:text-3xl font-bold text-primary-dark flex items-center">
                                <i className="fa-solid fa-cart-shopping mr-2 text-primary"></i>
                                Cart <span className="text-base md:text-xl text-gray-500 ml-2">({cart.length})</span>
                            </h1>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="text-sm text-primary hover:text-primary-dark font-semibold flex items-center bg-primary/10 px-3 py-1.5 rounded-lg self-start sm:self-auto"
                            >
                                <i className="fa-solid fa-map-location-dot mr-1"></i>
                                Delivery Areas
                            </button>
                        </div>

                        {/* Minimum Order Progress Bar */}
                        <MinimumOrderProgress currentAmount={subtotal} />

                        {cart.map(item => (
                            <div key={item.id} className="flex flex-col sm:flex-row p-4 border-2 border-gray-100 rounded-xl bg-white shadow-md hover:shadow-lg transition gap-4">

                                {/* Product Image */}
                                <div className="flex-shrink-0 flex justify-center items-start">
                                    <img
                                        src={item.image || 'https://placehold.co/100x100?text=No+Image'}
                                        className="w-24 h-24 object-contain border rounded-lg p-1 bg-white"
                                        alt={item.name}
                                    />
                                </div>

                                {/* Product Details */}
                                <div className="flex-grow min-w-0">
                                    <h2 className="text-lg font-bold text-primary-dark line-clamp-2 break-words leading-tight">
                                        {item.name}
                                    </h2>
                                    <p className="text-xl text-danger font-extrabold my-1">
                                        {formatCurrency(parseFloat(item.price) * item.quantity)}
                                    </p>
                                    <p className="text-xs text-gray-500">
                                        Unit Price: {formatCurrency(item.price)}
                                    </p>
                                </div>

                                {/* Actions */}
                                <div className="flex flex-row sm:flex-col items-center sm:items-end justify-between sm:justify-between border-t sm:border-t-0 pt-3 sm:pt-0">
                                    <div className="flex items-center space-x-2 bg-gray-100 rounded-full p-1">
                                        <button
                                            onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                            className="bg-primary text-white w-8 h-8 rounded-full hover:bg-primary-dark transition flex items-center justify-center"
                                        >
                                            <i className="fa-solid fa-minus text-xs"></i>
                                        </button>
                                        <span className="w-8 text-center font-bold text-lg">{item.quantity}</span>
                                        <button
                                            onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                            className="bg-primary text-white w-8 h-8 rounded-full hover:bg-primary-dark transition flex items-center justify-center"
                                        >
                                            <i className="fa-solid fa-plus text-xs"></i>
                                        </button>
                                    </div>

                                    <button
                                        onClick={() => updateQuantity(item.id, 0)}
                                        className="text-danger hover:underline text-sm font-semibold mt-0 sm:mt-2"
                                    >
                                        <i className="fa-solid fa-trash-can mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        ))}

                        {/* Continue Shopping Button */}
                        <div className="flex justify-between items-center pt-4">
                            <button
                                onClick={() => setView('products')}
                                className="bg-gray-100 text-gray-800 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition"
                            >
                                <i className="fa-solid fa-arrow-left mr-2"></i>
                                Continue Shopping
                            </button>

                            {!hasMinimum && (
                                <div className="text-right">
                                    <p className="text-sm text-gray-600">Need {formatCurrency(DELIVERY_POLICY.minimumOrder - subtotal)} more</p>
                                    <p className="text-xs text-gray-500">to reach minimum order</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Right Column: Summary */}
                    <div className="lg:col-span-1">
                        <div className="sticky top-4 p-6 bg-white rounded-xl shadow-vibrant border-2 border-primary/20">
                            <h2 className="text-2xl font-bold text-primary mb-4 border-b pb-2">Order Summary</h2>
                            <div className="flex justify-between text-xl font-bold mb-4">
                                <span>Subtotal:</span>
                                <span className="text-danger">{formatCurrency(subtotal)}</span>
                            </div>

                            {/* Minimum Order Warning */}
                            {!hasMinimum ? (
                                <div className="bg-red-50 text-red-700 p-3 rounded-lg mb-4 border border-red-200">
                                    <div className="flex items-center">
                                        <i className="fa-solid fa-exclamation-triangle mr-2"></i>
                                        <div>
                                            <p className="font-bold">Minimum Order Not Met</p>
                                            <p className="text-sm">Add {formatCurrency(DELIVERY_POLICY.minimumOrder - subtotal)} more to checkout</p>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-green-50 text-green-700 p-3 rounded-lg mb-4 border border-green-200">
                                    <div className="flex items-center">
                                        <i className="fa-solid fa-check-circle mr-2"></i>
                                        <div>
                                            <p className="font-bold">Minimum Order Achieved!</p>
                                            <p className="text-sm">You can proceed to checkout</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <p className="text-sm text-gray-500 mb-6 flex items-center">
                                <i className="fa-solid fa-truck-fast mr-2 text-success"></i>
                                Free shipping on all orders above â‚¹{DELIVERY_POLICY.freeDeliveryAbove}!
                            </p>

                            <button
                                onClick={() => setView('checkout')}
                                disabled={!hasMinimum}
                                className={`w-full p-3 rounded-lg font-bold text-lg shadow-md transition transform active:scale-95 ${hasMinimum ? 'bg-accent text-primary-dark hover:bg-accent-hover' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                            >
                                {hasMinimum ? 'Proceed to Checkout' : 'Add More Items to Checkout'}
                            </button>

                            {!hasMinimum && (
                                <button
                                    onClick={() => setView('products')}
                                    className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition mt-3"
                                >
                                    <i className="fa-solid fa-cart-plus mr-2"></i>
                                    Continue Shopping
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 9. UPI PAYMENT COMPONENTS
        // =======================================================

        const UpiPaymentView = ({ finalTotal, upiId, orderId, onPaymentComplete, onBack, showToast }) => {
            const [selectedApp, setSelectedApp] = useState(null);
            const [paymentStatus, setPaymentStatus] = useState('pending');
            const [transactionId, setTransactionId] = useState('');
            const [isVerifying, setIsVerifying] = useState(false);

            const upiPaymentLink = `upi://pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}&cu=INR`;
            const qrCodeUrl = `${UPI_CONFIG.qrCodeBase}${encodeURIComponent(upiPaymentLink)}`;

            const handleCopyUpiId = () => {
                navigator.clipboard.writeText(upiId).then(() => {
                    showToast('UPI ID copied to clipboard!', 'success');
                });
            };

            const handleCopyPaymentLink = () => {
                navigator.clipboard.writeText(upiPaymentLink).then(() => {
                    showToast('Payment link copied!', 'success');
                });
            };

            const handleOpenPaymentApp = (app) => {
                setSelectedApp(app.id);

                let deepLink = '';
                switch(app.id) {
                    case 'gpay':
                        deepLink = `tez://upi/pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}`;
                        break;
                    case 'phonepe':
                        deepLink = `phonepe://upi/pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}`;
                        break;
                    case 'paytm':
                        deepLink = `paytmmp://upi/pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}`;
                        break;
                    case 'whatsapp':
                        deepLink = `whatsapp://send?text=Please%20pay%20â‚¹${finalTotal}%20to%20${upiId}%20for%20Order%20${orderId}`;
                        break;
                    default:
                        deepLink = upiPaymentLink;
                }

                window.location.href = deepLink;

                setTimeout(() => {
                    window.location.href = upiPaymentLink;
                }, 1000);

                showToast(`Opening ${app.name}...`, 'info');
            };

            const handleVerifyPayment = async () => {
                if (!transactionId.trim()) {
                    showToast('Please enter transaction ID', 'error');
                    return;
                }

                setIsVerifying(true);
                setPaymentStatus('processing');

                setTimeout(() => {
                    setIsVerifying(false);
                    setPaymentStatus('completed');
                    showToast('Payment verified successfully!', 'success');

                    setTimeout(() => {
                        onPaymentComplete(transactionId);
                    }, 1500);
                }, 2000);
            };

            const handleManualVerification = () => {
                setPaymentStatus('completed');
                onPaymentComplete('MANUAL-' + Date.now().toString().slice(-8));
            };

            return (
                <div className="p-4 max-w-4xl mx-auto">
                    <div className="mb-6">
                        <button onClick={onBack} className="text-primary hover:text-primary-dark font-semibold mb-4 flex items-center">
                            <i className="fa-solid fa-arrow-left mr-2"></i> Back to Checkout
                        </button>
                        <h1 className="text-3xl font-bold text-primary-dark">UPI Payment</h1>
                        <p className="text-gray-600 mt-2">Complete your payment using any UPI app</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Left Column - Payment Details */}
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4">Payment Details</h2>

                                <div className="space-y-4">
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Order ID:</span>
                                        <span className="font-semibold">#{orderId}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Amount to Pay:</span>
                                        <span className="text-2xl font-bold text-danger">{formatCurrency(finalTotal)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">UPI ID:</span>
                                        <div className="flex items-center">
                                            <span className="font-mono font-bold text-upi">{upiId}</span>
                                            <button onClick={handleCopyUpiId} className="ml-2 text-upi hover:text-upi-dark">
                                                <i className="fa-solid fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Payment Apps */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4">Open Payment App</h2>
                                <p className="text-sm text-gray-600 mb-4">Click your preferred app to open and pay</p>

                                <div className="grid grid-cols-2 gap-3">
                                    {UPI_CONFIG.paymentApps.map(app => (
                                        <button
                                            key={app.id}
                                            onClick={() => handleOpenPaymentApp(app)}
                                            className={`payment-app-btn p-3 rounded-lg flex flex-col items-center justify-center ${selectedApp === app.id ? 'active' : ''} ${app.color}`}
                                        >
                                            <i className={`${app.icon} text-2xl mb-2`}></i>
                                            <span className="text-sm font-semibold">{app.name}</span>
                                        </button>
                                    ))}
                                </div>

                                <div className="mt-4 text-center">
                                    <button
                                        onClick={handleCopyPaymentLink}
                                        className="text-sm text-upi hover:text-upi-dark font-semibold"
                                    >
                                        <i className="fa-solid fa-link mr-1"></i> Copy Payment Link
                                    </button>
                                </div>
                            </div>

                            {/* Payment Verification */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4">Verify Payment</h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Transaction ID (UTR) With Name</label>
                                        <input
                                            type="text"
                                            placeholder="Enter transaction ID from your app"
                                            className="text-input-style"
                                            value={transactionId}
                                            onChange={(e) => setTransactionId(e.target.value)}
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Find this in your payment app after transaction with 12 Number</p>
                                    </div>

                                    <button
                                        onClick={handleVerifyPayment}
                                        disabled={isVerifying || !transactionId.trim()}
                                        className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition disabled:opacity-50"
                                    >
                                        {isVerifying ? (
                                            <>
                                                <i className="fa-solid fa-spinner fa-spin mr-2"></i>
                                                Verifying Payment...
                                            </>
                                        ) : 'Verify Payment'}
                                    </button>

                                    <div className="text-center">

                                          Example : 600645274493--murugan

                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Right Column - QR Code */}
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4 text-center">Scan & Pay</h2>

                                <div className="flex flex-col items-center">
                                    <div className="upi-qr-container mb-4">
                                        <img
                                            src={qrCodeUrl}
                                            alt="UPI QR Code"
                                            className="w-64 h-64 border-4 border-white shadow-lg rounded-lg"
                                        />
                                    </div>

                                    <div className="text-center space-y-2">
                                        <p className="text-sm text-gray-600">Scan QR code with any UPI app</p>
                                        <p className="font-mono font-bold text-upi text-lg">{upiId}</p>
                                        <p className="text-sm text-gray-500">Amount: {formatCurrency(finalTotal)}</p>
                                    </div>

                                    <div className="mt-6 bg-upi-light p-4 rounded-lg w-full">
                                        <h3 className="font-bold text-upi mb-2 flex items-center">
                                            <i className="fa-solid fa-lightbulb mr-2"></i> How to Pay
                                        </h3>
                                        <ol className="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                                            <li>Open any UPI app on your phone</li>
                                            <li>Tap on "Scan QR Code"</li>
                                            <li>Point camera at the QR code above</li>
                                            <li>Verify amount and confirm payment</li>
                                            <li>Save transaction ID for verification</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            {/* Payment Status */}
                            <div className={`p-6 rounded-xl border-2 ${paymentStatus === 'completed' ? 'bg-green-50 border-success' : paymentStatus === 'processing' ? 'bg-blue-50 border-info' : 'bg-yellow-50 border-accent'}`}>
                                <h3 className="text-lg font-bold mb-3 flex items-center">
                                    {paymentStatus === 'completed' ? (
                                        <>
                                            <i className="fa-solid fa-check-circle text-success mr-2"></i>
                                            Payment Completed
                                        </>
                                    ) : paymentStatus === 'processing' ? (
                                        <>
                                            <i className="fa-solid fa-spinner fa-spin text-info mr-2"></i>
                                            Payment Processing
                                        </>
                                    ) : (
                                        <>
                                            <i className="fa-solid fa-clock text-accent mr-2"></i>
                                            Payment Pending
                                        </>
                                    )}
                                </h3>

                                <div className="space-y-2">
                                    {paymentStatus === 'completed' ? (
                                        <p className="text-success font-semibold">Payment verified! Your order will be processed.</p>
                                    ) : paymentStatus === 'processing' ? (
                                        <p className="text-info font-semibold animate-pulse">Verifying your payment...</p>
                                    ) : (
                                        <p className="text-gray-700">Complete payment to confirm your order</p>
                                    )}

                                    {transactionId && (
                                        <p className="text-sm">
                                            <span className="font-semibold">Transaction ID:</span> {transactionId}
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 10. CHECKOUT VIEW
        // =======================================================

        const CheckoutView = ({ user, cart, setView, setCart, post, showToast }) => {
            const [address, setAddress] = useState('');
            const [couponCode, setCouponCode] = useState('');
            const [discountData, setDiscountData] = useState({ discount: 0, message: '', total: null });
            const [isPlacing, setIsPlacing] = useState(false);
            const [paymentMethod, setPaymentMethod] = useState('cod');
            const [showUpiPayment, setShowUpiPayment] = useState(false);
            const [orderId, setOrderId] = useState(null);
            const [emailUpdates, setEmailUpdates] = useState(true);
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);
            const [deliveryArea, setDeliveryArea] = useState('');
            const [deliveryCharge, setDeliveryCharge] = useState(0);

            const originalTotal = cart.reduce((sum, item) => sum + parseFloat(item.price) * item.quantity, 0);
            const finalTotal = (discountData.total !== null ? discountData.total : originalTotal) + deliveryCharge;

            // Check minimum order requirement
            const hasMinimum = originalTotal >= DELIVERY_POLICY.minimumOrder;

            useEffect(() => {
                if (getRole(user) === 'guest') {
                    showToast('Sign in to checkout.', 'error');
                    setView('login');
                }
                if (isUserBanned(user)) {
                    showToast('Cannot proceed: Your account is restricted.', 'error');
                    setView('profile');
                }
                if (!hasMinimum) {
                    showToast(`Minimum order is â‚¹${DELIVERY_POLICY.minimumOrder}. Add more items.`, 'error');
                }
            }, [user, hasMinimum]);

            const handleApplyCoupon = async () => {
                if (!couponCode) return;

                const res = await post({ action: 'applyCoupon', couponCode, totalAmount: originalTotal });

                if (res.status === 'success') {
                    setDiscountData({ discount: res.discountAmount, message: res.message, total: res.newTotal });
                    showToast('Coupon applied!', 'success');

                    if (res.couponApplied) {
                        setTimeout(() => {
                            showToast('Coupon usage notification sent.', 'info');
                        }, 500);
                    }
                } else {
                    setDiscountData({ discount: 0, message: res.message, total: null });
                    showToast(res.message, 'error');
                }
            };

            const handlePlaceOrder = async (paymentMethodUsed = paymentMethod, transactionId = null) => {
                if (!hasMinimum) {
                    return showToast(`Minimum order is â‚¹${DELIVERY_POLICY.minimumOrder}. Add more items.`, 'error');
                }
                if (!address) return showToast('Delivery address is required.', 'error');
                if (!deliveryArea) return showToast('Please select a delivery area.', 'error');
                if (cart.length === 0) return showToast('Your cart is empty.', 'error');

                setIsPlacing(true);

                const orderData = {
                    action: 'placeOrder',
                    email: user.email,
                    total: finalTotal,
                    items: cart.map(i => ({ id: i.id, name: i.name, price: i.price, qty: i.quantity })),
                    transactionId: transactionId || (paymentMethodUsed === 'cod' ? 'COD-' + Date.now().toString().slice(-6) : 'UPI-' + Date.now().toString().slice(-6)),
                    address: address,
                    deliveryArea: deliveryArea,
                    deliveryCharge: deliveryCharge,
                    paymentMethod: paymentMethodUsed,
                    paymentStatus: paymentMethodUsed === 'cod' ? 'pending' : (transactionId ? 'paid' : 'pending'),
                    sendOrderConfirmation: emailUpdates,
                    notifyAdmin: true
                };

                const res = await post(orderData);
                setIsPlacing(false);

                if (res.status === 'success') {
                    showToast(`Order #${res.orderId} placed! Earned ${res.awardedCoins} coins.`, 'success');

                    if (res.orderEmailSent && emailUpdates) {
                        setTimeout(() => {
                            showToast('Order confirmation email sent to your inbox.', 'info');
                        }, 1000);
                    }

                    if (res.adminNotified) {
                        setTimeout(() => {
                            showToast('Admin has been notified about your order.', 'info');
                        }, 1500);
                    }

                    setCart([]);
                    setView('orders');
                } else {
                    showToast(res.message, 'error');
                }
            };

            const handleProceedToUpiPayment = () => {
                if (!hasMinimum) {
                    return showToast(`Minimum order is â‚¹${DELIVERY_POLICY.minimumOrder}. Add more items.`, 'error');
                }
                if (!address) {
                    showToast('Delivery address is required.', 'error');
                    return;
                }
                if (!deliveryArea) {
                    showToast('Please select a delivery area.', 'error');
                    return;
                }

                const tempOrderId = 'TEMP-' + Date.now().toString().slice(-8);
                setOrderId(tempOrderId);
                setShowUpiPayment(true);
            };

            const handleUpiPaymentComplete = (transactionId) => {
                handlePlaceOrder('upi', transactionId);
            };

            const handleDeliveryAreaSelect = (area) => {
                setDeliveryArea(area.name);
                setDeliveryCharge(originalTotal >= DELIVERY_POLICY.freeDeliveryAbove ? 0 : area.charge);
            };

            if (getRole(user) === 'guest' || isUserBanned(user)) return null;

            if (showUpiPayment) {
                return (
                    <UpiPaymentView
                        finalTotal={finalTotal}
                        upiId={UPI_CONFIG.upiId}
                        orderId={orderId}
                        onPaymentComplete={handleUpiPaymentComplete}
                        onBack={() => setShowUpiPayment(false)}
                        showToast={showToast}
                    />
                );
            }

            return (
                <div className="p-3 md:p-4 max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 pb-24 md:pb-4">
                    <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border">
                        <h2 className="text-xl md:text-2xl font-bold mb-4 text-primary border-b pb-2 flex items-center">
                            <i className="fa-solid fa-truck mr-2"></i> Delivery
                        </h2>

                        {/* Minimum Order Warning */}
                        {!hasMinimum && (
                            <div className="bg-red-50 border-l-4 border-red-500 p-3 md:p-4 mb-4 rounded">
                                <div className="flex items-start">
                                    <i className="fa-solid fa-exclamation-triangle text-red-500 text-lg mr-2 mt-0.5"></i>
                                    <div>
                                        <p className="font-bold text-red-700 text-sm">Minimum Order Not Met</p>
                                        <p className="text-xs text-red-600 mt-1">
                                            Need {formatCurrency(DELIVERY_POLICY.minimumOrder - originalTotal)} more
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <label className="text-sm font-bold block mb-1">Delivery Address with Phone Number</label>
                        <textarea
                            className="text-input-style mb-4"
                            rows="3"
                            placeholder="Enter your full delivery address... with phone number"
                            value={address}
                            onChange={e => setAddress(e.target.value)}
                            required
                            disabled={!hasMinimum}
                        ></textarea>

                        {/* Delivery Area Selection */}
                        <div className="mb-4">
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-sm font-bold">Select Delivery Area</label>
                                <button
                                    type="button"
                                    onClick={() => setShowDeliveryModal(true)}
                                    className="text-xs text-primary hover:text-primary-dark font-semibold"
                                >
                                    <i className="fa-solid fa-map-location-dot mr-1"></i>
                                    View All Areas
                                </button>
                            </div>

                            {deliveryArea && (
                                <div className="bg-green-50 p-3 rounded-lg border border-green-200 mb-3">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <p className="font-semibold text-green-700">{deliveryArea}</p>
                                            <p className="text-xs text-green-600">
                                                Delivery Charge: {deliveryCharge === 0 ? 'FREE' : `â‚¹${deliveryCharge}`}
                                            </p>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setDeliveryArea('');
                                                setDeliveryCharge(0);
                                            }}
                                            className="text-xs text-red-500 hover:text-red-700"
                                        >
                                            Change
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-2">
                                {DELIVERY_POLICY.deliveryAreas.slice(0, 4).map(area => (
                                    <button
                                        key={area.code}
                                        type="button"
                                        onClick={() => handleDeliveryAreaSelect(area)}
                                        className={`p-3 rounded-lg border text-sm font-semibold transition ${deliveryArea === area.name ? 'border-primary bg-primary/10 text-primary' : 'border-gray-200 hover:border-primary'}`}
                                        disabled={!hasMinimum}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span>{area.name}</span>
                                            <span className={`text-xs ${originalTotal >= DELIVERY_POLICY.freeDeliveryAbove || area.charge === 0 ? 'text-success' : 'text-gray-600'}`}>
                                                {originalTotal >= DELIVERY_POLICY.freeDeliveryAbove || area.charge === 0 ? 'FREE' : `â‚¹${area.charge}`}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <h3 className="text-xl font-bold mb-3 text-primary-dark">Payment Method</h3>

                        <div className="space-y-3 mb-4">
                            <div
                                className={`flex items-center p-3 rounded-lg border cursor-pointer transition ${paymentMethod === 'cod' ? 'border-primary bg-primary/5' : 'border-gray-200 hover:border-primary'} ${!hasMinimum ? 'opacity-50 cursor-not-allowed' : ''}`}
                                onClick={() => hasMinimum && setPaymentMethod('cod')}
                            >
                                <div className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${paymentMethod === 'cod' ? 'border-primary bg-primary' : 'border-gray-300'}`}>
                                    {paymentMethod === 'cod' && <div className="w-2 h-2 rounded-full bg-white"></div>}
                                </div>
                                <div className="flex items-center">
                                    <i className="fa-solid fa-hand-holding-dollar mr-3 text-2xl text-success"></i>
                                    <div>
                                        <p className="font-semibold">Cash on Delivery (COD)</p>
                                        <p className="text-xs text-gray-500">Pay when you receive the order</p>
                                    </div>
                                </div>
                            </div>

                            <div
                                className={`flex items-center p-3 rounded-lg border cursor-pointer transition ${paymentMethod === 'upi' ? 'border-upi bg-upi-light' : 'border-gray-200 hover:border-upi'} ${!hasMinimum ? 'opacity-50 cursor-not-allowed' : ''}`}
                                onClick={() => hasMinimum && setPaymentMethod('upi')}
                            >
                                <div className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${paymentMethod === 'upi' ? 'border-upi bg-upi' : 'border-gray-300'}`}>
                                    {paymentMethod === 'upi' && <div className="w-2 h-2 rounded-full bg-white"></div>}
                                </div>
                                <div className="flex items-center">
                                    <i className="fa-solid fa-qrcode mr-3 text-2xl text-upi"></i>
                                    <div>
                                        <p className="font-semibold">UPI Payment</p>
                                        <p className="text-xs text-gray-500">Pay instantly with any UPI app</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3 className="text-xl font-bold mb-3 mt-6 text-primary-dark border-t pt-4">Coupon Code</h3>
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                className="text-input-style flex-grow"
                                placeholder="Enter coupon code (Optional)"
                                value={couponCode}
                                onChange={e => setCouponCode(e.target.value)}
                                disabled={!hasMinimum}
                            />
                            <button
                                onClick={handleApplyCoupon}
                                className="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition font-semibold text-sm disabled:opacity-50"
                                disabled={!hasMinimum}
                            >
                                Apply
                            </button>
                        </div>
                        {discountData.message && (
                            <p className={`text-sm mt-2 ${discountData.discount > 0 ? 'text-success' : 'text-danger'}`}>{discountData.message}</p>
                        )}

                        {/* Email Updates Preference */}
                        <div className="mt-6 border-t pt-4">
                            <div className="flex items-center space-x-3">
                                <input
                                    type="checkbox"
                                    id="emailUpdates"
                                    checked={emailUpdates}
                                    onChange={(e) => setEmailUpdates(e.target.checked)}
                                    className="w-5 h-5 text-primary rounded focus:ring-primary"
                                    disabled={!hasMinimum}
                                />
                                <label htmlFor="emailUpdates" className="text-sm font-semibold text-gray-700">
                                    Receive order updates via email
                                </label>
                            </div>
                            <p className="text-xs text-gray-500 mt-1">
                                Get order confirmation, shipping updates, and delivery notifications
                            </p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-vibrant border-2 border-primary/20 h-fit">
                        <h2 className="text-2xl font-bold text-primary mb-4 border-b pb-2">Order Summary</h2>

                        {/* Minimum Order Progress */}
                        <MinimumOrderProgress currentAmount={originalTotal} />

                        <div className="space-y-2 mb-4">
                            <div className="flex justify-between text-base">
                                <span>Cart Subtotal:</span>
                                <span>{formatCurrency(originalTotal)}</span>
                            </div>
                            <div className="flex justify-between text-base font-semibold">
                                <span>Shipping:</span>
                                <span className={deliveryCharge === 0 ? "text-success font-bold" : "text-gray-600"}>
                                    {deliveryCharge === 0 ? 'FREE' : formatCurrency(deliveryCharge)}
                                </span>
                            </div>
                            <div className="flex justify-between text-base font-semibold">
                                <span>Discount:</span>
                                <span>- {formatCurrency(discountData.discount)}</span>
                            </div>
                        </div>

                        <div className="flex justify-between text-xl font-extrabold text-primary-dark pt-2 border-t border-primary/20">
                            <span>Grand Total:</span>
                            <span className="text-danger">{formatCurrency(finalTotal)}</span>
                        </div>

                        {/* Minimum Order Status */}
                        {!hasMinimum && (
                            <div className="mt-4 p-3 bg-red-50 rounded-lg border border-red-200">
                                <div className="flex items-center">
                                    <i className="fa-solid fa-exclamation-circle text-red-500 mr-2"></i>
                                    <div>
                                        <p className="text-sm font-bold text-red-700">Minimum Order Required</p>
                                        <p className="text-xs text-red-600">
                                            Add {formatCurrency(DELIVERY_POLICY.minimumOrder - originalTotal)} more to place your order
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Email Notification Info */}
                        {emailUpdates && hasMinimum && (
                            <div className="mt-4 p-3 bg-info/10 rounded-lg border border-info/30">
                                <div className="flex items-center">
                                    <i className="fa-solid fa-envelope text-info mr-2"></i>
                                    <p className="text-sm text-info/80">
                                        You'll receive order confirmation and updates via email.
                                    </p>
                                </div>
                            </div>
                        )}

                        <div className="mt-6 space-y-3">
                            {paymentMethod === 'cod' ? (
                                <button
                                    onClick={() => handlePlaceOrder()}
                                    disabled={isPlacing || !address || cart.length === 0 || !hasMinimum || !deliveryArea}
                                    className={`w-full p-3 rounded-lg text-lg shadow-lg transition ${hasMinimum && address && deliveryArea ? 'bg-success text-white hover:bg-success/80' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                                >
                                    {isPlacing ? 'Placing Order...' :
                                     !hasMinimum ? 'Minimum Order Not Met' :
                                     !deliveryArea ? 'Select Delivery Area' :
                                     'Place Order (COD)'}
                                </button>
                            ) : (
                                <button
                                    onClick={handleProceedToUpiPayment}
                                    disabled={isPlacing || !address || cart.length === 0 || !hasMinimum || !deliveryArea}
                                    className={`w-full p-3 rounded-lg text-lg shadow-lg transition ${hasMinimum && address && deliveryArea ? 'bg-upi text-white hover:bg-upi/80' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                                >
                                    {isPlacing ? 'Processing...' :
                                     !hasMinimum ? 'Minimum Order Not Met' :
                                     !deliveryArea ? 'Select Delivery Area' :
                                     'Proceed to UPI Payment'}
                                </button>
                            )}

                            <button onClick={() => setView('cart')} className="w-full bg-gray-200 text-gray-800 p-3 rounded-lg text-lg hover:bg-gray-300 transition">
                                Back to Cart
                            </button>
                        </div>

                        {paymentMethod === 'upi' && hasMinimum && (
                            <div className="mt-4 p-3 bg-upi-light rounded-lg border border-upi/30">
                                <div className="flex items-center">
                                    <i className="fa-solid fa-info-circle text-upi mr-2"></i>
                                    <p className="text-sm text-upi/80">
                                        You'll be redirected to UPI payment page where you can scan QR code or pay using any UPI app.
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 11. ORDERS VIEW
        // =======================================================

        const OrdersView = ({ user, get, post, showToast, setSelectedOrder }) => {
            const [orders, setOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const role = getRole(user);

            const getStatusColor = (status) => {
                if (status === 'Delivered') return 'text-success';
                if (status === 'Cancelled') return 'text-danger';
                if (status === 'Pending') return 'text-accent-hover';
                return 'text-info';
            };

            // Check if order can be cancelled (within 2 hours of placement)
            const canCancelOrder = (order) => {
                if (order.status !== 'Pending') return false;
                const orderDate = new Date(order.date);
                const now = new Date();
                const hoursDiff = (now - orderDate) / (1000 * 60 * 60);
                return hoursDiff <= 2;
            };

            const handleCancelOrder = async (orderId) => {
                const reason = prompt('Please provide a reason for cancellation (optional):');
                if (reason === null) return; // User clicked cancel on prompt

                const confirmCancel = window.confirm('Are you sure you want to cancel this order? This action cannot be undone.');
                if (!confirmCancel) return;

                const res = await post({
                    action: 'cancelOrder',
                    orderId,
                    reason: reason || 'Customer requested cancellation',
                    email: user.email
                });

                if (res.status === 'success') {
                    showToast('Order cancelled successfully. You will receive a confirmation email.', 'success');
                    setOrders(orders.map(o => o.orderId === orderId ? {...o, status: 'Cancelled'} : o));
                } else {
                    showToast(res.message || 'Cannot cancel order. The 2-hour cancellation window may have passed.', 'error');
                }
            };

            useEffect(() => {
                const fetchOrders = async () => {
                    const params = role === 'admin' ? { action: 'getAllOrders' } : { action: 'getOrdersByEmail', email: user.email };
                    const res = await get(params);
                    setIsLoading(false);
                    if (res.status !== 'error') setOrders(res.filter(o => o.orderId));
                };
                if (role !== 'guest') fetchOrders();
            }, [user]);

            if (isLoading) return <LoadingSpinner />;
            if (orders.length === 0) return <div className="text-center py-16 md:py-20 text-gray-500 text-lg md:text-xl pb-24 md:pb-20"><i className="fa-solid fa-box-open fa-3x mb-4"></i><p>No orders placed yet.</p></div>;

            return (
                <div className="p-3 md:p-4 max-w-5xl mx-auto space-y-3 md:space-y-4 pb-24 md:pb-4">
                    <h1 className="text-xl md:text-3xl font-bold text-primary-dark mb-4 md:mb-6 flex items-center">
                        <i className="fa-solid fa-receipt mr-2 text-primary"></i>
                        {role === 'admin' ? 'All Orders' : 'My Orders'}
                    </h1>
                    {orders.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(order => (
                        <div key={order.orderId} className="bg-white p-4 md:p-5 rounded-xl shadow-md border-l-4 border-primary/50 hover:border-primary transition duration-200">
                            <div className="flex flex-col sm:flex-row sm:justify-between gap-3">
                                <div className="flex-1">
                                    <p className="text-xs text-gray-500">{order.date}</p>
                                    <h2 className="text-lg md:text-xl font-bold text-primary-dark">#{order.orderId}</h2>
                                    {order.paymentMethod && (
                                        <div className="flex flex-wrap items-center gap-2 mt-2">
                                            <span className="text-xs px-2 py-1 rounded bg-gray-100">
                                                {order.paymentMethod === 'upi' ? (
                                                    <><i className="fa-solid fa-qrcode mr-1 text-upi"></i>UPI</>
                                                ) : (
                                                    <><i className="fa-solid fa-hand-holding-dollar mr-1 text-success"></i>COD</>
                                                )}
                                            </span>
                                            {order.paymentStatus && (
                                                <span className={`text-xs px-2 py-1 rounded ${order.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                                    {order.paymentStatus === 'paid' ? 'Paid' : 'Pending'}
                                                </span>
                                            )}
                                            {order.assignedTo && (
                                                <span className="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">
                                                    <i className="fa-solid fa-truck mr-1"></i>{order.assignedTo}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="flex sm:flex-col items-center sm:items-end justify-between">
                                    <span className="text-lg md:text-xl font-extrabold text-danger">{formatCurrency(order.total)}</span>
                                    <span className={`px-3 py-1 text-xs font-bold rounded-full ${order.status==='Delivered'?'bg-success text-white':order.status==='Cancelled'?'bg-danger text-white':'bg-info/20 text-info'}`}>{order.status}</span>
                                </div>
                            </div>
                            <div className="mt-3 flex flex-col sm:flex-row justify-between items-start sm:items-center border-t pt-3 gap-2">
                                <p className="text-xs md:text-sm text-gray-600">{order.items.length} items</p>
                                <div className="flex gap-2 w-full sm:w-auto">
                                    {role !== 'admin' && canCancelOrder(order) && (
                                        <button
                                            onClick={() => handleCancelOrder(order.orderId)}
                                            className="text-danger hover:text-danger/80 text-sm font-semibold px-3 py-2 rounded-lg bg-danger/10 transition touch-target flex-1 sm:flex-none"
                                        >
                                            <i className="fa-solid fa-ban mr-1"></i> Cancel
                                        </button>
                                    )}
                                    {role !== 'admin' && order.status === 'Pending' && !canCancelOrder(order) && (
                                        <span className="text-xs text-gray-500 px-3 py-2">
                                            <i className="fa-solid fa-clock mr-1"></i> Cancel window expired
                                        </span>
                                    )}
                                    <button onClick={() => setSelectedOrder(order)} className="text-primary hover:text-primary-dark text-sm font-semibold px-3 py-2 rounded-lg bg-primary/10 transition touch-target flex-1 sm:flex-none">
                                        <i className="fa-solid fa-eye mr-1"></i> View
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // =======================================================
        // 12. ORDER DETAIL MODAL
        // =======================================================

        const OrderDetailModal = ({ order: initialOrder, onClose, onUpdateStatus, role }) => {
            if (!initialOrder) return null;

            // Local order state so status updates reflect immediately inside modal
            const [order, setOrder] = React.useState(initialOrder);
            const [orderAction, setOrderAction] = React.useState(null); // { type:'accept'|'reject', note:'', reason:'' }
            const [isActioning, setIsActioning] = React.useState(false);

            const statusMeta = {
                'Pending':   { color:'bg-yellow-100 text-yellow-800',   icon:'fa-clock',        label:'â³ Pending'   },
                'Confirmed': { color:'bg-blue-100 text-blue-800',       icon:'fa-check-circle', label:'âœ… Confirmed'  },
                'Shipped':   { color:'bg-purple-100 text-purple-800',   icon:'fa-truck',        label:'ðŸšš Shipped'    },
                'Delivered': { color:'bg-green-100 text-green-800',     icon:'fa-circle-check', label:'âœ… Delivered'  },
                'Cancelled': { color:'bg-red-100 text-red-700',         icon:'fa-circle-xmark', label:'ðŸš« Cancelled'  },
                'Rejected':  { color:'bg-red-200 text-red-800',         icon:'fa-ban',          label:'âŒ Rejected'   },
            };
            const sm = statusMeta[order.status] || { color:'bg-gray-100 text-gray-600', icon:'fa-circle', label:order.status };

            const applyStatusUpdate = async (newStatus, notifyCustomer = true) => {
                const res = await post({ action:'updateOrderStatus', orderId:order.orderId, status:newStatus, notifyCustomer });
                if (res.status === 'success') {
                    const updated = { ...order, status: newStatus };
                    setOrder(updated);
                    onUpdateStatus(order.orderId, newStatus);
                    showToast(`Order status â†’ ${newStatus}`, 'success');
                } else showToast(res.message || 'Update failed', 'error');
            };

            const handleAccept = async () => {
                setIsActioning(true);
                const res = await post({ action:'acceptOrder', orderId:order.orderId, adminNote: orderAction.note || '' });
                setIsActioning(false);
                if (res.status === 'success') {
                    const updated = { ...order, status:'Confirmed' };
                    setOrder(updated);
                    onUpdateStatus(order.orderId, 'Confirmed');
                    setOrderAction(null);
                    showToast('Order accepted! Confirmation email sent.', 'success');
                } else showToast(res.message || 'Failed', 'error');
            };

            const handleReject = async () => {
                if (!orderAction.reason?.trim()) { showToast('Please enter a rejection reason.', 'error'); return; }
                setIsActioning(true);
                const res = await post({ action:'rejectOrder', orderId:order.orderId, reason:orderAction.reason.trim() });
                setIsActioning(false);
                if (res.status === 'success') {
                    const updated = { ...order, status:'Rejected' };
                    setOrder(updated);
                    onUpdateStatus(order.orderId, 'Rejected');
                    setOrderAction(null);
                    showToast('Order rejected. Customer notified.', 'success');
                } else showToast(res.message || 'Failed', 'error');
            };

            const handleMarkPaid = async () => {
                const res = await post({ action:'updatePaymentStatus', orderId:order.orderId, paymentStatus:'paid', notifyCustomer:true });
                if (res.status === 'success') {
                    setOrder(o => ({ ...o, paymentStatus:'paid' }));
                    showToast('Payment marked as paid. Customer notified.', 'success');
                } else showToast(res.message || 'Failed', 'error');
            };

            const isPending   = order.status === 'Pending';
            const isConfirmed = order.status === 'Confirmed';
            const isShipped   = order.status === 'Shipped';
            const isClosed    = ['Delivered','Cancelled','Rejected'].includes(order.status);

            return (
                <div className="fixed inset-0 bg-black/60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4 print:p-0" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl md:rounded-2xl shadow-2xl max-w-4xl w-full max-h-[92vh] overflow-y-auto print:max-w-none print:rounded-none" onClick={e => e.stopPropagation()}>
                        {/* Mobile handle */}
                        <div className="md:hidden flex justify-center py-2 print:hidden">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>

                        <div className="p-4 md:p-6 pt-2 md:pt-6">
                            {/* Header */}
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4 print:hidden">
                                <div>
                                    <h2 className="text-xl md:text-2xl font-extrabold text-primary-dark">Order #{order.orderId}</h2>
                                    <span className={`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-extrabold mt-1 ${sm.color}`}>
                                        <i className={`fa-solid ${sm.icon}`}></i> {sm.label}
                                    </span>
                                </div>
                                <button onClick={onClose} className="text-gray-400 hover:text-danger transition p-1">
                                    <i className="fa-solid fa-xmark text-xl"></i>
                                </button>
                            </div>

                            {/* â”€â”€ INVOICE SECTION (print-visible) â”€â”€ */}
                            <div className="print:block print:w-full print:p-6">
                                {/* Store header for print */}
                                <div className="hidden print:block text-center mb-6 border-b-2 border-gray-800 pb-4">
                                    <h1 className="text-2xl font-extrabold">Maddur Murugan Super Store</h1>
                                    <p className="text-sm text-gray-600">Tax Invoice</p>
                                </div>

                                <h3 className="text-lg font-bold mb-3 text-primary print:text-black flex items-center gap-2">
                                    <i className="fa-solid fa-receipt text-accent print:hidden"></i>
                                    Invoice â€” Order #{order.orderId}
                                </h3>

                                {/* Order Info Grid */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                    {/* Customer & order details */}
                                    <div className="bg-gray-50 rounded-xl p-3 space-y-1.5 text-sm print:bg-transparent print:border print:border-gray-300 print:rounded-none">
                                        <div className="flex gap-2"><span className="text-gray-500 w-24 flex-shrink-0">Date</span><span className="font-semibold">{order.date}</span></div>
                                        {order.userEmail && <div className="flex gap-2"><span className="text-gray-500 w-24 flex-shrink-0">Customer</span><span className="font-semibold truncate">{order.userEmail}</span></div>}
                                        <div className="flex gap-2">
                                            <span className="text-gray-500 w-24 flex-shrink-0">Status</span>
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-extrabold ${sm.color}`}>{sm.label}</span>
                                        </div>
                                        {order.transactionId && <div className="flex gap-2"><span className="text-gray-500 w-24 flex-shrink-0">Txn ID</span><span className="font-semibold text-xs">{order.transactionId}</span></div>}
                                    </div>
                                    {/* Payment & address */}
                                    <div className="bg-gray-50 rounded-xl p-3 space-y-1.5 text-sm print:bg-transparent print:border print:border-gray-300 print:rounded-none">
                                        {order.paymentMethod && (
                                            <div className="flex gap-2 items-center">
                                                <span className="text-gray-500 w-24 flex-shrink-0">Payment</span>
                                                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${order.paymentMethod==='upi'?'bg-upi-light text-upi':'bg-green-100 text-green-800'}`}>
                                                    {order.paymentMethod==='upi'?'UPI':'COD'}
                                                    {order.paymentStatus && ` Â· ${order.paymentStatus}`}
                                                </span>
                                            </div>
                                        )}
                                        {order.address && (
                                            <div className="flex gap-2">
                                                <span className="text-gray-500 w-24 flex-shrink-0"><i className="fa-solid fa-location-dot text-accent mr-1"></i>Address</span>
                                                <span className="font-semibold text-xs leading-relaxed">{order.address}</span>
                                            </div>
                                        )}
                                        {order.deliveryArea && <div className="flex gap-2"><span className="text-gray-500 w-24 flex-shrink-0">Area</span><span className="font-semibold">{order.deliveryArea}</span></div>}
                                        {order.assignedTo && <div className="flex gap-2"><span className="text-gray-500 w-24 flex-shrink-0"><i className="fa-solid fa-motorcycle mr-1 text-xs"></i>Delivery</span><span className="font-semibold">{order.assignedTo}</span></div>}
                                    </div>
                                </div>

                                {/* Items table */}
                                <div className="overflow-x-auto rounded-xl border border-gray-200 mb-4">
                                    <table className="w-full text-sm">
                                        <thead><tr className="bg-primary text-white"><th className="p-3 text-left">Item</th><th className="p-3 text-center w-16">Qty</th><th className="p-3 text-right w-24">Unit Price</th><th className="p-3 text-right w-24">Subtotal</th></tr></thead>
                                        <tbody>
                                            {order.items.map((item, idx) => (
                                                <tr key={idx} className={`border-b ${idx%2===0?'bg-white':'bg-gray-50/50'}`}>
                                                    <td className="p-3 font-medium">{item.name}</td>
                                                    <td className="p-3 text-center text-gray-600">{item.qty}</td>
                                                    <td className="p-3 text-right text-gray-600">{formatCurrency(item.price)}</td>
                                                    <td className="p-3 text-right font-bold text-primary-dark">{formatCurrency(item.price * item.qty)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                        <tfoot>
                                            {order.deliveryCharge > 0 && (
                                                <tr className="bg-gray-50">
                                                    <td colSpan="3" className="p-3 text-right text-gray-500">Delivery Charge</td>
                                                    <td className="p-3 text-right text-gray-600">{formatCurrency(order.deliveryCharge)}</td>
                                                </tr>
                                            )}
                                            {order.discount > 0 && (
                                                <tr className="bg-green-50">
                                                    <td colSpan="3" className="p-3 text-right text-success font-semibold">Discount</td>
                                                    <td className="p-3 text-right text-success font-semibold">âˆ’{formatCurrency(order.discount)}</td>
                                                </tr>
                                            )}
                                            <tr className="bg-primary/5 border-t-2 border-primary/30">
                                                <td colSpan="3" className="p-3 text-right text-lg font-extrabold text-primary-dark">Grand Total</td>
                                                <td className="p-3 text-right text-xl font-extrabold text-danger">{formatCurrency(order.total)}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                                <div className="text-center text-xs text-gray-400 print:mt-8">Thank you for shopping with Maddur Murugan Super Store!</div>
                            </div>

                            {/* â”€â”€ ADMIN ACTIONS (no print) â”€â”€ */}
                            {role === 'admin' && (
                                <div className="mt-5 border-t-2 border-dashed border-gray-200 pt-5 print:hidden space-y-4">

                                    {/* Accept/Reject confirmation panel */}
                                    {orderAction && (
                                        <div className={`rounded-2xl p-4 border-2 ${orderAction.type==='accept'?'border-green-300 bg-green-50':'border-red-300 bg-red-50'}`}>
                                            <div className="flex items-center gap-3 mb-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${orderAction.type==='accept'?'bg-success text-white':'bg-danger text-white'}`}>
                                                    <i className={`fa-solid ${orderAction.type==='accept'?'fa-check':'fa-xmark'} text-lg`}></i>
                                                </div>
                                                <div>
                                                    <h4 className="font-extrabold text-gray-900">{orderAction.type==='accept'?'Accept Order':'Reject Order'}</h4>
                                                    <p className="text-xs text-gray-500">Customer will be notified via email immediately.</p>
                                                </div>
                                            </div>
                                            {orderAction.type === 'accept' ? (
                                                <div className="mb-3">
                                                    <label className="text-xs font-bold text-gray-600 block mb-1">Message to Customer (optional)</label>
                                                    <textarea rows="2" placeholder="e.g. Your order will be delivered by 5pm today."
                                                        className="text-input-style text-sm resize-none"
                                                        value={orderAction.note || ''}
                                                        onChange={e => setOrderAction(a => ({ ...a, note: e.target.value }))} />
                                                </div>
                                            ) : (
                                                <div className="mb-3">
                                                    <label className="text-xs font-bold text-gray-600 block mb-1">Reason for Rejection <span className="text-red-500">*</span></label>
                                                    <textarea rows="2" placeholder="e.g. Item out of stock, delivery area unavailableâ€¦"
                                                        className="text-input-style text-sm resize-none border-red-300 focus:border-red-500"
                                                        value={orderAction.reason || ''}
                                                        onChange={e => setOrderAction(a => ({ ...a, reason: e.target.value }))} />
                                                </div>
                                            )}
                                            <div className="flex gap-2">
                                                <button
                                                    onClick={orderAction.type==='accept' ? handleAccept : handleReject}
                                                    disabled={isActioning}
                                                    className={`flex-1 py-2.5 rounded-xl font-extrabold text-white text-sm transition shadow-md disabled:opacity-50 flex items-center justify-center gap-2 ${orderAction.type==='accept'?'bg-success hover:bg-green-600':'bg-danger hover:bg-red-600'}`}>
                                                    {isActioning ? <><i className="fa-solid fa-spinner fa-spin"></i> Sending...</> : orderAction.type==='accept' ? <><i className="fa-solid fa-check-circle"></i> Confirm Accept</> : <><i className="fa-solid fa-circle-xmark"></i> Send Rejection</>}
                                                </button>
                                                <button onClick={() => setOrderAction(null)}
                                                    className="bg-white border border-gray-300 text-gray-600 px-4 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-50 transition">
                                                    Cancel
                                                </button>
                                            </div>
                                        </div>
                                    )}

                                    {/* â”€â”€ Status workflow buttons â”€â”€ */}
                                    {!orderAction && (
                                        <>
                                            <h4 className="font-extrabold text-primary-dark flex items-center gap-2 text-sm">
                                                <i className="fa-solid fa-sliders text-accent"></i> Admin Actions
                                            </h4>

                                            {/* PENDING: Accept + Reject */}
                                            {isPending && (
                                                <div className="flex gap-3">
                                                    <button onClick={() => setOrderAction({ type:'accept', note:'' })}
                                                        className="flex-1 bg-success text-white py-3 rounded-xl font-extrabold text-sm hover:bg-green-600 transition shadow-md flex items-center justify-center gap-2">
                                                        <i className="fa-solid fa-check-circle"></i> Accept Order
                                                    </button>
                                                    <button onClick={() => setOrderAction({ type:'reject', reason:'' })}
                                                        className="flex-1 bg-danger text-white py-3 rounded-xl font-extrabold text-sm hover:bg-red-600 transition shadow-md flex items-center justify-center gap-2">
                                                        <i className="fa-solid fa-circle-xmark"></i> Reject
                                                    </button>
                                                </div>
                                            )}

                                            {/* CONFIRMED: next step â†’ Shipped */}
                                            {isConfirmed && (
                                                <div className="space-y-2">
                                                    <p className="text-xs text-gray-500 font-semibold">Order confirmed â€” mark next status:</p>
                                                    <div className="flex gap-2 flex-wrap">
                                                        <button onClick={() => applyStatusUpdate('Shipped')}
                                                            className="flex items-center gap-2 bg-purple-500 text-white px-5 py-2.5 rounded-xl font-extrabold text-sm hover:bg-purple-600 transition shadow-sm">
                                                            <i className="fa-solid fa-truck"></i> Mark Shipped
                                                        </button>
                                                        <button onClick={() => setOrderAction({ type:'reject', reason:'' })}
                                                            className="flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2.5 rounded-xl font-bold text-sm hover:bg-gray-200 transition border border-gray-200">
                                                            <i className="fa-solid fa-circle-xmark"></i> Cancel Order
                                                        </button>
                                                    </div>
                                                </div>
                                            )}

                                            {/* SHIPPED: next step â†’ Delivered */}
                                            {isShipped && (
                                                <div className="space-y-2">
                                                    <p className="text-xs text-gray-500 font-semibold">Order shipped â€” mark as delivered:</p>
                                                    <button onClick={() => applyStatusUpdate('Delivered')}
                                                        className="flex items-center gap-2 bg-success text-white px-5 py-2.5 rounded-xl font-extrabold text-sm hover:bg-green-600 transition shadow-sm">
                                                        <i className="fa-solid fa-circle-check"></i> Mark as Delivered
                                                    </button>
                                                </div>
                                            )}

                                            {/* CLOSED orders */}
                                            {isClosed && (
                                                <div className={`rounded-xl p-3 text-sm font-semibold flex items-center gap-2 ${order.status==='Delivered'?'bg-green-50 text-green-700 border border-green-200':order.status==='Rejected'?'bg-red-50 text-red-700 border border-red-200':'bg-gray-100 text-gray-600 border border-gray-200'}`}>
                                                    <i className={`fa-solid ${order.status==='Delivered'?'fa-circle-check':order.status==='Rejected'?'fa-ban':'fa-circle-xmark'}`}></i>
                                                    This order is {order.status.toLowerCase()}. No further actions available.
                                                </div>
                                            )}

                                            {/* UPI Mark as Paid */}
                                            {order.paymentMethod === 'upi' && order.paymentStatus !== 'paid' && !isClosed && (
                                                <button onClick={handleMarkPaid}
                                                    className="flex items-center gap-2 bg-upi text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-purple-700 transition shadow-sm">
                                                    <i className="fa-solid fa-qrcode"></i> Mark UPI as Paid
                                                </button>
                                            )}
                                        </>
                                    )}

                                    {/* Print Invoice â€” always shown */}
                                    <div className="flex items-center gap-2 pt-2 border-t border-gray-100">
                                        <button onClick={() => window.print()}
                                            className="flex items-center gap-2 bg-info text-white px-4 py-2 rounded-xl text-sm font-bold hover:bg-blue-600 transition shadow-sm">
                                            <i className="fa-solid fa-print"></i> Print Invoice
                                        </button>
                                        <span className="text-xs text-gray-400">Opens print dialog for this order</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 13. PROFILE VIEW
        // =======================================================

        const ProfileView = ({ user, setUser, setView, post, showToast }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [form, setForm] = useState(user);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [emailPreferences, setEmailPreferences] = useState({
                orderUpdates: true,
                promotional: true,
                securityAlerts: true
            });
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);
            const isBanned = isUserBanned(user);

            // Change Password State
            const [showPasswordChange, setShowPasswordChange] = useState(false);
            const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });
            const [passwordError, setPasswordError] = useState(null);

            const handleChangePassword = async (e) => {
                e.preventDefault();
                setPasswordError(null);

                if (passwordForm.new.length < 6) {
                    setPasswordError("New password must be at least 6 characters.");
                    return;
                }
                if (passwordForm.new !== passwordForm.confirm) {
                    setPasswordError("New passwords do not match.");
                    return;
                }

                setIsSubmitting(true);

                const res = await post({
                    action: 'changePassword',
                    email: user.email,
                    currentPassword: passwordForm.current,
                    newPassword: passwordForm.new
                });

                setIsSubmitting(false);

                if (res.status === 'success') {
                    showToast('Password changed successfully!', 'success');
                    setShowPasswordChange(false);
                    setPasswordForm({ current: '', new: '', confirm: '' });
                } else {
                    setPasswordError(res.message || "Failed to change password.");
                }
            };

            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('muruganUser');
                localStorage.removeItem('muruganCart');
                showToast('Logged out successfully.', 'info');
                setView('home');
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const res = await post({ action: 'updateProfile', ...form });
                setIsSubmitting(false);

                if (res.status === 'success') {
                    setUser(res.user);
                    localStorage.setItem('muruganUser', JSON.stringify(res.user));
                    showToast('Profile updated!', 'success');
                    setIsEditing(false);
                } else {
                    showToast(res.message || 'Update failed.', 'error');
                }
            };

            const handleUpdateEmailPreferences = async () => {
                const res = await post({
                    action: 'updateEmailPreferences',
                    email: user.email,
                    preferences: emailPreferences
                });

                if (res.status === 'success') {
                    showToast('Email preferences updated!', 'success');
                } else {
                    showToast('Failed to update preferences.', 'error');
                }
            };

            return (
                <div className="p-3 md:p-4 max-w-xl mx-auto pb-24 md:pb-4">
                    <h1 className="text-2xl md:text-3xl font-bold text-primary-dark mb-4 md:mb-6 border-b-2 border-primary/50 pb-2 flex items-center">
                        <i className="fa-solid fa-user-circle mr-2"></i> My Account
                    </h1>

                    {isBanned && (
                        <div className="bg-danger/10 border-l-4 border-danger p-4 mb-6 rounded-lg">
                            <h2 className="text-xl font-bold text-danger mb-2"><i className='fa-solid fa-triangle-exclamation mr-1'></i> Account Restricted</h2>
                            <p className="text-danger/80">Your account is currently restricted from placing orders and creating support tickets. Please contact support for more information.</p>
                        </div>
                    )}

                    {/* Delivery Policy Notice */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck-fast text-blue-500 text-xl mr-3"></i>
                                <div>
                                    <p className="font-semibold text-gray-800">Delivery Information</p>
                                    <p className="text-sm text-gray-600">Minimum order: â‚¹{DELIVERY_POLICY.minimumOrder} â€¢ Free delivery in select areas</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="text-sm text-primary hover:text-primary-dark font-semibold"
                            >
                                View Areas
                            </button>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-vibrant border-t-4 border-primary">
                        <h2 className="text-xl font-bold mb-4 text-primary">Personal Details</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-bold block mb-1">Name</label>
                                <input required className="text-input-style" name="name" value={form.name} onChange={e => setForm({...form, name:e.target.value})} disabled={!isEditing} />
                            </div>
                            <div>
                                <label className="text-sm font-bold block mb-1">Email</label>
                                <input type="email" className="text-input-style bg-gray-100 cursor-not-allowed" value={form.email} disabled />
                            </div>
                            <div>
                                <label className="text-sm font-bold block mb-1">Phone Number</label>
                                <input type="tel" className="text-input-style" name="phone" value={form.phone} onChange={e => setForm({...form, phone:e.target.value})} disabled={!isEditing} />
                            </div>

                            <div className="border-t pt-4">
                                <label className="text-sm font-bold block mb-1">Loyalty Coins</label>
                                <p className="text-2xl font-extrabold text-success flex items-center"><i className="fa-solid fa-coins mr-2"></i> {user.coins || 0}</p>
                                <p className="text-xs text-gray-500 mt-1">Earned from placing orders.</p>
                            </div>

                            <div className="flex justify-between pt-4">
                                {isEditing ? (
                                    <button type="submit" disabled={isSubmitting} className="bg-success text-white p-3 rounded-lg font-bold text-lg hover:bg-success/80 transition disabled:opacity-50 shadow-md">
                                        {isSubmitting ? 'Saving...' : 'Save Changes'}
                                    </button>
                                ) : (
                                    <button type="button" onClick={() => setIsEditing(true)} className="bg-primary text-white p-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition shadow-md">
                                        <i className="fa-solid fa-edit mr-2"></i> Edit Profile
                                    </button>
                                )}
                                <button type="button" onClick={handleLogout} className="bg-gray-400 text-white p-3 rounded-lg font-bold text-lg hover:bg-danger transition shadow-md">
                                    <i className="fa-solid fa-sign-out-alt mr-2"></i> Logout
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Change Password Section */}
                    <div className="mt-6 bg-white p-6 rounded-xl shadow-vibrant border-t-4 border-accent">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-accent flex items-center">
                                <i className="fa-solid fa-key mr-2"></i> Change Password
                            </h2>
                            <button
                                type="button"
                                onClick={() => setShowPasswordChange(!showPasswordChange)}
                                className="text-primary hover:text-primary-dark font-semibold text-sm"
                            >
                                {showPasswordChange ? 'Cancel' : 'Change'}
                            </button>
                        </div>

                        {showPasswordChange && (
                            <form onSubmit={handleChangePassword} className="space-y-4">
                                {passwordError && (
                                    <div className="bg-danger/10 border-l-4 border-danger p-3 rounded flex items-start animate-shake">
                                        <i className="fa-solid fa-triangle-exclamation text-danger mt-1 mr-2"></i>
                                        <div>
                                            <p className="text-sm text-danger font-bold">Error</p>
                                            <p className="text-xs text-danger/80">{passwordError}</p>
                                        </div>
                                    </div>
                                )}
                                <div>
                                    <label className="text-sm font-bold block mb-1">Current Password</label>
                                    <input
                                        required
                                        type="password"
                                        className="text-input-style"
                                        placeholder="Enter current password"
                                        value={passwordForm.current}
                                        onChange={e => setPasswordForm({...passwordForm, current: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">New Password</label>
                                    <input
                                        required
                                        type="password"
                                        className="text-input-style"
                                        placeholder="At least 6 characters"
                                        value={passwordForm.new}
                                        onChange={e => setPasswordForm({...passwordForm, new: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Confirm New Password</label>
                                    <input
                                        required
                                        type="password"
                                        className="text-input-style"
                                        placeholder="Re-enter new password"
                                        value={passwordForm.confirm}
                                        onChange={e => setPasswordForm({...passwordForm, confirm: e.target.value})}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold hover:bg-accent-hover transition disabled:opacity-50 shadow-md"
                                >
                                    {isSubmitting ? 'Changing...' : 'Change Password'}
                                </button>
                            </form>
                        )}

                        {!showPasswordChange && (
                            <p className="text-sm text-gray-500">
                                <i className="fa-solid fa-shield-halved mr-1"></i>
                                Keep your account secure by updating your password regularly.
                            </p>
                        )}
                    </div>

                    <div className="mt-6 border-t pt-6">
                        <button onClick={() => setView('orders')} className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold text-lg hover:bg-accent-hover transition shadow-md mb-3">
                            <i className="fa-solid fa-receipt mr-2"></i> View My Orders
                        </button>
                        <button onClick={() => setView('support')} className="w-full bg-info text-white p-3 rounded-lg font-bold text-lg hover:bg-info/80 transition shadow-md">
                            <i className="fa-solid fa-headset mr-2"></i> Contact Support
                        </button>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 14. ADMIN STAT CARD
        // =======================================================

        const StatCard = ({ title, value, icon, color='primary', onClick }) => (
            <div className={`bg-white p-3 md:p-4 rounded-xl shadow-md border-l-4 md:border-l-0 md:border-t-4 border-${color} ${onClick ? 'cursor-pointer hover:shadow-lg transition-shadow' : ''}`} onClick={onClick}>
                <div className="flex justify-between items-center">
                    <p className="text-xs md:text-sm font-semibold text-gray-500">{title}</p>
                    <i className={`fa-solid ${icon} text-lg md:text-xl text-${color}/70`}></i>
                </div>
                <p className="text-2xl md:text-3xl font-extrabold text-primary-dark mt-1 md:mt-2">{value}</p>
            </div>
        );

        // =======================================================
        // 15. EDIT PRODUCT MODAL
        // =======================================================

        const EditProductModal = ({ product, onClose, onSave }) => {
            const [editForm, setEditForm] = useState(product);
            const [isSaving, setIsSaving] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setEditForm(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                const res = await onSave(editForm);
                setIsSaving(false);
                if (res.status === 'success') onClose(true);
                else onClose(false, res.message);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => onClose()}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-2xl w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <form onSubmit={handleSubmit} className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4">
                                <h2 className="text-lg md:text-2xl font-bold text-primary-dark line-clamp-1">Edit: {product.name}</h2>
                                <button type="button" onClick={() => onClose()} className="text-gray-500 hover:text-danger transition p-1"><i className="fa-solid fa-xmark text-xl"></i></button>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-bold block mb-1">Product ID (Cannot Change)</label>
                                    <input className="text-input-style bg-gray-100 cursor-not-allowed" value={editForm.id} disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Name</label>
                                    <input required className="text-input-style" name="name" value={editForm.name} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Price (â‚¹)</label>
                                    <input required type="number" step="0.01" className="text-input-style" name="price" value={editForm.price} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Category</label>
                                    <input required className="text-input-style" name="category" value={editForm.category} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Image URL</label>
                                    <input className="text-input-style" name="image" value={editForm.image} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Description</label>
                                    <textarea className="text-input-style" rows="3" name="description" value={editForm.description} onChange={handleChange} />
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button type="submit" disabled={isSaving} className="bg-primary text-white p-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition disabled:opacity-50 shadow-md">
                                    {isSaving ? 'Saving...' : 'Save Product'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 16. ADMIN VIEW
        // =======================================================

        const AdminView = ({ user, post, get, showToast }) => {
            const [tab, setTab] = useState('summary');
            const [products, setProducts] = useState([]);
            const [users, setUsers] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [newProduct, setNewProduct] = useState({ id: '', name: '', price: '', category: '', image: '', description: '' });
            const [newCoupon, setNewCoupon] = useState({ code: '', discountType: 'fixed', discountValue: '', minOrder: '0' });
            const [orders, setOrders] = useState([]);
            const [tickets, setTickets] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            const [productToEdit, setProductToEdit] = useState(null);
            const [orderToView, setOrderToView] = useState(null);

            // Dashboard Stats State
            const [dashboardStats, setDashboardStats] = useState(null);
            const [salesReport, setSalesReport] = useState(null);
            const [salesPeriod, setSalesPeriod] = useState('week');
            const [activityLog, setActivityLog] = useState([]);

            // Product Management State
            const [lowStockProducts, setLowStockProducts] = useState([]);
            const [lowStockThreshold, setLowStockThreshold] = useState(10);
            const [productSearchTerm, setProductSearchTerm] = useState('');
            const [productToUpdateStock, setProductToUpdateStock] = useState(null);
            const [showBulkPriceUpdate, setShowBulkPriceUpdate] = useState(false);
            const [bulkPriceUpdates, setBulkPriceUpdates] = useState([]);

            // User Management State
            const [userSearchEmail, setUserSearchEmail] = useState('');
            const [searchedUser, setSearchedUser] = useState(null);
            const [userToResetPassword, setUserToResetPassword] = useState(null);

            // Coupon Management State
            const [couponToEdit, setCouponToEdit] = useState(null);
            const [couponValidationTest, setCouponValidationTest] = useState({ code: '', amount: '' });
            const [validationResult, setValidationResult] = useState(null);

            // Order Management State
            const [orderStats, setOrderStats] = useState(null);

            // Targeted Email State
            const [targetEmail, setTargetEmail] = useState('');
            const [isTargetedEmail, setIsTargetedEmail] = useState(false);

            // Grocery List State
            const [groceryLists, setGroceryLists] = useState([]);
            const [glAction, setGlAction] = useState(null); // { listId, type: 'accept'|'reject', note:'', reason:'' }

            // Festival Banners State
            const [adminBanners, setAdminBanners] = useState([]);
            const [bannerForm, setBannerForm] = useState({ title:'', subtitle:'', imageUrl:'', bgColor:'linear-gradient(135deg,#FF7F50,#FF6347)', emoji:'ðŸŽ‰' });
            const [editingBanner, setEditingBanner] = useState(null);
            const [bannerPreset, setBannerPreset] = useState('');

            const fetchData = async () => {
                setIsLoading(true);
                const [pRes, uRes, oRes, tRes, cRes, statsRes, activityRes, glRes, bnRes] = await Promise.all([
                    get({ action: 'getProducts' }),
                    get({ action: 'getUsers' }),
                    get({ action: 'getAllOrders' }),
                    get({ action: 'getTickets' }),
                    get({ action: 'getCoupons' }),
                    get({ action: 'getDashboardStats' }),
                    get({ action: 'getActivityLog', limit: 50 }),
                    get({ action: 'getGroceryLists' }),
                    get({ action: 'getBanners' })
                ]);

                if (pRes.status !== 'error') setProducts(pRes);
                if (uRes.status !== 'error') setUsers(uRes.map(u => ({ ...u, status: u.status || 'active' })));
                if (oRes.status !== 'error') setOrders(oRes.filter(o => o.orderId));
                if (tRes.status !== 'error') setTickets(tRes);
                if (cRes.status !== 'error') setCoupons(cRes);
                if (statsRes.status !== 'error' && statsRes.data) setDashboardStats(statsRes.data);
                if (activityRes.status !== 'error' && activityRes.data) setActivityLog(activityRes.data);
                if (!glRes.status || glRes.status !== 'error') setGroceryLists(Array.isArray(glRes) ? glRes : []);
                if (Array.isArray(bnRes)) setAdminBanners(bnRes);
                setIsLoading(false);
            };

            const fetchSalesReport = async (period) => {
                const res = await get({ action: 'getSalesReport', period });
                if (res.status !== 'error' && res.data) {
                    setSalesReport(res.data);
                }
            };

            const fetchLowStockProducts = async () => {
                const res = await get({ action: 'getLowStockProducts', threshold: lowStockThreshold });
                if (res.status !== 'error' && res.data) {
                    setLowStockProducts(res.data);
                }
            };

            const fetchOrderStats = async () => {
                const res = await get({ action: 'getOrderStats' });
                if (res.status !== 'error' && res.data) {
                    setOrderStats(res.data);
                }
            };

            useEffect(() => {
                if (getRole(user) === 'admin') {
                    fetchData();
                    fetchSalesReport(salesPeriod);
                    fetchLowStockProducts();
                    fetchOrderStats();
                }
            }, [user]);

            useEffect(() => {
                if (getRole(user) === 'admin') {
                    fetchSalesReport(salesPeriod);
                }
            }, [salesPeriod]);

            const handleAddProduct = async (e) => {
                e.preventDefault();
                const res = await post({ action: 'addProduct', ...newProduct, price: parseFloat(newProduct.price) || 0 });
                if (res.status === 'success') {
                    showToast('Product Added!', 'success');
                    setNewProduct({ id: '', name: '', price: '', category: '', image: '', description: '' });
                    fetchData();
                } else showToast(res.message, 'error');
            };

            const handleUpdateProduct = async (productData) => {
                const res = await post({ action: 'updateProduct', ...productData, price: parseFloat(productData.price) || 0 });
                if (res.status === 'success') {
                    showToast('Product Updated!', 'success');
                    setProductToEdit(null);
                    fetchData();
                    return { status: 'success' };
                } else return { status: 'error', message: res.message };
            };

            const handleDeleteProduct = async (id) => {
                if (window.confirm(`Are you sure you want to delete product ID: ${id}?`)) {
                    const res = await post({ action: 'deleteProduct', id });
                    if (res.status === 'success') {
                        showToast('Product Deleted', 'success');
                        fetchData();
                    } else showToast('Deletion Failed', 'error');
                }
            };

            const handleToggleUserStatus = async (email, currentStatus) => {
                const newStatus = currentStatus === 'active' ? 'banned' : 'active';
                const actionVerb = newStatus === 'banned' ? 'Ban' : 'Unban';
                if (window.confirm(`Are you sure you want to ${actionVerb} user: ${email}? This will send a notification email.`)) {
                    const res = await post({
                        action: 'updateUserStatus',
                        email,
                        status: newStatus,
                        notifyUser: true
                    });
                    if(res.status==='success') {
                        showToast(`User ${actionVerb}ned. Notification email sent.`, 'success');
                        fetchData();
                    } else showToast('Update Failed', 'error');
                }
            };

            const handleReplyTicket = async (ticketId) => {
                const reply = prompt("Enter your reply for the ticket:");
                if (reply) {
                    const res = await post({
                        action: 'replyTicket',
                        ticketId,
                        adminReply: reply,
                        notifyCustomer: true
                    });
                    if(res.status==='success') {
                        showToast('Ticket Replied. Customer notified via email.', 'success');
                        fetchData();
                    } else showToast('Reply Failed', 'error');
                }
            };

            const handleSendOffer = async () => {
                const subject = document.getElementById('offerSubject')?.value;
                const message = document.getElementById('offerMessage')?.value;

                if (!subject || !message) return showToast("Subject and message are required.", 'error');

                const confirmSend = window.confirm(`Send the offer email blast to ALL ${users.filter(u=>u.role==='user' && u.status !== 'banned').length} registered active users?`);

                if (confirmSend) {
                    const res = await post({ action: 'sendOffer', subject, message });
                    if(res.status==='success') showToast(`Email sent to ${res.recipients} users.`, 'success');
                    else showToast(res.message, 'error');
                }
            };

            const handleAddCoupon = async (e) => {
                e.preventDefault();
                if (!newCoupon.code || !newCoupon.discountValue) return showToast('Code and Value are required.', 'error');
                if (parseFloat(newCoupon.discountValue) <= 0) return showToast('Discount value must be positive.', 'error');

                const couponData = {
                    action: 'addCoupon',
                    code: newCoupon.code.toUpperCase(),
                    value: parseFloat(newCoupon.discountValue),
                    type: newCoupon.discountType,
                    minOrder: parseFloat(newCoupon.minOrder) || 0
                };

                const res = await post(couponData);

                if (res.status === 'success') {
                    showToast('Coupon Added!', 'success');
                    setNewCoupon({ code: '', discountType: 'fixed', discountValue: '', minOrder: '0' });
                    fetchData();
                } else showToast(res.message || 'Failed to add coupon.', 'error');
            };

            const handleDeleteCoupon = async (code) => {
                if (window.confirm(`Are you sure you want to delete coupon code: ${code}?`)) {
                    const res = await post({ action: 'deleteCoupon', code });
                    if (res.status === 'success') {
                        showToast('Coupon Deleted', 'success');
                        fetchData();
                    } else showToast('Deletion Failed', 'error');
                }
            };

            const getCouponDisplayValue = (coupon) => {
                if (coupon.discountType === 'percentage') return `${parseFloat(coupon.value).toFixed(0)}% OFF`;
                if (coupon.discountType === 'fixed') return `${formatCurrency(coupon.value)} OFF`;
                return 'N/A';
            };

            // Stock Management Handlers
            const handleUpdateStock = async (productId, action, quantity) => {
                const res = await post({ action: 'updateStock', id: productId, stockAction: action, quantity: parseInt(quantity) });
                if (res.status === 'success') {
                    showToast(`Stock ${action === 'add' ? 'added' : 'removed'} successfully!`, 'success');
                    setProductToUpdateStock(null);
                    fetchData();
                    fetchLowStockProducts();
                } else showToast(res.message || 'Stock update failed', 'error');
            };

            const handleBulkUpdatePrices = async () => {
                if (bulkPriceUpdates.length === 0) return showToast('No price updates specified', 'error');
                const res = await post({ action: 'bulkUpdatePrices', updates: bulkPriceUpdates });
                if (res.status === 'success') {
                    showToast(`Prices updated for ${res.updated || bulkPriceUpdates.length} products!`, 'success');
                    setShowBulkPriceUpdate(false);
                    setBulkPriceUpdates([]);
                    fetchData();
                } else showToast(res.message || 'Bulk update failed', 'error');
            };

            // User Management Handlers
            const handleSearchUserByEmail = async () => {
                if (!userSearchEmail) return showToast('Enter an email to search', 'error');
                const res = await get({ action: 'getUserByEmail', email: userSearchEmail });
                if (res.status !== 'error' && res.data) {
                    setSearchedUser(res.data);
                } else {
                    setSearchedUser(null);
                    showToast('User not found', 'error');
                }
            };

            const handleDeleteUser = async (email) => {
                if (window.confirm(`Are you sure you want to DELETE user: ${email}? This action cannot be undone!`)) {
                    const res = await post({ action: 'deleteUser', email });
                    if (res.status === 'success') {
                        showToast('User deleted successfully', 'success');
                        setSearchedUser(null);
                        fetchData();
                    } else showToast(res.message || 'Delete failed', 'error');
                }
            };

            const handleAdminResetPassword = async (email, newPassword) => {
                if (!newPassword || newPassword.length < 6) return showToast('Password must be at least 6 characters', 'error');
                const res = await post({ action: 'resetPassword', email, newPassword });
                if (res.status === 'success') {
                    showToast('Password reset successfully! User notified via email.', 'success');
                    setUserToResetPassword(null);
                } else showToast(res.message || 'Password reset failed', 'error');
            };

            // Coupon Management Handlers
            const handleUpdateCoupon = async (couponData) => {
                const res = await post({ action: 'updateCoupon', ...couponData });
                if (res.status === 'success') {
                    showToast('Coupon updated successfully!', 'success');
                    setCouponToEdit(null);
                    fetchData();
                    return { status: 'success' };
                } else return { status: 'error', message: res.message };
            };

            const handleToggleCoupon = async (code) => {
                const res = await post({ action: 'toggleCoupon', code });
                if (res.status === 'success') {
                    showToast(`Coupon ${res.active ? 'activated' : 'deactivated'}!`, 'success');
                    fetchData();
                } else showToast(res.message || 'Toggle failed', 'error');
            };

            const handleValidateCoupon = async () => {
                if (!couponValidationTest.code || !couponValidationTest.amount) {
                    return showToast('Enter coupon code and amount', 'error');
                }
                const res = await post({
                    action: 'validateCoupon',
                    couponCode: couponValidationTest.code,
                    totalAmount: parseFloat(couponValidationTest.amount)
                });
                setValidationResult(res);
            };

            // Order Management Handlers
            const handleCancelOrder = async (orderId, reason) => {
                const res = await post({ action: 'cancelOrder', orderId, reason, email: user.email });
                if (res.status === 'success') {
                    showToast('Order cancelled successfully', 'success');
                    fetchData();
                    fetchOrderStats();
                } else showToast(res.message || 'Cannot cancel order', 'error');
            };

            const handleAssignDelivery = async (orderId, assignedTo) => {
                const res = await post({ action: 'assignDelivery', orderId, assignedTo });
                if (res.status === 'success') {
                    showToast(`Delivery assigned to ${assignedTo}`, 'success');
                    fetchData();
                } else showToast(res.message || 'Assignment failed', 'error');
            };

            // Ticket Management Handlers
            const handleCloseTicket = async (ticketId) => {
                const res = await post({ action: 'closeTicket', ticketId });
                if (res.status === 'success') {
                    showToast('Ticket closed successfully', 'success');
                    fetchData();
                } else showToast(res.message || 'Failed to close ticket', 'error');
            };

            const handleUpdateTicketPriority = async (ticketId, priority) => {
                const res = await post({ action: 'updateTicketPriority', ticketId, priority });
                if (res.status === 'success') {
                    showToast(`Priority updated to ${priority}`, 'success');
                    fetchData();
                } else showToast(res.message || 'Failed to update priority', 'error');
            };

            // Targeted Email Handler
            const handleSendTargetedEmail = async () => {
                const subject = document.getElementById('offerSubject')?.value;
                const message = document.getElementById('offerMessage')?.value;

                if (!subject || !message) return showToast("Subject and message are required.", 'error');
                if (!targetEmail) return showToast("Enter target email address.", 'error');

                const confirmSend = window.confirm(`Send email to ${targetEmail}?`);
                if (confirmSend) {
                    const res = await post({ action: 'sendTargetedEmail', email: targetEmail, subject, message });
                    if (res.status === 'success') {
                        showToast(`Email sent to ${targetEmail}!`, 'success');
                        setTargetEmail('');
                    } else showToast(res.message, 'error');
                }
            };

            // â”€â”€ Grocery List Accept / Reject â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const handleAcceptOrder = async () => {
                if (!glAction?.listId) return;
                const res = await post({ action: 'acceptGroceryList', listId: glAction.listId, adminNote: glAction.note || '' });
                if (res.status === 'success') { showToast('Order accepted! Confirmation email sent.', 'success'); setGlAction(null); fetchData(); }
                else showToast(res.message || 'Failed', 'error');
            };

            const handleRejectOrder = async () => {
                if (!glAction?.listId || !glAction.reason?.trim()) { showToast('Please enter a rejection reason.', 'error'); return; }
                const res = await post({ action: 'rejectGroceryList', listId: glAction.listId, reason: glAction.reason.trim() });
                if (res.status === 'success') { showToast('Order rejected. Customer notified.', 'success'); setGlAction(null); fetchData(); }
                else showToast(res.message || 'Failed', 'error');
            };

            const handleGLStatusUpdate = async (listId, status) => {
                const res = await post({ action: 'updateGroceryListStatus', listId, status });
                if (res.status === 'success') { showToast(`Status â†’ ${status}`, 'success'); fetchData(); }
                else showToast(res.message || 'Update failed', 'error');
            };

            // â”€â”€ Banner Handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const handleAddBanner = async () => {
                if (!bannerForm.title.trim()) { showToast('Banner title is required.', 'error'); return; }
                const res = await post({ action: 'addBanner', ...bannerForm });
                if (res.status === 'success') { showToast('Banner added!', 'success'); setBannerForm({ title:'', subtitle:'', imageUrl:'', bgColor:'linear-gradient(135deg,#FF7F50,#FF6347)', emoji:'ðŸŽ‰' }); fetchData(); }
                else showToast(res.message || 'Failed', 'error');
            };

            const handleUpdateBanner = async () => {
                if (!editingBanner) return;
                if (!bannerForm.title.trim()) { showToast('Banner title is required.', 'error'); return; }
                const res = await post({ action: 'updateBanner', bannerId: editingBanner, ...bannerForm });
                if (res.status === 'success') {
                    showToast('Banner updated!', 'success');
                    setEditingBanner(null);
                    setBannerForm({ title:'', subtitle:'', imageUrl:'', bgColor:'linear-gradient(135deg,#FF7F50,#FF6347)', emoji:'ðŸŽ‰' });
                    fetchData();
                }
                else showToast(res.message || 'Failed', 'error');
            };

            const handleDeleteBanner = async (bannerId) => {
                const res = await post({ action: 'deleteBanner', bannerId });
                if (res.status === 'success') { showToast('Banner deleted.', 'success'); fetchData(); }
                else showToast(res.message || 'Failed', 'error');
            };

            const handleToggleBanner = async (bannerId) => {
                const res = await post({ action: 'toggleBanner', bannerId });
                if (res.status === 'success') { showToast(`Banner ${res.active ? 'enabled' : 'disabled'}.`, 'success'); fetchData(); }
                else showToast(res.message || 'Failed', 'error');
            };

            const applyPreset = (preset, target) => {
                const p = FESTIVAL_PRESETS.find(fp => fp.label === preset);
                if (!p) return;
                // both 'add' and 'edit' modes use bannerForm for the actual form fields
                setBannerForm(f => ({ ...f, bgColor: p.bg, emoji: p.emoji, title: f.title || p.label }));
            };

            // Filtered products for search
            const filteredAdminProducts = useMemo(() => {
                if (!productSearchTerm) return products;
                return products.filter(p =>
                    p.name.toLowerCase().includes(productSearchTerm.toLowerCase()) ||
                    p.id.toLowerCase().includes(productSearchTerm.toLowerCase()) ||
                    p.category.toLowerCase().includes(productSearchTerm.toLowerCase())
                );
            }, [products, productSearchTerm]);

            if (getRole(user) !== 'admin') return <div className="text-center py-20 text-gray-500 text-xl">Access Denied. Admin privileges required.</div>;
            if (isLoading) return <LoadingSpinner />;

            return (
                <div className="p-3 md:p-4 max-w-7xl mx-auto pb-20 md:pb-4">
                    <h1 className="text-2xl md:text-3xl font-extrabold text-danger mb-4 md:mb-6 border-b-2 border-danger/50 pb-2 flex items-center">
                        <i className="fa-solid fa-user-gear mr-2"></i>
                        <span className="hidden sm:inline">Admin Dashboard</span>
                        <span className="sm:hidden">Admin</span>
                    </h1>

                    {/* Mobile-friendly scrollable tabs */}
                    <div className="flex gap-2 mb-4 md:mb-6 pb-2 overflow-x-auto hide-scrollbar -mx-3 px-3 md:mx-0 md:px-0">
                        {['summary','products','orders','users','support','coupons','marketing','grocerylists','banners','activity'].map(t => (
                            <button
                                key={t}
                                onClick={()=>setTab(t)}
                                className={`px-3 md:px-4 py-2 rounded-lg font-bold capitalize text-xs md:text-sm whitespace-nowrap transition shadow-md flex-shrink-0 touch-target ${tab===t?'bg-primary text-white':'bg-white text-gray-700 hover:bg-gray-100 active:bg-gray-200'}`}
                            >
                                <i className={`fa-solid ${t==='summary'?'fa-chart-pie':t==='products'?'fa-box':t==='orders'?'fa-receipt':t==='users'?'fa-users':t==='support'?'fa-headset':t==='coupons'?'fa-tags':t==='marketing'?'fa-bullhorn':t==='grocerylists'?'fa-list-check':t==='banners'?'fa-flag':'fa-clock-rotate-left'} mr-1 md:mr-2`}></i>
                                <span className="hidden xs:inline">{t==='marketing'?'Offers':t==='activity'?'Activity':t==='grocerylists'?'Grocery':t==='banners'?'Banners':t}</span>
                                <span className="xs:hidden">{t==='summary'?'Stats':t==='products'?'Items':t==='orders'?'Orders':t==='users'?'Users':t==='support'?'Help':t==='coupons'?'Codes':t==='marketing'?'Offers':t==='grocerylists'?'Lists':t==='banners'?'Banners':'Log'}</span>
                            </button>
                        ))}
                    </div>

                    {tab === 'summary' && (
                        <div className="space-y-6">
                            {/* Main Stats Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
                                <StatCard title="Total Products" value={dashboardStats?.totalProducts || products.length} icon="fa-cubes" color="info" />
                                <StatCard title="Total Users" value={dashboardStats?.totalUsers || users.length} icon="fa-users" color="primary" />
                                <StatCard title="Total Orders" value={dashboardStats?.totalOrders || orders.length} icon="fa-receipt" color="accent" />
                                <StatCard title="Open Tickets" value={dashboardStats?.openTickets || tickets.filter(t => t.status === 'Open').length} icon="fa-headset" color="danger" />
                                <StatCard title="Active Coupons" value={dashboardStats?.activeCoupons || coupons.length} icon="fa-tags" color="success" />
                                <StatCard title="Banned Users" value={dashboardStats?.bannedUsers || users.filter(u => u.status === 'banned').length} icon="fa-ban" color="danger" />
                                <StatCard title="UPI Orders" value={dashboardStats?.upiOrders || orders.filter(o => o.paymentMethod === 'upi').length} icon="fa-qrcode" color="upi" />
                                <StatCard title="COD Orders" value={dashboardStats?.codOrders || orders.filter(o => o.paymentMethod === 'cod' || !o.paymentMethod).length} icon="fa-hand-holding-dollar" color="success" />
                                <StatCard title="Grocery Lists" value={groceryLists.length} icon="fa-list-check" color="primary" onClick={() => setTab('grocerylists')} />
                                <StatCard title="Pending Lists" value={groceryLists.filter(g => g.status === 'Pending').length} icon="fa-clock" color="accent" onClick={() => setTab('grocerylists')} />
                                <StatCard title="Festival Banners" value={adminBanners.length} icon="fa-flag" color="info" onClick={() => setTab('banners')} />
                                <StatCard title="Active Banners" value={adminBanners.filter(b => b.isActive === 'true' || b.isActive === true).length} icon="fa-star" color="success" onClick={() => setTab('banners')} />
                            </div>

                            {/* Order Statistics */}
                            {orderStats && (
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-md">
                                    <h3 className="text-lg font-bold text-primary-dark mb-4 flex items-center">
                                        <i className="fa-solid fa-chart-bar mr-2 text-primary"></i> Order Statistics
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                        {[
                                            { label:'Pending',   val: orderStats.pending   || orders.filter(o=>o.status==='Pending').length,   bg:'bg-yellow-50',  border:'border-yellow-200', text:'text-yellow-800',  emoji:'â³' },
                                            { label:'Confirmed', val: orders.filter(o=>o.status==='Confirmed').length,                          bg:'bg-blue-50',    border:'border-blue-200',   text:'text-blue-800',    emoji:'âœ…' },
                                            { label:'Shipped',   val: orderStats.shipped   || orders.filter(o=>o.status==='Shipped').length,    bg:'bg-purple-50',  border:'border-purple-200', text:'text-purple-800',  emoji:'ðŸšš' },
                                            { label:'Delivered', val: orderStats.delivered || orders.filter(o=>o.status==='Delivered').length,  bg:'bg-green-50',   border:'border-green-200',  text:'text-green-800',   emoji:'ðŸ“¦' },
                                            { label:'Rejected',  val: orders.filter(o=>o.status==='Rejected').length,                           bg:'bg-red-50',     border:'border-red-200',    text:'text-red-800',     emoji:'âŒ' },
                                            { label:'Cancelled', val: orderStats.cancelled || orders.filter(o=>o.status==='Cancelled').length,  bg:'bg-gray-50',    border:'border-gray-200',   text:'text-gray-700',    emoji:'ðŸš«' },
                                        ].map(({ label, val, bg, border, text, emoji }) => (
                                            <div key={label} className={`${bg} p-3 rounded-xl border ${border} text-center cursor-pointer hover:shadow-md transition`} onClick={() => setTab('orders')}>
                                                <p className="text-lg mb-0.5">{emoji}</p>
                                                <p className={`text-xs font-semibold ${text} opacity-80`}>{label}</p>
                                                <p className={`text-2xl font-extrabold ${text}`}>{val}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Sales Report Section */}
                            <div className="bg-white p-4 md:p-6 rounded-xl shadow-md">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                                    <h3 className="text-lg font-bold text-primary-dark flex items-center">
                                        <i className="fa-solid fa-chart-line mr-2 text-success"></i> Sales Report
                                    </h3>
                                    <div className="flex gap-2">
                                        {['today', 'week', 'month', 'year'].map(period => (
                                            <button
                                                key={period}
                                                onClick={() => setSalesPeriod(period)}
                                                className={`px-3 py-1.5 rounded-lg text-xs font-bold capitalize transition ${salesPeriod === period ? 'bg-success text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                            >
                                                {period}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                {salesReport ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                            <p className="text-sm text-green-700">Total Sales</p>
                                            <p className="text-2xl font-bold text-green-800">{formatCurrency(salesReport.totalSales || 0)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                            <p className="text-sm text-blue-700">Orders</p>
                                            <p className="text-2xl font-bold text-blue-800">{salesReport.orderCount || 0}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                            <p className="text-sm text-purple-700">Avg Order Value</p>
                                            <p className="text-2xl font-bold text-purple-800">{formatCurrency(salesReport.avgOrderValue || 0)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                            <p className="text-sm text-orange-700">New Customers</p>
                                            <p className="text-2xl font-bold text-orange-800">{salesReport.newCustomers || 0}</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-500 py-8">
                                        <i className="fa-solid fa-spinner fa-spin mr-2"></i> Loading sales data...
                                    </div>
                                )}
                            </div>

                            {/* Low Stock Alert */}
                            {lowStockProducts.length > 0 && (
                                <div className="bg-red-50 p-4 md:p-6 rounded-xl shadow-md border-l-4 border-red-500">
                                    <h3 className="text-lg font-bold text-red-700 mb-4 flex items-center">
                                        <i className="fa-solid fa-triangle-exclamation mr-2"></i> Low Stock Alert ({lowStockProducts.length} items)
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {lowStockProducts.slice(0, 6).map(p => (
                                            <div key={p.id} className="bg-white p-3 rounded-lg border border-red-200 flex justify-between items-center">
                                                <div>
                                                    <p className="font-semibold text-sm text-gray-800 line-clamp-1">{p.name}</p>
                                                    <p className="text-xs text-red-600">Stock: {p.stock || 0}</p>
                                                </div>
                                                <button
                                                    onClick={() => { setProductToUpdateStock(p); setTab('products'); }}
                                                    className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-lg font-semibold hover:bg-red-200"
                                                >
                                                    Update
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {tab === 'products' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                {/* Add Product Form */}
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border-t-4 border-primary">
                                    <h2 className="text-lg md:text-xl font-bold mb-4 text-primary flex items-center">
                                        <i className="fa-solid fa-plus-circle mr-2"></i> Add New Product
                                    </h2>
                                    <form onSubmit={handleAddProduct} className="space-y-3">
                                        <input required className="text-input-style" placeholder="Product ID (Unique)" value={newProduct.id} onChange={e => setNewProduct({...newProduct, id:e.target.value})} />
                                        <input required className="text-input-style" placeholder="Product Name" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name:e.target.value})} />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input required type="number" step="0.01" className="text-input-style" placeholder="Price (â‚¹)" value={newProduct.price} onChange={e => setNewProduct({...newProduct, price:e.target.value})} />
                                            <input required className="text-input-style" placeholder="Category" value={newProduct.category} onChange={e => setNewProduct({...newProduct, category:e.target.value})} />
                                        </div>
                                        <input className="text-input-style" placeholder="Image URL (Optional)" value={newProduct.image} onChange={e => setNewProduct({...newProduct, image:e.target.value})} />
                                        <textarea className="text-input-style" rows="2" placeholder="Description (Optional)" value={newProduct.description} onChange={e => setNewProduct({...newProduct, description:e.target.value})} />
                                        <button type="submit" className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition shadow-md touch-target">
                                            <i className="fa-solid fa-plus-circle mr-2"></i> Add Product
                                        </button>
                                    </form>
                                </div>

                                {/* Bulk Price Update */}
                                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-accent">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-accent flex items-center">
                                            <i className="fa-solid fa-tags mr-2"></i> Bulk Price Update
                                        </h3>
                                        <button
                                            onClick={() => setShowBulkPriceUpdate(!showBulkPriceUpdate)}
                                            className="text-xs text-primary hover:text-primary-dark font-semibold"
                                        >
                                            {showBulkPriceUpdate ? 'Cancel' : 'Open'}
                                        </button>
                                    </div>
                                    {showBulkPriceUpdate && (
                                        <div className="space-y-3">
                                            <p className="text-xs text-gray-600">Add products to update their prices in bulk.</p>
                                            {bulkPriceUpdates.map((item, idx) => (
                                                <div key={idx} className="flex gap-2 items-center">
                                                    <select
                                                        className="text-input-style flex-1 text-xs"
                                                        value={item.id}
                                                        onChange={e => {
                                                            const newUpdates = [...bulkPriceUpdates];
                                                            newUpdates[idx].id = e.target.value;
                                                            setBulkPriceUpdates(newUpdates);
                                                        }}
                                                    >
                                                        <option value="">Select Product</option>
                                                        {products.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                    </select>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        className="text-input-style w-24 text-xs"
                                                        placeholder="New Price"
                                                        value={item.price}
                                                        onChange={e => {
                                                            const newUpdates = [...bulkPriceUpdates];
                                                            newUpdates[idx].price = e.target.value;
                                                            setBulkPriceUpdates(newUpdates);
                                                        }}
                                                    />
                                                    <button onClick={() => setBulkPriceUpdates(bulkPriceUpdates.filter((_, i) => i !== idx))} className="text-danger text-xs">
                                                        <i className="fa-solid fa-times"></i>
                                                    </button>
                                                </div>
                                            ))}
                                            <button
                                                onClick={() => setBulkPriceUpdates([...bulkPriceUpdates, { id: '', price: '' }])}
                                                className="text-xs text-primary font-semibold"
                                            >
                                                <i className="fa-solid fa-plus mr-1"></i> Add Item
                                            </button>
                                            {bulkPriceUpdates.length > 0 && (
                                                <button
                                                    onClick={handleBulkUpdatePrices}
                                                    className="w-full bg-accent text-primary-dark p-2 rounded-lg font-bold text-sm hover:bg-accent-hover"
                                                >
                                                    Update {bulkPriceUpdates.length} Prices
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Low Stock Threshold Setting */}
                                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-danger">
                                    <h3 className="font-bold text-danger mb-3 flex items-center">
                                        <i className="fa-solid fa-triangle-exclamation mr-2"></i> Low Stock Threshold
                                    </h3>
                                    <div className="flex gap-2">
                                        <input
                                            type="number"
                                            className="text-input-style flex-1"
                                            value={lowStockThreshold}
                                            onChange={e => setLowStockThreshold(parseInt(e.target.value) || 10)}
                                        />
                                        <button
                                            onClick={fetchLowStockProducts}
                                            className="bg-danger text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-danger/80"
                                        >
                                            Check
                                        </button>
                                    </div>
                                    {lowStockProducts.length > 0 && (
                                        <p className="text-xs text-danger mt-2">
                                            <i className="fa-solid fa-exclamation-circle mr-1"></i>
                                            {lowStockProducts.length} products below threshold
                                        </p>
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-2 bg-white rounded-xl shadow-md">
                                <div className="p-4 border-b">
                                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
                                        <h2 className="text-lg md:text-xl font-bold text-primary flex items-center">
                                            <i className="fa-solid fa-box mr-2"></i> Products
                                            <span className="text-sm bg-primary/10 px-3 py-1 rounded-full ml-2">{filteredAdminProducts.length}</span>
                                        </h2>
                                        {/* Search Input */}
                                        <div className="relative flex-1 max-w-xs">
                                            <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                            <input
                                                type="text"
                                                className="text-input-style pl-9 text-sm"
                                                placeholder="Search by name, ID, category..."
                                                value={productSearchTerm}
                                                onChange={e => setProductSearchTerm(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Desktop Table View */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 uppercase"><tr><th className="p-3">ID</th><th className="p-3">Name</th><th className="p-3">Price</th><th className="p-3">Stock</th><th className="p-3">Category</th><th className="p-3">Actions</th></tr></thead>
                                        <tbody>
                                            {filteredAdminProducts.map(p => (
                                                <tr key={p.id} className={`border-b hover:bg-gray-50 ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-50' : ''}`}>
                                                    <td className="p-3 text-xs text-gray-500">{p.id}</td>
                                                    <td className="p-3 font-semibold">{p.name}</td>
                                                    <td className="p-3 font-bold text-danger">{formatCurrency(p.price)}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                            {p.stock || 0}
                                                        </span>
                                                    </td>
                                                    <td className="p-3">{p.category}</td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        <button onClick={() => setProductToUpdateStock(p)} className="text-success hover:text-success/80 text-xs font-semibold mr-2"><i className='fa-solid fa-boxes-stacked'></i> Stock</button>
                                                        <button onClick={() => setProductToEdit(p)} className="text-info hover:text-info/80 text-xs font-semibold mr-2"><i className='fa-solid fa-edit'></i> Edit</button>
                                                        <button onClick={() => handleDeleteProduct(p.id)} className="text-danger hover:text-danger/80 text-xs font-semibold"><i className='fa-solid fa-trash'></i> Del</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden p-3 space-y-3 max-h-[60vh] overflow-y-auto">
                                    {filteredAdminProducts.map(p => (
                                        <div key={p.id} className={`rounded-xl p-4 border ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'}`}>
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <h3 className="font-bold text-gray-800 text-sm line-clamp-2">{p.name}</h3>
                                                    <p className="text-xs text-gray-500 mt-1">ID: {p.id}</p>
                                                </div>
                                                <div className="text-right ml-2">
                                                    <span className="text-lg font-extrabold text-danger block">{formatCurrency(p.price)}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                        Stock: {p.stock || 0}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                                <span className="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full font-medium">{p.category}</span>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setProductToUpdateStock(p)} className="bg-success text-white px-2 py-1.5 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-boxes-stacked'></i>
                                                    </button>
                                                    <button onClick={() => setProductToEdit(p)} className="bg-info text-white px-2 py-1.5 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-edit'></i>
                                                    </button>
                                                    <button onClick={() => handleDeleteProduct(p.id)} className="bg-danger text-white px-2 py-1.5 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-trash'></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'orders' && (
                        <div className="space-y-4">
                            {/* Delivery Portal Link Card */}
                            <div className="bg-gradient-to-r from-accent/10 to-accent/5 p-4 rounded-xl border border-accent/20">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-accent text-primary-dark p-3 rounded-full">
                                            <i className="fa-solid fa-motorcycle text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-primary-dark">Delivery Partner Portal</h3>
                                            <p className="text-sm text-gray-600">Share this link with delivery boys to access their orders</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                const url = window.location.origin + window.location.pathname + '?view=delivery';
                                                navigator.clipboard.writeText(url);
                                                showToast('Delivery portal link copied!', 'success');
                                            }}
                                            className="bg-accent text-primary-dark px-4 py-2 rounded-lg font-semibold hover:bg-accent-hover transition text-sm"
                                        >
                                            <i className="fa-solid fa-copy mr-1"></i> Copy Link
                                        </button>
                                        <a
                                            href="?view=delivery"
                                            target="_blank"
                                            className="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark transition text-sm"
                                        >
                                            <i className="fa-solid fa-external-link mr-1"></i> Open
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-md">
                            <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                <span><i className="fa-solid fa-receipt mr-2"></i> Orders</span>
                                <div className="flex gap-2 items-center flex-wrap">
                                    {orders.filter(o=>o.status==='Pending').length > 0 && (
                                        <span className="text-xs bg-yellow-100 text-yellow-800 font-bold px-2 py-1 rounded-full">
                                            â³ {orders.filter(o=>o.status==='Pending').length} Pending
                                        </span>
                                    )}
                                    {orders.filter(o=>o.status==='Confirmed').length > 0 && (
                                        <span className="text-xs bg-blue-100 text-blue-800 font-bold px-2 py-1 rounded-full">
                                            âœ… {orders.filter(o=>o.status==='Confirmed').length} Confirmed
                                        </span>
                                    )}
                                    <span className="text-sm bg-primary/10 px-3 py-1 rounded-full font-semibold">{orders.length} total</span>
                                </div>
                            </h2>

                            {/* â”€â”€ Helper for status badge â”€â”€ */}
                            {(() => {
                                const orderStatusBadge = (status) => {
                                    const map = {
                                        'Pending':   'bg-yellow-100 text-yellow-800',
                                        'Confirmed': 'bg-blue-100 text-blue-800',
                                        'Shipped':   'bg-purple-100 text-purple-800',
                                        'Delivered': 'bg-green-100 text-green-800',
                                        'Cancelled': 'bg-red-100 text-red-700',
                                        'Rejected':  'bg-red-200 text-red-800',
                                    };
                                    const icon = {
                                        'Pending':'â³','Confirmed':'âœ…','Shipped':'ðŸšš',
                                        'Delivered':'âœ…','Cancelled':'ðŸš«','Rejected':'âŒ',
                                    };
                                    return <span className={`px-2 py-0.5 rounded-full text-xs font-extrabold ${map[status]||'bg-gray-100 text-gray-600'}`}>{icon[status]||''} {status}</span>;
                                };

                            return (<>
                            {/* Desktop Table */}
                            <div className="hidden md:block overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 uppercase text-xs">
                                        <tr>
                                            <th className="p-3">Order ID</th>
                                            <th className="p-3">Customer</th>
                                            <th className="p-3">Date</th>
                                            <th className="p-3">Total</th>
                                            <th className="p-3">Payment</th>
                                            <th className="p-3">Assigned</th>
                                            <th className="p-3">Status</th>
                                            <th className="p-3">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {orders.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o => (
                                            <tr key={o.orderId} className={`border-b hover:bg-gray-50 ${o.status==='Pending'?'bg-yellow-50/40':o.status==='Rejected'?'bg-red-50/30':''}`}>
                                                <td className="p-3 text-xs font-mono text-gray-500">#{o.orderId}</td>
                                                <td className="p-3 max-w-[140px] truncate">{o.userEmail}</td>
                                                <td className="p-3 text-xs text-gray-500">{o.date}</td>
                                                <td className="p-3 font-extrabold text-danger">{formatCurrency(o.total)}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${o.paymentMethod==='upi'?'bg-upi-light text-upi':'bg-green-100 text-green-800'}`}>
                                                        {o.paymentMethod==='upi'?'UPI':'COD'}{o.paymentStatus?` Â· ${o.paymentStatus}`:''}
                                                    </span>
                                                </td>
                                                <td className="p-3">
                                                    {(o.status==='Pending'||o.status==='Confirmed'||o.status==='Shipped') ? (
                                                        <select className="text-xs border rounded-lg px-2 py-1 bg-white"
                                                            value={o.assignedTo||''}
                                                            onChange={e => handleAssignDelivery(o.orderId, e.target.value)}>
                                                            <option value="">Assignâ€¦</option>
                                                            <option>Delivery Boy 1</option>
                                                            <option>Delivery Boy 2</option>
                                                            <option>Delivery Boy 3</option>
                                                            <option>Self Pickup</option>
                                                        </select>
                                                    ) : <span className="text-xs text-gray-400">{o.assignedTo||'â€”'}</span>}
                                                </td>
                                                <td className="p-3">{orderStatusBadge(o.status)}</td>
                                                <td className="p-3 whitespace-nowrap">
                                                    <button onClick={() => setOrderToView(o)}
                                                        className="text-primary hover:text-primary-dark text-xs font-semibold bg-primary/10 px-3 py-1.5 rounded-lg hover:bg-primary/20 transition">
                                                        <i className="fa-solid fa-eye mr-1"></i>View
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {/* Mobile Card View */}
                            <div className="md:hidden p-3 space-y-3 max-h-[70vh] overflow-y-auto">
                                {orders.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o => (
                                    <div key={o.orderId} className={`rounded-2xl border-2 overflow-hidden ${o.status==='Pending'?'border-yellow-300 bg-yellow-50/30':o.status==='Confirmed'?'border-blue-300 bg-blue-50/20':o.status==='Shipped'?'border-purple-300 bg-purple-50/20':o.status==='Delivered'?'border-green-300 bg-green-50/20':o.status==='Rejected'?'border-red-300 bg-red-50/20':'border-gray-200 bg-white'}`}>
                                        {/* Card header */}
                                        <div className="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-100">
                                            <div>
                                                <span className="font-extrabold text-primary text-sm">#{o.orderId}</span>
                                                <p className="text-[11px] text-gray-500 mt-0.5 truncate max-w-[180px]">{o.userEmail}</p>
                                            </div>
                                            {orderStatusBadge(o.status)}
                                        </div>

                                        <div className="px-4 py-3 space-y-2">
                                            {/* Amount + payment + date */}
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-xl font-extrabold text-danger">{formatCurrency(o.total)}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${o.paymentMethod==='upi'?'bg-upi-light text-upi':'bg-green-100 text-green-800'}`}>
                                                        {o.paymentMethod==='upi'?'UPI':'COD'}
                                                    </span>
                                                </div>
                                                <span className="text-xs text-gray-400">{o.date}</span>
                                            </div>

                                            {/* Address if present */}
                                            {o.address && (
                                                <p className="text-xs text-gray-500 flex items-start gap-1">
                                                    <i className="fa-solid fa-location-dot text-accent mt-0.5 flex-shrink-0"></i>
                                                    <span className="line-clamp-1">{o.address}</span>
                                                </p>
                                            )}

                                            {/* Assign delivery for active orders */}
                                            {(o.status==='Pending'||o.status==='Confirmed'||o.status==='Shipped') && (
                                                <select className="w-full text-xs border rounded-xl px-3 py-2 bg-white"
                                                    value={o.assignedTo||''}
                                                    onChange={e => handleAssignDelivery(o.orderId, e.target.value)}>
                                                    <option value="">Assign Deliveryâ€¦</option>
                                                    <option>Delivery Boy 1</option>
                                                    <option>Delivery Boy 2</option>
                                                    <option>Delivery Boy 3</option>
                                                    <option>Self Pickup</option>
                                                </select>
                                            )}

                                            {/* Action buttons */}
                                            <button onClick={() => setOrderToView(o)}
                                                className="w-full bg-primary text-white py-2.5 rounded-xl text-sm font-extrabold hover:bg-primary-dark transition flex items-center justify-center gap-2">
                                                <i className="fa-solid fa-eye"></i> View & Manage Order
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            </>);
                            })()}
                        </div>
                        </div>
                    )}

                    {tab === 'users' && (
                        <div className="space-y-4">
                            {/* User Search Section */}
                            <div className="bg-white p-4 rounded-xl shadow-md">
                                <h3 className="font-bold text-primary mb-3 flex items-center">
                                    <i className="fa-solid fa-search mr-2"></i> Search User by Email
                                </h3>
                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        className="text-input-style flex-1"
                                        placeholder="Enter user email..."
                                        value={userSearchEmail}
                                        onChange={e => setUserSearchEmail(e.target.value)}
                                    />
                                    <button
                                        onClick={handleSearchUserByEmail}
                                        className="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark"
                                    >
                                        Search
                                    </button>
                                </div>
                                {/* Search Result */}
                                {searchedUser && (
                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-bold text-primary">Search Result</h4>
                                            <button onClick={() => setSearchedUser(null)} className="text-gray-500 text-sm">
                                                <i className="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                                            <div><span className="text-gray-500">Name:</span> <strong>{searchedUser.name}</strong></div>
                                            <div><span className="text-gray-500">Email:</span> <strong className="text-xs">{searchedUser.email}</strong></div>
                                            <div><span className="text-gray-500">Role:</span> <strong className="capitalize">{searchedUser.role}</strong></div>
                                            <div><span className="text-gray-500">Status:</span> <strong className={searchedUser.status === 'banned' ? 'text-danger' : 'text-success'}>{searchedUser.status || 'active'}</strong></div>
                                            <div><span className="text-gray-500">Coins:</span> <strong className="text-success">{searchedUser.coins || 0}</strong></div>
                                            <div><span className="text-gray-500">Phone:</span> <strong>{searchedUser.phone || '-'}</strong></div>
                                        </div>
                                        {searchedUser.role !== 'admin' && (
                                            <div className="flex gap-2 flex-wrap">
                                                <button
                                                    onClick={() => handleToggleUserStatus(searchedUser.email, searchedUser.status)}
                                                    className={`text-xs font-bold px-3 py-2 rounded-lg ${searchedUser.status === 'banned' ? 'bg-success text-white' : 'bg-accent text-primary-dark'}`}
                                                >
                                                    <i className={`fa-solid ${searchedUser.status === 'banned' ? 'fa-circle-check' : 'fa-ban'} mr-1`}></i>
                                                    {searchedUser.status === 'banned' ? 'Unban' : 'Ban'}
                                                </button>
                                                <button
                                                    onClick={() => setUserToResetPassword(searchedUser)}
                                                    className="text-xs font-bold px-3 py-2 rounded-lg bg-info text-white"
                                                >
                                                    <i className="fa-solid fa-key mr-1"></i> Reset Password
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteUser(searchedUser.email)}
                                                    className="text-xs font-bold px-3 py-2 rounded-lg bg-danger text-white"
                                                >
                                                    <i className="fa-solid fa-trash mr-1"></i> Delete User
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Users List */}
                            <div className="bg-white rounded-xl shadow-md">
                                <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                    <span><i className="fa-solid fa-users mr-2"></i> Users</span>
                                    <span className="text-sm bg-primary/10 px-3 py-1 rounded-full">{users.length}</span>
                                </h2>

                                {/* Desktop Table View */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 uppercase"><tr><th className="p-3">Name</th><th className="p-3">Email</th><th className="p-3">Role</th><th className="p-3">Coins</th><th className="p-3">Status</th><th className="p-3">Actions</th></tr></thead>
                                        <tbody>
                                            {users.map(u => (
                                                <tr key={u.email} className="border-b hover:bg-gray-50">
                                                    <td className="p-3 font-semibold">{u.name}</td>
                                                    <td className="p-3 text-xs">{u.email}</td>
                                                    <td className="p-3 capitalize">{u.role}</td>
                                                    <td className="p-3 text-success font-bold">{u.coins || 0}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${u.status === 'banned' ? 'bg-danger text-white' : 'bg-success/20 text-success'}`}>{u.status || 'active'}</span>
                                                    </td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        {u.role !== 'admin' && (
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleToggleUserStatus(u.email, u.status)} className={`text-xs font-semibold px-2 py-1 rounded-md transition ${u.status === 'banned' ? 'bg-success text-white hover:bg-success/80' : 'bg-accent text-primary-dark hover:bg-accent-hover'}`}>
                                                                    <i className={`fa-solid ${u.status === 'banned' ? 'fa-circle-check' : 'fa-ban'}`}></i>
                                                                </button>
                                                                <button onClick={() => setUserToResetPassword(u)} className="text-xs font-semibold px-2 py-1 rounded-md bg-info text-white hover:bg-info/80">
                                                                    <i className="fa-solid fa-key"></i>
                                                                </button>
                                                                <button onClick={() => handleDeleteUser(u.email)} className="text-xs font-semibold px-2 py-1 rounded-md bg-danger text-white hover:bg-danger/80">
                                                                    <i className="fa-solid fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden p-3 space-y-3 max-h-[70vh] overflow-y-auto">
                                    {users.map(u => (
                                        <div key={u.email} className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold ${u.role === 'admin' ? 'bg-danger' : u.status === 'banned' ? 'bg-gray-400' : 'bg-primary'}`}>
                                                        {u.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-gray-800">{u.name}</h3>
                                                        <p className="text-xs text-gray-500 truncate max-w-[180px]">{u.email}</p>
                                                    </div>
                                                </div>
                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${u.status === 'banned' ? 'bg-danger text-white' : 'bg-success/20 text-success'}`}>{u.status || 'active'}</span>
                                            </div>
                                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full font-medium capitalize">{u.role}</span>
                                                    <span className="text-sm font-bold text-success flex items-center">
                                                        <i className="fa-solid fa-coins mr-1"></i> {u.coins || 0}
                                                    </span>
                                                </div>
                                                {u.role !== 'admin' && (
                                                    <div className="flex gap-1">
                                                        <button onClick={() => handleToggleUserStatus(u.email, u.status)} className={`text-xs font-bold px-3 py-2 rounded-lg touch-target ${u.status === 'banned' ? 'bg-success text-white' : 'bg-accent text-primary-dark'}`}>
                                                            <i className={`fa-solid ${u.status === 'banned' ? 'fa-circle-check' : 'fa-ban'}`}></i>
                                                        </button>
                                                        <button onClick={() => setUserToResetPassword(u)} className="text-xs font-bold px-3 py-2 rounded-lg bg-info text-white touch-target">
                                                            <i className="fa-solid fa-key"></i>
                                                        </button>
                                                        <button onClick={() => handleDeleteUser(u.email)} className="text-xs font-bold px-3 py-2 rounded-lg bg-danger text-white touch-target">
                                                            <i className="fa-solid fa-trash"></i>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'coupons' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                {/* Add Coupon Form */}
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border-t-4 border-success">
                                    <h2 className="text-lg md:text-xl font-bold mb-4 text-success flex items-center">
                                        <i className="fa-solid fa-tag mr-2"></i> Add Coupon
                                    </h2>
                                    <form onSubmit={handleAddCoupon} className="space-y-3">
                                        <input required className="text-input-style uppercase" placeholder="Coupon Code (e.g., SAVE20)" value={newCoupon.code} onChange={e => setNewCoupon({...newCoupon, code:e.target.value.toUpperCase()})} />

                                        <div className='grid grid-cols-2 gap-2'>
                                            <select required className="text-input-style" value={newCoupon.discountType} onChange={e => setNewCoupon({...newCoupon, discountType:e.target.value})}>
                                                <option value="fixed">Fixed (â‚¹)</option>
                                                <option value="percentage">Percent (%)</option>
                                            </select>
                                            <input
                                                required
                                                type="number"
                                                step="0.01"
                                                className="text-input-style"
                                                placeholder="Value"
                                                value={newCoupon.discountValue}
                                                onChange={e => setNewCoupon({...newCoupon, discountValue:e.target.value})}
                                            />
                                        </div>

                                        <input type="number" step="0.01" className="text-input-style" placeholder="Min Order (â‚¹0)" value={newCoupon.minOrder} onChange={e => setNewCoupon({...newCoupon, minOrder:e.target.value})} />

                                        <button type="submit" className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition shadow-md touch-target">
                                            <i className="fa-solid fa-plus-circle mr-2"></i> Add Coupon
                                        </button>
                                    </form>
                                </div>

                                {/* Coupon Validation Test */}
                                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-info">
                                    <h3 className="font-bold text-info mb-3 flex items-center">
                                        <i className="fa-solid fa-check-double mr-2"></i> Test Coupon
                                    </h3>
                                    <div className="space-y-3">
                                        <input
                                            className="text-input-style uppercase"
                                            placeholder="Coupon Code"
                                            value={couponValidationTest.code}
                                            onChange={e => setCouponValidationTest({...couponValidationTest, code: e.target.value.toUpperCase()})}
                                        />
                                        <input
                                            type="number"
                                            className="text-input-style"
                                            placeholder="Order Amount (â‚¹)"
                                            value={couponValidationTest.amount}
                                            onChange={e => setCouponValidationTest({...couponValidationTest, amount: e.target.value})}
                                        />
                                        <button
                                            type="button"
                                            onClick={handleValidateCoupon}
                                            className="w-full bg-info text-white p-2 rounded-lg font-bold hover:bg-info/80 transition text-sm"
                                        >
                                            Validate Coupon
                                        </button>
                                        {validationResult && (
                                            <div className={`p-3 rounded-lg text-sm ${validationResult.status === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                                {validationResult.status === 'success' ? (
                                                    <>
                                                        <p className="font-bold"><i className="fa-solid fa-check-circle mr-1"></i> Valid!</p>
                                                        <p>Discount: {formatCurrency(validationResult.discountAmount || 0)}</p>
                                                        <p>New Total: {formatCurrency(validationResult.newTotal || 0)}</p>
                                                    </>
                                                ) : (
                                                    <p><i className="fa-solid fa-times-circle mr-1"></i> {validationResult.message}</p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2 bg-white rounded-xl shadow-md">
                                <h2 className="text-lg md:text-xl font-bold p-4 border-b text-success flex items-center justify-between">
                                    <span><i className="fa-solid fa-tags mr-2"></i> Coupons</span>
                                    <span className="text-sm bg-success/10 px-3 py-1 rounded-full">{coupons.length}</span>
                                </h2>

                                {/* Desktop Table View */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 uppercase"><tr><th className="p-3">Code</th><th className="p-3">Type</th><th className="p-3">Discount</th><th className="p-3">Min Order</th><th className="p-3">Status</th><th className="p-3">Actions</th></tr></thead>
                                        <tbody>
                                            {coupons.map(coupon => (
                                                <tr key={coupon.code} className={`border-b hover:bg-gray-50 ${coupon.active === false ? 'bg-gray-100 opacity-60' : ''}`}>
                                                    <td className="p-3 font-semibold text-primary">{coupon.code}</td>
                                                    <td className="p-3 capitalize">{coupon.discountType}</td>
                                                    <td className="p-3 font-bold text-danger">{getCouponDisplayValue(coupon)}</td>
                                                    <td className="p-3">{formatCurrency(coupon.minOrder)}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${coupon.active === false ? 'bg-gray-300 text-gray-600' : 'bg-success/20 text-success'}`}>
                                                            {coupon.active === false ? 'Inactive' : 'Active'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        <button onClick={() => handleToggleCoupon(coupon.code)} className={`text-xs font-semibold mr-2 px-2 py-1 rounded ${coupon.active === false ? 'bg-success text-white' : 'bg-gray-400 text-white'}`}>
                                                            <i className={`fa-solid ${coupon.active === false ? 'fa-toggle-on' : 'fa-toggle-off'}`}></i>
                                                        </button>
                                                        <button onClick={() => setCouponToEdit({...coupon})} className="text-info hover:text-info/80 text-xs font-semibold mr-2"><i className='fa-solid fa-edit'></i></button>
                                                        <button onClick={() => handleDeleteCoupon(coupon.code)} className="text-danger hover:text-danger/80 text-xs font-semibold"><i className='fa-solid fa-trash'></i></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden p-3 space-y-3 max-h-[60vh] overflow-y-auto">
                                    {coupons.length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">No coupons yet</div>
                                    ) : coupons.map(coupon => (
                                        <div key={coupon.code} className={`rounded-xl p-4 border-2 border-dashed ${coupon.active === false ? 'bg-gray-100 border-gray-300 opacity-60' : 'bg-gradient-to-r from-success/5 to-success/10 border-success/30'}`}>
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-mono font-bold text-lg text-primary bg-white px-3 py-1 rounded-lg shadow-sm">{coupon.code}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${coupon.active === false ? 'bg-gray-300 text-gray-600' : 'bg-success/20 text-success'}`}>
                                                        {coupon.active === false ? 'OFF' : 'ON'}
                                                    </span>
                                                </div>
                                                <span className="text-lg font-extrabold text-danger">{getCouponDisplayValue(coupon)}</span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="text-sm">
                                                    <span className="text-gray-500">Min: </span>
                                                    <span className="font-semibold">{formatCurrency(coupon.minOrder)}</span>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleToggleCoupon(coupon.code)} className={`px-3 py-2 rounded-lg text-xs font-bold touch-target ${coupon.active === false ? 'bg-success text-white' : 'bg-gray-400 text-white'}`}>
                                                        <i className={`fa-solid ${coupon.active === false ? 'fa-toggle-on' : 'fa-toggle-off'}`}></i>
                                                    </button>
                                                    <button onClick={() => setCouponToEdit({...coupon})} className="bg-info text-white px-3 py-2 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-edit'></i>
                                                    </button>
                                                    <button onClick={() => handleDeleteCoupon(coupon.code)} className="bg-danger text-white px-3 py-2 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-trash'></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'support' && (
                        <div className="bg-white rounded-xl shadow-md">
                            <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                <span><i className="fa-solid fa-headset mr-2"></i> Tickets</span>
                                <div className="flex gap-2 flex-wrap">
                                    <span className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">{tickets.filter(t => t.priority === 'Urgent').length} Urgent</span>
                                    <span className="text-xs bg-danger/10 text-danger px-2 py-1 rounded-full">{tickets.filter(t => t.status === 'Open').length} Open</span>
                                    <span className="text-xs bg-success/10 text-success px-2 py-1 rounded-full">{tickets.filter(t => t.status !== 'Open').length} Closed</span>
                                </div>
                            </h2>
                            <div className="space-y-3 p-3 md:p-4 max-h-[70vh] overflow-y-auto">
                                {tickets.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">No support tickets</div>
                                ) : tickets.sort((a,b)=>{
                                    // Sort by priority first (Urgent > High > Medium > Low), then by date
                                    const priorityOrder = { 'Urgent': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
                                    const aPriority = priorityOrder[a.priority] ?? 2;
                                    const bPriority = priorityOrder[b.priority] ?? 2;
                                    if (aPriority !== bPriority) return aPriority - bPriority;
                                    return new Date(b.dateCreated) - new Date(a.dateCreated);
                                }).map(t => (
                                    <div key={t.ticketId} className={`p-4 rounded-xl border shadow-sm ${t.priority === 'Urgent' ? 'bg-red-50 border-red-200' : t.priority === 'High' ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'}`}>
                                        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className='font-bold text-primary text-sm'>#{t.ticketId} - {t.subject}</span>
                                                {/* Priority Badge */}
                                                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                                                    t.priority === 'Urgent' ? 'bg-red-500 text-white' :
                                                    t.priority === 'High' ? 'bg-orange-500 text-white' :
                                                    t.priority === 'Low' ? 'bg-gray-400 text-white' :
                                                    'bg-blue-500 text-white'
                                                }`}>
                                                    {t.priority || 'Medium'}
                                                </span>
                                            </div>
                                            <span className={`px-2 py-1 rounded-full text-white text-xs self-start sm:self-auto ${t.status==='Open'?'bg-danger':'bg-success'}`}>{t.status}</span>
                                        </div>
                                        <p className="text-xs text-gray-500 mb-2 break-all">
                                            <span className="block sm:inline">{t.email}</span>
                                            <span className="hidden sm:inline"> | </span>
                                            <span className="block sm:inline">{t.dateCreated}</span>
                                        </p>
                                        <p className="text-sm text-gray-700 my-2 italic bg-white p-2 rounded-lg">"{t.message}"</p>
                                        {t.adminReply && (
                                            <div className="bg-info/10 text-info p-3 text-sm rounded-lg mt-2 border-l-4 border-info">
                                                <span className="font-bold block mb-1">Admin Reply:</span>
                                                {t.adminReply}
                                            </div>
                                        )}
                                        {/* Admin Actions */}
                                        <div className="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-200">
                                            {t.status === 'Open' && !t.adminReply && (
                                                <button onClick={() => handleReplyTicket(t.ticketId)} className="bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-semibold touch-target">
                                                    <i className="fa-solid fa-reply mr-1"></i> Reply
                                                </button>
                                            )}
                                            {t.status === 'Open' && (
                                                <button onClick={() => handleCloseTicket(t.ticketId)} className="bg-success text-white px-3 py-1.5 rounded-lg text-xs font-semibold touch-target">
                                                    <i className="fa-solid fa-check-circle mr-1"></i> Close
                                                </button>
                                            )}
                                            {t.status === 'Open' && (
                                                <select
                                                    className="text-xs border rounded px-2 py-1.5 bg-white"
                                                    value={t.priority || 'Medium'}
                                                    onChange={e => handleUpdateTicketPriority(t.ticketId, e.target.value)}
                                                >
                                                    <option value="Low">Low Priority</option>
                                                    <option value="Medium">Medium Priority</option>
                                                    <option value="High">High Priority</option>
                                                    <option value="Urgent">Urgent</option>
                                                </select>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {tab === 'marketing' && (
                        <div className="max-w-xl mx-auto bg-white p-4 md:p-6 rounded-xl shadow-md border-t-4 border-accent">
                            <h2 className="text-xl md:text-2xl font-bold mb-2 text-primary-dark flex items-center">
                                <i className="fa-solid fa-bullhorn mr-2 text-accent"></i> Send Offer
                            </h2>

                            {/* Toggle between broadcast and targeted */}
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={() => setIsTargetedEmail(false)}
                                    className={`flex-1 py-2 rounded-lg font-semibold text-sm transition ${!isTargetedEmail ? 'bg-accent text-primary-dark' : 'bg-gray-100 text-gray-700'}`}
                                >
                                    <i className="fa-solid fa-users mr-1"></i> Broadcast
                                </button>
                                <button
                                    onClick={() => setIsTargetedEmail(true)}
                                    className={`flex-1 py-2 rounded-lg font-semibold text-sm transition ${isTargetedEmail ? 'bg-accent text-primary-dark' : 'bg-gray-100 text-gray-700'}`}
                                >
                                    <i className="fa-solid fa-user mr-1"></i> Individual
                                </button>
                            </div>

                            {!isTargetedEmail ? (
                                <p className='text-sm text-gray-600 mb-4'>
                                    Email blast to <strong className="text-primary">{users.filter(u=>u.role==='user' && u.status !== 'banned').length}</strong> active users
                                </p>
                            ) : (
                                <div className="mb-4">
                                    <label className="text-sm font-bold block mb-1">Target Email</label>
                                    <input
                                        type="email"
                                        className="text-input-style"
                                        placeholder="customer@email.com"
                                        value={targetEmail}
                                        onChange={e => setTargetEmail(e.target.value)}
                                    />
                                </div>
                            )}

                            <div className="space-y-3">
                                <div>
                                    <label className="text-sm font-bold block mb-1">Subject</label>
                                    <input id="offerSubject" required className="text-input-style" placeholder="Big Winter Sale is Here!" />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Message</label>
                                    <textarea id="offerMessage" required className="text-input-style" rows="4" placeholder="Dear Customer, use code WINTER20 for 20% off all items!"></textarea>
                                </div>
                                {isTargetedEmail ? (
                                    <button onClick={handleSendTargetedEmail} className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition shadow-md touch-target">
                                        <i className="fa-solid fa-paper-plane mr-2"></i> Send to {targetEmail || 'User'}
                                    </button>
                                ) : (
                                    <button onClick={handleSendOffer} className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold hover:bg-accent-hover transition shadow-md touch-target">
                                        <i className="fa-solid fa-paper-plane mr-2"></i> Send to All Users
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Grocery Lists Tab */}
                    {tab === 'grocerylists' && (
                        <div className="space-y-4">
                            {/* Header */}
                            <div className="flex items-center justify-between">
                                <h2 className="text-lg md:text-xl font-bold text-primary flex items-center gap-2">
                                    <i className="fa-solid fa-list-check"></i> Customer Grocery Orders
                                    <span className="bg-primary/10 text-primary text-sm px-2 py-0.5 rounded-full font-semibold">{groceryLists.length}</span>
                                </h2>
                                <button onClick={fetchData} className="text-sm bg-primary/10 text-primary px-3 py-1 rounded-lg hover:bg-primary/20 flex items-center gap-1">
                                    <i className="fa-solid fa-refresh"></i> Refresh
                                </button>
                            </div>

                            {/* Accept/Reject inline modal */}
                            {glAction && (
                                <div className="fixed inset-0 bg-black/50 z-50 flex items-end md:items-center justify-center p-4" onClick={() => setGlAction(null)}>
                                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6" onClick={e => e.stopPropagation()}>
                                        {glAction.type === 'accept' ? (
                                            <>
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                                                        <i className="fa-solid fa-check text-green-600 text-xl"></i>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-extrabold text-gray-900">Accept Order</h3>
                                                        <p className="text-sm text-gray-500">{glAction.listId}</p>
                                                    </div>
                                                </div>
                                                <p className="text-sm text-gray-600 mb-3">Customer will receive an <strong>acceptance confirmation email</strong> with their order details.</p>
                                                <div className="mb-4">
                                                    <label className="text-xs font-bold text-gray-600 block mb-1">Message to Customer (optional)</label>
                                                    <textarea
                                                        rows="2"
                                                        placeholder="e.g. Your order will be delivered by 5pm today."
                                                        className="text-input-style text-sm resize-none"
                                                        value={glAction.note || ''}
                                                        onChange={e => setGlAction(a => ({ ...a, note: e.target.value }))}
                                                    />
                                                </div>
                                                <div className="flex gap-3">
                                                    <button onClick={handleAcceptOrder}
                                                        className="flex-1 bg-success text-white py-3 rounded-xl font-extrabold hover:bg-green-600 transition shadow-md flex items-center justify-center gap-2">
                                                        <i className="fa-solid fa-check-circle"></i> Confirm Accept
                                                    </button>
                                                    <button onClick={() => setGlAction(null)}
                                                        className="bg-gray-100 text-gray-600 px-5 py-3 rounded-xl font-bold hover:bg-gray-200 transition">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="flex items-center gap-3 mb-4">
                                                    <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                                                        <i className="fa-solid fa-xmark text-red-600 text-xl"></i>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-extrabold text-gray-900">Reject Order</h3>
                                                        <p className="text-sm text-gray-500">{glAction.listId}</p>
                                                    </div>
                                                </div>
                                                <p className="text-sm text-gray-600 mb-3">Customer will receive a <strong>rejection email with your reason</strong>.</p>
                                                <div className="mb-4">
                                                    <label className="text-xs font-bold text-gray-600 block mb-1">Reason for Rejection <span className="text-red-500">*</span></label>
                                                    <textarea
                                                        rows="3"
                                                        placeholder="e.g. Some items are out of stock. Please reorder after 2 days."
                                                        className="text-input-style text-sm resize-none border-red-200 focus:border-red-400"
                                                        value={glAction.reason || ''}
                                                        onChange={e => setGlAction(a => ({ ...a, reason: e.target.value }))}
                                                    />
                                                </div>
                                                <div className="flex gap-3">
                                                    <button onClick={handleRejectOrder}
                                                        className="flex-1 bg-danger text-white py-3 rounded-xl font-extrabold hover:bg-red-600 transition shadow-md flex items-center justify-center gap-2">
                                                        <i className="fa-solid fa-circle-xmark"></i> Send Rejection
                                                    </button>
                                                    <button onClick={() => setGlAction(null)}
                                                        className="bg-gray-100 text-gray-600 px-5 py-3 rounded-xl font-bold hover:bg-gray-200 transition">
                                                        Cancel
                                                    </button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            )}

                            {groceryLists.length === 0 ? (
                                <div className="text-center py-16 text-gray-400 bg-white rounded-xl border">
                                    <i className="fa-solid fa-list-check text-4xl mb-3"></i>
                                    <p className="font-semibold">No grocery orders submitted yet.</p>
                                </div>
                            ) : [...groceryLists].reverse().map((gl, idx) => {
                                const parseGLItems = (s) => { try { return JSON.parse(s); } catch(e) { return []; } };
                                const glItems = parseGLItems(gl.items);
                                const hasFile = !!(gl.fileUrl);
                                const isPending = gl.status === 'Pending';
                                const isAccepted = gl.status === 'Accepted';
                                const isRejected = gl.status === 'Rejected';
                                const statusColors = {
                                    'Pending':    'bg-yellow-100 text-yellow-800 border-yellow-200',
                                    'Accepted':   'bg-green-100 text-green-800 border-green-200',
                                    'Processing': 'bg-blue-100 text-blue-800 border-blue-200',
                                    'Ready':      'bg-purple-100 text-purple-800 border-purple-200',
                                    'Delivered':  'bg-gray-100 text-gray-700 border-gray-200',
                                    'Rejected':   'bg-red-100 text-red-700 border-red-200',
                                    'Cancelled':  'bg-red-50 text-red-600 border-red-100',
                                };
                                const postAcceptStatuses = ['Processing', 'Ready', 'Delivered'];
                                return (
                                    <div key={idx} className={`bg-white rounded-xl shadow-sm overflow-hidden border-2 ${isAccepted?'border-green-300':isRejected?'border-red-200':isPending?'border-yellow-300':'border-gray-200'}`}>
                                        {/* Card header */}
                                        <div className="flex flex-wrap items-start justify-between gap-2 p-4 border-b border-gray-100 bg-gray-50">
                                            <div className="min-w-0">
                                                <p className="font-extrabold text-primary-dark text-sm">{gl.listId}</p>
                                                <p className="text-sm text-gray-600 mt-0.5">
                                                    <i className="fa-solid fa-user mr-1 text-xs"></i>{gl.userName}
                                                    <span className="text-gray-400 text-xs ml-1">({gl.userEmail})</span>
                                                </p>
                                                {gl.phone && <p className="text-xs text-gray-500 mt-0.5"><i className="fa-solid fa-phone mr-1 text-xs"></i>{gl.phone}</p>}
                                                <p className="text-xs text-gray-400 mt-1">{new Date(gl.dateSubmitted).toLocaleString('en-IN')}</p>
                                            </div>
                                            <span className={`px-3 py-1 rounded-full text-xs font-extrabold border flex-shrink-0 ${statusColors[gl.status] || 'bg-gray-100 text-gray-600 border-gray-200'}`}>
                                                {gl.status === 'Accepted' ? 'âœ… Accepted' : gl.status === 'Rejected' ? 'âŒ Rejected' : gl.status === 'Pending' ? 'â³ Pending' : gl.status}
                                            </span>
                                        </div>

                                        <div className="p-4 space-y-3">
                                            {/* Delivery + Payment */}
                                            {(gl.address || gl.paymentMethod) && (
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs">
                                                    {gl.paymentMethod && (
                                                        <div className="flex items-center gap-2 bg-gray-50 rounded-lg p-2 border border-gray-100">
                                                            <i className={`fa-solid ${gl.paymentMethod==='upi'?'fa-qrcode text-purple-600':'fa-hand-holding-dollar text-green-600'}`}></i>
                                                            <div>
                                                                <p className="font-bold text-gray-700">{(gl.paymentMethod||'').toUpperCase()}</p>
                                                                <p className="text-gray-400">Payment method</p>
                                                            </div>
                                                        </div>
                                                    )}
                                                    {gl.address && (
                                                        <div className="flex items-start gap-2 bg-gray-50 rounded-lg p-2 border border-gray-100">
                                                            <i className="fa-solid fa-location-dot text-accent mt-0.5 flex-shrink-0"></i>
                                                            <div>
                                                                <p className="font-bold text-gray-700">Delivery Address</p>
                                                                <p className="text-gray-500 whitespace-pre-line">{gl.address}</p>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            )}

                                            {/* File upload */}
                                            {hasFile && (
                                                <div className="flex items-center justify-between bg-blue-50 rounded-lg p-3 border border-blue-100">
                                                    <div className="flex items-center gap-2 text-sm">
                                                        <i className="fa-brands fa-google-drive text-blue-500 text-lg"></i>
                                                        <div>
                                                            <p className="font-semibold text-blue-800">{gl.fileName || 'Uploaded File'}</p>
                                                            <p className="text-xs text-blue-500">{gl.fileType}</p>
                                                        </div>
                                                    </div>
                                                    <a href={gl.fileUrl} target="_blank" rel="noopener noreferrer"
                                                        className="text-xs text-blue-600 hover:underline font-bold bg-blue-100 px-3 py-1.5 rounded-lg flex items-center gap-1">
                                                        <i className="fa-solid fa-external-link-alt"></i> Open
                                                    </a>
                                                </div>
                                            )}

                                            {/* Items table */}
                                            {glItems.length > 0 && (
                                                <div className="overflow-x-auto">
                                                    <table className="w-full text-sm">
                                                        <thead><tr className="text-xs text-gray-500 border-b bg-gray-50">
                                                            <th className="text-left py-2 px-1">Item</th>
                                                            <th className="text-center py-2 px-1 w-14">Qty</th>
                                                            <th className="text-left py-2 px-1 w-16">Unit</th>
                                                        </tr></thead>
                                                        <tbody>
                                                            {glItems.map((it, i) => (
                                                                <tr key={i} className="border-b border-gray-50">
                                                                    <td className="py-1.5 px-1 font-medium">{it.name}</td>
                                                                    <td className="py-1.5 px-1 text-center text-gray-700">{it.quantity}</td>
                                                                    <td className="py-1.5 px-1 text-gray-500 text-xs">{it.unit}</td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            )}

                                            {gl.notes && <p className="text-xs text-gray-600 bg-yellow-50 border border-yellow-100 rounded-lg p-2"><i className="fa-solid fa-note-sticky mr-1 text-yellow-500"></i><strong>Customer Note:</strong> {gl.notes}</p>}

                                            {gl.adminNote && (
                                                <div className={`rounded-lg p-2.5 text-xs flex items-start gap-2 ${isRejected?'bg-red-50 border border-red-200 text-red-800':'bg-green-50 border border-green-200 text-green-800'}`}>
                                                    <i className={`fa-solid ${isRejected?'fa-circle-xmark':'fa-comment-dots'} mt-0.5 flex-shrink-0`}></i>
                                                    <span><strong>{isRejected?'Rejection Reason':'Store Message'}:</strong> {gl.adminNote}</span>
                                                </div>
                                            )}

                                            {/* Action Buttons */}
                                            <div className="pt-2 border-t border-gray-100">
                                                {isPending && (
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => setGlAction({ listId: gl.listId, type: 'accept', note: '' })}
                                                            className="flex-1 bg-success text-white py-2.5 rounded-xl font-extrabold text-sm hover:bg-green-600 transition shadow-sm flex items-center justify-center gap-2"
                                                        >
                                                            <i className="fa-solid fa-check-circle"></i> Accept Order
                                                        </button>
                                                        <button
                                                            onClick={() => setGlAction({ listId: gl.listId, type: 'reject', reason: '' })}
                                                            className="flex-1 bg-danger text-white py-2.5 rounded-xl font-extrabold text-sm hover:bg-red-600 transition shadow-sm flex items-center justify-center gap-2"
                                                        >
                                                            <i className="fa-solid fa-circle-xmark"></i> Reject
                                                        </button>
                                                    </div>
                                                )}
                                                {isAccepted && (
                                                    <div className="flex flex-wrap gap-2 items-center">
                                                        <span className="text-xs text-gray-500 font-semibold">Update status:</span>
                                                        {postAcceptStatuses.map(s => (
                                                            <button key={s}
                                                                onClick={() => handleGLStatusUpdate(gl.listId, s)}
                                                                className={`text-xs px-3 py-1.5 rounded-full font-bold border transition ${gl.status===s?'bg-primary text-white border-primary':'bg-white text-gray-600 border-gray-200 hover:border-primary hover:text-primary'}`}>
                                                                {s}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                                {(gl.status==='Processing'||gl.status==='Ready') && (
                                                    <div className="flex flex-wrap gap-2 items-center">
                                                        <span className="text-xs text-gray-500 font-semibold">Update:</span>
                                                        {postAcceptStatuses.map(s => (
                                                            <button key={s}
                                                                onClick={() => handleGLStatusUpdate(gl.listId, s)}
                                                                className={`text-xs px-3 py-1.5 rounded-full font-bold border transition ${gl.status===s?'bg-primary text-white border-primary':'bg-white text-gray-600 border-gray-200 hover:border-primary hover:text-primary'}`}>
                                                                {s}
                                                            </button>
                                                        ))}
                                                    </div>
                                                )}
                                                {(isRejected || gl.status==='Delivered' || gl.status==='Cancelled') && (
                                                    <p className="text-xs text-gray-400 text-center py-1">This order is closed.</p>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                    {/* Festival Banners Tab */}
                    {/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */}
                    {tab === 'banners' && (
                        <div className="space-y-6">
                            {/* Header */}
                            <div className="flex items-center justify-between">
                                <h2 className="text-lg md:text-xl font-bold text-primary-dark flex items-center gap-2">
                                    <i className="fa-solid fa-flag text-accent"></i> Festival Banners
                                    <span className="text-xs bg-accent/10 text-accent px-2 py-1 rounded-full">{adminBanners.length} total</span>
                                </h2>
                                <button onClick={fetchData} className="text-sm bg-primary/10 text-primary px-3 py-1 rounded-lg hover:bg-primary/20 transition">
                                    <i className="fa-solid fa-refresh mr-1"></i> Refresh
                                </button>
                            </div>

                            {/* Add / Edit Banner Form */}
                            <div className="bg-white rounded-2xl shadow-md p-5 border border-gray-100">
                                <h3 className="text-base font-bold text-primary-dark mb-4 flex items-center gap-2">
                                    <i className={`fa-solid ${editingBanner ? 'fa-pen-to-square text-accent' : 'fa-plus-circle text-success'}`}></i>
                                    {editingBanner ? 'Edit Banner' : 'Add New Banner'}
                                </h3>

                                {/* Festival Presets */}
                                <div className="mb-4">
                                    <label className="block text-xs font-semibold text-gray-600 mb-2 uppercase tracking-wide">Quick Festival Presets</label>
                                    <div className="flex flex-wrap gap-2">
                                        {FESTIVAL_PRESETS.map(fp => (
                                            <button
                                                key={fp.label}
                                                onClick={() => applyPreset(fp.label, editingBanner ? 'edit' : 'add')}
                                                className="flex items-center gap-1 px-3 py-1.5 rounded-full text-xs font-semibold text-white shadow hover:scale-105 active:scale-95 transition-transform"
                                                style={{ background: fp.bg }}
                                            >
                                                <span>{fp.emoji}</span> {fp.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Live Preview */}
                                <div className="mb-4 rounded-xl overflow-hidden h-24 flex items-center justify-center relative"
                                    style={{ background: bannerForm.bgColor }}>
                                    <div className="absolute inset-0 opacity-20"
                                        style={{ background: 'repeating-linear-gradient(45deg,rgba(255,255,255,0.1) 0,rgba(255,255,255,0.1) 2px,transparent 0,transparent 50%)', backgroundSize: '12px 12px' }}>
                                    </div>
                                    <div className="relative text-center px-4">
                                        <div className="text-3xl mb-1" style={{ animation: 'bannerFloat 3s ease-in-out infinite' }}>{bannerForm.emoji || 'ðŸŽ‰'}</div>
                                        <div className="text-white font-bold text-sm shimmer-text">{bannerForm.title || 'Banner Title'}</div>
                                        {bannerForm.subtitle && <div className="text-white/80 text-xs">{bannerForm.subtitle}</div>}
                                    </div>
                                    <div className="absolute top-2 right-2 bg-white/20 text-white text-xs px-2 py-0.5 rounded-full backdrop-blur-sm">Preview</div>
                                </div>

                                {/* Form Fields */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1">Title *</label>
                                        <input
                                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary"
                                            placeholder="e.g. Diwali Sale!"
                                            value={bannerForm.title}
                                            onChange={e => setBannerForm(f => ({ ...f, title: e.target.value }))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1">Subtitle</label>
                                        <input
                                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary"
                                            placeholder="e.g. Up to 50% off on sweets"
                                            value={bannerForm.subtitle}
                                            onChange={e => setBannerForm(f => ({ ...f, subtitle: e.target.value }))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1">Emoji / Icon</label>
                                        <input
                                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary"
                                            placeholder="ðŸŽ‰"
                                            value={bannerForm.emoji}
                                            onChange={e => setBannerForm(f => ({ ...f, emoji: e.target.value }))}
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-gray-600 mb-1">Image URL (optional)</label>
                                        <input
                                            className="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-primary"
                                            placeholder="https://... (banner image)"
                                            value={bannerForm.imageUrl}
                                            onChange={e => setBannerForm(f => ({ ...f, imageUrl: e.target.value }))}
                                        />
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs font-semibold text-gray-600 mb-1">Background (CSS gradient or color)</label>
                                        <div className="flex gap-2">
                                            <input
                                                className="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm font-mono focus:outline-none focus:border-primary"
                                                placeholder="linear-gradient(135deg,#FF6B35,#FFD700)"
                                                value={bannerForm.bgColor}
                                                onChange={e => setBannerForm(f => ({ ...f, bgColor: e.target.value }))}
                                            />
                                            <div className="w-10 h-10 rounded-lg border border-gray-200 flex-shrink-0" style={{ background: bannerForm.bgColor }}></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex gap-3 flex-wrap">
                                    {editingBanner ? (
                                        <>
                                            <button
                                                onClick={handleUpdateBanner}
                                                className="flex-1 bg-accent text-white py-2 px-4 rounded-lg font-bold text-sm hover:bg-accent-hover transition shadow-md"
                                            >
                                                <i className="fa-solid fa-check mr-2"></i> Save Changes
                                            </button>
                                            <button
                                                onClick={() => { setEditingBanner(null); setBannerForm({ title:'', subtitle:'', imageUrl:'', bgColor:'linear-gradient(135deg,#FF7F50,#FF6347)', emoji:'ðŸŽ‰' }); }}
                                                className="bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-bold text-sm hover:bg-gray-300 transition"
                                            >
                                                <i className="fa-solid fa-xmark mr-1"></i> Cancel
                                            </button>
                                        </>
                                    ) : (
                                        <button
                                            onClick={handleAddBanner}
                                            className="flex-1 bg-success text-white py-2 px-4 rounded-lg font-bold text-sm hover:bg-green-600 transition shadow-md"
                                        >
                                            <i className="fa-solid fa-plus mr-2"></i> Add Banner
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Banners List */}
                            {adminBanners.length === 0 ? (
                                <div className="bg-white rounded-2xl shadow-md p-10 text-center text-gray-500">
                                    <div className="text-5xl mb-3">ðŸŽª</div>
                                    <p className="font-semibold">No festival banners yet.</p>
                                    <p className="text-sm mt-1">Add your first banner using the form above.</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <h3 className="text-sm font-bold text-gray-600 uppercase tracking-wide">
                                        <i className="fa-solid fa-list mr-1"></i> All Banners ({adminBanners.length})
                                    </h3>
                                    {adminBanners.map(banner => {
                                        const isActive = banner.isActive === 'true' || banner.isActive === true;
                                        return (
                                            <div key={banner.bannerId} className={`bg-white rounded-2xl shadow-md overflow-hidden border-2 transition-all ${isActive ? 'border-green-400' : 'border-gray-200 opacity-80'}`}>
                                                {/* Banner visual strip */}
                                                <div className="h-20 relative flex items-center px-6"
                                                    style={{ background: banner.bgColor || 'linear-gradient(135deg,#FF7F50,#FF6347)' }}>
                                                    <div className="absolute inset-0 opacity-20"
                                                        style={{ background: 'repeating-linear-gradient(45deg,rgba(255,255,255,0.1) 0,rgba(255,255,255,0.1) 2px,transparent 0,transparent 50%)', backgroundSize: '12px 12px' }}>
                                                    </div>
                                                    {banner.imageUrl ? (
                                                        <img src={banner.imageUrl} alt="" className="h-14 w-14 object-cover rounded-xl mr-4 shadow-lg flex-shrink-0" onError={e => e.target.style.display='none'} />
                                                    ) : (
                                                        <span className="text-4xl mr-4" style={{ animation: isActive ? 'bannerFloat 3s ease-in-out infinite' : 'none' }}>{banner.emoji || 'ðŸŽ‰'}</span>
                                                    )}
                                                    <div className="relative">
                                                        <div className="text-white font-bold text-base shimmer-text leading-tight">{banner.title}</div>
                                                        {banner.subtitle && <div className="text-white/80 text-xs mt-0.5">{banner.subtitle}</div>}
                                                    </div>
                                                    {/* Status badge */}
                                                    <div className={`absolute top-2 right-3 text-xs px-2 py-0.5 rounded-full font-bold ${isActive ? 'bg-green-400 text-white' : 'bg-gray-400/60 text-white'}`}>
                                                        {isActive ? 'â— Live' : 'â—‹ Off'}
                                                    </div>
                                                </div>

                                                {/* Controls */}
                                                <div className="px-4 py-3 bg-gray-50 flex items-center gap-3 flex-wrap">
                                                    {/* Toggle switch */}
                                                    <button
                                                        onClick={() => handleToggleBanner(banner.bannerId)}
                                                        className={`flex items-center gap-2 px-4 py-2 rounded-full text-xs font-bold transition shadow ${isActive ? 'bg-green-100 text-green-700 hover:bg-green-200' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
                                                    >
                                                        <span className={`w-8 h-4 rounded-full relative inline-block transition-colors ${isActive ? 'bg-green-500' : 'bg-gray-400'}`}>
                                                            <span className={`absolute top-0.5 w-3 h-3 rounded-full bg-white shadow transition-transform ${isActive ? 'translate-x-4' : 'translate-x-0.5'}`}></span>
                                                        </span>
                                                        {isActive ? 'Enabled' : 'Disabled'}
                                                    </button>

                                                    <button
                                                        onClick={() => {
                                                            setEditingBanner(banner.bannerId);
                                                            setBannerForm({
                                                                title: banner.title || '',
                                                                subtitle: banner.subtitle || '',
                                                                imageUrl: banner.imageUrl || '',
                                                                bgColor: banner.bgColor || 'linear-gradient(135deg,#FF7F50,#FF6347)',
                                                                emoji: banner.emoji || 'ðŸŽ‰'
                                                            });
                                                            window.scrollTo({ top: 0, behavior: 'smooth' });
                                                        }}
                                                        className="flex items-center gap-1 px-4 py-2 rounded-full text-xs font-bold bg-blue-100 text-blue-700 hover:bg-blue-200 transition shadow"
                                                    >
                                                        <i className="fa-solid fa-pen"></i> Edit
                                                    </button>

                                                    <button
                                                        onClick={() => {
                                                            if (window.confirm(`Delete banner "${banner.title}"?`)) handleDeleteBanner(banner.bannerId);
                                                        }}
                                                        className="flex items-center gap-1 px-4 py-2 rounded-full text-xs font-bold bg-red-100 text-red-700 hover:bg-red-200 transition shadow"
                                                    >
                                                        <i className="fa-solid fa-trash"></i> Delete
                                                    </button>

                                                    <span className="ml-auto text-xs text-gray-400">ID: {banner.bannerId}</span>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    )}

                    {/* Activity Log Tab */}
                    {tab === 'activity' && (
                        <div className="bg-white rounded-xl shadow-md">
                            <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                <span><i className="fa-solid fa-clock-rotate-left mr-2"></i> Activity Log</span>
                                <button onClick={fetchData} className="text-sm bg-primary/10 text-primary px-3 py-1 rounded-lg hover:bg-primary/20">
                                    <i className="fa-solid fa-refresh mr-1"></i> Refresh
                                </button>
                            </h2>
                            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto">
                                {activityLog.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">
                                        <i className="fa-solid fa-inbox fa-2x mb-2"></i>
                                        <p>No activity logged yet</p>
                                    </div>
                                ) : activityLog.map((activity, index) => (
                                    <div key={index} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${
                                            activity.type === 'order' ? 'bg-green-100 text-green-600' :
                                            activity.type === 'user' ? 'bg-blue-100 text-blue-600' :
                                            activity.type === 'product' ? 'bg-purple-100 text-purple-600' :
                                            activity.type === 'ticket' ? 'bg-orange-100 text-orange-600' :
                                            'bg-gray-100 text-gray-600'
                                        }`}>
                                            <i className={`fa-solid ${
                                                activity.type === 'order' ? 'fa-receipt' :
                                                activity.type === 'user' ? 'fa-user' :
                                                activity.type === 'product' ? 'fa-box' :
                                                activity.type === 'ticket' ? 'fa-ticket' :
                                                'fa-circle-info'
                                            }`}></i>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm font-semibold text-gray-800">{activity.action || activity.message}</p>
                                            <p className="text-xs text-gray-500">{activity.details || ''}</p>
                                            <p className="text-xs text-gray-400 mt-1">{activity.timestamp || activity.date}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Modals for Admin Actions */}
                    {productToEdit && (
                        <EditProductModal
                            product={productToEdit}
                            onClose={(success, message) => { setProductToEdit(null); if (success) showToast('Product updated successfully.', 'success'); else if (message) showToast(message, 'error'); }}
                            onSave={handleUpdateProduct}
                        />
                    )}
                    {orderToView && (
                        <OrderDetailModal
                            order={orderToView}
                            onClose={() => setOrderToView(null)}
                            onUpdateStatus={(id, status) => {
                                setOrderToView(prev => ({ ...prev, status }));
                                setOrders(orders.map(o => o.orderId === id ? { ...o, status } : o));
                                showToast(`Order #${id} status changed to ${status}.`, 'success');
                            }}
                            role={getRole(user)}
                        />
                    )}

                    {/* Stock Management Modal */}
                    {productToUpdateStock && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => setProductToUpdateStock(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>
                                <div className="p-6">
                                    <div className="flex justify-between items-start border-b pb-3 mb-4">
                                        <h2 className="text-xl font-bold text-primary-dark">Update Stock</h2>
                                        <button onClick={() => setProductToUpdateStock(null)} className="text-gray-500 hover:text-danger">
                                            <i className="fa-solid fa-xmark text-xl"></i>
                                        </button>
                                    </div>
                                    <div className="mb-4">
                                        <p className="font-semibold text-gray-800">{productToUpdateStock.name}</p>
                                        <p className="text-sm text-gray-500">Current Stock: <span className="font-bold text-primary">{productToUpdateStock.stock || 0}</span></p>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => {
                                                    const qty = prompt('Enter quantity to ADD:');
                                                    if (qty && parseInt(qty) > 0) handleUpdateStock(productToUpdateStock.id, 'add', qty);
                                                }}
                                                className="flex-1 bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition"
                                            >
                                                <i className="fa-solid fa-plus mr-2"></i> Add Stock
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const qty = prompt('Enter quantity to REMOVE:');
                                                    if (qty && parseInt(qty) > 0) handleUpdateStock(productToUpdateStock.id, 'remove', qty);
                                                }}
                                                className="flex-1 bg-danger text-white p-3 rounded-lg font-bold hover:bg-danger/80 transition"
                                            >
                                                <i className="fa-solid fa-minus mr-2"></i> Remove Stock
                                            </button>
                                        </div>
                                        <div>
                                            <label className="text-sm font-bold block mb-1">Set Exact Stock</label>
                                            <div className="flex gap-2">
                                                <input
                                                    type="number"
                                                    id="exactStock"
                                                    className="text-input-style flex-1"
                                                    placeholder="Enter exact quantity"
                                                    defaultValue={productToUpdateStock.stock || 0}
                                                />
                                                <button
                                                    onClick={() => {
                                                        const qty = document.getElementById('exactStock').value;
                                                        if (qty) handleUpdateStock(productToUpdateStock.id, 'set', qty);
                                                    }}
                                                    className="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark"
                                                >
                                                    Set
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Coupon Modal */}
                    {couponToEdit && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => setCouponToEdit(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const res = await handleUpdateCoupon(couponToEdit);
                                    if (res.status === 'success') setCouponToEdit(null);
                                }} className="p-6">
                                    <div className="flex justify-between items-start border-b pb-3 mb-4">
                                        <h2 className="text-xl font-bold text-primary-dark">Edit Coupon</h2>
                                        <button type="button" onClick={() => setCouponToEdit(null)} className="text-gray-500 hover:text-danger">
                                            <i className="fa-solid fa-xmark text-xl"></i>
                                        </button>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-sm font-bold block mb-1">Coupon Code</label>
                                            <input className="text-input-style bg-gray-100" value={couponToEdit.code} disabled />
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-sm font-bold block mb-1">Discount Type</label>
                                                <select
                                                    className="text-input-style"
                                                    value={couponToEdit.discountType}
                                                    onChange={e => setCouponToEdit({...couponToEdit, discountType: e.target.value})}
                                                >
                                                    <option value="fixed">Fixed (â‚¹)</option>
                                                    <option value="percentage">Percent (%)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-sm font-bold block mb-1">Value</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    className="text-input-style"
                                                    value={couponToEdit.value}
                                                    onChange={e => setCouponToEdit({...couponToEdit, value: e.target.value})}
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-sm font-bold block mb-1">Minimum Order (â‚¹)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="text-input-style"
                                                value={couponToEdit.minOrder}
                                                onChange={e => setCouponToEdit({...couponToEdit, minOrder: e.target.value})}
                                            />
                                        </div>
                                        <button type="submit" className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* User Reset Password Modal */}
                    {userToResetPassword && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => setUserToResetPassword(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>
                                <div className="p-6">
                                    <div className="flex justify-between items-start border-b pb-3 mb-4">
                                        <h2 className="text-xl font-bold text-primary-dark">Reset Password</h2>
                                        <button onClick={() => setUserToResetPassword(null)} className="text-gray-500 hover:text-danger">
                                            <i className="fa-solid fa-xmark text-xl"></i>
                                        </button>
                                    </div>
                                    <div className="mb-4">
                                        <p className="text-gray-600">Reset password for:</p>
                                        <p className="font-bold text-primary">{userToResetPassword.email}</p>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-sm font-bold block mb-1">New Password</label>
                                            <input
                                                type="password"
                                                id="adminResetPassword"
                                                className="text-input-style"
                                                placeholder="At least 6 characters"
                                            />
                                        </div>
                                        <button
                                            onClick={() => {
                                                const newPass = document.getElementById('adminResetPassword').value;
                                                handleAdminResetPassword(userToResetPassword.email, newPass);
                                            }}
                                            className="w-full bg-danger text-white p-3 rounded-lg font-bold hover:bg-danger/80 transition"
                                        >
                                            <i className="fa-solid fa-key mr-2"></i> Reset Password
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 17. SUPPORT VIEW
        // =======================================================

        const SupportView = ({ user, get, post, showToast, setView }) => {
            const [form, setForm] = useState({ subject: '', message: '', priority: 'Medium' });
            const [tickets, setTickets] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);

            const fetchTickets = async () => {
                const res = await get({ action: 'getTickets', email: user.email });
                setIsLoading(false);
                if (res.status !== 'error') setTickets(res);
            };

            useEffect(() => {
                if (getRole(user) !== 'guest') fetchTickets();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isUserBanned(user)) return showToast('Restricted accounts cannot create new tickets.', 'error');
                const res = await post({
                    action: 'createTicket',
                    email: user.email,
                    subject: form.subject,
                    message: form.message,
                    priority: form.priority,
                    sendConfirmation: true
                });
                if (res.status === 'success') {
                    showToast('Ticket created! We will respond shortly.', 'success');

                    if (res.confirmationSent) {
                        setTimeout(() => {
                            showToast('Ticket confirmation email sent to your inbox.', 'info');
                        }, 1000);
                    }

                    setForm({ subject: '', message: '', priority: 'Medium' });
                    fetchTickets();
                } else showToast(res.message, 'error');
            };

            if (getRole(user) === 'guest') return <div className="text-center py-10 text-lg md:text-xl text-gray-600 pb-24 md:pb-10">Please <button onClick={() => setView('login')} className="text-primary font-bold hover:underline">sign in</button> to contact support.</div>;
            if (isLoading) return <LoadingSpinner />;

            return (
                <div className="p-3 md:p-4 max-w-3xl mx-auto pb-24 md:pb-4">
                    <h1 className="text-xl md:text-3xl font-bold mb-4 md:mb-6 text-primary-dark border-b-2 border-primary/50 pb-2 flex items-center flex-wrap gap-2">
                        <i className="fa-solid fa-headset mr-2"></i>
                        <span>Support</span>
                        <a href="tel:9047878046" className="text-sm md:text-base bg-success text-white px-3 py-1 rounded-full ml-auto">
                            <i className="fa-solid fa-phone mr-1"></i> Call
                        </a>
                    </h1>

                    {/* Delivery Policy Notice */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck-fast text-blue-500 text-xl mr-3"></i>
                                <div>
                                    <p className="font-semibold text-gray-800">Delivery Policy</p>
                                    <p className="text-sm text-gray-600">Minimum order: â‚¹{DELIVERY_POLICY.minimumOrder} â€¢ Free delivery in select areas</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="text-sm text-primary hover:text-primary-dark font-semibold"
                            >
                                View Areas
                            </button>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow-md mb-6 border-t-4 border-success">
                        <h2 className="text-xl font-bold mb-3 text-success">Create New Ticket</h2>
                        {isUserBanned(user) && <p className='text-danger mb-3'><i className='fa-solid fa-triangle-exclamation mr-1'></i> Restricted accounts cannot create new tickets.</p>}
                        <input className="text-input-style mb-3" placeholder="Subject" value={form.subject} onChange={e => setForm({...form, subject:e.target.value})} required disabled={isUserBanned(user)} />
                        <textarea className="text-input-style mb-3" rows="3" placeholder="Describe your issue in detail..." value={form.message} onChange={e => setForm({...form, message:e.target.value})} required disabled={isUserBanned(user)} />

                        {/* Priority Selector */}
                        <div className="mb-3">
                            <label className="text-sm font-bold block mb-1 text-gray-700">Priority Level</label>
                            <select
                                className="text-input-style"
                                value={form.priority}
                                onChange={e => setForm({...form, priority: e.target.value})}
                                disabled={isUserBanned(user)}
                            >
                                <option value="Low">Low - General inquiry</option>
                                <option value="Medium">Medium - Need assistance</option>
                                <option value="High">High - Important issue</option>
                                <option value="Urgent">Urgent - Requires immediate attention</option>
                            </select>
                        </div>

                        <div className="flex items-center text-xs text-gray-600 mb-3">
                            <i className="fa-solid fa-envelope mr-1"></i>
                            <span>You'll receive a confirmation email with your ticket details</span>
                        </div>
                        <button className="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/80 transition font-bold disabled:opacity-50" disabled={isUserBanned(user)}>
                            <i className="fa-solid fa-ticket mr-2"></i> Submit Ticket
                        </button>
                    </form>

                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <h2 className="text-xl font-bold p-4 border-b text-primary">Your Past Tickets ({tickets.length})</h2>
                        <div className="space-y-4 p-4">
                            {tickets.sort((a,b)=>new Date(b.dateCreated)-new Date(a.dateCreated)).map(t => (
                                <div key={t.ticketId} className={`p-4 rounded-xl border shadow-sm ${t.priority === 'Urgent' ? 'bg-red-50 border-red-200' : t.priority === 'High' ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'}`}>
                                    <div className="flex flex-wrap justify-between items-center gap-2 mb-1">
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <span className='font-bold text-primary'>#{t.ticketId} - {t.subject}</span>
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                                                t.priority === 'Urgent' ? 'bg-red-500 text-white' :
                                                t.priority === 'High' ? 'bg-orange-500 text-white' :
                                                t.priority === 'Low' ? 'bg-gray-400 text-white' :
                                                'bg-blue-500 text-white'
                                            }`}>
                                                {t.priority || 'Medium'}
                                            </span>
                                        </div>
                                        <span className={`px-2 py-1 rounded-full text-white text-xs ${t.status==='Open'?'bg-danger':'bg-success'}`}>{t.status}</span>
                                    </div>
                                    <p className="text-xs text-gray-500 mb-2">Created: {t.dateCreated}</p>
                                    <p className="text-sm text-gray-700 my-2 italic">"{t.message}"</p>
                                    {t.adminReply && (
                                        <div className="bg-info/10 text-info p-2 text-xs rounded mt-2 border-l-2 border-info font-semibold">Admin Reply: {t.adminReply}</div>
                                    )}
                                </div>
                            ))}
                            {tickets.length === 0 && <div className='text-center text-gray-500 py-4'>No tickets found.</div>}
                        </div>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 18. DELIVERY BOY VIEW
        // =======================================================

        const DeliveryBoyView = ({ user, get, post, showToast }) => {
            const [orders, setOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [deliveryBoyName, setDeliveryBoyName] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [stats, setStats] = useState({ pending: 0, delivered: 0, total: 0 });

            // Delivery boy names (same as in admin panel)
            const deliveryBoyOptions = ['Delivery Boy 1', 'Delivery Boy 2', 'Delivery Boy 3'];

            const fetchOrders = async () => {
                if (!deliveryBoyName) return;
                setIsLoading(true);
                const res = await get({ action: 'getAllOrders' });
                setIsLoading(false);

                if (res.status !== 'error') {
                    // Filter orders assigned to this delivery boy
                    const myOrders = res.filter(o => o.assignedTo === deliveryBoyName && o.orderId);
                    setOrders(myOrders);

                    // Calculate stats
                    setStats({
                        pending: myOrders.filter(o => o.status === 'Pending' || o.status === 'Shipped').length,
                        delivered: myOrders.filter(o => o.status === 'Delivered').length,
                        total: myOrders.length
                    });
                }
            };

            useEffect(() => {
                if (isLoggedIn && deliveryBoyName) {
                    fetchOrders();
                    // Auto refresh every 30 seconds
                    const interval = setInterval(fetchOrders, 30000);
                    return () => clearInterval(interval);
                }
            }, [isLoggedIn, deliveryBoyName]);

            const handleLogin = () => {
                if (!deliveryBoyName) {
                    showToast('Please select your name', 'error');
                    return;
                }
                setIsLoggedIn(true);
                localStorage.setItem('deliveryBoyName', deliveryBoyName);
                showToast(`Welcome, ${deliveryBoyName}!`, 'success');
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setDeliveryBoyName('');
                setOrders([]);
                localStorage.removeItem('deliveryBoyName');
                showToast('Logged out successfully', 'info');
            };

            // Check for saved delivery boy session
            useEffect(() => {
                const savedName = localStorage.getItem('deliveryBoyName');
                if (savedName && deliveryBoyOptions.includes(savedName)) {
                    setDeliveryBoyName(savedName);
                    setIsLoggedIn(true);
                }
            }, []);

            const handleUpdateStatus = async (orderId, newStatus) => {
                const confirm = window.confirm(`Mark order #${orderId} as "${newStatus}"?`);
                if (!confirm) return;

                const res = await post({
                    action: 'updateOrderStatus',
                    orderId,
                    status: newStatus,
                    notifyCustomer: true,
                    updatedBy: deliveryBoyName
                });

                if (res.status === 'success') {
                    showToast(`Order #${orderId} marked as ${newStatus}!`, 'success');
                    fetchOrders();
                    setSelectedOrder(null);
                } else {
                    showToast(res.message || 'Failed to update status', 'error');
                }
            };

            const getStatusColor = (status) => {
                if (status === 'Delivered') return 'bg-success text-white';
                if (status === 'Cancelled') return 'bg-danger text-white';
                if (status === 'Shipped') return 'bg-info text-white';
                return 'bg-accent-hover text-white';
            };

            // Login Screen
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-primary-dark to-primary flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-6">
                                <div className="w-20 h-20 bg-accent rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fa-solid fa-truck text-3xl text-primary-dark"></i>
                                </div>
                                <h1 className="text-2xl font-bold text-primary-dark">Delivery Portal</h1>
                                <p className="text-gray-500 mt-2">Maddur Murugan Super Store</p>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Select Your Name</label>
                                    <select
                                        className="text-input-style"
                                        value={deliveryBoyName}
                                        onChange={(e) => setDeliveryBoyName(e.target.value)}
                                    >
                                        <option value="">-- Select --</option>
                                        {deliveryBoyOptions.map(name => (
                                            <option key={name} value={name}>{name}</option>
                                        ))}
                                    </select>
                                </div>

                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold text-lg hover:bg-accent-hover transition shadow-md"
                                >
                                    <i className="fa-solid fa-sign-in-alt mr-2"></i> Login
                                </button>
                            </div>

                            <div className="mt-6 text-center text-sm text-gray-500">
                                <i className="fa-solid fa-phone mr-1"></i> Contact: +91 9047878046
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-primary-dark text-white p-4 sticky top-0 z-50 shadow-lg">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck text-accent text-xl mr-3"></i>
                                <div>
                                    <h1 className="font-bold text-lg">Delivery Portal</h1>
                                    <p className="text-xs text-gray-300">{deliveryBoyName}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={fetchOrders}
                                    className="bg-primary p-2 rounded-lg hover:bg-primary/80 transition"
                                    title="Refresh"
                                >
                                    <i className="fa-solid fa-refresh"></i>
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="bg-danger p-2 rounded-lg hover:bg-danger/80 transition"
                                    title="Logout"
                                >
                                    <i className="fa-solid fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-4xl mx-auto p-4 space-y-4">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                <i className="fa-solid fa-clock text-accent text-2xl mb-2"></i>
                                <p className="text-2xl font-bold text-primary-dark">{stats.pending}</p>
                                <p className="text-xs text-gray-500">Pending</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                <i className="fa-solid fa-check-circle text-success text-2xl mb-2"></i>
                                <p className="text-2xl font-bold text-primary-dark">{stats.delivered}</p>
                                <p className="text-xs text-gray-500">Delivered</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                <i className="fa-solid fa-box text-info text-2xl mb-2"></i>
                                <p className="text-2xl font-bold text-primary-dark">{stats.total}</p>
                                <p className="text-xs text-gray-500">Total</p>
                            </div>
                        </div>

                        {/* Orders List */}
                        <div className="bg-white rounded-xl shadow-md overflow-hidden">
                            <div className="p-4 border-b bg-primary/5">
                                <h2 className="font-bold text-primary-dark flex items-center">
                                    <i className="fa-solid fa-list-check mr-2"></i>
                                    My Deliveries
                                    <span className="ml-2 text-sm bg-primary text-white px-2 py-0.5 rounded-full">{orders.length}</span>
                                </h2>
                            </div>

                            {isLoading ? (
                                <div className="p-8 text-center">
                                    <i className="fa-solid fa-spinner fa-spin text-3xl text-primary"></i>
                                    <p className="mt-2 text-gray-500">Loading orders...</p>
                                </div>
                            ) : orders.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">
                                    <i className="fa-solid fa-inbox text-4xl mb-3"></i>
                                    <p>No orders assigned to you yet.</p>
                                    <button onClick={fetchOrders} className="mt-3 text-primary font-semibold">
                                        <i className="fa-solid fa-refresh mr-1"></i> Refresh
                                    </button>
                                </div>
                            ) : (
                                <div className="divide-y">
                                    {orders.sort((a, b) => {
                                        // Sort: Pending/Shipped first, then by date
                                        const statusOrder = { 'Pending': 0, 'Shipped': 1, 'Delivered': 2, 'Cancelled': 3 };
                                        const statusDiff = (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
                                        if (statusDiff !== 0) return statusDiff;
                                        return new Date(b.date) - new Date(a.date);
                                    }).map(order => (
                                        <div
                                            key={order.orderId}
                                            className={`p-4 hover:bg-gray-50 transition cursor-pointer ${order.status === 'Pending' || order.status === 'Shipped' ? 'bg-yellow-50' : ''}`}
                                            onClick={() => setSelectedOrder(order)}
                                        >
                                            <div className="flex items-start justify-between">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="font-bold text-primary">#{order.orderId}</span>
                                                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${getStatusColor(order.status)}`}>
                                                            {order.status}
                                                        </span>
                                                        {order.paymentMethod && (
                                                            <span className={`px-2 py-0.5 rounded-full text-xs ${order.paymentMethod === 'upi' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                                {order.paymentMethod === 'upi' ? 'UPI' : 'COD'}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p className="text-sm text-gray-600 truncate">{order.address}</p>
                                                    <p className="text-xs text-gray-400 mt-1">{order.date}</p>
                                                </div>
                                                <div className="text-right ml-3">
                                                    <p className="font-bold text-danger text-lg">{formatCurrency(order.total)}</p>
                                                    <p className="text-xs text-gray-500">{order.items?.length || 0} items</p>
                                                </div>
                                            </div>

                                            {/* Quick Action Buttons for Pending/Shipped orders */}
                                            {(order.status === 'Pending' || order.status === 'Shipped') && (
                                                <div className="flex gap-2 mt-3 pt-3 border-t">
                                                    {order.status === 'Pending' && (
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); handleUpdateStatus(order.orderId, 'Shipped'); }}
                                                            className="flex-1 bg-info text-white py-2 rounded-lg text-sm font-bold hover:bg-info/80 transition"
                                                        >
                                                            <i className="fa-solid fa-truck mr-1"></i> Mark Shipped
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); handleUpdateStatus(order.orderId, 'Delivered'); }}
                                                        className="flex-1 bg-success text-white py-2 rounded-lg text-sm font-bold hover:bg-success/80 transition"
                                                    >
                                                        <i className="fa-solid fa-check-circle mr-1"></i> Mark Delivered
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Contact Support */}
                        <div className="bg-white p-4 rounded-xl shadow-md">
                            <h3 className="font-bold text-gray-700 mb-3">Need Help?</h3>
                            <div className="flex gap-3">
                                <a
                                    href="tel:9047878046"
                                    className="flex-1 bg-success text-white p-3 rounded-lg text-center font-bold hover:bg-success/80 transition"
                                >
                                    <i className="fa-solid fa-phone mr-2"></i> Call Store
                                </a>
                                <a
                                    href="https://wa.me/919047878046"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="flex-1 bg-[#25D366] text-white p-3 rounded-lg text-center font-bold hover:bg-[#25D366]/80 transition"
                                >
                                    <i className="fa-brands fa-whatsapp mr-2"></i> WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>

                    {/* Order Detail Modal */}
                    {selectedOrder && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-end md:items-center justify-center p-0 md:p-4" onClick={() => setSelectedOrder(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                {/* Mobile swipe handle */}
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>

                                <div className="p-4 border-b sticky top-0 bg-white z-10">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-xl font-bold text-primary-dark">Order #{selectedOrder.orderId}</h2>
                                        <button onClick={() => setSelectedOrder(null)} className="text-gray-500 hover:text-danger p-2">
                                            <i className="fa-solid fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>

                                <div className="p-4 space-y-4">
                                    {/* Status */}
                                    <div className="flex items-center justify-between">
                                        <span className="text-gray-600">Status:</span>
                                        <span className={`px-3 py-1 rounded-full text-sm font-bold ${getStatusColor(selectedOrder.status)}`}>
                                            {selectedOrder.status}
                                        </span>
                                    </div>

                                    {/* Payment Info */}
                                    <div className="bg-gray-50 p-3 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-600">Payment:</span>
                                            <span className={`px-2 py-1 rounded text-sm font-bold ${selectedOrder.paymentMethod === 'upi' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                {selectedOrder.paymentMethod === 'upi' ? 'UPI' : 'Cash on Delivery'}
                                                {selectedOrder.paymentStatus && ` (${selectedOrder.paymentStatus})`}
                                            </span>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <span className="text-gray-600">Total Amount:</span>
                                            <span className="text-xl font-bold text-danger">{formatCurrency(selectedOrder.total)}</span>
                                        </div>
                                        {selectedOrder.paymentMethod === 'cod' && selectedOrder.status !== 'Delivered' && (
                                            <div className="mt-2 p-2 bg-yellow-100 rounded text-yellow-800 text-sm">
                                                <i className="fa-solid fa-exclamation-triangle mr-1"></i>
                                                Collect {formatCurrency(selectedOrder.total)} on delivery
                                            </div>
                                        )}
                                    </div>

                                    {/* Customer & Address */}
                                    <div className="space-y-2">
                                        <h3 className="font-bold text-gray-700">Delivery Address</h3>
                                        <div className="bg-blue-50 p-3 rounded-lg">
                                            <p className="text-sm font-semibold text-gray-800">{selectedOrder.userEmail}</p>
                                            <p className="text-sm text-gray-600 mt-1">{selectedOrder.address}</p>
                                            {selectedOrder.deliveryArea && (
                                                <p className="text-xs text-blue-600 mt-1">
                                                    <i className="fa-solid fa-map-marker-alt mr-1"></i> {selectedOrder.deliveryArea}
                                                </p>
                                            )}
                                        </div>

                                        {/* Call/WhatsApp Customer */}
                                        <div className="flex gap-2">
                                            <a
                                                href={`mailto:${selectedOrder.userEmail}`}
                                                className="flex-1 bg-primary text-white p-2 rounded-lg text-center text-sm font-semibold"
                                            >
                                                <i className="fa-solid fa-envelope mr-1"></i> Email
                                            </a>
                                        </div>
                                    </div>

                                    {/* Order Items */}
                                    <div>
                                        <h3 className="font-bold text-gray-700 mb-2">Order Items ({selectedOrder.items?.length || 0})</h3>
                                        <div className="bg-gray-50 rounded-lg divide-y">
                                            {selectedOrder.items?.map((item, idx) => (
                                                <div key={idx} className="p-3 flex items-center justify-between">
                                                    <div>
                                                        <p className="font-semibold text-sm">{item.name}</p>
                                                        <p className="text-xs text-gray-500">Qty: {item.qty} Ã— {formatCurrency(item.price)}</p>
                                                    </div>
                                                    <p className="font-bold text-danger">{formatCurrency(item.price * item.qty)}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Order Date */}
                                    <div className="text-center text-sm text-gray-500">
                                        <i className="fa-solid fa-calendar mr-1"></i> Ordered: {selectedOrder.date}
                                    </div>

                                    {/* Action Buttons */}
                                    {(selectedOrder.status === 'Pending' || selectedOrder.status === 'Shipped') && (
                                        <div className="space-y-2 pt-4 border-t">
                                            {selectedOrder.status === 'Pending' && (
                                                <button
                                                    onClick={() => handleUpdateStatus(selectedOrder.orderId, 'Shipped')}
                                                    className="w-full bg-info text-white p-3 rounded-lg font-bold hover:bg-info/80 transition"
                                                >
                                                    <i className="fa-solid fa-truck mr-2"></i> Mark as Shipped
                                                </button>
                                            )}
                                            <button
                                                onClick={() => handleUpdateStatus(selectedOrder.orderId, 'Delivered')}
                                                className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition"
                                            >
                                                <i className="fa-solid fa-check-circle mr-2"></i> Mark as Delivered
                                            </button>
                                        </div>
                                    )}

                                    {selectedOrder.status === 'Delivered' && (
                                        <div className="bg-green-50 p-4 rounded-lg text-center">
                                            <i className="fa-solid fa-check-circle text-success text-3xl mb-2"></i>
                                            <p className="font-bold text-success">Order Delivered Successfully!</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 19A. FESTIVAL BANNER COMPONENT
        // =======================================================

        const FESTIVAL_PRESETS = [
            { label: 'Diwali',           emoji: 'ðŸª”', bg: 'linear-gradient(135deg,#FF6B35,#F7931E,#FFD700)' },
            { label: 'Pongal',           emoji: 'ðŸŒ¾', bg: 'linear-gradient(135deg,#F9A825,#388E3C,#FFF176)' },
            { label: 'Christmas',        emoji: 'ðŸŽ„', bg: 'linear-gradient(135deg,#C62828,#2E7D32,#FFFFFF)' },
            { label: 'New Year',         emoji: 'ðŸŽ†', bg: 'linear-gradient(135deg,#6A1B9A,#1565C0,#00BCD4)' },
            { label: 'Eid',              emoji: 'ðŸŒ™', bg: 'linear-gradient(135deg,#00695C,#FFD54F,#1A237E)' },
            { label: 'Holi',             emoji: 'ðŸŒˆ', bg: 'linear-gradient(135deg,#E91E63,#9C27B0,#FF9800)' },
            { label: 'Independence Day', emoji: 'ðŸ‡®ðŸ‡³', bg: 'linear-gradient(135deg,#FF9933,#FFFFFF,#138808)' },
            { label: 'Onam',             emoji: 'ðŸŒº', bg: 'linear-gradient(135deg,#1B5E20,#F9A825,#B71C1C)' },
            { label: 'Navratri',         emoji: 'ðŸŽ­', bg: 'linear-gradient(135deg,#D32F2F,#F57F17,#7B1FA2)' },
            { label: 'Sale / Offer',     emoji: 'ðŸ·ï¸', bg: 'linear-gradient(135deg,#1565C0,#0288D1,#26C6DA)' },
        ];

        const SPARKLE_POSITIONS = [
            { top:'8%',  left:'4%',  size:18, delay:'0s'   },
            { top:'15%', right:'6%', size:22, delay:'0.4s' },
            { top:'55%', left:'2%',  size:14, delay:'0.8s' },
            { bottom:'12%', right:'4%', size:20, delay:'1.1s' },
            { top:'35%', right:'12%',size:12, delay:'1.4s' },
            { bottom:'20%', left:'10%',size:16, delay:'0.6s' },
        ];

        const FestivalBanner = ({ banners = [], setView }) => {
            const active = banners.filter(b => String(b.isActive).toUpperCase() === 'TRUE');
            const [idx, setIdx] = useState(0);
            const [sliding, setSliding] = useState(false);

            useEffect(() => {
                if (active.length <= 1) return;
                const t = setInterval(() => {
                    setSliding(true);
                    setTimeout(() => { setIdx(i => (i + 1) % active.length); setSliding(false); }, 350);
                }, 5000);
                return () => clearInterval(t);
            }, [active.length]);

            if (active.length === 0) return null;
            const b = active[idx];

            const goTo = (i) => { setSliding(true); setTimeout(() => { setIdx(i); setSliding(false); }, 350); };
            const prev = () => goTo((idx - 1 + active.length) % active.length);
            const next = () => goTo((idx + 1) % active.length);

            const bgStyle = b.bgColor && b.bgColor.startsWith('linear')
                ? { background: b.bgColor }
                : { backgroundColor: b.bgColor || '#FF7F50' };

            // Confetti pieces
            const confetti = ['ðŸŽŠ','âœ¨','ðŸŒŸ','ðŸ’«','â­','ðŸŽ‰'].map((c, i) => ({
                char: c, left: `${10 + i * 14}%`, delay: `${i * 0.35}s`, duration: `${1.8 + i * 0.3}s`
            }));

            return (
                <div className="relative overflow-hidden rounded-2xl mb-6 shadow-2xl banner-glow" style={{ ...bgStyle, minHeight: '150px' }}>

                    {/* Confetti rain */}
                    {confetti.map((c, i) => (
                        <span key={i} className="absolute text-xl pointer-events-none select-none confetti-piece"
                            style={{ left: c.left, top: '-10px', animationDelay: c.delay, animationDuration: c.duration }}>
                            {c.char}
                        </span>
                    ))}

                    {/* Sparkle stars */}
                    {SPARKLE_POSITIONS.map((s, i) => (
                        <span key={i} className="absolute text-yellow-200 pointer-events-none select-none sparkle"
                            style={{ ...s, fontSize: s.size, animationDelay: s.delay }}>â˜…</span>
                    ))}

                    {/* Ripple circle decoration */}
                    <div className="absolute -right-16 -top-16 w-48 h-48 rounded-full bg-white/10 pointer-events-none" style={{ animation: 'ripple 3s ease-out infinite' }}></div>
                    <div className="absolute -left-10 -bottom-10 w-36 h-36 rounded-full bg-white/10 pointer-events-none" style={{ animation: 'ripple 3s ease-out infinite 1.5s' }}></div>

                    {/* Floating emoji bg */}
                    <div className="absolute top-3 left-4 text-5xl opacity-20 banner-float pointer-events-none select-none" style={{ animationDelay: '0s' }}>{b.emoji || 'ðŸŽ‰'}</div>
                    <div className="absolute bottom-2 right-4 text-4xl opacity-15 banner-float pointer-events-none select-none" style={{ animationDelay: '1.8s' }}>{b.emoji || 'ðŸŽŠ'}</div>

                    {/* Main content */}
                    <div className={`flex flex-col sm:flex-row items-center justify-between px-6 md:px-12 py-5 gap-4 transition-all duration-300 ${sliding ? 'opacity-0 translate-x-6' : 'opacity-100 translate-x-0'}`}
                        style={{ transition: 'opacity 0.35s, transform 0.35s' }}>

                        <div className="text-center sm:text-left flex-1 z-10">
                            <div className="flex items-center justify-center sm:justify-start gap-2 mb-1 flex-wrap">
                                <span className="text-2xl sm:text-3xl">{b.emoji || 'ðŸŽ‰'}</span>
                                <h2 className="shimmer-text text-2xl sm:text-3xl font-extrabold tracking-wide drop-shadow-lg">{b.title}</h2>
                                <span className="text-2xl sm:text-3xl">{b.emoji || 'ðŸŽ‰'}</span>
                            </div>
                            {b.subtitle && (
                                <p className="text-white/90 text-sm sm:text-base font-medium mb-3 drop-shadow">
                                    {b.subtitle}
                                </p>
                            )}
                            <button onClick={() => setView('products')}
                                className="bg-white/95 text-primary-dark font-extrabold px-5 py-2 rounded-full text-sm hover:scale-105 active:scale-95 transition-transform shadow-lg inline-flex items-center gap-2">
                                <i className="fa-solid fa-cart-shopping"></i> Shop Now
                            </button>
                        </div>

                        {b.imageUrl && (
                            <div className="flex-shrink-0 z-10">
                                <img src={b.imageUrl} alt={b.title}
                                    className="w-24 h-24 sm:w-32 sm:h-32 object-contain drop-shadow-2xl banner-float"
                                    style={{ animationDelay: '0.5s' }} />
                            </div>
                        )}
                    </div>

                    {/* Nav arrows */}
                    {active.length > 1 && (
                        <>
                            <button onClick={prev} className="absolute left-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 backdrop-blur-sm text-white rounded-full w-8 h-8 flex items-center justify-center transition z-20">
                                <i className="fa-solid fa-chevron-left text-xs"></i>
                            </button>
                            <button onClick={next} className="absolute right-1 top-1/2 -translate-y-1/2 bg-black/20 hover:bg-black/40 backdrop-blur-sm text-white rounded-full w-8 h-8 flex items-center justify-center transition z-20">
                                <i className="fa-solid fa-chevron-right text-xs"></i>
                            </button>
                            <div className="absolute bottom-2 left-0 right-0 flex justify-center gap-1.5 z-20">
                                {active.map((_, i) => (
                                    <button key={i} onClick={() => goTo(i)}
                                        className={`h-1.5 rounded-full transition-all duration-300 ${i === idx ? 'w-6 bg-white' : 'w-2 bg-white/50'}`} />
                                ))}
                            </div>
                        </>
                    )}
                </div>
            );
        };

        // =======================================================
        // 19B. GROCERY LIST VIEW (3 MODES)
        // =======================================================

        const GroceryListView = ({ user, get, post, showToast, setView, products = [] }) => {
            const role = getRole(user);
            const UNITS = ['kg', 'g', 'litre', 'ml', 'piece', 'dozen', 'packet', 'box', 'bundle'];
            const emptyItem = { name: '', quantity: '1', unit: 'kg' };

            // Mode: 'catalog' | 'manual' | 'upload'
            const [mode, setMode] = useState('catalog');
            // Main tab: 'order' | 'history'
            const [activeTab, setActiveTab] = useState('order');

            // Catalog mode
            const [catalogCart, setCatalogCart] = useState({});
            const [catalogSearch, setCatalogSearch] = useState('');
            const [catalogCat, setCatalogCat] = useState('All');

            // Manual mode
            const [manualItems, setManualItems] = useState([{ ...emptyItem }]);

            // Upload mode
            const [uploadFile, setUploadFile] = useState(null);
            const [uploadPreview, setUploadPreview] = useState(null);
            const [isDragOver, setIsDragOver] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);

            // Shared
            const [notes, setNotes] = useState('');
            const [address, setAddress] = useState(user.address || '');
            const [paymentMethod, setPaymentMethod] = useState('cod');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [myLists, setMyLists] = useState([]);
            const [loadingLists, setLoadingLists] = useState(true);

            const fetchMyLists = async () => {
                setLoadingLists(true);
                const res = await get({ action: 'getGroceryLists', email: user.email });
                if (!res.status || res.status !== 'error') setMyLists(Array.isArray(res) ? res : []);
                setLoadingLists(false);
            };

            useEffect(() => { if (role !== 'guest') fetchMyLists(); }, []);

            if (role === 'guest') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-[60vh] text-center p-6 pb-24">
                        <i className="fa-solid fa-list-check text-5xl text-primary mb-4"></i>
                        <h2 className="text-2xl font-bold text-primary-dark mb-2">Grocery List</h2>
                        <p className="text-gray-600 mb-6">Sign in to send your grocery list to the store.</p>
                        <button onClick={() => setView('login')} className="bg-accent text-primary-dark px-6 py-3 rounded-lg font-bold hover:bg-accent-hover transition shadow-md">
                            <i className="fa-solid fa-sign-in-alt mr-2"></i>Sign In
                        </button>
                    </div>
                );
            }

            // â”€â”€ Catalog helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const activeProducts = products.filter(p => String(p.isActive).toUpperCase() !== 'FALSE');
            const categories = ['All', ...new Set(activeProducts.map(p => p.category).filter(Boolean))];
            const filteredProds = activeProducts.filter(p => {
                const mc = catalogCat === 'All' || p.category === catalogCat;
                const ms = !catalogSearch || p.name.toLowerCase().includes(catalogSearch.toLowerCase());
                return mc && ms;
            });
            const setCatalogQty = (id, qty) => setCatalogCart(prev => ({ ...prev, [id]: Math.max(0, qty) }));
            const catalogCount = Object.values(catalogCart).filter(q => q > 0).length;

            // â”€â”€ Manual helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const addManualItem = () => setManualItems(p => [...p, { ...emptyItem }]);
            const removeManualItem = (i) => { if (manualItems.length > 1) setManualItems(p => p.filter((_, j) => j !== i)); };
            const updateManualItem = (i, f, v) => setManualItems(p => p.map((it, j) => j === i ? { ...it, [f]: v } : it));

            // â”€â”€ Upload helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const ALLOWED_MIME = ['image/jpeg','image/png','image/jpg','image/webp','image/heic','application/pdf',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const handleFileSelect = (file) => {
                if (!ALLOWED_MIME.includes(file.type)) { showToast('Only JPG/PNG, PDF, or DOCX files allowed.', 'error'); return; }
                if (file.size > 5 * 1024 * 1024) { showToast('File must be under 5 MB.', 'error'); return; }
                setUploadFile(file);
                if (file.type.startsWith('image/')) {
                    const r = new FileReader(); r.onload = e => setUploadPreview(e.target.result); r.readAsDataURL(file);
                } else setUploadPreview(null);
            };
            const fileToBase64 = (f) => new Promise((res, rej) => {
                const r = new FileReader(); r.readAsDataURL(f);
                r.onload = () => res(r.result.split(',')[1]); r.onerror = rej;
            });
            const getFileIcon  = (t) => !t?'fa-file':t.startsWith('image/')?'fa-file-image':t.includes('pdf')?'fa-file-pdf':t.includes('word')?'fa-file-word':'fa-file';
            const getFileColor = (t) => !t?'text-gray-500':t.startsWith('image/')?'text-green-500':t.includes('pdf')?'text-red-500':t.includes('word')?'text-blue-500':'text-gray-500';
            const getDriveThumb = (url) => { const m = (url||'').match(/\/d\/([a-zA-Z0-9_-]+)/); return m ? `https://drive.google.com/uc?id=${m[1]}` : null; };

            // â”€â”€ Submit handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const validateCheckout = () => {
                if (!address.trim()) { showToast('Please enter your delivery address.','error'); return false; }
                return true;
            };

            const handleSubmitCatalog = async () => {
                const items = Object.entries(catalogCart).filter(([,q])=>q>0).map(([id,q])=>{
                    const p = activeProducts.find(p=>String(p.id)===String(id));
                    return p ? { name:p.name, quantity:String(q), unit:p.unit||'piece' } : null;
                }).filter(Boolean);
                if (!items.length) { showToast('Select at least one product.','error'); return; }
                if (!validateCheckout()) return;
                setIsSubmitting(true);
                const res = await post({ action:'submitGroceryList', email:user.email, userName:user.name, phone:user.phone||'', address:address.trim(), paymentMethod, items, notes:notes.trim() });
                setIsSubmitting(false);
                if (res.status==='success') { showToast(res.message||'List sent!','success'); setCatalogCart({}); setNotes(''); setActiveTab('history'); fetchMyLists(); }
                else showToast(res.message||'Failed.','error');
            };

            const handleSubmitManual = async () => {
                const items = manualItems.filter(it=>it.name.trim());
                if (!items.length) { showToast('Add at least one item.','error'); return; }
                if (!validateCheckout()) return;
                setIsSubmitting(true);
                const res = await post({ action:'submitGroceryList', email:user.email, userName:user.name, phone:user.phone||'', address:address.trim(), paymentMethod, items, notes:notes.trim() });
                setIsSubmitting(false);
                if (res.status==='success') { showToast(res.message||'List sent!','success'); setManualItems([{...emptyItem}]); setNotes(''); setActiveTab('history'); fetchMyLists(); }
                else showToast(res.message||'Failed.','error');
            };

            const handleSubmitUpload = async () => {
                if (!uploadFile) { showToast('Please select a file.','error'); return; }
                if (!validateCheckout()) return;
                setIsSubmitting(true); setUploadProgress(10);
                try {
                    const prog = setInterval(()=>setUploadProgress(p=>Math.min(p+12,82)),350);
                    const b64 = await fileToBase64(uploadFile);
                    const res = await post({ action:'uploadGroceryListFile', email:user.email, userName:user.name, phone:user.phone||'',
                        address:address.trim(), paymentMethod,
                        fileData:b64, fileName:uploadFile.name, mimeType:uploadFile.type, notes:notes.trim() });
                    clearInterval(prog); setUploadProgress(100);
                    setTimeout(()=>{
                        setIsSubmitting(false); setUploadProgress(0);
                        if (res.status==='success') { showToast(res.message||'File uploaded!','success'); setUploadFile(null); setUploadPreview(null); setNotes(''); setActiveTab('history'); fetchMyLists(); }
                        else showToast(res.message||'Upload failed.','error');
                    },500);
                } catch(e) { setIsSubmitting(false); setUploadProgress(0); showToast('Upload error. Try again.','error'); }
            };

            // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const statusColor = (s) => ({
                'Pending':    'bg-yellow-100 text-yellow-800',
                'Accepted':   'bg-green-100 text-green-800',
                'Processing': 'bg-blue-100 text-blue-800',
                'Ready':      'bg-purple-100 text-purple-800',
                'Delivered':  'bg-gray-100 text-gray-700',
                'Rejected':   'bg-red-100 text-red-700',
                'Cancelled':  'bg-red-50 text-red-600',
            }[s]||'bg-gray-100 text-gray-600');

            const parseItems = (s) => { try { return JSON.parse(s); } catch(e) { return []; } };

            const SubmitBtn = ({ label, icon, onClick, disabled }) => (
                <button onClick={onClick} disabled={disabled}
                    className="w-full bg-accent text-primary-dark py-3 rounded-xl font-extrabold text-base hover:bg-accent-hover active:scale-95 transition-all shadow-lg disabled:opacity-50 flex items-center justify-center gap-2">
                    {disabled ? <><i className="fa-solid fa-spinner fa-spin"></i> Processing...</> : <><i className={`fa-solid ${icon}`}></i> {label}</>}
                </button>
            );

            const NotesField = () => (
                <div>
                    <label className="text-sm font-bold text-gray-700 mb-1 block"><i className="fa-solid fa-note-sticky mr-1 text-accent"></i>Special Notes (Optional)</label>
                    <textarea rows="2" placeholder="Preferred brands, delivery time, quantity notesâ€¦"
                        className="text-input-style text-sm resize-none" value={notes} onChange={e=>setNotes(e.target.value)} />
                </div>
            );

            // â”€â”€ Checkout Section (address + payment) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const CheckoutSection = () => (
                <div className="bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/20 rounded-2xl p-4 space-y-4">
                    <h3 className="font-extrabold text-primary-dark flex items-center gap-2 text-base">
                        <span className="w-7 h-7 rounded-full bg-primary text-white flex items-center justify-center text-xs font-black">2</span>
                        Delivery & Payment
                    </h3>

                    {/* Address */}
                    <div>
                        <label className="text-sm font-bold text-gray-700 mb-1 block">
                            <i className="fa-solid fa-location-dot mr-1 text-accent"></i>Delivery Address <span className="text-red-500">*</span>
                        </label>
                        <textarea
                            rows="3"
                            placeholder="House No., Street, Area, City â€” e.g. 12 Gandhi Nagar, Maddur, Karnataka 571428"
                            className="text-input-style text-sm resize-none"
                            value={address}
                            onChange={e => setAddress(e.target.value)}
                        />
                    </div>

                    {/* Payment Method */}
                    <div>
                        <label className="text-sm font-bold text-gray-700 mb-2 block">
                            <i className="fa-solid fa-wallet mr-1 text-accent"></i>Payment Method <span className="text-red-500">*</span>
                        </label>
                        <div className="grid grid-cols-2 gap-2">
                            {/* COD */}
                            <button
                                type="button"
                                onClick={() => setPaymentMethod('cod')}
                                className={`flex items-center gap-2 p-3 rounded-xl border-2 font-bold text-sm transition-all ${paymentMethod==='cod'?'border-success bg-success/10 text-success':'border-gray-200 bg-white text-gray-600 hover:border-gray-300'}`}
                            >
                                <span className={`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${paymentMethod==='cod'?'border-success bg-success':'border-gray-300'}`}>
                                    {paymentMethod==='cod' && <span className="w-2 h-2 rounded-full bg-white"></span>}
                                </span>
                                <span>
                                    <i className="fa-solid fa-hand-holding-dollar mr-1"></i>
                                    <span className="hidden sm:inline">Cash on Delivery</span>
                                    <span className="sm:hidden">COD</span>
                                </span>
                            </button>

                            {/* UPI */}
                            <button
                                type="button"
                                onClick={() => setPaymentMethod('upi')}
                                className={`flex items-center gap-2 p-3 rounded-xl border-2 font-bold text-sm transition-all ${paymentMethod==='upi'?'border-upi bg-upi-light text-upi':'border-gray-200 bg-white text-gray-600 hover:border-gray-300'}`}
                            >
                                <span className={`w-5 h-5 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${paymentMethod==='upi'?'border-upi bg-upi':'border-gray-300'}`}>
                                    {paymentMethod==='upi' && <span className="w-2 h-2 rounded-full bg-white"></span>}
                                </span>
                                <span>
                                    <i className="fa-solid fa-qrcode mr-1"></i>UPI / Online
                                </span>
                            </button>
                        </div>
                        {paymentMethod === 'upi' && (
                            <p className="text-xs text-upi bg-upi-light rounded-lg p-2 mt-2 flex items-center gap-1">
                                <i className="fa-solid fa-circle-info"></i>
                                We will share our UPI QR code / ID when we call to confirm your order.
                            </p>
                        )}
                        {paymentMethod === 'cod' && (
                            <p className="text-xs text-success bg-green-50 rounded-lg p-2 mt-2 flex items-center gap-1">
                                <i className="fa-solid fa-circle-check"></i>
                                Pay in cash when your order is delivered to your door.
                            </p>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="max-w-2xl mx-auto p-3 md:p-6 pb-28 md:pb-6">
                    {/* Header */}
                    <div className="flex items-center mb-4">
                        <div className="w-12 h-12 rounded-2xl bg-primary/10 flex items-center justify-center mr-3 flex-shrink-0">
                            <i className="fa-solid fa-list-check text-2xl text-primary"></i>
                        </div>
                        <div>
                            <h1 className="text-2xl font-extrabold text-primary-dark">My Grocery List</h1>
                            <p className="text-sm text-gray-500">3 ways to send your list to the store</p>
                        </div>
                    </div>

                    {/* Main tabs */}
                    <div className="flex gap-2 mb-4">
                        <button onClick={()=>setActiveTab('order')}
                            className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-sm transition shadow-sm ${activeTab==='order'?'bg-primary text-white':'bg-white text-gray-600 hover:bg-gray-100'}`}>
                            <i className="fa-solid fa-cart-plus"></i> New Order
                        </button>
                        <button onClick={()=>{setActiveTab('history');fetchMyLists();}}
                            className={`flex items-center gap-2 px-4 py-2 rounded-xl font-bold text-sm transition shadow-sm ${activeTab==='history'?'bg-primary text-white':'bg-white text-gray-600 hover:bg-gray-100'}`}>
                            <i className="fa-solid fa-clock-rotate-left"></i> My Lists
                            {myLists.length > 0 && <span className={`text-xs px-1.5 py-0.5 rounded-full ${activeTab==='history'?'bg-white/30 text-white':'bg-primary/10 text-primary'}`}>{myLists.length}</span>}
                        </button>
                    </div>

                    {/* â”€â”€ ORDER TAB â”€â”€ */}
                    {activeTab === 'order' && (
                        <div className="space-y-4">
                            {/* Mode selector */}
                            <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-1.5 flex gap-1.5">
                                {[
                                    { id:'catalog', icon:'fa-store',         label:'From Store',  desc:'Pick products' },
                                    { id:'manual',  icon:'fa-keyboard',      label:'Type List',   desc:'Write items'  },
                                    { id:'upload',  icon:'fa-cloud-arrow-up',label:'Upload File', desc:'Photo/PDF/DOCX' }
                                ].map(m => (
                                    <button key={m.id} onClick={()=>setMode(m.id)}
                                        className={`flex-1 flex flex-col items-center gap-0.5 py-2.5 px-1 rounded-xl text-xs font-semibold transition-all mode-btn-active ${mode===m.id?'bg-primary text-white scale-[1.02]':'text-gray-600 hover:bg-gray-50'}`}>
                                        <i className={`fa-solid ${m.icon} text-lg mb-0.5`}></i>
                                        <span className="font-bold">{m.label}</span>
                                        <span className={`text-[10px] font-normal ${mode===m.id?'text-white/75':'text-gray-400'}`}>{m.desc}</span>
                                    </button>
                                ))}
                            </div>

                            {/* â•â•â• CATALOG MODE â•â•â• */}
                            {mode === 'catalog' && (
                                <div className="space-y-3">
                                    <div className="flex gap-2">
                                        <div className="flex-1 relative">
                                            <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none"></i>
                                            <input type="text" placeholder="Search productsâ€¦" className="text-input-style pl-9 text-sm"
                                                value={catalogSearch} onChange={e=>setCatalogSearch(e.target.value)} />
                                        </div>
                                        <select className="text-input-style text-sm w-32" value={catalogCat} onChange={e=>setCatalogCat(e.target.value)}>
                                            {categories.map(c=><option key={c}>{c}</option>)}
                                        </select>
                                    </div>

                                    <div className="space-y-2 max-h-[48vh] overflow-y-auto pr-1">
                                        {filteredProds.length === 0
                                            ? <p className="text-center text-gray-400 py-10">No products found</p>
                                            : filteredProds.map(p => {
                                                const qty = catalogCart[p.id] || 0;
                                                return (
                                                    <div key={p.id} className={`flex items-center gap-3 p-3 rounded-xl border transition-all ${qty>0?'border-primary/40 bg-primary/5 shadow-sm':'border-gray-200 bg-white'}`}>
                                                        {p.image && <img src={p.image} alt={p.name} className="w-11 h-11 object-cover rounded-lg flex-shrink-0 shadow-sm" />}
                                                        <div className="flex-1 min-w-0">
                                                            <p className="font-semibold text-gray-800 text-sm truncate">{p.name}</p>
                                                            <p className="text-xs text-gray-400">{p.category} Â· {formatCurrency(p.price)}/{p.unit||'unit'}</p>
                                                        </div>
                                                        <div className="flex items-center gap-1.5 flex-shrink-0">
                                                            {qty > 0 ? <>
                                                                <button onClick={()=>setCatalogQty(p.id,qty-1)} className="w-7 h-7 rounded-full bg-primary/10 text-primary flex items-center justify-center hover:bg-primary/20 transition text-xs font-bold">âˆ’</button>
                                                                <span className="w-7 text-center font-extrabold text-primary text-sm">{qty}</span>
                                                                <button onClick={()=>setCatalogQty(p.id,qty+1)} className="w-7 h-7 rounded-full bg-primary text-white flex items-center justify-center hover:bg-primary-dark transition text-xs font-bold">+</button>
                                                            </> : (
                                                                <button onClick={()=>setCatalogQty(p.id,1)} className="bg-accent text-primary-dark text-xs font-bold px-3 py-1.5 rounded-lg hover:bg-accent-hover transition active:scale-95">Add</button>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                        })}
                                    </div>

                                    {catalogCount > 0 && (
                                        <div className="space-y-3 animate-fade-in">
                                            <div className="bg-primary/5 border border-primary/20 rounded-xl p-3">
                                                <p className="text-sm font-bold text-primary"><i className="fa-solid fa-check-circle mr-2"></i>{catalogCount} product{catalogCount>1?'s':''} selected</p>
                                            </div>
                                            <div className="bg-white rounded-2xl border border-gray-200 p-4 space-y-3">
                                                <h3 className="font-extrabold text-primary-dark flex items-center gap-2 text-sm">
                                                    <span className="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs font-black">1</span>
                                                    Extra Notes
                                                </h3>
                                                <NotesField />
                                            </div>
                                            <CheckoutSection />
                                            <SubmitBtn label="Place Grocery Order" icon="fa-paper-plane" onClick={handleSubmitCatalog} disabled={isSubmitting} />
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* â•â•â• MANUAL MODE â•â•â• */}
                            {mode === 'manual' && (
                                <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-4 space-y-3">
                                    <div className="space-y-2">
                                        {manualItems.map((item,i) => (
                                            <div key={i} className="flex gap-2 items-center bg-gray-50 p-2 rounded-xl border border-gray-200">
                                                <div className="flex-1">
                                                    <input type="text" placeholder={`Item ${i+1} name`} className="text-input-style text-sm"
                                                        value={item.name} onChange={e=>updateManualItem(i,'name',e.target.value)} />
                                                </div>
                                                <div className="w-18">
                                                    <input type="number" min="0.1" step="0.1" placeholder="Qty" className="text-input-style text-sm text-center"
                                                        value={item.quantity} onChange={e=>updateManualItem(i,'quantity',e.target.value)} style={{width:'72px'}} />
                                                </div>
                                                <div className="w-24">
                                                    <select className="text-input-style text-sm" value={item.unit} onChange={e=>updateManualItem(i,'unit',e.target.value)}>
                                                        {UNITS.map(u=><option key={u}>{u}</option>)}
                                                    </select>
                                                </div>
                                                <button onClick={()=>removeManualItem(i)} disabled={manualItems.length===1}
                                                    className="text-danger hover:text-red-700 p-1 disabled:opacity-30 flex-shrink-0">
                                                    <i className="fa-solid fa-trash text-sm"></i>
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={addManualItem}
                                        className="w-full border-2 border-dashed border-primary/40 text-primary hover:border-primary hover:bg-primary/5 py-2 rounded-xl text-sm font-semibold transition flex items-center justify-center gap-2">
                                        <i className="fa-solid fa-plus"></i> Add Another Item
                                    </button>
                                    <div className="bg-white rounded-2xl border border-gray-200 p-4 space-y-3">
                                        <h3 className="font-extrabold text-primary-dark flex items-center gap-2 text-sm">
                                            <span className="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs font-black">2</span>
                                            Extra Notes
                                        </h3>
                                        <NotesField />
                                    </div>
                                    <CheckoutSection />
                                    <SubmitBtn label="Place Grocery Order" icon="fa-paper-plane" onClick={handleSubmitManual} disabled={isSubmitting} />
                                </div>
                            )}

                            {/* â•â•â• UPLOAD MODE â•â•â• */}
                            {mode === 'upload' && (
                                <div className="bg-white rounded-2xl border border-gray-200 shadow-sm p-4 space-y-4">
                                    {/* Drop zone */}
                                    <div
                                        className={`border-2 border-dashed rounded-2xl p-6 text-center transition-all cursor-pointer ${isDragOver?'border-primary bg-primary/8':'border-gray-300 hover:border-primary/60 hover:bg-gray-50'} ${uploadFile?'border-success/60 bg-green-50/50':''}`}
                                        onDragOver={e=>{e.preventDefault();setIsDragOver(true);}}
                                        onDragLeave={()=>setIsDragOver(false)}
                                        onDrop={e=>{e.preventDefault();setIsDragOver(false);if(e.dataTransfer.files[0])handleFileSelect(e.dataTransfer.files[0]);}}
                                        onClick={()=>document.getElementById('glFileInput').click()}
                                    >
                                        <input id="glFileInput" type="file" className="hidden"
                                            accept="image/*,.pdf,.docx,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                                            onChange={e=>{if(e.target.files[0])handleFileSelect(e.target.files[0]);e.target.value='';}} />
                                        {uploadPreview ? (
                                            <div className="space-y-2">
                                                <img src={uploadPreview} alt="Preview" className="max-h-48 mx-auto rounded-xl shadow-md object-contain" />
                                                <p className="text-sm font-bold text-success"><i className="fa-solid fa-check-circle mr-1"></i>{uploadFile.name}</p>
                                                <p className="text-xs text-gray-400">{(uploadFile.size/1024).toFixed(1)} KB</p>
                                            </div>
                                        ) : uploadFile ? (
                                            <div className="space-y-2">
                                                <i className={`fa-solid ${getFileIcon(uploadFile.type)} text-5xl ${getFileColor(uploadFile.type)}`}></i>
                                                <p className="text-sm font-bold text-success">{uploadFile.name}</p>
                                                <p className="text-xs text-gray-400">{(uploadFile.size/1024).toFixed(1)} KB</p>
                                            </div>
                                        ) : (
                                            <div className="space-y-3">
                                                <div className="flex justify-center gap-3 text-4xl">
                                                    <i className="fa-solid fa-camera text-green-400"></i>
                                                    <i className="fa-solid fa-file-pdf text-red-400"></i>
                                                    <i className="fa-solid fa-file-word text-blue-400"></i>
                                                </div>
                                                <div>
                                                    <p className="font-bold text-gray-700 text-base">Tap or drag your file here</p>
                                                    <p className="text-sm text-gray-500 mt-1">Photo <span className="text-gray-400">Â·</span> PDF <span className="text-gray-400">Â·</span> DOCX</p>
                                                    <p className="text-xs text-gray-400 mt-1">Max 5 MB</p>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {uploadFile && (
                                        <button onClick={()=>{setUploadFile(null);setUploadPreview(null);}} className="w-full text-sm text-gray-500 hover:text-danger transition py-1 flex items-center justify-center gap-2">
                                            <i className="fa-solid fa-xmark"></i> Remove file
                                        </button>
                                    )}

                                    {/* Format info chips */}
                                    <div className="grid grid-cols-3 gap-2 text-center">
                                        {[{icon:'fa-camera',c:'text-green-500',bg:'bg-green-50',l:'Photo',t:'Handwritten'},
                                          {icon:'fa-file-pdf',c:'text-red-500',bg:'bg-red-50',l:'PDF',t:'Digital list'},
                                          {icon:'fa-file-word',c:'text-blue-500',bg:'bg-blue-50',l:'DOCX',t:'Word doc'}].map(f=>(
                                            <div key={f.l} className={`${f.bg} rounded-xl p-2.5 border border-gray-100`}>
                                                <i className={`fa-solid ${f.icon} ${f.c} text-xl mb-1`}></i>
                                                <p className="text-xs font-bold text-gray-700">{f.l}</p>
                                                <p className="text-[10px] text-gray-400">{f.t}</p>
                                            </div>
                                        ))}
                                    </div>

                                    <NotesField />

                                    {/* Progress bar */}
                                    {isSubmitting && uploadProgress > 0 && (
                                        <div className="space-y-1">
                                            <div className="flex justify-between text-xs text-gray-600 font-semibold">
                                                <span><i className="fa-brands fa-google-drive mr-1 text-primary"></i>Uploading to Driveâ€¦</span>
                                                <span>{uploadProgress}%</span>
                                            </div>
                                            <div className="progress-bar"><div className="progress-bar-fill bg-gradient-to-r from-primary to-info" style={{width:`${uploadProgress}%`}}></div></div>
                                        </div>
                                    )}

                                    <div className="bg-blue-50 border border-blue-200 rounded-xl p-3 text-xs text-blue-700 flex items-start gap-2">
                                        <i className="fa-brands fa-google-drive mt-0.5 flex-shrink-0 text-blue-500"></i>
                                        <span>Your file is stored securely in Google Drive. The store owner will review it and update your list status.</span>
                                    </div>

                                    <div className="bg-white rounded-2xl border border-gray-200 p-4 space-y-3">
                                        <h3 className="font-extrabold text-primary-dark flex items-center gap-2 text-sm">
                                            <span className="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs font-black">2</span>
                                            Extra Notes
                                        </h3>
                                        <NotesField />
                                    </div>
                                    <CheckoutSection />
                                    <SubmitBtn label="Upload & Place Order" icon="fa-cloud-arrow-up" onClick={handleSubmitUpload} disabled={isSubmitting||!uploadFile} />
                                </div>
                            )}
                        </div>
                    )}

                    {/* â”€â”€ HISTORY TAB â”€â”€ */}
                    {activeTab === 'history' && (
                        <div className="space-y-4">
                            {loadingLists ? <LoadingSpinner /> : myLists.length === 0 ? (
                                <div className="text-center py-16 text-gray-400 bg-white rounded-2xl border border-gray-200">
                                    <i className="fa-solid fa-list-check text-5xl mb-3 text-gray-200"></i>
                                    <p className="font-bold text-gray-500">No lists submitted yet.</p>
                                    <button onClick={()=>setActiveTab('order')} className="mt-4 text-primary hover:underline text-sm font-semibold">
                                        Send your first list â†’
                                    </button>
                                </div>
                            ) : [...myLists].reverse().map((list, ri) => {
                                const pitems = parseItems(list.items);
                                const hasFile = list.fileUrl && String(list.fileUrl).startsWith('http');
                                const isImg = hasFile && list.fileType && list.fileType.startsWith('image/');
                                const thumb = isImg ? getDriveThumb(list.fileUrl) : null;
                                return (
                                    <div key={ri} className="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden animate-fade-in">
                                        <div className="flex items-center justify-between px-4 py-3 border-b border-gray-100 bg-gray-50/80">
                                            <div>
                                                <div className="flex items-center gap-2">
                                                    <p className="font-extrabold text-primary-dark text-sm">{list.listId}</p>
                                                    {hasFile && <span className="text-[10px] bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold"><i className={`fa-solid ${getFileIcon(list.fileType)} mr-1`}></i>File</span>}
                                                    {pitems.length>0 && !hasFile && <span className="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-bold"><i className="fa-solid fa-list mr-1"></i>{pitems.length} items</span>}
                                                </div>
                                                <p className="text-xs text-gray-400">{new Date(list.dateSubmitted).toLocaleString('en-IN')}</p>
                                            </div>
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${statusColor(list.status)}`}>{list.status}</span>
                                        </div>
                                        <div className="p-4 space-y-2">
                                            {hasFile && (
                                                <div>
                                                    {thumb
                                                        ? <img src={thumb} alt="list" className="max-h-36 rounded-xl shadow-sm object-contain mb-2 w-full" />
                                                        : <div className="flex items-center gap-2 bg-gray-50 rounded-xl p-3 mb-2">
                                                            <i className={`fa-solid ${getFileIcon(list.fileType)} text-3xl ${getFileColor(list.fileType)}`}></i>
                                                            <div><p className="text-sm font-semibold text-gray-700">{list.fileName}</p><p className="text-xs text-gray-400">{list.fileType}</p></div>
                                                          </div>}
                                                    <a href={list.fileUrl} target="_blank" rel="noopener noreferrer"
                                                        className="inline-flex items-center gap-1.5 text-xs text-primary hover:underline font-bold">
                                                        <i className="fa-brands fa-google-drive"></i> Open in Drive
                                                    </a>
                                                </div>
                                            )}
                                            {pitems.length > 0 && (
                                                <table className="w-full text-sm">
                                                    <thead><tr className="text-xs text-gray-400 border-b"><th className="text-left py-1">Item</th><th className="text-center py-1 w-14">Qty</th><th className="text-left py-1 w-14">Unit</th></tr></thead>
                                                    <tbody>
                                                        {pitems.map((it,i)=>(
                                                            <tr key={i} className="border-b border-gray-50">
                                                                <td className="py-1 font-medium">{it.name}</td>
                                                                <td className="py-1 text-center text-gray-600">{it.quantity}</td>
                                                                <td className="py-1 text-gray-400 text-xs">{it.unit}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            )}
                                            {/* Delivery + Payment info */}
                                            {(list.address || list.paymentMethod) && (
                                                <div className="grid grid-cols-2 gap-2 text-xs">
                                                    {list.paymentMethod && (
                                                        <div className="bg-gray-50 rounded-lg p-2 flex items-center gap-1.5">
                                                            <i className={`fa-solid ${list.paymentMethod==='upi'?'fa-qrcode text-upi':'fa-hand-holding-dollar text-success'}`}></i>
                                                            <span className="font-semibold text-gray-700">{list.paymentMethod.toUpperCase()}</span>
                                                        </div>
                                                    )}
                                                    {list.address && (
                                                        <div className="bg-gray-50 rounded-lg p-2 flex items-start gap-1.5">
                                                            <i className="fa-solid fa-location-dot text-accent mt-0.5 flex-shrink-0"></i>
                                                            <span className="text-gray-600 line-clamp-2">{list.address}</span>
                                                        </div>
                                                    )}
                                                </div>
                                            )}
                                            {list.notes && <p className="text-xs text-gray-500 bg-gray-50 rounded-lg p-2"><strong>Note:</strong> {list.notes}</p>}
                                            {list.adminNote && (
                                                <div className={`border rounded-xl p-2.5 text-xs flex items-start gap-2 ${list.status==='Rejected'?'bg-red-50 border-red-200 text-red-800':'bg-blue-50 border-blue-100 text-blue-800'}`}>
                                                    <i className={`fa-solid ${list.status==='Rejected'?'fa-circle-xmark':'fa-store'} mt-0.5 flex-shrink-0`}></i>
                                                    <span><strong>{list.status==='Rejected'?'Reason':'Store'}:</strong> {list.adminNote}</span>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 20. MAIN APP COMPONENT
        // =======================================================

        const App = () => {
            // Check URL parameters for initial view (e.g., ?view=delivery)
            const getInitialView = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const viewParam = urlParams.get('view');
                if (viewParam === 'delivery') return 'delivery';
                return 'home';
            };

            const [view, setView] = useState(getInitialView());
            const [products, setProducts] = useState([]);
            const [banners, setBanners] = useState([]);
            const [cart, setCart] = useState(JSON.parse(localStorage.getItem('muruganCart') || '[]'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('muruganUser') || 'null'));
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [loadingProducts, setLoadingProducts] = useState(true);
            const [toast, setToast] = useState({ message: '', type: '' });
            const [openTicketCount, setOpenTicketCount] = useState(0);

            const totalCartItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const isDeliveryView = view === 'delivery';

            // Fetch products, banners, and check user status on load
            useEffect(() => {
                const fetchProducts = async () => {
                    const res = await get({ action: 'getProducts' });
                    if (res.status !== 'error') setProducts(res);
                    setLoadingProducts(false);
                };
                const fetchBanners = async () => {
                    const res = await get({ action: 'getBanners' });
                    if (Array.isArray(res)) setBanners(res);
                };
                fetchProducts();
                fetchBanners();

                const checkUserStatus = () => {
                    if (user && isUserBanned(user)) {
                        setToast({ message: "Your account is restricted. Logging out.", type: 'error' });
                        setUser(null);
                        localStorage.removeItem('muruganUser');
                    }
                };
                checkUserStatus();
            }, []);

            // Fetch open ticket count for admin
            useEffect(() => {
                const fetchOpenTicketCount = async () => {
                    if (getRole(user) === 'admin') {
                        const res = await get({ action: 'getOpenTicketsCount' });
                        if (res.status !== 'error' && res.count !== undefined) {
                            setOpenTicketCount(res.count);
                        } else if (res.status !== 'error') {
                            // Fallback: fetch all tickets and count open ones
                            const ticketsRes = await get({ action: 'getTickets' });
                            if (ticketsRes.status !== 'error') {
                                setOpenTicketCount(ticketsRes.filter(t => t.status === 'Open').length);
                            }
                        }
                    }
                };
                fetchOpenTicketCount();
                // Refresh every 30 seconds
                const interval = setInterval(fetchOpenTicketCount, 30000);
                return () => clearInterval(interval);
            }, [user]);

            // Sync cart to local storage
            useEffect(() => {
                localStorage.setItem('muruganCart', JSON.stringify(cart));
            }, [cart]);

            // Handle order detail view state change
            useEffect(() => {
                if (selectedOrder) setView('orders');
            }, [selectedOrder]);

            const showToast = (msg, type) => setToast({ message: msg, type });

            const addToCart = (p, qty = 1) => {
                if (isUserBanned(user)) {
                    return showToast('Account is restricted. Cannot add items to cart.', 'error');
                }
                const exist = cart.find(i => i.id === p.id);
                if (exist) setCart(cart.map(i => i.id === p.id ? { ...i, quantity: i.quantity + qty } : i));
                else setCart([...cart, { ...p, quantity: qty }]);
                showToast(`${p.name} added to cart!`, 'success');
            };

            const isAuth = view === 'login' || view === 'register';

            const renderView = () => {
                if (loadingProducts) return <LoadingSpinner />;

                switch (view) {
                    case 'login':
                    case 'register':
                        return <AuthView mode={view} setView={setView} setUser={setUser} showToast={showToast} />;
                    case 'home':
                        return <HomeView products={products} setView={setView} setSelectedProduct={setSelectedProduct} onQuickAddToCart={addToCart} banners={banners} />;
                    case 'products':
                        return <ProductsView products={products} setView={setView} setSelectedProduct={setSelectedProduct} onQuickAddToCart={addToCart} />;
                    case 'cart':
                        return <CartView cart={cart} setCart={setCart} setView={setView} showToast={showToast} />;
                    case 'checkout':
                        return <CheckoutView user={user} cart={cart} setView={setView} setCart={setCart} post={post} showToast={showToast} />;
                    case 'profile':
                        return <ProfileView user={user} setUser={setUser} setView={setView} post={post} showToast={showToast} />;
                    case 'orders':
                        return <OrdersView user={user} get={get} post={post} showToast={showToast} setSelectedOrder={setSelectedOrder} />;
                    case 'admin':
                        return <AdminView user={user} post={post} get={get} showToast={showToast} />;
                    case 'support':
                        return <SupportView user={user} get={get} post={post} showToast={showToast} setView={setView} />;
                    case 'grocerylist':
                        return <GroceryListView user={user} get={get} post={post} showToast={showToast} setView={setView} products={products} />;
                    case 'delivery':
                        return <DeliveryBoyView user={user} get={get} post={post} showToast={showToast} />;
                    default:
                        return <HomeView products={products} setView={setView} setSelectedProduct={setSelectedProduct} onQuickAddToCart={addToCart} banners={banners} />;
                }
            };

            const shouldRenderMobileNav = !isAuth && !isDeliveryView && (view !== 'admin') && (view !== 'checkout') && !selectedOrder;

            // If delivery view, render only the delivery component (it has its own layout)
            if (isDeliveryView) {
                return (
                    <>
                        <DeliveryBoyView user={user} get={get} post={post} showToast={showToast} />
                        <ToastNotification message={toast.message} type={toast.type} onClose={() => setToast({ message: '', type: '' })} />
                    </>
                );
            }

            return (
                <div className="min-h-screen flex flex-col">
                    {!isAuth && <Header user={user} setView={setView} totalCartItems={totalCartItems} openTicketCount={openTicketCount} />}

                    <main className={`flex-grow ${isAuth || selectedOrder || view==='admin' ? '' : 'pt-4 pb-16 md:pb-0'}`}>
                        {renderView()}

                        {/* Order Detail Modal for Admin/Orders View */}
                        {selectedOrder && (
                            <OrderDetailModal
                                order={selectedOrder}
                                onClose={() => setSelectedOrder(null)}
                                onUpdateStatus={(id, status) => {
                                    setSelectedOrder(prev => ({ ...prev, status }));
                                    showToast(`Order #${id} status changed to ${status}.`, 'success');
                                }}
                                role={getRole(user)}
                            />
                        )}
                    </main>

                    {/* Mobile Bottom Navigation Bar */}
                    {shouldRenderMobileNav && <MobileNavBar view={view} setView={setView} totalCartItems={totalCartItems} user={user} />}

                    {/* Product Quick View Modal */}
                    <ProductDetailModal
                        product={selectedProduct}
                        onClose={() => setSelectedProduct(null)}
                        onAddToCart={addToCart}
                    />

                    {/* Toast Notification Popup */}
                    <ToastNotification message={toast.message} type={toast.type} onClose={() => setToast({ message: '', type: '' })} />

                    <footer className="bg-primary-dark text-white text-center py-6 mt-8 flex-shrink-0 shadow-inner">
                        <div className="mb-2 font-bold text-lg tracking-wider text-accent">MADDUR MURUGAN SUPER STORE</div>
                        <div className="text-xs text-gray-400">Powered by samcm | Â© 2026. All rights reserved.</div>
                        <div className="text-xs text-gray-400 mt-2">
                            UPI ID: {UPI_CONFIG.upiId} | Accepts all UPI payments
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                            <i className="fa-solid fa-envelope mr-1"></i> Email Notifications: Login alerts, order updates, and offers
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                            <i className="fa-solid fa-truck mr-1"></i> Minimum Order: â‚¹{DELIVERY_POLICY.minimumOrder} â€¢ Free delivery in select areas
                        </div>
                        <div className="mt-3 pt-3 border-t border-gray-600">
                            <a
                                href="?view=delivery"
                                className="text-xs text-gray-400 hover:text-accent transition"
                            >
                                <i className="fa-solid fa-motorcycle mr-1"></i> Delivery Partner Portal
                            </a>
                        </div>
                    </footer>
                </div>
            );
        }

        // Render the main App component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
