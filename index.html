<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maddur Murugan Super Store</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Configuration for a More Colorful Interface
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // NEW THEME: ROYAL BLUE / BRIGHT ORANGE
                        'primary-dark': '#153A60',   // Dark Royal Blue (Header/Footer BG)
                        'primary': '#2A629A',        // Vibrant Blue (Secondary Header/Accents)
                        'accent': '#FF7F50',         // Coral/Bright Orange (Primary Buttons)
                        'accent-hover': '#FF6347',   // Tomato Red (Darker Orange)
                        'success': '#4CAF50',        // Bright Green (Success/Coins)
                        'info': '#2196F3',           // Blue (Info)
                        'danger': '#F44336',         // Red (Errors/Danger)
                        // --- NEW ADMIN COLOR ---
                        'banned': '#6B7280',         // Gray for Banned Status
                        'upi': '#6F42C1',            // Purple for UPI Payment
                        'upi-light': '#E9D8FD',      // Light Purple
                    },
                    boxShadow: {
                        // Updated shadow to match the blue theme
                        'vibrant': '0 10px 15px -3px rgba(21, 58, 96, 0.1), 0 4px 6px -2px rgba(21, 58, 96, 0.05)',
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'ping-slow': 'ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom styles for line clamping product names */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* Custom input styling */
        .text-input-style {
            padding: 0.65rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 16px; /* Prevent iOS zoom on focus */
        }
        .text-input-style:focus {
            border-color: #2A629A; /* Primary Blue on focus */
            box-shadow: 0 0 0 3px rgba(42, 98, 154, 0.2);
        }
        /* Error Box Animation */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        /* UPI QR Code Styling */
        .upi-qr-container {
            position: relative;
            display: inline-block;
        }
        .upi-qr-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: bold;
            color: #6F42C1;
            font-size: 1.2rem;
        }
        /* Payment App Buttons */
        .payment-app-btn {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .payment-app-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .payment-app-btn.active {
            border-color: #6F42C1;
            background-color: #F3F0FF;
        }
        /* Loading animation for payment verification */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        /* Custom animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.8s ease-out;
        }
        /* Smooth transitions */
        .transition-all {
            transition: all 0.3s ease;
        }
        /* Progress bar styling */
        .progress-bar {
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            background-color: #e5e7eb;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        /* Mobile-friendly improvements */
        @media (max-width: 768px) {
            /* Better touch targets */
            .touch-target {
                min-height: 44px;
                min-width: 44px;
            }
            /* Hide scrollbar but allow scroll */
            .hide-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .hide-scrollbar::-webkit-scrollbar {
                display: none;
            }
            /* Safe area for bottom nav */
            .safe-bottom {
                padding-bottom: env(safe-area-inset-bottom, 20px);
            }
            /* Mobile card view for tables */
            .mobile-card {
                display: block;
                background: white;
                border-radius: 12px;
                padding: 16px;
                margin-bottom: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                border: 1px solid #e5e7eb;
            }
            .mobile-card-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 8px 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .mobile-card-row:last-child {
                border-bottom: none;
            }
            .mobile-card-label {
                font-size: 12px;
                color: #6b7280;
                font-weight: 500;
            }
            .mobile-card-value {
                font-size: 14px;
                font-weight: 600;
                color: #1f2937;
            }
        }
        /* Bottom nav safe area */
        .bottom-nav-spacer {
            height: 70px;
        }
        @media (min-width: 768px) {
            .bottom-nav-spacer {
                height: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        // =======================================================
        // 1. GLOBAL CONSTANTS & API SETUP
        // =======================================================

        // !!! IMPORTANT: REPLACE THIS URL WITH YOUR OWN GOOGLE APPS SCRIPT WEB APP URL HERE !!!
        const API_URL = "https://script.google.com/macros/s/AKfycbyhm4liE6vXEz49jTJ1kbbHXLU8Xr64-PdZQbH8HqH7QyR1Yz_CJ1OWKeuZQTnGAjQVQg/exec";

        // UPI Configuration - Update these with your actual UPI details
        const UPI_CONFIG = {
            upiId: 'murunmurugan80-2@okicici', // Replace with your actual UPI ID
            merchantName: 'Maddur Murugan Super Store',
            qrCodeBase: 'https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=',
            paymentApps: [
                { id: 'gpay', name: 'Google Pay', icon: 'fa-brands fa-google-pay', color: 'bg-white text-gray-800', deepLink: 'tez://upi/pay' },
                { id: 'phonepe', name: 'PhonePe', icon: 'fa-solid fa-mobile-screen', color: 'bg-purple-600 text-white', deepLink: 'phonepe://upi/pay' },
                { id: 'paytm', name: 'Paytm', icon: 'fa-solid fa-wallet', color: 'bg-blue-500 text-white', deepLink: 'paytmmp://upi/pay' },
                { id: 'whatsapp', name: 'WhatsApp', icon: 'fa-brands fa-whatsapp', color: 'bg-green-500 text-white', deepLink: 'whatsapp://send' }
            ]
        };

        // Email Notification Configuration
        const EMAIL_CONFIG = {
            storeName: 'Maddur Murugan Super Store',
            storeEmail: 'noreply@muruganstore.com', // Update with your store email
            adminEmail: 'admin@muruganstore.com', // Update with admin email
            storePhone: '+91 9047878046 / +91 7530089730',
            storeAddress: '123 Main Street, Chennai, Tamil Nadu 600001',
            storeWebsite: 'https://mmsuperstore.github.io/'
        };

        // =======================================================
        // DELIVERY POLICY CONFIGURATION
        // =======================================================
        const DELIVERY_POLICY = {
            minimumOrder: 500, // ₹500 minimum order
            freeDeliveryAbove: 500, // Free delivery above ₹500
            deliveryAreas: [
                { name: 'Minimum 5 km', code: 'VLR', charge: 0, minOrder: 500 },
            ],
            nonDeliveryAreas: [
                'Maximum 8 km',

            ]
        };

        const post = async (data) => {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors', // Essential for GAS
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' }, // MUST be text/plain for GAS to parse JSON body correctly
                    body: JSON.stringify(data)
                });
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error("API Call Error:", error);
                return { status: 'error', message: 'Network or server error.' };
            }
        };

        const get = async (params) => {
            try {
                const query = new URLSearchParams(params).toString();
                const url = `${API_URL}?${query}`;
                const response = await fetch(url);
                const text = await response.text();
                return JSON.parse(text);
            } catch (error) {
                console.error("API Call Error:", error);
                return { status: 'error', message: 'Network or server error.' };
            }
        };

        const formatCurrency = (amount) => {
            return `₹${parseFloat(amount).toFixed(2)}`;
        };

        const getRole = (user) => user?.role || 'guest';
        const isUserBanned = (user) => user?.status === 'banned';

        // =======================================================
        // 2. REUSABLE UI COMPONENTS
        // =======================================================

        const Header = ({ user, setView, totalCartItems, openTicketCount }) => {
            const role = getRole(user);

            return (
                <header className="bg-primary-dark text-white sticky top-0 z-50 shadow-vibrant">
                    <div className="flex items-center justify-between p-2 md:p-3 max-w-7xl mx-auto">
                        {/* Logo */}
                        <div className="flex items-center cursor-pointer flex-shrink-0" onClick={() => setView('home')}>
                            <i className="fa-solid fa-store text-xl md:text-2xl text-accent mr-1 md:mr-2"></i>
                            <span className="text-sm sm:text-xl font-extrabold tracking-wider text-white">MMSS</span>
                            <span className="hidden lg:inline text-xl font-extrabold tracking-widest text-white">_ONLINE_SHOP</span>
                        </div>

                        {/* Search Bar - Hidden on mobile (use products page search) */}
                        <div className="flex-1 max-w-xl mx-4 hidden lg:flex">
                            <input type="text" placeholder="Search for products..." className="p-2 h-full rounded-l-md flex-grow text-gray-800 outline-none" />
                            <div className="bg-accent p-2 rounded-r-md hover:bg-accent-hover cursor-pointer transition">
                                <i className="fa-solid fa-magnifying-glass text-primary-dark"></i>
                            </div>
                        </div>

                        {/* Navigation Links */}
                        <div className="flex items-center space-x-2 md:space-x-4 text-sm font-semibold">
                            {/* Account & Lists */}
                            <div className="hover:text-accent cursor-pointer transition p-1 hidden md:block" onClick={() => setView(role === 'guest' ? 'login' : 'profile')}>
                                <p className="text-xs">Hello, {user?.name ? user.name.split(' ')[0] : 'Guest'}</p>
                                <p className="font-bold">{role === 'guest' ? 'Sign In' : 'Account'}</p>
                            </div>

                            {/* Orders - Desktop only */}
                            {role !== 'guest' && (
                                <div className="hover:text-accent cursor-pointer transition hidden lg:block p-1" onClick={() => setView('orders')}>
                                    <p className="text-xs">My</p>
                                    <p className="font-bold">Orders</p>
                                </div>
                            )}

                            {/* Admin Link - Desktop only with ticket badge */}
                            {role === 'admin' && (
                                <div className="hover:text-danger cursor-pointer transition hidden lg:block p-1 relative" onClick={() => setView('admin')}>
                                    <p className="text-xs text-danger">Panel</p>
                                    <p className="font-bold">Admin</p>
                                    {openTicketCount > 0 && (
                                        <span className="absolute -top-1 -right-1 bg-danger text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full animate-pulse">
                                            {openTicketCount > 9 ? '9+' : openTicketCount}
                                        </span>
                                    )}
                                </div>
                            )}

                            {/* Cart Icon - Always visible */}
                            <div className="flex items-center relative hover:text-accent cursor-pointer transition p-1" onClick={() => setView('cart')}>
                                <i className="fa-solid fa-cart-shopping text-xl md:text-2xl"></i>
                                {totalCartItems > 0 && (
                                    <span className="absolute -top-1 -right-1 bg-accent text-primary-dark text-[10px] md:text-xs font-bold w-4 h-4 md:w-5 md:h-5 flex items-center justify-center rounded-full">
                                        {totalCartItems > 9 ? '9+' : totalCartItems}
                                    </span>
                                )}
                                <span className="font-bold ml-1 hidden lg:inline">Cart</span>
                            </div>
                        </div>
                    </div>

                    {/* Secondary Navigation - Scrollable on mobile */}
                    <div className="bg-primary text-white p-2 flex items-center space-x-3 md:space-x-4 text-xs md:text-sm font-semibold overflow-x-auto hide-scrollbar shadow-inner">
                        <span className="flex items-center cursor-pointer text-accent hover:text-white transition whitespace-nowrap" onClick={() => setView('home')}>
                            <i className="fa-solid fa-house mr-1"></i> Home
                        </span>
                        <span className="cursor-pointer hover:text-accent transition whitespace-nowrap" onClick={() => setView('products')}>Products</span>
                        <span className="cursor-pointer hover:text-accent transition whitespace-nowrap" onClick={() => setView('support')}>Support</span>
                        {role === 'admin' && <span className="cursor-pointer hover:text-danger transition text-danger/80 whitespace-nowrap" onClick={() => setView('admin')}>Admin</span>}
                    </div>
                </header>
            );
        };

        const MobileNavBar = ({ view, setView, totalCartItems, user }) => {
            const role = getRole(user);

            const navItems = [
                { id: 'home', icon: 'fa-house', label: 'Home' },
                { id: 'products', icon: 'fa-cubes', label: 'Shop' },
                { id: 'cart', icon: 'fa-cart-shopping', label: 'Cart', count: totalCartItems },
                { id: role === 'guest' ? 'login' : 'profile', icon: 'fa-user', label: 'Account' },
                ...(role === 'admin' ? [{ id: 'admin', icon: 'fa-screwdriver-wrench', label: 'Admin' }] : [])
            ];

            return (
                <div className="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-primary shadow-2xl z-50 md:hidden safe-bottom">
                    <div className="flex justify-around items-center h-16 px-2">
                        {navItems.map(item => (
                            <button
                                key={item.id}
                                className={`flex flex-col items-center justify-center flex-1 py-2 px-1 text-xs transition-all touch-target ${view === item.id ? 'text-primary font-bold scale-105' : 'text-gray-500 active:text-primary active:scale-95'}`}
                                onClick={() => setView(item.id)}
                            >
                                <div className="relative mb-1">
                                    <i className={`fa-solid ${item.icon} text-xl`}></i>
                                    {item.count > 0 && item.id === 'cart' && (
                                        <span className="absolute -top-2 -right-3 bg-accent text-primary-dark text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full animate-pulse">
                                            {item.count > 9 ? '9+' : item.count}
                                        </span>
                                    )}
                                </div>
                                <span className="text-[10px] font-medium">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const ToastNotification = ({ message, type, onClose }) => {
            if (!message) return null;

            let bgColor = 'bg-primary-dark';
            let icon = 'fa-info-circle';

            switch (type) {
                case 'success':
                    bgColor = 'bg-success';
                    icon = 'fa-check-circle';
                    break;
                case 'error':
                    bgColor = 'bg-danger';
                    icon = 'fa-exclamation-triangle';
                    break;
                case 'warning':
                    bgColor = 'bg-accent-hover';
                    icon = 'fa-exclamation-circle';
                    break;
                case 'info':
                    bgColor = 'bg-info';
                    icon = 'fa-info-circle';
                    break;
            }

            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [message, onClose]);

            return (
                <div className={`fixed top-4 right-4 z-[100] p-4 rounded-lg text-white shadow-xl max-w-xs transition-all duration-300 ${bgColor}`}>
                    <div className="flex items-center">
                        <i className={`fa-solid ${icon} mr-3 text-lg`}></i>
                        <p className="text-sm font-semibold flex-1">{message}</p>
                        <button onClick={onClose} className="ml-4 text-white opacity-70 hover:opacity-100">
                            <i className="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                </div>
            );
        };

        const LoadingSpinner = () => (
            <div className="flex justify-center items-center py-12">
                <i className="fa-solid fa-spinner fa-spin fa-2xl text-primary"></i>
            </div>
        );

        // =======================================================
        // DELIVERY AREAS MODAL COMPONENT
        // =======================================================
        const DeliveryAreasModal = ({ isOpen, onClose }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-2xl w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <div className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4">
                                <h2 className="text-2xl font-bold text-primary-dark">Delivery Areas & Charges</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-danger transition">
                                    <i className="fa-solid fa-xmark text-xl"></i>
                                </button>
                            </div>

                            <div className="mb-6">
                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                                    <h3 className="text-lg font-bold text-primary-dark mb-2 flex items-center">
                                        <i className="fa-solid fa-info-circle mr-2 text-info"></i>
                                        Delivery Policy
                                    </h3>
                                    <ul className="text-sm text-gray-700 space-y-2">
                                        <li className="flex items-start">
                                            <i className="fa-solid fa-check-circle text-success mt-1 mr-2"></i>
                                            <span><strong>Minimum Order:</strong> ₹{DELIVERY_POLICY.minimumOrder} for all delivery areas</span>
                                        </li>
                                        <li className="flex items-start">
                                            <i className="fa-solid fa-check-circle text-success mt-1 mr-2"></i>
                                            <span><strong>Free Delivery:</strong> For orders above ₹{DELIVERY_POLICY.freeDeliveryAbove} in select areas</span>
                                        </li>
                                        <li className="flex items-start">
                                            <i className="fa-solid fa-check-circle text-success mt-1 mr-2"></i>
                                            <span><strong>Delivery Time:</strong> 1-2 hours during store hours (7 AM - 10 PM)</span>
                                        </li>
                                    </ul>
                                </div>

                                <h3 className="text-xl font-bold text-primary-dark mb-4">Serviceable Areas</h3>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    {DELIVERY_POLICY.deliveryAreas.map(area => (
                                        <div key={area.code} className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="font-bold text-gray-800">{area.name}</h4>
                                                <span className="text-xs font-semibold bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                                    {area.code}
                                                </span>
                                            </div>
                                            <div className="flex justify-between items-center">
                                                <div>
                                                    <p className="text-sm text-gray-600">Delivery Charge:</p>
                                                    <p className={`text-lg font-bold ${area.charge === 0 ? 'text-success' : 'text-gray-800'}`}>
                                                        {area.charge === 0 ? 'FREE' : `₹${area.charge}`}
                                                    </p>
                                                </div>
                                                <div>
                                                    <p className="text-sm text-gray-600">Min. Order:</p>
                                                    <p className="text-lg font-bold text-danger">₹{area.minOrder}</p>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                    <h4 className="text-lg font-bold text-yellow-800 mb-2 flex items-center">
                                        <i className="fa-solid fa-exclamation-triangle mr-2"></i>
                                        Currently Not Serviced
                                    </h4>
                                    <p className="text-sm text-gray-700 mb-2">The following areas are currently not serviced:</p>
                                    <div className="flex flex-wrap gap-2">
                                        {DELIVERY_POLICY.nonDeliveryAreas.map(area => (
                                            <span key={area} className="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                                                {area}
                                            </span>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            <div className="border-t pt-4">
                                <button
                                    onClick={onClose}
                                    className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition"
                                >
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // MINIMUM ORDER PROGRESS BAR COMPONENT
        // =======================================================
        const MinimumOrderProgress = ({ currentAmount }) => {
            const minAmount = DELIVERY_POLICY.minimumOrder;
            const progressPercentage = Math.min((currentAmount / minAmount) * 100, 100);
            const remainingAmount = Math.max(0, minAmount - currentAmount);
            const hasMinimum = currentAmount >= minAmount;

            return (
                <div className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="font-bold text-gray-800">Minimum Order Progress</h3>
                        <span className={`font-bold ${hasMinimum ? 'text-success' : 'text-accent-hover'}`}>
                            {formatCurrency(currentAmount)} / {formatCurrency(minAmount)}
                        </span>
                    </div>

                    {/* Progress Bar */}
                    <div className="progress-bar mb-3">
                        <div
                            className="progress-bar-fill bg-gradient-to-r from-blue-500 to-green-500"
                            style={{ width: `${progressPercentage}%` }}
                        ></div>
                    </div>

                    {/* Status Message */}
                    {hasMinimum ? (
                        <div className="bg-green-50 text-green-700 p-3 rounded-lg text-center">
                            <i className="fa-solid fa-check-circle mr-2"></i>
                            <strong>Congratulations!</strong> Your order meets the minimum requirement.
                        </div>
                    ) : (
                        <div className="bg-yellow-50 text-yellow-800 p-3 rounded-lg">
                            <div className="flex items-center justify-between">
                                <div>
                                    <i className="fa-solid fa-info-circle mr-2"></i>
                                    <span>Add <strong className="text-danger">{formatCurrency(remainingAmount)} more</strong> to place your order</span>
                                </div>
                                <div className="text-sm font-bold">
                                    {Math.round(progressPercentage)}%
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 3. AUTH VIEW (OTP & ERROR DISPLAY)
        // =======================================================
        const AuthView = ({ mode, setView, setUser, showToast }) => {
            const [step, setStep] = useState(1); // 1: Input Details, 2: Verify OTP
            const [form, setForm] = useState({ name: '', email: '', password: '', phone: '', otp: '' });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [authError, setAuthError] = useState(null);

            // Forgot Password Flow State
            const [forgotStep, setForgotStep] = useState(0); // 0: hidden, 1: enter email, 2: enter OTP+new password
            const [forgotForm, setForgotForm] = useState({ email: '', otp: '', newPassword: '', confirmPassword: '' });

            useEffect(() => {
                setAuthError(null);
                setStep(1);
                setForgotStep(0);
                setForm(prev => ({ ...prev, name: '', password: '', phone: '', otp: '' }));
                setForgotForm({ email: '', otp: '', newPassword: '', confirmPassword: '' });
            }, [mode]);

            // Forgot Password Handlers
            const handleForgotPassword = async (e) => {
                e.preventDefault();
                setAuthError(null);
                if (!forgotForm.email) {
                    setAuthError("Please enter your email address.");
                    return;
                }
                setIsSubmitting(true);

                const res = await post({
                    action: 'forgotPassword',
                    email: forgotForm.email
                });

                setIsSubmitting(false);
                if (res.status === 'success') {
                    setForgotStep(2);
                    showToast("OTP sent to your email!", 'success');
                } else {
                    setAuthError(res.message || "Failed to send OTP. Check your email.");
                }
            };

            const handleVerifyPasswordReset = async (e) => {
                e.preventDefault();
                setAuthError(null);

                if (forgotForm.otp.length !== 6) {
                    setAuthError("OTP must be 6 digits.");
                    return;
                }
                if (forgotForm.newPassword.length < 6) {
                    setAuthError("Password must be at least 6 characters.");
                    return;
                }
                if (forgotForm.newPassword !== forgotForm.confirmPassword) {
                    setAuthError("Passwords do not match.");
                    return;
                }

                setIsSubmitting(true);

                const res = await post({
                    action: 'verifyPasswordReset',
                    email: forgotForm.email,
                    otp: forgotForm.otp,
                    newPassword: forgotForm.newPassword
                });

                setIsSubmitting(false);
                if (res.status === 'success') {
                    showToast("Password reset successful! Please sign in.", 'success');
                    setForgotStep(0);
                    setForgotForm({ email: '', otp: '', newPassword: '', confirmPassword: '' });
                } else {
                    setAuthError(res.message || "Password reset failed.");
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setAuthError(null);
                setIsSubmitting(true);

                const res = await post({
                    action: 'login',
                    email: form.email,
                    password: form.password,
                    notifyLogin: true
                });

                setIsSubmitting(false);
                if (res.status === 'success') {
                    if (isUserBanned(res.user)) {
                        setAuthError("Your account has been restricted. Please contact support.");
                        return;
                    }
                    setUser(res.user);
                    localStorage.setItem('muruganUser', JSON.stringify(res.user));
                    showToast(`Welcome back, ${res.user.name.split(' ')[0]}!`, 'success');

                    if (res.notificationSent) {
                        setTimeout(() => {
                            showToast('Login notification sent to your email.', 'info');
                        }, 1000);
                    }

                    setView('home');
                } else {
                    setAuthError(res.message || "Invalid credentials.");
                }
            };

            const handleRegisterRequest = async (e) => {
                e.preventDefault();
                setAuthError(null);
                if (form.password.length < 6) {
                    setAuthError("Password must be at least 6 characters.");
                    return;
                }
                setIsSubmitting(true);

                const res = await post({
                    action: 'sendOtp',
                    email: form.email,
                    name: form.name,
                    password: form.password,
                    phone: form.phone
                });
                setIsSubmitting(false);

                if (res.status === 'success') {
                    setStep(2);
                    showToast("OTP sent to your email!", 'success');
                } else {
                    setAuthError(res.message || "Registration failed.");
                }
            };

            const handleVerifyOTP = async (e) => {
                e.preventDefault();
                setAuthError(null);
                if (form.otp.length !== 6) {
                    setAuthError("OTP must be 6 digits.");
                    return;
                }
                setIsSubmitting(true);

                const res = await post({
                    action: 'verifyRegister',
                    email: form.email,
                    otp: form.otp,
                    sendWelcomeEmail: true
                });
                setIsSubmitting(false);

                if (res.status === 'success') {
                    setUser(res.user);
                    localStorage.setItem('muruganUser', JSON.stringify(res.user));
                    showToast("Account created successfully!", 'success');

                    if (res.welcomeEmailSent) {
                        setTimeout(() => {
                            showToast('Welcome email sent! Check your inbox.', 'info');
                        }, 1000);
                    }

                    setView('home');
                } else {
                    setAuthError(res.message || "Verification failed.");
                }
            };

            return (
                <div className="flex flex-col justify-center items-center min-h-screen bg-gray-100 p-4 pb-20 md:pb-4">
                    <div className="bg-white p-5 md:p-8 rounded-xl border border-gray-300 w-full max-w-sm shadow-2xl">
                        <h2 className="text-2xl md:text-3xl mb-4 font-extrabold text-primary-dark border-b-2 border-accent pb-2">
                            {mode === 'login' ? 'Sign-In' : step === 1 ? 'Create Account' : 'Verify Email'}
                        </h2>

                        {/* Error Display with Shake Animation */}
                        {authError && (
                            <div className="bg-danger/10 border-l-4 border-danger p-3 mb-4 rounded flex items-start animate-shake">
                                <i className="fa-solid fa-triangle-exclamation text-danger mt-1 mr-2"></i>
                                <div>
                                    <p className="text-sm text-danger font-bold">Error!</p>
                                    <p className="text-xs text-danger/80">{authError}</p>
                                </div>
                            </div>
                        )}

                        {mode === 'login' && forgotStep === 0 && (
                            <form onSubmit={handleLogin} className="flex flex-col gap-3">
                                <label className="text-sm font-bold text-gray-700">Email</label>
                                <input required type="email" className="text-input-style" value={form.email} onChange={e => setForm({...form, email:e.target.value})} />
                                <label className="text-sm font-bold text-gray-700">Password</label>
                                <input required type="password" className="text-input-style" value={form.password} onChange={e => setForm({...form, password:e.target.value})} />
                                <div className="flex items-center justify-between text-xs mt-1">
                                    <div className="flex items-center text-gray-600">
                                        <i className="fa-solid fa-envelope mr-1"></i>
                                        <span>You'll receive a login confirmation email</span>
                                    </div>
                                    <button type="button" onClick={() => { setForgotStep(1); setForgotForm({...forgotForm, email: form.email}); }} className="text-primary hover:underline font-semibold">
                                        Forgot Password?
                                    </button>
                                </div>
                                <button type="submit" disabled={isSubmitting} className="bg-accent p-3 rounded-md font-bold text-primary-dark hover:bg-accent-hover transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Signing in...' : 'Sign In'}
                                </button>
                            </form>
                        )}

                        {/* Forgot Password - Step 1: Enter Email */}
                        {mode === 'login' && forgotStep === 1 && (
                            <form onSubmit={handleForgotPassword} className="flex flex-col gap-3">
                                <div className="bg-info/10 text-info p-3 rounded text-sm mb-2 border border-info/30">
                                    <i className="fa-solid fa-key mr-2"></i>
                                    Enter your email to receive a password reset OTP.
                                </div>
                                <label className="text-sm font-bold text-gray-700">Email Address</label>
                                <input
                                    required
                                    type="email"
                                    className="text-input-style"
                                    placeholder="Enter your registered email"
                                    value={forgotForm.email}
                                    onChange={e => setForgotForm({...forgotForm, email: e.target.value})}
                                />
                                <button type="submit" disabled={isSubmitting} className="bg-primary text-white p-3 rounded-md font-bold hover:bg-primary-dark transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Sending OTP...' : 'Send Reset OTP'}
                                </button>
                                <button type="button" onClick={() => setForgotStep(0)} className="text-xs text-primary hover:underline mt-2 text-center">
                                    <i className="fa-solid fa-arrow-left mr-1"></i> Back to Sign In
                                </button>
                            </form>
                        )}

                        {/* Forgot Password - Step 2: Enter OTP & New Password */}
                        {mode === 'login' && forgotStep === 2 && (
                            <form onSubmit={handleVerifyPasswordReset} className="flex flex-col gap-3">
                                <div className="bg-primary/10 text-primary p-3 rounded text-sm mb-2 border border-primary/30">
                                    <i className="fa-solid fa-envelope mr-2"></i>
                                    OTP sent to <strong>{forgotForm.email}</strong>.
                                </div>
                                <label className="text-sm font-bold">Enter 6-Digit OTP</label>
                                <input
                                    required
                                    type="text"
                                    inputMode="numeric"
                                    pattern="\d{6}"
                                    maxLength="6"
                                    className="text-input-style text-center tracking-widest text-2xl font-mono"
                                    placeholder="XXXXXX"
                                    value={forgotForm.otp}
                                    onChange={e => setForgotForm({...forgotForm, otp: e.target.value.replace(/\D/g, '')})}
                                />
                                <label className="text-sm font-bold">New Password</label>
                                <input
                                    required
                                    type="password"
                                    className="text-input-style"
                                    placeholder="At least 6 characters"
                                    value={forgotForm.newPassword}
                                    onChange={e => setForgotForm({...forgotForm, newPassword: e.target.value})}
                                />
                                <label className="text-sm font-bold">Confirm New Password</label>
                                <input
                                    required
                                    type="password"
                                    className="text-input-style"
                                    placeholder="Re-enter new password"
                                    value={forgotForm.confirmPassword}
                                    onChange={e => setForgotForm({...forgotForm, confirmPassword: e.target.value})}
                                />
                                <button type="submit" disabled={isSubmitting} className="bg-success text-white p-3 rounded-md font-bold hover:bg-success/80 transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Resetting...' : 'Reset Password'}
                                </button>
                                <button type="button" onClick={() => setForgotStep(1)} className="text-xs text-primary hover:underline mt-2 text-center">
                                    <i className="fa-solid fa-arrow-left mr-1"></i> Change email
                                </button>
                            </form>
                        )}

                        {mode === 'register' && step === 1 && (
                            <form onSubmit={handleRegisterRequest} className="flex flex-col gap-3">
                                <label className="text-sm font-bold">Your Name</label>
                                <input required className="text-input-style" value={form.name} onChange={e => setForm({...form, name:e.target.value})} />
                                <label className="text-sm font-bold">Phone Number</label>
                                <input required type="tel" className="text-input-style" value={form.phone} onChange={e => setForm({...form, phone:e.target.value})} />
                                <label className="text-sm font-bold">Email</label>
                                <input required type="email" className="text-input-style" value={form.email} onChange={e => setForm({...form, email:e.target.value})} />
                                <label className="text-sm font-bold">Password</label>
                                <input required type="password" className="text-input-style" placeholder="At least 6 characters" value={form.password} onChange={e => setForm({...form, password:e.target.value})} />
                                <div className="flex items-center text-xs text-gray-600 mt-1">
                                    <i className="fa-solid fa-gift mr-1"></i>
                                    <span>You'll receive a welcome email with special offers!</span>
                                </div>
                                <button type="submit" disabled={isSubmitting} className="bg-accent p-3 rounded-md font-bold text-primary-dark hover:bg-accent-hover transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Sending OTP...' : 'Continue'}
                                </button>
                            </form>
                        )}

                        {mode === 'register' && step === 2 && (
                            <form onSubmit={handleVerifyOTP} className="flex flex-col gap-3">
                                <div className="bg-primary/10 text-primary p-3 rounded text-sm mb-2 border border-primary/30">
                                    <i className="fa-solid fa-envelope mr-2"></i>
                                    OTP sent to <strong>{form.email}</strong>.
                                </div>
                                <label className="text-sm font-bold">Enter 6-Digit OTP</label>
                                <input
                                    required
                                    type="text"
                                    inputMode="numeric"
                                    pattern="\d{6}"
                                    maxLength="6"
                                    className="text-input-style text-center tracking-widest text-2xl font-mono"
                                    placeholder="XXXXXX"
                                    value={form.otp}
                                    onChange={e => setForm({...form, otp:e.target.value.replace(/\D/g, '')})}
                                />
                                <button type="submit" disabled={isSubmitting} className="bg-success text-white p-3 rounded-md font-bold hover:bg-success/80 transition mt-4 disabled:opacity-50 shadow-md">
                                    {isSubmitting ? 'Verifying...' : 'Verify & Create Account'}
                                </button>
                                <button type="button" onClick={() => setStep(1)} className="text-xs text-primary hover:underline mt-2 text-center">
                                    <i className="fa-solid fa-arrow-left mr-1"></i> Change details
                                </button>
                            </form>
                        )}

                        {forgotStep === 0 && (
                            <div className="mt-6 border-t pt-4 text-center">
                                {mode === 'login' ? (
                                    <p className="text-sm">New here? <button onClick={() => setView('register')} className="text-primary hover:underline font-semibold">Create your account</button></p>
                                ) : (
                                    <p className="text-sm">Already have an account? <button onClick={() => setView('login')} className="text-primary hover:underline font-semibold">Sign In</button></p>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // =======================================================
        // 4. HOME VIEW WITH CUSTOMIZABLE SECTIONS
        // =======================================================

        const HomeView = ({ products, setView, setSelectedProduct, onQuickAddToCart }) => {
            // ============================================
            // EASILY CUSTOMIZE THESE VARIABLES BELOW
            // ============================================

            // 1. STORE INFORMATION (Change these values)
            const STORE_CONFIG = {
                name: "Maddur Murugan Super Store",
                tagline: "Serving you fresh since 2003",
                phone: "+91 7530089730",
                address: "1/309 Bazzer Street, Maddur, Tamil Nadu 631206",
                openingHours: "6:00 AM - 9:00 PM Daily",
                whatsappNumber: "919047878046" // Without + sign
            };

            // 2. CURRENT OFFERS & DEALS (Update these regularly)
            const CURRENT_OFFERS = [
                /*{
                    id: 1,
                    title: "Special Sunday Offer",
                    description: "Buy 1 Get 1 Free on Milk",
                    icon: "fa-gift",
                    color: "bg-red-500",
                    expires: "Today Only",
                    couponCode: "SUNDAYBOGO"
                },
                {
                    id: 2,
                    title: "Weekend Discount",
                    description: "Flat 15% OFF on Vegetables",
                    icon: "fa-carrot",
                    color: "bg-green-500",
                    expires: "Weekend Special",
                    couponCode: "VEGGIE15"
                },
                {
                    id: 3,
                    title: "New User Bonus",
                    description: "₹50 OFF on First Order",
                    icon: "fa-user-plus",
                    color: "bg-blue-500",
                    expires: "For New Customers",
                    couponCode: "WELCOME50"
                },
                {
                    id: 4,
                    title: "Free Delivery",
                    description: "No delivery charges on orders above ₹300",
                    icon: "fa-truck",
                    color: "bg-purple-500",
                    expires: "Ongoing",
                    couponCode: "FREEDEL"
                }*/
            ];

            // 3. HERO BANNER CONTENT (Change images and text)
            const HERO_BANNERS = [
                {
                    id: 1,
                    title: "Fresh Groceries",
                    subtitle: "Direct from farm to your home",
                    image: "https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80",
                    buttonText: "Shop Now",
                    buttonColor: "bg-accent",
                    textColor: "text-white"
                },
                {
                    id: 2,
                    title: "Daily Essentials",
                    subtitle: "Everything you need at best prices",
                    image: "https://images.unsplash.com/photo-1556909114-f6e7ad7d3136?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80",
                    buttonText: "View Products",
                    buttonColor: "bg-primary",
                    textColor: "text-white"
                },
                {
                    id: 3,
                    title: "Special Discounts",
                    subtitle: "Upto 50% OFF on selected items",
                    image: "https://images.unsplash.com/photo-1607082350899-7e105aa886ae?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80",
                    buttonText: "View Offers",
                    buttonColor: "bg-success",
                    textColor: "text-white"
                }
            ];

            // 4. FEATURED CATEGORIES (Update based on your inventory)
            const FEATURED_CATEGORIES = [
                {
                    name: "Fresh Vegetables",
                    icon: "fa-leaf",
                    color: "text-green-500",
                    bgColor: "bg-green-50",
                    productCount: 24
                },
                {
                    name: "Dairy Products",
                    icon: "fa-cow",
                    color: "text-blue-500",
                    bgColor: "bg-blue-50",
                    productCount: 18
                },
                {
                    name: "Bakery Items",
                    icon: "fa-bread-slice",
                    color: "text-yellow-500",
                    bgColor: "bg-yellow-50",
                    productCount: 12
                },
                {
                    name: "Beverages",
                    icon: "fa-wine-bottle",
                    color: "text-purple-500",
                    bgColor: "bg-purple-50",
                    productCount: 30
                },
                {
                    name: "Snacks",
                    icon: "fa-cookie",
                    color: "text-red-500",
                    bgColor: "bg-red-50",
                    productCount: 25
                },
                {
                    name: "Household",
                    icon: "fa-home",
                    color: "text-indigo-500",
                    bgColor: "bg-indigo-50",
                    productCount: 20
                }
            ];

            // 5. TESTIMONIALS (Add customer reviews)
            const TESTIMONIALS = [
                {
                    id: 1,
                    name: "Kumar",
                    comment: "Best quality vegetables at reasonable prices. Delivery is always on time!",
                    rating: 5,
                    date: "2 days ago",
                    avatarColor: "bg-blue-400"
                },
                {
                    id: 2,
                    name: "Priya ",
                    comment: "Love their customer service.",
                    rating: 5,
                    date: "1 week ago",
                    avatarColor: "bg-pink-400"
                },
                {
                    id: 3,
                    name: "Arun",
                    comment: "Great customer service and amazing offers every weekend.",
                    rating: 4,
                    date: "3 days ago",
                    avatarColor: "bg-green-400"
                }
            ];

            // 6. STATISTICS (Update your store stats)
            const STORE_STATS = [
                { icon: 'fa-heart', label: 'Happy Families', value: '2000+', color: 'text-red-500' },
                { icon: 'fa-truck-ramp-box', label: 'Daily Orders', value: '150+', color: 'text-blue-500' },
                { icon: 'fa-leaf', label: 'Fresh Stock', value: '100%', color: 'text-green-500' },
                { icon: 'fa-star', label: 'Top Rated', value: '4.9/5', color: 'text-yellow-500' }
            ];

            // 7. TIME-BASED GREETING (Automatic - no need to change)
            const hour = new Date().getHours();
            const greeting = hour < 12 ? "Good Morning" : hour < 17 ? "Good Afternoon" : "Good Evening";
            const wishIcon = hour < 12 ? "fa-sun" : hour < 17 ? "fa-cloud-sun" : "fa-moon";

            // Get featured products (first 8 products or customize)
            const featuredProducts = products.slice(0, 8);

            // State for hero banner rotation
            const [currentBanner, setCurrentBanner] = useState(0);
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);

            // Auto rotate banners every 5 seconds
            useEffect(() => {
                const interval = setInterval(() => {
                    setCurrentBanner((prev) => (prev + 1) % HERO_BANNERS.length);
                }, 5000);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="p-3 md:p-4 max-w-7xl mx-auto space-y-6 md:space-y-8 animate-fade-in pb-20 md:pb-4">

                    {/* =========================================== */}
                    {/* 1. WHATSAPP FLOATING BUTTON */}
                    {/* =========================================== */}
                    <a
                        href={`https://wa.me/${STORE_CONFIG.whatsappNumber}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="fixed bottom-20 md:bottom-6 right-4 md:right-6 z-40 bg-[#25D366] text-white w-14 h-14 md:w-16 md:h-16 rounded-full flex items-center justify-center shadow-2xl hover:scale-110 transition-transform animate-bounce-slow"
                        title="Chat with us on WhatsApp"
                    >
                        <i className="fa-brands fa-whatsapp text-2xl md:text-3xl"></i>
                    </a>

                    {/* =========================================== */}
                    {/* 2. PERSONALIZED WELCOME BAR */}
                    {/* =========================================== */}
                    <div className="bg-gradient-to-r from-primary/10 to-accent/10 p-4 rounded-2xl flex flex-col md:flex-row items-center justify-between border border-white shadow-inner">
                        <div className="flex items-center gap-3">
                            <div className="bg-white p-2 rounded-full shadow-sm">
                                <i className={`fa-solid ${wishIcon} text-accent text-xl animate-spin-slow`}></i>
                            </div>
                            <div>
                                <h2 className="text-xl font-black text-primary-dark">
                                    {greeting}, <span className="text-primary">Welcome to {STORE_CONFIG.name}!</span>
                                </h2>
                                <p className="text-xs text-gray-500 font-medium italic">"{STORE_CONFIG.tagline}"</p>
                            </div>
                        </div>
                        <div className="mt-3 md:mt-0 flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-gray-100">
                            <i className="fa-solid fa-clock text-primary"></i>
                            <span className="text-sm font-bold text-gray-700">{STORE_CONFIG.openingHours}</span>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 3. DELIVERY POLICY NOTICE */}
                    {/* =========================================== */}
                    <div className="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-accent p-4 rounded-lg shadow-sm">
                        <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck-fast text-accent text-xl mr-3"></i>
                                <div>
                                    <h3 className="font-bold text-gray-800">Free Delivery Available!</h3>
                                    <p className="text-sm text-gray-600">
                                        Minimum order: <strong className="text-danger">₹{DELIVERY_POLICY.minimumOrder}</strong> •
                                        Free delivery in select areas •
                                        Check delivery zones
                                    </p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="bg-accent text-primary-dark px-4 py-2 rounded-lg font-semibold hover:bg-accent-hover transition whitespace-nowrap"
                            >
                                <i className="fa-solid fa-map-location-dot mr-2"></i>
                                View Delivery Areas
                            </button>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 4. HERO BANNER CAROUSEL */}
                    {/* =========================================== */}
                    <div className="relative rounded-3xl overflow-hidden shadow-2xl h-64 md:h-96">
                        {/* Banner Images */}
                        {HERO_BANNERS.map((banner, index) => (
                            <div
                                key={banner.id}
                                className={`absolute inset-0 transition-opacity duration-1000 ${index === currentBanner ? 'opacity-100' : 'opacity-0'}`}
                            >
                                <div
                                    className="absolute inset-0 bg-cover bg-center"
                                    style={{ backgroundImage: `url(${banner.image})` }}
                                >
                                    <div className="absolute inset-0 bg-gradient-to-r from-black/60 to-transparent"></div>
                                </div>

                                <div className="relative z-10 h-full flex items-center p-8 md:p-16">
                                    <div className="max-w-xl">
                                        <div className="inline-flex items-center gap-2 bg-white/20 backdrop-blur-sm px-4 py-1 rounded-full border border-white/30 mb-4">
                                            <span className="relative flex h-2 w-2">
                                                <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-accent opacity-75"></span>
                                                <span className="relative inline-flex rounded-full h-2 w-2 bg-accent"></span>
                                            </span>
                                            <span className="text-sm font-bold uppercase tracking-widest text-white">Featured Offer</span>
                                        </div>

                                        <h1 className={`text-4xl md:text-6xl font-black tracking-tighter leading-tight mb-4 ${banner.textColor}`}>
                                            {banner.title}
                                        </h1>

                                        <p className={`text-xl mb-6 ${banner.textColor}`}>
                                            {banner.subtitle}
                                        </p>

                                        <button
                                            onClick={() => setView('products')}
                                            className={`${banner.buttonColor} text-white px-8 py-3 rounded-xl font-bold text-lg hover:shadow-lg transition-all flex items-center gap-3`}
                                        >
                                            {banner.buttonText}
                                            <i className="fa-solid fa-arrow-right group-hover:translate-x-2 transition-transform"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ))}

                        {/* Banner Indicators */}
                        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
                            {HERO_BANNERS.map((_, index) => (
                                <button
                                    key={index}
                                    onClick={() => setCurrentBanner(index)}
                                    className={`w-3 h-3 rounded-full transition-all ${index === currentBanner ? 'bg-white w-8' : 'bg-white/50 hover:bg-white/80'}`}
                                    aria-label={`Go to slide ${index + 1}`}
                                />
                            ))}
                        </div>

                        {/* Navigation Arrows */}
                        <button
                            onClick={() => setCurrentBanner((prev) => (prev - 1 + HERO_BANNERS.length) % HERO_BANNERS.length)}
                            className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition"
                        >
                            <i className="fa-solid fa-chevron-left"></i>
                        </button>
                        <button
                            onClick={() => setCurrentBanner((prev) => (prev + 1) % HERO_BANNERS.length)}
                            className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition"
                        >
                            <i className="fa-solid fa-chevron-right"></i>
                        </button>
                    </div>

                    {/* =========================================== */}
                    {/* 5. QUICK OFFERS GRID */}
                    {/* =========================================== */}
                    <div>
                        <div className="flex items-center justify-between mb-6">
                            <h2 className="text-2xl md:text-3xl font-bold text-primary-dark">Today's Best Offers</h2>
                            <button
                                onClick={() => setView('products')}
                                className="text-accent hover:text-accent-hover font-semibold flex items-center gap-1"
                            >
                                View All <i className="fa-solid fa-arrow-right"></i>
                            </button>
                        </div>

                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            {CURRENT_OFFERS.map((offer) => (
                                <div
                                    key={offer.id}
                                    className="bg-white rounded-xl p-5 shadow-lg border border-gray-100 hover:shadow-xl transition-shadow duration-300"
                                >
                                    <div className="flex items-start justify-between mb-3">
                                        <div className={`${offer.color} text-white p-3 rounded-xl`}>
                                            <i className={`fa-solid ${offer.icon} text-xl`}></i>
                                        </div>
                                        <span className="text-xs font-bold bg-gray-100 text-gray-600 px-2 py-1 rounded">
                                            {offer.expires}
                                        </span>
                                    </div>

                                    <h3 className="font-bold text-lg text-gray-800 mb-2">{offer.title}</h3>
                                    <p className="text-gray-600 mb-4">{offer.description}</p>

                                    {offer.couponCode && (
                                        <div className="flex items-center justify-between mt-4 pt-4 border-t">
                                            <span className="text-sm font-semibold text-gray-500">Use Code:</span>
                                            <span className="font-mono font-bold bg-gray-100 text-primary-dark px-3 py-1 rounded">
                                                {offer.couponCode}
                                            </span>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 6. STORE STATISTICS */}
                    {/* =========================================== */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        {STORE_STATS.map((stat, index) => (
                            <div key={index} className="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow text-center group">
                                <i className={`fa-solid ${stat.icon} ${stat.color} text-2xl mb-2 group-hover:scale-125 transition-transform`}></i>
                                <h4 className="text-2xl font-black text-primary-dark">{stat.value}</h4>
                                <p className="text-xs font-bold text-gray-400 uppercase tracking-tighter">{stat.label}</p>
                            </div>
                        ))}
                    </div>

                    {/* =========================================== */}
                    {/* 7. SHOP BY CATEGORY */}
                    {/* =========================================== */}
                    <div>
                        <h2 className="text-2xl md:text-3xl font-bold text-primary-dark mb-6 text-center">
                            Shop By Category
                        </h2>

                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                            {FEATURED_CATEGORIES.map((category, index) => (
                                <div
                                    key={index}
                                    onClick={() => setView('products')}
                                    className={`${category.bgColor} p-4 rounded-xl text-center cursor-pointer hover:shadow-lg transition-all transform hover:-translate-y-1 border border-transparent hover:border-gray-200`}
                                >
                                    <i className={`fa-solid ${category.icon} ${category.color} text-3xl mb-3`}></i>
                                    <h3 className="font-bold text-gray-800">{category.name}</h3>
                                    <p className="text-xs text-gray-500 mt-1">{category.productCount} items</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 8. FEATURED PRODUCTS */}
                    {/* =========================================== */}
                    <div className="space-y-8">
                        <div className="flex flex-col items-center gap-2">
                            <h2 className="text-2xl md:text-3xl font-black text-primary-dark uppercase">Our Products</h2>
                            <div className="w-24 h-1.5 bg-accent rounded-full"></div>
                            <p className="text-gray-600 text-center">Handpicked fresh items just for you</p>
                        </div>

                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
                            {featuredProducts.map(product => (
                                <div key={product.id} className="transform hover:-translate-y-2 transition-transform duration-300">
                                    <ProductCard
                                        product={product}
                                        setSelectedProduct={setSelectedProduct}
                                        onQuickAddToCart={onQuickAddToCart}
                                    />
                                </div>
                            ))}
                        </div>

                        <div className="text-center">
                            <button
                                onClick={() => setView('products')}
                                className="bg-accent text-primary-dark px-8 py-3 rounded-xl font-bold text-lg hover:bg-accent-hover transition shadow-md"
                            >
                                View All Products ({products.length})
                            </button>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 9. CUSTOMER TESTIMONIALS */}
                    {/* =========================================== */}
                    <div className="bg-primary-dark/5 p-8 rounded-3xl">
                        <h2 className="text-2xl md:text-3xl font-bold text-primary-dark mb-8 text-center">
                            What Our Customers Say
                        </h2>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            {TESTIMONIALS.map(testimonial => (
                                <div key={testimonial.id} className="bg-white p-6 rounded-xl shadow-md">
                                    <div className="flex items-center mb-4">
                                        <div className={`${testimonial.avatarColor} w-12 h-12 rounded-full flex items-center justify-center text-white font-bold mr-3`}>
                                            {testimonial.name.charAt(0)}
                                        </div>
                                        <div>
                                            <h4 className="font-bold text-gray-800">{testimonial.name}</h4>
                                            <div className="flex text-yellow-400">
                                                {[...Array(5)].map((_, i) => (
                                                    <i
                                                        key={i}
                                                        className={`fa-solid fa-star ${i < testimonial.rating ? 'text-yellow-400' : 'text-gray-300'}`}
                                                    ></i>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <p className="text-gray-600 italic mb-4">"{testimonial.comment}"</p>

                                    <div className="text-xs text-gray-500 flex justify-between items-center">
                                        <span>{testimonial.date}</span>
                                        <i className="fa-solid fa-quote-right text-primary/30"></i>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 10. STORE INFO & CONTACT */}
                    {/* =========================================== */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {/* Store Info */}
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center">
                                <i className="fa-solid fa-store mr-2 text-accent"></i> Store Information
                            </h3>
                            <ul className="space-y-3">
                                <li className="flex items-center">
                                    <i className="fa-solid fa-clock text-gray-400 w-5 mr-3"></i>
                                    <span className="text-gray-700">{STORE_CONFIG.openingHours}</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-phone text-gray-400 w-5 mr-3"></i>
                                    <span className="text-gray-700">{STORE_CONFIG.phone}</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-location-dot text-gray-400 w-5 mr-3"></i>
                                    <span className="text-gray-700">{STORE_CONFIG.address}</span>
                                </li>
                            </ul>
                        </div>

                        {/* Why Choose Us */}
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center">
                                <i className="fa-solid fa-award mr-2 text-accent"></i> Why Choose Us
                            </h3>
                            <ul className="space-y-3">
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">100% Fresh Products</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">Free Home Delivery</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">Easy Returns & Refunds</span>
                                </li>
                                <li className="flex items-center">
                                    <i className="fa-solid fa-check-circle text-green-500 w-5 mr-3"></i>
                                    <span className="text-gray-700">24/7 Customer Support</span>
                                </li>
                            </ul>
                        </div>

                        {/* Quick Links */}
                        <div className="bg-white p-6 rounded-xl shadow-md">
                            <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center">
                                <i className="fa-solid fa-link mr-2 text-accent"></i> Quick Links
                            </h3>
                            <ul className="space-y-3">
                                <li>
                                    <button
                                        onClick={() => setView('products')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Browse All Products
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('support')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Contact Support
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('orders')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        Track Your Order
                                    </button>
                                </li>
                                <li>
                                    <button
                                        onClick={() => setView('profile')}
                                        className="text-gray-700 hover:text-primary transition flex items-center"
                                    >
                                        <i className="fa-solid fa-chevron-right text-xs mr-2 text-gray-400"></i>
                                        My Account
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </div>

                    {/* =========================================== */}
                    {/* 11. FINAL GREETING & SOCIAL PROOF */}
                    {/* =========================================== */}
                    <div className="text-center py-10 bg-primary-dark rounded-[2rem] text-white overflow-hidden relative">
                        <div className="relative z-10">
                            <h3 className="text-2xl font-bold mb-4">Thank you for visiting {STORE_CONFIG.name}!</h3>
                            <p className="text-gray-300 mb-6 max-w-2xl mx-auto">
                                We're committed to providing you with the freshest groceries and best shopping experience.
                                Your satisfaction is our priority!
                            </p>

                            <div className="flex justify-center gap-4 text-2xl">
                                <a href="#" className="text-white hover:text-accent transition">
                                    <i className="fa-brands fa-facebook"></i>
                                </a>
                                <a href="#" className="text-white hover:text-accent transition">
                                    <i className="fa-brands fa-instagram"></i>
                                </a>
                                <a href="#" className="text-white hover:text-accent transition">
                                    <i className="fa-brands fa-twitter"></i>
                                </a>
                                <a
                                    href={`https://wa.me/${STORE_CONFIG.whatsappNumber}`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="text-white hover:text-green-400 transition"
                                >
                                    <i className="fa-brands fa-whatsapp"></i>
                                </a>
                            </div>

                            <div className="mt-6 flex justify-center gap-4">
                                <i className="fa-solid fa-heart text-red-400 animate-pulse-slow"></i>
                                <i className="fa-solid fa-heart text-red-400 animate-pulse-slow delay-75"></i>
                                <i className="fa-solid fa-heart text-red-400 animate-pulse-slow delay-150"></i>
                            </div>
                        </div>

                        {/* Background Glow Effect */}
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-accent/5 blur-[120px]"></div>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 5. PRODUCT CARD COMPONENT
        // =======================================================

        const ProductCard = ({ product, setSelectedProduct, onQuickAddToCart }) => {

            const handleQuickAdd = (e) => {
                e.stopPropagation();
                onQuickAddToCart(product, 1);
            };

            return (
                <div className="bg-white border p-3 md:p-4 rounded-xl shadow hover:shadow-lg transition duration-300 cursor-pointer flex flex-col justify-between transform hover:scale-[1.02] relative group" onClick={() => setSelectedProduct(product)}>
                    <img src={product.image || 'https://placehold.co/200x150?text=No+Image'} alt={product.name} className="w-full h-24 md:h-32 object-contain mb-2 md:mb-3 rounded-md bg-gray-50" />
                    <div className="flex-1">
                        <h3 className="text-sm md:text-md font-semibold mb-1 line-clamp-2 text-primary-dark leading-tight">{product.name}</h3>
                        <p className="text-[10px] md:text-xs text-gray-500 mb-1 md:mb-2">{product.category}</p>
                        <p className="text-lg md:text-xl font-extrabold text-danger">{formatCurrency(product.price)}</p>
                    </div>
                    {/* Quick Add Button - Desktop hover effect */}
                    <button onClick={handleQuickAdd} className="hidden md:flex absolute bottom-4 right-4 bg-accent text-primary-dark p-2 rounded-full shadow-lg hover:bg-accent-hover transition transform translate-x-12 group-hover:translate-x-0 opacity-0 group-hover:opacity-100 ease-in-out duration-300 items-center justify-center">
                        <i className="fa-solid fa-cart-plus text-lg"></i>
                    </button>
                    {/* Mobile add button - always visible */}
                    <button onClick={handleQuickAdd} className="mt-2 w-full bg-accent text-primary-dark py-2.5 rounded-lg font-bold text-xs hover:bg-accent-hover transition md:hidden touch-target active:scale-95">
                        <i className="fa-solid fa-cart-plus mr-1"></i> Add to Cart
                    </button>
                </div>
            );
        };

        // =======================================================
        // 6. PRODUCTS VIEW
        // =======================================================

        const ProductsView = ({ products, setSelectedProduct, onQuickAddToCart }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [sortOption, setSortOption] = useState('name-asc');
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);
            const categories = useMemo(() => ['All', ...new Set(products.map(p => p.category))], [products]);

            const filteredProducts = useMemo(() => {
                let filtered = products.filter(p =>
                    p.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    p.description.toLowerCase().includes(searchTerm.toLowerCase())
                );
                if (selectedCategory !== 'All') filtered = filtered.filter(p => p.category === selectedCategory);

                return filtered.sort((a, b) => {
                    const priceA = parseFloat(a.price) || 0;
                    const priceB = parseFloat(b.price) || 0;

                    if (sortOption === 'price-asc') return priceA - priceB;
                    if (sortOption === 'price-desc') return priceB - priceA;
                    return sortOption === 'name-asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name);
                });
            }, [products, searchTerm, selectedCategory, sortOption]);

            return (
                <div className="p-3 md:p-4 max-w-7xl mx-auto pb-20 md:pb-4">
                    <div className="flex flex-col sm:flex-row sm:items-center justify-between mb-4 md:mb-6 gap-3">
                        <h1 className="text-2xl md:text-3xl font-bold text-primary-dark">
                            <i className="fa-solid fa-cubes mr-2 text-primary"></i>
                            Products <span className="text-lg text-gray-500">({filteredProducts.length})</span>
                        </h1>
                        <button
                            onClick={() => setShowDeliveryModal(true)}
                            className="bg-accent text-primary-dark px-4 py-2 rounded-lg font-semibold hover:bg-accent-hover transition flex items-center justify-center touch-target"
                        >
                            <i className="fa-solid fa-truck-fast mr-2"></i>
                            Delivery Areas
                        </button>
                    </div>

                    {/* Search and Filter - Mobile Optimized */}
                    <div className="bg-white p-3 md:p-4 rounded-xl shadow-md mb-4 md:mb-6 border border-gray-100">
                        <div className="relative mb-3">
                            <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input
                                type="text"
                                placeholder="Search products..."
                                className="text-input-style pl-10"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <div className="grid grid-cols-2 gap-2 md:gap-4">
                            <div>
                                <label className="text-xs font-semibold mb-1 block text-gray-600">Category</label>
                                <select className="text-input-style text-sm" value={selectedCategory} onChange={(e) => setSelectedCategory(e.target.value)}>
                                    {categories.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-semibold mb-1 block text-gray-600">Sort</label>
                                <select className="text-input-style text-sm" value={sortOption} onChange={(e) => setSortOption(e.target.value)}>
                                    <option value="name-asc">A-Z</option>
                                    <option value="name-desc">Z-A</option>
                                    <option value="price-asc">Price ↑</option>
                                    <option value="price-desc">Price ↓</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Delivery Notice */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center">
                            <i className="fa-solid fa-info-circle text-blue-500 text-xl mr-3"></i>
                            <div>
                                <p className="font-semibold text-gray-800">Minimum Order: ₹{DELIVERY_POLICY.minimumOrder}</p>
                                <p className="text-sm text-gray-600">Add more items to reach the minimum order requirement for delivery.</p>
                            </div>
                        </div>
                    </div>

                    {filteredProducts.length === 0 ? <div className="text-center py-10 text-xl text-gray-500"><i className="fa-solid fa-face-frown mr-2"></i> No products found matching your criteria.</div> :
                        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                            {filteredProducts.map(p => <ProductCard key={p.id} product={p} setSelectedProduct={setSelectedProduct} onQuickAddToCart={onQuickAddToCart} />)}
                        </div>
                    }

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 7. PRODUCT DETAIL MODAL
        // =======================================================

        const ProductDetailModal = ({ product, onClose, onAddToCart }) => {
            if (!product) return null;
            const [quantity, setQuantity] = useState(1);
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-end md:items-center p-0 md:p-4" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <div className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4">
                                <h2 className="text-3xl font-bold text-primary-dark">{product.name}</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-danger transition"><i className="fa-solid fa-xmark text-2xl"></i></button>
                            </div>
                            <div className="md:flex gap-8">
                                <div className="md:w-1/2">
                                    <img src={product.image || 'https://placehold.co/400x300?text=No+Image'} className="w-full h-80 object-contain mb-4 border-4 border-gray-100 p-4 rounded-lg bg-white" />
                                    <h3 className="text-xl font-bold mb-2 text-primary">Description</h3>
                                    <p className="text-sm text-gray-700 leading-relaxed">{product.description || "No detailed description available for this product."}</p>
                                </div>
                                <div className="md:w-1/2 bg-gray-50 p-6 rounded-xl border border-primary/10 mt-6 md:mt-0">
                                    <p className="text-xl text-gray-600 mb-2">Category: <span className="font-semibold text-primary">{product.category}</span></p>
                                    <p className="text-3xl font-extrabold text-danger my-4">Price: {formatCurrency(product.price)}</p>

                                    <div className="flex items-center space-x-4 my-6">
                                        <label className="font-bold text-lg">Quantity:</label>
                                        <input type="number" min="1" value={quantity} onChange={(e) => setQuantity(Math.max(1, parseInt(e.target.value) || 1))} className="w-20 text-center border-2 border-primary/50 rounded-lg p-2 font-semibold text-primary-dark" />
                                    </div>
                                    <button onClick={() => { onAddToCart(product, quantity); setQuantity(1); }} className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold text-lg hover:bg-accent-hover transition shadow-md">
                                        <i className="fa-solid fa-cart-plus mr-2"></i> Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 8. CART VIEW
        // =======================================================

        const CartView = ({ cart, setCart, setView, showToast }) => {
            const subtotal = cart.reduce((sum, item) => sum + parseFloat(item.price) * item.quantity, 0);
            const hasMinimum = subtotal >= DELIVERY_POLICY.minimumOrder;
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);

            const updateQuantity = (id, newQty) => {
                if (newQty <= 0) {
                    setCart(cart.filter(item => item.id !== id));
                    showToast('Item removed.', 'warning');
                } else {
                    setCart(cart.map(item => item.id === id ? { ...item, quantity: newQty } : item));
                }
            };

            if (cart.length === 0) return (
                <div className="text-center py-16 md:py-20 px-4 pb-24 md:pb-20">
                    <i className="fa-solid fa-cart-arrow-down fa-4x md:fa-5x text-primary/30 mb-4 md:mb-6"></i>
                    <h1 className="text-2xl md:text-3xl font-bold text-primary-dark">Your Cart is Empty!</h1>
                    <p className="text-gray-600 mt-2 mb-4 md:mb-6">Time to fill it with awesome products.</p>
                    <button
                        onClick={() => setView('home')}
                        className="bg-primary text-white px-6 md:px-8 py-3 rounded-lg font-bold text-base md:text-lg hover:bg-primary-dark transition shadow-lg touch-target"
                    >
                        <i className="fa-solid fa-arrow-left mr-2"></i> Back to Home
                    </button>
                </div>
            );

            return (
                <div className="p-3 md:p-4 max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 pb-24 md:pb-4">
                    {/* Left Column: Cart Items */}
                    <div className="lg:col-span-2 space-y-3 md:space-y-4">
                        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2 md:mb-4">
                            <h1 className="text-xl md:text-3xl font-bold text-primary-dark flex items-center">
                                <i className="fa-solid fa-cart-shopping mr-2 text-primary"></i>
                                Cart <span className="text-base md:text-xl text-gray-500 ml-2">({cart.length})</span>
                            </h1>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="text-sm text-primary hover:text-primary-dark font-semibold flex items-center bg-primary/10 px-3 py-1.5 rounded-lg self-start sm:self-auto"
                            >
                                <i className="fa-solid fa-map-location-dot mr-1"></i>
                                Delivery Areas
                            </button>
                        </div>

                        {/* Minimum Order Progress Bar */}
                        <MinimumOrderProgress currentAmount={subtotal} />

                        {cart.map(item => (
                            <div key={item.id} className="flex flex-col sm:flex-row p-4 border-2 border-gray-100 rounded-xl bg-white shadow-md hover:shadow-lg transition gap-4">

                                {/* Product Image */}
                                <div className="flex-shrink-0 flex justify-center items-start">
                                    <img
                                        src={item.image || 'https://placehold.co/100x100?text=No+Image'}
                                        className="w-24 h-24 object-contain border rounded-lg p-1 bg-white"
                                        alt={item.name}
                                    />
                                </div>

                                {/* Product Details */}
                                <div className="flex-grow min-w-0">
                                    <h2 className="text-lg font-bold text-primary-dark line-clamp-2 break-words leading-tight">
                                        {item.name}
                                    </h2>
                                    <p className="text-xl text-danger font-extrabold my-1">
                                        {formatCurrency(parseFloat(item.price) * item.quantity)}
                                    </p>
                                    <p className="text-xs text-gray-500">
                                        Unit Price: {formatCurrency(item.price)}
                                    </p>
                                </div>

                                {/* Actions */}
                                <div className="flex flex-row sm:flex-col items-center sm:items-end justify-between sm:justify-between border-t sm:border-t-0 pt-3 sm:pt-0">
                                    <div className="flex items-center space-x-2 bg-gray-100 rounded-full p-1">
                                        <button
                                            onClick={() => updateQuantity(item.id, item.quantity - 1)}
                                            className="bg-primary text-white w-8 h-8 rounded-full hover:bg-primary-dark transition flex items-center justify-center"
                                        >
                                            <i className="fa-solid fa-minus text-xs"></i>
                                        </button>
                                        <span className="w-8 text-center font-bold text-lg">{item.quantity}</span>
                                        <button
                                            onClick={() => updateQuantity(item.id, item.quantity + 1)}
                                            className="bg-primary text-white w-8 h-8 rounded-full hover:bg-primary-dark transition flex items-center justify-center"
                                        >
                                            <i className="fa-solid fa-plus text-xs"></i>
                                        </button>
                                    </div>

                                    <button
                                        onClick={() => updateQuantity(item.id, 0)}
                                        className="text-danger hover:underline text-sm font-semibold mt-0 sm:mt-2"
                                    >
                                        <i className="fa-solid fa-trash-can mr-1"></i> Remove
                                    </button>
                                </div>
                            </div>
                        ))}

                        {/* Continue Shopping Button */}
                        <div className="flex justify-between items-center pt-4">
                            <button
                                onClick={() => setView('products')}
                                className="bg-gray-100 text-gray-800 px-6 py-3 rounded-lg font-semibold hover:bg-gray-200 transition"
                            >
                                <i className="fa-solid fa-arrow-left mr-2"></i>
                                Continue Shopping
                            </button>

                            {!hasMinimum && (
                                <div className="text-right">
                                    <p className="text-sm text-gray-600">Need {formatCurrency(DELIVERY_POLICY.minimumOrder - subtotal)} more</p>
                                    <p className="text-xs text-gray-500">to reach minimum order</p>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Right Column: Summary */}
                    <div className="lg:col-span-1">
                        <div className="sticky top-4 p-6 bg-white rounded-xl shadow-vibrant border-2 border-primary/20">
                            <h2 className="text-2xl font-bold text-primary mb-4 border-b pb-2">Order Summary</h2>
                            <div className="flex justify-between text-xl font-bold mb-4">
                                <span>Subtotal:</span>
                                <span className="text-danger">{formatCurrency(subtotal)}</span>
                            </div>

                            {/* Minimum Order Warning */}
                            {!hasMinimum ? (
                                <div className="bg-red-50 text-red-700 p-3 rounded-lg mb-4 border border-red-200">
                                    <div className="flex items-center">
                                        <i className="fa-solid fa-exclamation-triangle mr-2"></i>
                                        <div>
                                            <p className="font-bold">Minimum Order Not Met</p>
                                            <p className="text-sm">Add {formatCurrency(DELIVERY_POLICY.minimumOrder - subtotal)} more to checkout</p>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-green-50 text-green-700 p-3 rounded-lg mb-4 border border-green-200">
                                    <div className="flex items-center">
                                        <i className="fa-solid fa-check-circle mr-2"></i>
                                        <div>
                                            <p className="font-bold">Minimum Order Achieved!</p>
                                            <p className="text-sm">You can proceed to checkout</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <p className="text-sm text-gray-500 mb-6 flex items-center">
                                <i className="fa-solid fa-truck-fast mr-2 text-success"></i>
                                Free shipping on all orders above ₹{DELIVERY_POLICY.freeDeliveryAbove}!
                            </p>

                            <button
                                onClick={() => setView('checkout')}
                                disabled={!hasMinimum}
                                className={`w-full p-3 rounded-lg font-bold text-lg shadow-md transition transform active:scale-95 ${hasMinimum ? 'bg-accent text-primary-dark hover:bg-accent-hover' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                            >
                                {hasMinimum ? 'Proceed to Checkout' : 'Add More Items to Checkout'}
                            </button>

                            {!hasMinimum && (
                                <button
                                    onClick={() => setView('products')}
                                    className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition mt-3"
                                >
                                    <i className="fa-solid fa-cart-plus mr-2"></i>
                                    Continue Shopping
                                </button>
                            )}
                        </div>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 9. UPI PAYMENT COMPONENTS
        // =======================================================

        const UpiPaymentView = ({ finalTotal, upiId, orderId, onPaymentComplete, onBack, showToast }) => {
            const [selectedApp, setSelectedApp] = useState(null);
            const [paymentStatus, setPaymentStatus] = useState('pending');
            const [transactionId, setTransactionId] = useState('');
            const [isVerifying, setIsVerifying] = useState(false);

            const upiPaymentLink = `upi://pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}&cu=INR`;
            const qrCodeUrl = `${UPI_CONFIG.qrCodeBase}${encodeURIComponent(upiPaymentLink)}`;

            const handleCopyUpiId = () => {
                navigator.clipboard.writeText(upiId).then(() => {
                    showToast('UPI ID copied to clipboard!', 'success');
                });
            };

            const handleCopyPaymentLink = () => {
                navigator.clipboard.writeText(upiPaymentLink).then(() => {
                    showToast('Payment link copied!', 'success');
                });
            };

            const handleOpenPaymentApp = (app) => {
                setSelectedApp(app.id);

                let deepLink = '';
                switch(app.id) {
                    case 'gpay':
                        deepLink = `tez://upi/pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}`;
                        break;
                    case 'phonepe':
                        deepLink = `phonepe://upi/pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}`;
                        break;
                    case 'paytm':
                        deepLink = `paytmmp://upi/pay?pa=${upiId}&pn=Murugan%20Store&am=${finalTotal}&tn=Order-${orderId}`;
                        break;
                    case 'whatsapp':
                        deepLink = `whatsapp://send?text=Please%20pay%20₹${finalTotal}%20to%20${upiId}%20for%20Order%20${orderId}`;
                        break;
                    default:
                        deepLink = upiPaymentLink;
                }

                window.location.href = deepLink;

                setTimeout(() => {
                    window.location.href = upiPaymentLink;
                }, 1000);

                showToast(`Opening ${app.name}...`, 'info');
            };

            const handleVerifyPayment = async () => {
                if (!transactionId.trim()) {
                    showToast('Please enter transaction ID', 'error');
                    return;
                }

                setIsVerifying(true);
                setPaymentStatus('processing');

                setTimeout(() => {
                    setIsVerifying(false);
                    setPaymentStatus('completed');
                    showToast('Payment verified successfully!', 'success');

                    setTimeout(() => {
                        onPaymentComplete(transactionId);
                    }, 1500);
                }, 2000);
            };

            const handleManualVerification = () => {
                setPaymentStatus('completed');
                onPaymentComplete('MANUAL-' + Date.now().toString().slice(-8));
            };

            return (
                <div className="p-4 max-w-4xl mx-auto">
                    <div className="mb-6">
                        <button onClick={onBack} className="text-primary hover:text-primary-dark font-semibold mb-4 flex items-center">
                            <i className="fa-solid fa-arrow-left mr-2"></i> Back to Checkout
                        </button>
                        <h1 className="text-3xl font-bold text-primary-dark">UPI Payment</h1>
                        <p className="text-gray-600 mt-2">Complete your payment using any UPI app</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* Left Column - Payment Details */}
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4">Payment Details</h2>

                                <div className="space-y-4">
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Order ID:</span>
                                        <span className="font-semibold">#{orderId}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">Amount to Pay:</span>
                                        <span className="text-2xl font-bold text-danger">{formatCurrency(finalTotal)}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-gray-600">UPI ID:</span>
                                        <div className="flex items-center">
                                            <span className="font-mono font-bold text-upi">{upiId}</span>
                                            <button onClick={handleCopyUpiId} className="ml-2 text-upi hover:text-upi-dark">
                                                <i className="fa-solid fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Payment Apps */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4">Open Payment App</h2>
                                <p className="text-sm text-gray-600 mb-4">Click your preferred app to open and pay</p>

                                <div className="grid grid-cols-2 gap-3">
                                    {UPI_CONFIG.paymentApps.map(app => (
                                        <button
                                            key={app.id}
                                            onClick={() => handleOpenPaymentApp(app)}
                                            className={`payment-app-btn p-3 rounded-lg flex flex-col items-center justify-center ${selectedApp === app.id ? 'active' : ''} ${app.color}`}
                                        >
                                            <i className={`${app.icon} text-2xl mb-2`}></i>
                                            <span className="text-sm font-semibold">{app.name}</span>
                                        </button>
                                    ))}
                                </div>

                                <div className="mt-4 text-center">
                                    <button
                                        onClick={handleCopyPaymentLink}
                                        className="text-sm text-upi hover:text-upi-dark font-semibold"
                                    >
                                        <i className="fa-solid fa-link mr-1"></i> Copy Payment Link
                                    </button>
                                </div>
                            </div>

                            {/* Payment Verification */}
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4">Verify Payment</h2>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-semibold mb-2">Transaction ID (UTR) With Name</label>
                                        <input
                                            type="text"
                                            placeholder="Enter transaction ID from your app"
                                            className="text-input-style"
                                            value={transactionId}
                                            onChange={(e) => setTransactionId(e.target.value)}
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Find this in your payment app after transaction with 12 Number</p>
                                    </div>

                                    <button
                                        onClick={handleVerifyPayment}
                                        disabled={isVerifying || !transactionId.trim()}
                                        className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition disabled:opacity-50"
                                    >
                                        {isVerifying ? (
                                            <>
                                                <i className="fa-solid fa-spinner fa-spin mr-2"></i>
                                                Verifying Payment...
                                            </>
                                        ) : 'Verify Payment'}
                                    </button>

                                    <div className="text-center">

                                          Example : 600645274493--murugan

                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Right Column - QR Code */}
                        <div className="space-y-6">
                            <div className="bg-white p-6 rounded-xl shadow-md border border-gray-200">
                                <h2 className="text-xl font-bold text-primary-dark mb-4 text-center">Scan & Pay</h2>

                                <div className="flex flex-col items-center">
                                    <div className="upi-qr-container mb-4">
                                        <img
                                            src={qrCodeUrl}
                                            alt="UPI QR Code"
                                            className="w-64 h-64 border-4 border-white shadow-lg rounded-lg"
                                        />
                                    </div>

                                    <div className="text-center space-y-2">
                                        <p className="text-sm text-gray-600">Scan QR code with any UPI app</p>
                                        <p className="font-mono font-bold text-upi text-lg">{upiId}</p>
                                        <p className="text-sm text-gray-500">Amount: {formatCurrency(finalTotal)}</p>
                                    </div>

                                    <div className="mt-6 bg-upi-light p-4 rounded-lg w-full">
                                        <h3 className="font-bold text-upi mb-2 flex items-center">
                                            <i className="fa-solid fa-lightbulb mr-2"></i> How to Pay
                                        </h3>
                                        <ol className="text-sm text-gray-700 space-y-1 list-decimal list-inside">
                                            <li>Open any UPI app on your phone</li>
                                            <li>Tap on "Scan QR Code"</li>
                                            <li>Point camera at the QR code above</li>
                                            <li>Verify amount and confirm payment</li>
                                            <li>Save transaction ID for verification</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>

                            {/* Payment Status */}
                            <div className={`p-6 rounded-xl border-2 ${paymentStatus === 'completed' ? 'bg-green-50 border-success' : paymentStatus === 'processing' ? 'bg-blue-50 border-info' : 'bg-yellow-50 border-accent'}`}>
                                <h3 className="text-lg font-bold mb-3 flex items-center">
                                    {paymentStatus === 'completed' ? (
                                        <>
                                            <i className="fa-solid fa-check-circle text-success mr-2"></i>
                                            Payment Completed
                                        </>
                                    ) : paymentStatus === 'processing' ? (
                                        <>
                                            <i className="fa-solid fa-spinner fa-spin text-info mr-2"></i>
                                            Payment Processing
                                        </>
                                    ) : (
                                        <>
                                            <i className="fa-solid fa-clock text-accent mr-2"></i>
                                            Payment Pending
                                        </>
                                    )}
                                </h3>

                                <div className="space-y-2">
                                    {paymentStatus === 'completed' ? (
                                        <p className="text-success font-semibold">Payment verified! Your order will be processed.</p>
                                    ) : paymentStatus === 'processing' ? (
                                        <p className="text-info font-semibold animate-pulse">Verifying your payment...</p>
                                    ) : (
                                        <p className="text-gray-700">Complete payment to confirm your order</p>
                                    )}

                                    {transactionId && (
                                        <p className="text-sm">
                                            <span className="font-semibold">Transaction ID:</span> {transactionId}
                                        </p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 10. CHECKOUT VIEW
        // =======================================================

        const CheckoutView = ({ user, cart, setView, setCart, post, showToast }) => {
            const [address, setAddress] = useState('');
            const [couponCode, setCouponCode] = useState('');
            const [discountData, setDiscountData] = useState({ discount: 0, message: '', total: null });
            const [isPlacing, setIsPlacing] = useState(false);
            const [paymentMethod, setPaymentMethod] = useState('cod');
            const [showUpiPayment, setShowUpiPayment] = useState(false);
            const [orderId, setOrderId] = useState(null);
            const [emailUpdates, setEmailUpdates] = useState(true);
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);
            const [deliveryArea, setDeliveryArea] = useState('');
            const [deliveryCharge, setDeliveryCharge] = useState(0);

            const originalTotal = cart.reduce((sum, item) => sum + parseFloat(item.price) * item.quantity, 0);
            const finalTotal = (discountData.total !== null ? discountData.total : originalTotal) + deliveryCharge;

            // Check minimum order requirement
            const hasMinimum = originalTotal >= DELIVERY_POLICY.minimumOrder;

            useEffect(() => {
                if (getRole(user) === 'guest') {
                    showToast('Sign in to checkout.', 'error');
                    setView('login');
                }
                if (isUserBanned(user)) {
                    showToast('Cannot proceed: Your account is restricted.', 'error');
                    setView('profile');
                }
                if (!hasMinimum) {
                    showToast(`Minimum order is ₹${DELIVERY_POLICY.minimumOrder}. Add more items.`, 'error');
                }
            }, [user, hasMinimum]);

            const handleApplyCoupon = async () => {
                if (!couponCode) return;

                const res = await post({ action: 'applyCoupon', couponCode, totalAmount: originalTotal });

                if (res.status === 'success') {
                    setDiscountData({ discount: res.discountAmount, message: res.message, total: res.newTotal });
                    showToast('Coupon applied!', 'success');

                    if (res.couponApplied) {
                        setTimeout(() => {
                            showToast('Coupon usage notification sent.', 'info');
                        }, 500);
                    }
                } else {
                    setDiscountData({ discount: 0, message: res.message, total: null });
                    showToast(res.message, 'error');
                }
            };

            const handlePlaceOrder = async (paymentMethodUsed = paymentMethod, transactionId = null) => {
                if (!hasMinimum) {
                    return showToast(`Minimum order is ₹${DELIVERY_POLICY.minimumOrder}. Add more items.`, 'error');
                }
                if (!address) return showToast('Delivery address is required.', 'error');
                if (!deliveryArea) return showToast('Please select a delivery area.', 'error');
                if (cart.length === 0) return showToast('Your cart is empty.', 'error');

                setIsPlacing(true);

                const orderData = {
                    action: 'placeOrder',
                    email: user.email,
                    total: finalTotal,
                    items: cart.map(i => ({ id: i.id, name: i.name, price: i.price, qty: i.quantity })),
                    transactionId: transactionId || (paymentMethodUsed === 'cod' ? 'COD-' + Date.now().toString().slice(-6) : 'UPI-' + Date.now().toString().slice(-6)),
                    address: address,
                    deliveryArea: deliveryArea,
                    deliveryCharge: deliveryCharge,
                    paymentMethod: paymentMethodUsed,
                    paymentStatus: paymentMethodUsed === 'cod' ? 'pending' : (transactionId ? 'paid' : 'pending'),
                    sendOrderConfirmation: emailUpdates,
                    notifyAdmin: true
                };

                const res = await post(orderData);
                setIsPlacing(false);

                if (res.status === 'success') {
                    showToast(`Order #${res.orderId} placed! Earned ${res.awardedCoins} coins.`, 'success');

                    if (res.orderEmailSent && emailUpdates) {
                        setTimeout(() => {
                            showToast('Order confirmation email sent to your inbox.', 'info');
                        }, 1000);
                    }

                    if (res.adminNotified) {
                        setTimeout(() => {
                            showToast('Admin has been notified about your order.', 'info');
                        }, 1500);
                    }

                    setCart([]);
                    setView('orders');
                } else {
                    showToast(res.message, 'error');
                }
            };

            const handleProceedToUpiPayment = () => {
                if (!hasMinimum) {
                    return showToast(`Minimum order is ₹${DELIVERY_POLICY.minimumOrder}. Add more items.`, 'error');
                }
                if (!address) {
                    showToast('Delivery address is required.', 'error');
                    return;
                }
                if (!deliveryArea) {
                    showToast('Please select a delivery area.', 'error');
                    return;
                }

                const tempOrderId = 'TEMP-' + Date.now().toString().slice(-8);
                setOrderId(tempOrderId);
                setShowUpiPayment(true);
            };

            const handleUpiPaymentComplete = (transactionId) => {
                handlePlaceOrder('upi', transactionId);
            };

            const handleDeliveryAreaSelect = (area) => {
                setDeliveryArea(area.name);
                setDeliveryCharge(originalTotal >= DELIVERY_POLICY.freeDeliveryAbove ? 0 : area.charge);
            };

            if (getRole(user) === 'guest' || isUserBanned(user)) return null;

            if (showUpiPayment) {
                return (
                    <UpiPaymentView
                        finalTotal={finalTotal}
                        upiId={UPI_CONFIG.upiId}
                        orderId={orderId}
                        onPaymentComplete={handleUpiPaymentComplete}
                        onBack={() => setShowUpiPayment(false)}
                        showToast={showToast}
                    />
                );
            }

            return (
                <div className="p-3 md:p-4 max-w-4xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 pb-24 md:pb-4">
                    <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border">
                        <h2 className="text-xl md:text-2xl font-bold mb-4 text-primary border-b pb-2 flex items-center">
                            <i className="fa-solid fa-truck mr-2"></i> Delivery
                        </h2>

                        {/* Minimum Order Warning */}
                        {!hasMinimum && (
                            <div className="bg-red-50 border-l-4 border-red-500 p-3 md:p-4 mb-4 rounded">
                                <div className="flex items-start">
                                    <i className="fa-solid fa-exclamation-triangle text-red-500 text-lg mr-2 mt-0.5"></i>
                                    <div>
                                        <p className="font-bold text-red-700 text-sm">Minimum Order Not Met</p>
                                        <p className="text-xs text-red-600 mt-1">
                                            Need {formatCurrency(DELIVERY_POLICY.minimumOrder - originalTotal)} more
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <label className="text-sm font-bold block mb-1">Delivery Address with Phone Number</label>
                        <textarea
                            className="text-input-style mb-4"
                            rows="3"
                            placeholder="Enter your full delivery address... with phone number"
                            value={address}
                            onChange={e => setAddress(e.target.value)}
                            required
                            disabled={!hasMinimum}
                        ></textarea>

                        {/* Delivery Area Selection */}
                        <div className="mb-4">
                            <div className="flex justify-between items-center mb-2">
                                <label className="text-sm font-bold">Select Delivery Area</label>
                                <button
                                    type="button"
                                    onClick={() => setShowDeliveryModal(true)}
                                    className="text-xs text-primary hover:text-primary-dark font-semibold"
                                >
                                    <i className="fa-solid fa-map-location-dot mr-1"></i>
                                    View All Areas
                                </button>
                            </div>

                            {deliveryArea && (
                                <div className="bg-green-50 p-3 rounded-lg border border-green-200 mb-3">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <p className="font-semibold text-green-700">{deliveryArea}</p>
                                            <p className="text-xs text-green-600">
                                                Delivery Charge: {deliveryCharge === 0 ? 'FREE' : `₹${deliveryCharge}`}
                                            </p>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => {
                                                setDeliveryArea('');
                                                setDeliveryCharge(0);
                                            }}
                                            className="text-xs text-red-500 hover:text-red-700"
                                        >
                                            Change
                                        </button>
                                    </div>
                                </div>
                            )}

                            <div className="grid grid-cols-2 gap-2">
                                {DELIVERY_POLICY.deliveryAreas.slice(0, 4).map(area => (
                                    <button
                                        key={area.code}
                                        type="button"
                                        onClick={() => handleDeliveryAreaSelect(area)}
                                        className={`p-3 rounded-lg border text-sm font-semibold transition ${deliveryArea === area.name ? 'border-primary bg-primary/10 text-primary' : 'border-gray-200 hover:border-primary'}`}
                                        disabled={!hasMinimum}
                                    >
                                        <div className="flex justify-between items-center">
                                            <span>{area.name}</span>
                                            <span className={`text-xs ${originalTotal >= DELIVERY_POLICY.freeDeliveryAbove || area.charge === 0 ? 'text-success' : 'text-gray-600'}`}>
                                                {originalTotal >= DELIVERY_POLICY.freeDeliveryAbove || area.charge === 0 ? 'FREE' : `₹${area.charge}`}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>

                        <h3 className="text-xl font-bold mb-3 text-primary-dark">Payment Method</h3>

                        <div className="space-y-3 mb-4">
                            <div
                                className={`flex items-center p-3 rounded-lg border cursor-pointer transition ${paymentMethod === 'cod' ? 'border-primary bg-primary/5' : 'border-gray-200 hover:border-primary'} ${!hasMinimum ? 'opacity-50 cursor-not-allowed' : ''}`}
                                onClick={() => hasMinimum && setPaymentMethod('cod')}
                            >
                                <div className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${paymentMethod === 'cod' ? 'border-primary bg-primary' : 'border-gray-300'}`}>
                                    {paymentMethod === 'cod' && <div className="w-2 h-2 rounded-full bg-white"></div>}
                                </div>
                                <div className="flex items-center">
                                    <i className="fa-solid fa-hand-holding-dollar mr-3 text-2xl text-success"></i>
                                    <div>
                                        <p className="font-semibold">Cash on Delivery (COD)</p>
                                        <p className="text-xs text-gray-500">Pay when you receive the order</p>
                                    </div>
                                </div>
                            </div>

                            <div
                                className={`flex items-center p-3 rounded-lg border cursor-pointer transition ${paymentMethod === 'upi' ? 'border-upi bg-upi-light' : 'border-gray-200 hover:border-upi'} ${!hasMinimum ? 'opacity-50 cursor-not-allowed' : ''}`}
                                onClick={() => hasMinimum && setPaymentMethod('upi')}
                            >
                                <div className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${paymentMethod === 'upi' ? 'border-upi bg-upi' : 'border-gray-300'}`}>
                                    {paymentMethod === 'upi' && <div className="w-2 h-2 rounded-full bg-white"></div>}
                                </div>
                                <div className="flex items-center">
                                    <i className="fa-solid fa-qrcode mr-3 text-2xl text-upi"></i>
                                    <div>
                                        <p className="font-semibold">UPI Payment</p>
                                        <p className="text-xs text-gray-500">Pay instantly with any UPI app</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h3 className="text-xl font-bold mb-3 mt-6 text-primary-dark border-t pt-4">Coupon Code</h3>
                        <div className="flex space-x-2">
                            <input
                                type="text"
                                className="text-input-style flex-grow"
                                placeholder="Enter coupon code (Optional)"
                                value={couponCode}
                                onChange={e => setCouponCode(e.target.value)}
                                disabled={!hasMinimum}
                            />
                            <button
                                onClick={handleApplyCoupon}
                                className="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition font-semibold text-sm disabled:opacity-50"
                                disabled={!hasMinimum}
                            >
                                Apply
                            </button>
                        </div>
                        {discountData.message && (
                            <p className={`text-sm mt-2 ${discountData.discount > 0 ? 'text-success' : 'text-danger'}`}>{discountData.message}</p>
                        )}

                        {/* Email Updates Preference */}
                        <div className="mt-6 border-t pt-4">
                            <div className="flex items-center space-x-3">
                                <input
                                    type="checkbox"
                                    id="emailUpdates"
                                    checked={emailUpdates}
                                    onChange={(e) => setEmailUpdates(e.target.checked)}
                                    className="w-5 h-5 text-primary rounded focus:ring-primary"
                                    disabled={!hasMinimum}
                                />
                                <label htmlFor="emailUpdates" className="text-sm font-semibold text-gray-700">
                                    Receive order updates via email
                                </label>
                            </div>
                            <p className="text-xs text-gray-500 mt-1">
                                Get order confirmation, shipping updates, and delivery notifications
                            </p>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-vibrant border-2 border-primary/20 h-fit">
                        <h2 className="text-2xl font-bold text-primary mb-4 border-b pb-2">Order Summary</h2>

                        {/* Minimum Order Progress */}
                        <MinimumOrderProgress currentAmount={originalTotal} />

                        <div className="space-y-2 mb-4">
                            <div className="flex justify-between text-base">
                                <span>Cart Subtotal:</span>
                                <span>{formatCurrency(originalTotal)}</span>
                            </div>
                            <div className="flex justify-between text-base font-semibold">
                                <span>Shipping:</span>
                                <span className={deliveryCharge === 0 ? "text-success font-bold" : "text-gray-600"}>
                                    {deliveryCharge === 0 ? 'FREE' : formatCurrency(deliveryCharge)}
                                </span>
                            </div>
                            <div className="flex justify-between text-base font-semibold">
                                <span>Discount:</span>
                                <span>- {formatCurrency(discountData.discount)}</span>
                            </div>
                        </div>

                        <div className="flex justify-between text-xl font-extrabold text-primary-dark pt-2 border-t border-primary/20">
                            <span>Grand Total:</span>
                            <span className="text-danger">{formatCurrency(finalTotal)}</span>
                        </div>

                        {/* Minimum Order Status */}
                        {!hasMinimum && (
                            <div className="mt-4 p-3 bg-red-50 rounded-lg border border-red-200">
                                <div className="flex items-center">
                                    <i className="fa-solid fa-exclamation-circle text-red-500 mr-2"></i>
                                    <div>
                                        <p className="text-sm font-bold text-red-700">Minimum Order Required</p>
                                        <p className="text-xs text-red-600">
                                            Add {formatCurrency(DELIVERY_POLICY.minimumOrder - originalTotal)} more to place your order
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Email Notification Info */}
                        {emailUpdates && hasMinimum && (
                            <div className="mt-4 p-3 bg-info/10 rounded-lg border border-info/30">
                                <div className="flex items-center">
                                    <i className="fa-solid fa-envelope text-info mr-2"></i>
                                    <p className="text-sm text-info/80">
                                        You'll receive order confirmation and updates via email.
                                    </p>
                                </div>
                            </div>
                        )}

                        <div className="mt-6 space-y-3">
                            {paymentMethod === 'cod' ? (
                                <button
                                    onClick={() => handlePlaceOrder()}
                                    disabled={isPlacing || !address || cart.length === 0 || !hasMinimum || !deliveryArea}
                                    className={`w-full p-3 rounded-lg text-lg shadow-lg transition ${hasMinimum && address && deliveryArea ? 'bg-success text-white hover:bg-success/80' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                                >
                                    {isPlacing ? 'Placing Order...' :
                                     !hasMinimum ? 'Minimum Order Not Met' :
                                     !deliveryArea ? 'Select Delivery Area' :
                                     'Place Order (COD)'}
                                </button>
                            ) : (
                                <button
                                    onClick={handleProceedToUpiPayment}
                                    disabled={isPlacing || !address || cart.length === 0 || !hasMinimum || !deliveryArea}
                                    className={`w-full p-3 rounded-lg text-lg shadow-lg transition ${hasMinimum && address && deliveryArea ? 'bg-upi text-white hover:bg-upi/80' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                                >
                                    {isPlacing ? 'Processing...' :
                                     !hasMinimum ? 'Minimum Order Not Met' :
                                     !deliveryArea ? 'Select Delivery Area' :
                                     'Proceed to UPI Payment'}
                                </button>
                            )}

                            <button onClick={() => setView('cart')} className="w-full bg-gray-200 text-gray-800 p-3 rounded-lg text-lg hover:bg-gray-300 transition">
                                Back to Cart
                            </button>
                        </div>

                        {paymentMethod === 'upi' && hasMinimum && (
                            <div className="mt-4 p-3 bg-upi-light rounded-lg border border-upi/30">
                                <div className="flex items-center">
                                    <i className="fa-solid fa-info-circle text-upi mr-2"></i>
                                    <p className="text-sm text-upi/80">
                                        You'll be redirected to UPI payment page where you can scan QR code or pay using any UPI app.
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 11. ORDERS VIEW
        // =======================================================

        const OrdersView = ({ user, get, post, showToast, setSelectedOrder }) => {
            const [orders, setOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const role = getRole(user);

            const getStatusColor = (status) => {
                if (status === 'Delivered') return 'text-success';
                if (status === 'Cancelled') return 'text-danger';
                if (status === 'Pending') return 'text-accent-hover';
                return 'text-info';
            };

            // Check if order can be cancelled (within 2 hours of placement)
            const canCancelOrder = (order) => {
                if (order.status !== 'Pending') return false;
                const orderDate = new Date(order.date);
                const now = new Date();
                const hoursDiff = (now - orderDate) / (1000 * 60 * 60);
                return hoursDiff <= 2;
            };

            const handleCancelOrder = async (orderId) => {
                const reason = prompt('Please provide a reason for cancellation (optional):');
                if (reason === null) return; // User clicked cancel on prompt

                const confirmCancel = window.confirm('Are you sure you want to cancel this order? This action cannot be undone.');
                if (!confirmCancel) return;

                const res = await post({
                    action: 'cancelOrder',
                    orderId,
                    reason: reason || 'Customer requested cancellation',
                    email: user.email
                });

                if (res.status === 'success') {
                    showToast('Order cancelled successfully. You will receive a confirmation email.', 'success');
                    setOrders(orders.map(o => o.orderId === orderId ? {...o, status: 'Cancelled'} : o));
                } else {
                    showToast(res.message || 'Cannot cancel order. The 2-hour cancellation window may have passed.', 'error');
                }
            };

            useEffect(() => {
                const fetchOrders = async () => {
                    const params = role === 'admin' ? { action: 'getAllOrders' } : { action: 'getOrdersByEmail', email: user.email };
                    const res = await get(params);
                    setIsLoading(false);
                    if (res.status !== 'error') setOrders(res.filter(o => o.orderId));
                };
                if (role !== 'guest') fetchOrders();
            }, [user]);

            if (isLoading) return <LoadingSpinner />;
            if (orders.length === 0) return <div className="text-center py-16 md:py-20 text-gray-500 text-lg md:text-xl pb-24 md:pb-20"><i className="fa-solid fa-box-open fa-3x mb-4"></i><p>No orders placed yet.</p></div>;

            return (
                <div className="p-3 md:p-4 max-w-5xl mx-auto space-y-3 md:space-y-4 pb-24 md:pb-4">
                    <h1 className="text-xl md:text-3xl font-bold text-primary-dark mb-4 md:mb-6 flex items-center">
                        <i className="fa-solid fa-receipt mr-2 text-primary"></i>
                        {role === 'admin' ? 'All Orders' : 'My Orders'}
                    </h1>
                    {orders.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(order => (
                        <div key={order.orderId} className="bg-white p-4 md:p-5 rounded-xl shadow-md border-l-4 border-primary/50 hover:border-primary transition duration-200">
                            <div className="flex flex-col sm:flex-row sm:justify-between gap-3">
                                <div className="flex-1">
                                    <p className="text-xs text-gray-500">{order.date}</p>
                                    <h2 className="text-lg md:text-xl font-bold text-primary-dark">#{order.orderId}</h2>
                                    {order.paymentMethod && (
                                        <div className="flex flex-wrap items-center gap-2 mt-2">
                                            <span className="text-xs px-2 py-1 rounded bg-gray-100">
                                                {order.paymentMethod === 'upi' ? (
                                                    <><i className="fa-solid fa-qrcode mr-1 text-upi"></i>UPI</>
                                                ) : (
                                                    <><i className="fa-solid fa-hand-holding-dollar mr-1 text-success"></i>COD</>
                                                )}
                                            </span>
                                            {order.paymentStatus && (
                                                <span className={`text-xs px-2 py-1 rounded ${order.paymentStatus === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                                    {order.paymentStatus === 'paid' ? 'Paid' : 'Pending'}
                                                </span>
                                            )}
                                            {order.assignedTo && (
                                                <span className="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">
                                                    <i className="fa-solid fa-truck mr-1"></i>{order.assignedTo}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>
                                <div className="flex sm:flex-col items-center sm:items-end justify-between">
                                    <span className="text-lg md:text-xl font-extrabold text-danger">{formatCurrency(order.total)}</span>
                                    <span className={`px-3 py-1 text-xs font-bold rounded-full ${order.status==='Delivered'?'bg-success text-white':order.status==='Cancelled'?'bg-danger text-white':'bg-info/20 text-info'}`}>{order.status}</span>
                                </div>
                            </div>
                            <div className="mt-3 flex flex-col sm:flex-row justify-between items-start sm:items-center border-t pt-3 gap-2">
                                <p className="text-xs md:text-sm text-gray-600">{order.items.length} items</p>
                                <div className="flex gap-2 w-full sm:w-auto">
                                    {role !== 'admin' && canCancelOrder(order) && (
                                        <button
                                            onClick={() => handleCancelOrder(order.orderId)}
                                            className="text-danger hover:text-danger/80 text-sm font-semibold px-3 py-2 rounded-lg bg-danger/10 transition touch-target flex-1 sm:flex-none"
                                        >
                                            <i className="fa-solid fa-ban mr-1"></i> Cancel
                                        </button>
                                    )}
                                    {role !== 'admin' && order.status === 'Pending' && !canCancelOrder(order) && (
                                        <span className="text-xs text-gray-500 px-3 py-2">
                                            <i className="fa-solid fa-clock mr-1"></i> Cancel window expired
                                        </span>
                                    )}
                                    <button onClick={() => setSelectedOrder(order)} className="text-primary hover:text-primary-dark text-sm font-semibold px-3 py-2 rounded-lg bg-primary/10 transition touch-target flex-1 sm:flex-none">
                                        <i className="fa-solid fa-eye mr-1"></i> View
                                    </button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // =======================================================
        // 12. ORDER DETAIL MODAL
        // =======================================================

        const OrderDetailModal = ({ order, onClose, onUpdateStatus, role }) => {
            if (!order) return null;

            const getStatusColor = (status) => {
                if (status === 'Delivered') return 'text-success';
                if (status === 'Cancelled') return 'text-danger';
                if (status === 'Pending') return 'text-accent-hover';
                return 'text-info';
            };

            const handleStatusChange = async (newStatus) => {
                const confirm = window.confirm(`Are you sure you want to change status to "${newStatus}"?`);
                if (confirm) {
                    const res = await post({
                        action: 'updateOrderStatus',
                        orderId: order.orderId,
                        status: newStatus,
                        notifyCustomer: true
                    });
                    if (res.status === 'success') {
                        onUpdateStatus(order.orderId, newStatus);
                        if (res.notificationSent) {
                            alert(`Status updated to ${newStatus}. Customer has been notified via email.`);
                        }
                    } else {
                        alert(res.message);
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4 print:p-0" onClick={onClose}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-4xl w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300 print:max-w-none print:w-auto print:h-auto print:rounded-none" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2 print:hidden">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <div className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4 print:hidden">
                                <h2 className="text-2xl font-bold text-primary-dark">Order #{order.orderId} Details</h2>
                                <button onClick={onClose} className="text-gray-500 hover:text-danger transition"><i className="fa-solid fa-xmark text-xl"></i></button>
                            </div>

                            <div className="print:block print:w-full print:p-6">
                                <h3 className="text-xl font-bold mb-2 text-primary">Invoice for Order #{order.orderId}</h3>
                                <div className="grid grid-cols-2 text-sm mb-4 border-b pb-3">
                                    <div><span className='font-semibold'>Date:</span> {order.date}</div>
                                    <div><span className='font-semibold'>Status:</span> <span className={`font-bold ${getStatusColor(order.status)}`}>{order.status}</span></div>
                                    {order.userEmail && <div><span className='font-semibold'>Customer:</span> {order.userEmail}</div>}
                                    {order.address && <div className='col-span-2'><span className='font-semibold'>Delivery:</span> {order.address}</div>}
                                    {order.paymentMethod && (
                                        <div><span className='font-semibold'>Payment:</span>
                                            <span className={`ml-2 px-2 py-1 text-xs rounded ${order.paymentMethod === 'upi' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>
                                                {order.paymentMethod === 'upi' ? 'UPI' : 'COD'}
                                                {order.paymentStatus && ` (${order.paymentStatus})`}
                                            </span>
                                        </div>
                                    )}
                                    {order.transactionId && <div><span className='font-semibold'>Transaction ID:</span> {order.transactionId}</div>}
                                </div>
                                <table className="w-full text-sm mb-4">
                                    <thead className="bg-gray-100 uppercase"><tr><th className="p-2 text-left">Item</th><th className="p-2 text-center">Qty</th><th className="p-2 text-right">Unit Price</th><th className="p-2 text-right">Subtotal</th></tr></thead>
                                    <tbody>
                                        {order.items.map((item, index) => (<tr key={index} className="border-b"><td className="p-2">{item.name}</td><td className="p-2 text-center">{item.qty}</td><td className="p-2 text-right">{formatCurrency(item.price)}</td><td className="p-2 text-right text-danger">{formatCurrency(item.price * item.qty)}</td></tr> ))}
                                    </tbody>
                                </table>
                                <div className="text-right text-2xl font-extrabold text-primary-dark border-t-2 border-primary/50 pt-3">Grand Total: {formatCurrency(order.total)}</div>
                                <div className="text-center mt-6 text-xs text-gray-500">Thank you for shopping with Maddur Murugan Super Store!</div>
                            </div>

                            {role === 'admin' && (
                                <div className="mt-6 border-t pt-4 print:hidden">
                                    <h3 className="text-lg font-bold mb-2 text-danger">Admin Actions</h3>
                                    <div className="flex flex-wrap gap-2">
                                        {['Pending', 'Shipped', 'Delivered', 'Cancelled'].map(status => (
                                            <button key={status} onClick={() => handleStatusChange(status)} disabled={order.status === status} className={`px-3 py-1 rounded-lg text-sm font-bold transition ${order.status === status ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-danger text-white hover:bg-danger/80'}`}>
                                                Set to {status}
                                            </button>
                                        ))}
                                    </div>
                                    {order.paymentMethod === 'upi' && order.paymentStatus !== 'paid' && (
                                        <button onClick={() => {
                                            if (confirm('Mark this UPI payment as paid? This will notify the customer.')) {
                                                post({
                                                    action: 'updatePaymentStatus',
                                                    orderId: order.orderId,
                                                    paymentStatus: 'paid',
                                                    notifyCustomer: true
                                                });
                                                onUpdateStatus(order.orderId, order.status);
                                                alert('Payment status updated to Paid. Customer has been notified.');
                                            }
                                        }} className="mt-2 bg-success text-white px-3 py-1 rounded-lg text-sm font-bold transition hover:bg-success/80">
                                            <i className="fa-solid fa-check-circle mr-1"></i> Mark as Paid
                                        </button>
                                    )}
                                    <button onClick={() => window.print()} className="mt-3 bg-info text-white px-3 py-1 rounded-lg text-sm font-bold transition hover:bg-info/80 ml-2"><i className="fa-solid fa-print mr-1"></i> Print Invoice</button>

                                   
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 13. PROFILE VIEW
        // =======================================================

        const ProfileView = ({ user, setUser, setView, post, showToast }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [form, setForm] = useState(user);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [emailPreferences, setEmailPreferences] = useState({
                orderUpdates: true,
                promotional: true,
                securityAlerts: true
            });
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);
            const isBanned = isUserBanned(user);

            // Change Password State
            const [showPasswordChange, setShowPasswordChange] = useState(false);
            const [passwordForm, setPasswordForm] = useState({ current: '', new: '', confirm: '' });
            const [passwordError, setPasswordError] = useState(null);

            const handleChangePassword = async (e) => {
                e.preventDefault();
                setPasswordError(null);

                if (passwordForm.new.length < 6) {
                    setPasswordError("New password must be at least 6 characters.");
                    return;
                }
                if (passwordForm.new !== passwordForm.confirm) {
                    setPasswordError("New passwords do not match.");
                    return;
                }

                setIsSubmitting(true);

                const res = await post({
                    action: 'changePassword',
                    email: user.email,
                    currentPassword: passwordForm.current,
                    newPassword: passwordForm.new
                });

                setIsSubmitting(false);

                if (res.status === 'success') {
                    showToast('Password changed successfully!', 'success');
                    setShowPasswordChange(false);
                    setPasswordForm({ current: '', new: '', confirm: '' });
                } else {
                    setPasswordError(res.message || "Failed to change password.");
                }
            };

            const handleLogout = () => {
                setUser(null);
                localStorage.removeItem('muruganUser');
                localStorage.removeItem('muruganCart');
                showToast('Logged out successfully.', 'info');
                setView('home');
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                const res = await post({ action: 'updateProfile', ...form });
                setIsSubmitting(false);

                if (res.status === 'success') {
                    setUser(res.user);
                    localStorage.setItem('muruganUser', JSON.stringify(res.user));
                    showToast('Profile updated!', 'success');
                    setIsEditing(false);
                } else {
                    showToast(res.message || 'Update failed.', 'error');
                }
            };

            const handleUpdateEmailPreferences = async () => {
                const res = await post({
                    action: 'updateEmailPreferences',
                    email: user.email,
                    preferences: emailPreferences
                });

                if (res.status === 'success') {
                    showToast('Email preferences updated!', 'success');
                } else {
                    showToast('Failed to update preferences.', 'error');
                }
            };

            return (
                <div className="p-3 md:p-4 max-w-xl mx-auto pb-24 md:pb-4">
                    <h1 className="text-2xl md:text-3xl font-bold text-primary-dark mb-4 md:mb-6 border-b-2 border-primary/50 pb-2 flex items-center">
                        <i className="fa-solid fa-user-circle mr-2"></i> My Account
                    </h1>

                    {isBanned && (
                        <div className="bg-danger/10 border-l-4 border-danger p-4 mb-6 rounded-lg">
                            <h2 className="text-xl font-bold text-danger mb-2"><i className='fa-solid fa-triangle-exclamation mr-1'></i> Account Restricted</h2>
                            <p className="text-danger/80">Your account is currently restricted from placing orders and creating support tickets. Please contact support for more information.</p>
                        </div>
                    )}

                    {/* Delivery Policy Notice */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck-fast text-blue-500 text-xl mr-3"></i>
                                <div>
                                    <p className="font-semibold text-gray-800">Delivery Information</p>
                                    <p className="text-sm text-gray-600">Minimum order: ₹{DELIVERY_POLICY.minimumOrder} • Free delivery in select areas</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="text-sm text-primary hover:text-primary-dark font-semibold"
                            >
                                View Areas
                            </button>
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl shadow-vibrant border-t-4 border-primary">
                        <h2 className="text-xl font-bold mb-4 text-primary">Personal Details</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="text-sm font-bold block mb-1">Name</label>
                                <input required className="text-input-style" name="name" value={form.name} onChange={e => setForm({...form, name:e.target.value})} disabled={!isEditing} />
                            </div>
                            <div>
                                <label className="text-sm font-bold block mb-1">Email</label>
                                <input type="email" className="text-input-style bg-gray-100 cursor-not-allowed" value={form.email} disabled />
                            </div>
                            <div>
                                <label className="text-sm font-bold block mb-1">Phone Number</label>
                                <input type="tel" className="text-input-style" name="phone" value={form.phone} onChange={e => setForm({...form, phone:e.target.value})} disabled={!isEditing} />
                            </div>

                            <div className="border-t pt-4">
                                <label className="text-sm font-bold block mb-1">Loyalty Coins</label>
                                <p className="text-2xl font-extrabold text-success flex items-center"><i className="fa-solid fa-coins mr-2"></i> {user.coins || 0}</p>
                                <p className="text-xs text-gray-500 mt-1">Earned from placing orders.</p>
                            </div>

                            <div className="flex justify-between pt-4">
                                {isEditing ? (
                                    <button type="submit" disabled={isSubmitting} className="bg-success text-white p-3 rounded-lg font-bold text-lg hover:bg-success/80 transition disabled:opacity-50 shadow-md">
                                        {isSubmitting ? 'Saving...' : 'Save Changes'}
                                    </button>
                                ) : (
                                    <button type="button" onClick={() => setIsEditing(true)} className="bg-primary text-white p-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition shadow-md">
                                        <i className="fa-solid fa-edit mr-2"></i> Edit Profile
                                    </button>
                                )}
                                <button type="button" onClick={handleLogout} className="bg-gray-400 text-white p-3 rounded-lg font-bold text-lg hover:bg-danger transition shadow-md">
                                    <i className="fa-solid fa-sign-out-alt mr-2"></i> Logout
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Change Password Section */}
                    <div className="mt-6 bg-white p-6 rounded-xl shadow-vibrant border-t-4 border-accent">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-accent flex items-center">
                                <i className="fa-solid fa-key mr-2"></i> Change Password
                            </h2>
                            <button
                                type="button"
                                onClick={() => setShowPasswordChange(!showPasswordChange)}
                                className="text-primary hover:text-primary-dark font-semibold text-sm"
                            >
                                {showPasswordChange ? 'Cancel' : 'Change'}
                            </button>
                        </div>

                        {showPasswordChange && (
                            <form onSubmit={handleChangePassword} className="space-y-4">
                                {passwordError && (
                                    <div className="bg-danger/10 border-l-4 border-danger p-3 rounded flex items-start animate-shake">
                                        <i className="fa-solid fa-triangle-exclamation text-danger mt-1 mr-2"></i>
                                        <div>
                                            <p className="text-sm text-danger font-bold">Error</p>
                                            <p className="text-xs text-danger/80">{passwordError}</p>
                                        </div>
                                    </div>
                                )}
                                <div>
                                    <label className="text-sm font-bold block mb-1">Current Password</label>
                                    <input
                                        required
                                        type="password"
                                        className="text-input-style"
                                        placeholder="Enter current password"
                                        value={passwordForm.current}
                                        onChange={e => setPasswordForm({...passwordForm, current: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">New Password</label>
                                    <input
                                        required
                                        type="password"
                                        className="text-input-style"
                                        placeholder="At least 6 characters"
                                        value={passwordForm.new}
                                        onChange={e => setPasswordForm({...passwordForm, new: e.target.value})}
                                    />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Confirm New Password</label>
                                    <input
                                        required
                                        type="password"
                                        className="text-input-style"
                                        placeholder="Re-enter new password"
                                        value={passwordForm.confirm}
                                        onChange={e => setPasswordForm({...passwordForm, confirm: e.target.value})}
                                    />
                                </div>
                                <button
                                    type="submit"
                                    disabled={isSubmitting}
                                    className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold hover:bg-accent-hover transition disabled:opacity-50 shadow-md"
                                >
                                    {isSubmitting ? 'Changing...' : 'Change Password'}
                                </button>
                            </form>
                        )}

                        {!showPasswordChange && (
                            <p className="text-sm text-gray-500">
                                <i className="fa-solid fa-shield-halved mr-1"></i>
                                Keep your account secure by updating your password regularly.
                            </p>
                        )}
                    </div>

                    <div className="mt-6 border-t pt-6">
                        <button onClick={() => setView('orders')} className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold text-lg hover:bg-accent-hover transition shadow-md mb-3">
                            <i className="fa-solid fa-receipt mr-2"></i> View My Orders
                        </button>
                        <button onClick={() => setView('support')} className="w-full bg-info text-white p-3 rounded-lg font-bold text-lg hover:bg-info/80 transition shadow-md">
                            <i className="fa-solid fa-headset mr-2"></i> Contact Support
                        </button>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 14. ADMIN STAT CARD
        // =======================================================

        const StatCard = ({ title, value, icon, color='primary' }) => (
            <div className={`bg-white p-3 md:p-4 rounded-xl shadow-md border-l-4 md:border-l-0 md:border-t-4 border-${color}`}>
                <div className="flex justify-between items-center">
                    <p className="text-xs md:text-sm font-semibold text-gray-500">{title}</p>
                    <i className={`fa-solid ${icon} text-lg md:text-xl text-${color}/70`}></i>
                </div>
                <p className="text-2xl md:text-3xl font-extrabold text-primary-dark mt-1 md:mt-2">{value}</p>
            </div>
        );

        // =======================================================
        // 15. EDIT PRODUCT MODAL
        // =======================================================

        const EditProductModal = ({ product, onClose, onSave }) => {
            const [editForm, setEditForm] = useState(product);
            const [isSaving, setIsSaving] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setEditForm(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                const res = await onSave(editForm);
                setIsSaving(false);
                if (res.status === 'success') onClose(true);
                else onClose(false, res.message);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => onClose()}>
                    <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-2xl w-full max-h-[85vh] md:max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        {/* Mobile swipe handle */}
                        <div className="md:hidden flex justify-center py-2">
                            <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                        </div>
                        <form onSubmit={handleSubmit} className="p-4 md:p-6 pt-2 md:pt-6">
                            <div className="flex justify-between items-start border-b-2 border-primary/20 pb-3 mb-4">
                                <h2 className="text-lg md:text-2xl font-bold text-primary-dark line-clamp-1">Edit: {product.name}</h2>
                                <button type="button" onClick={() => onClose()} className="text-gray-500 hover:text-danger transition p-1"><i className="fa-solid fa-xmark text-xl"></i></button>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="text-sm font-bold block mb-1">Product ID (Cannot Change)</label>
                                    <input className="text-input-style bg-gray-100 cursor-not-allowed" value={editForm.id} disabled />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Name</label>
                                    <input required className="text-input-style" name="name" value={editForm.name} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Price (₹)</label>
                                    <input required type="number" step="0.01" className="text-input-style" name="price" value={editForm.price} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Category</label>
                                    <input required className="text-input-style" name="category" value={editForm.category} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Image URL</label>
                                    <input className="text-input-style" name="image" value={editForm.image} onChange={handleChange} />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Description</label>
                                    <textarea className="text-input-style" rows="3" name="description" value={editForm.description} onChange={handleChange} />
                                </div>
                            </div>
                            <div className="mt-6 flex justify-end">
                                <button type="submit" disabled={isSaving} className="bg-primary text-white p-3 rounded-lg font-bold text-lg hover:bg-primary-dark transition disabled:opacity-50 shadow-md">
                                    {isSaving ? 'Saving...' : 'Save Product'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // =======================================================
        // 16. ADMIN VIEW
        // =======================================================

        const AdminView = ({ user, post, get, showToast }) => {
            const [tab, setTab] = useState('summary');
            const [products, setProducts] = useState([]);
            const [users, setUsers] = useState([]);
            const [coupons, setCoupons] = useState([]);
            const [newProduct, setNewProduct] = useState({ id: '', name: '', price: '', category: '', image: '', description: '' });
            const [newCoupon, setNewCoupon] = useState({ code: '', discountType: 'fixed', discountValue: '', minOrder: '0' });
            const [orders, setOrders] = useState([]);
            const [tickets, setTickets] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            const [productToEdit, setProductToEdit] = useState(null);
            const [orderToView, setOrderToView] = useState(null);

            // Dashboard Stats State
            const [dashboardStats, setDashboardStats] = useState(null);
            const [salesReport, setSalesReport] = useState(null);
            const [salesPeriod, setSalesPeriod] = useState('week');
            const [activityLog, setActivityLog] = useState([]);

            // Product Management State
            const [lowStockProducts, setLowStockProducts] = useState([]);
            const [lowStockThreshold, setLowStockThreshold] = useState(10);
            const [productSearchTerm, setProductSearchTerm] = useState('');
            const [productToUpdateStock, setProductToUpdateStock] = useState(null);
            const [showBulkPriceUpdate, setShowBulkPriceUpdate] = useState(false);
            const [bulkPriceUpdates, setBulkPriceUpdates] = useState([]);

            // User Management State
            const [userSearchEmail, setUserSearchEmail] = useState('');
            const [searchedUser, setSearchedUser] = useState(null);
            const [userToResetPassword, setUserToResetPassword] = useState(null);

            // Coupon Management State
            const [couponToEdit, setCouponToEdit] = useState(null);
            const [couponValidationTest, setCouponValidationTest] = useState({ code: '', amount: '' });
            const [validationResult, setValidationResult] = useState(null);

            // Order Management State
            const [orderStats, setOrderStats] = useState(null);

            // Targeted Email State
            const [targetEmail, setTargetEmail] = useState('');
            const [isTargetedEmail, setIsTargetedEmail] = useState(false);

            const fetchData = async () => {
                setIsLoading(true);
                const [pRes, uRes, oRes, tRes, cRes, statsRes, activityRes] = await Promise.all([
                    get({ action: 'getProducts' }),
                    get({ action: 'getUsers' }),
                    get({ action: 'getAllOrders' }),
                    get({ action: 'getTickets' }),
                    get({ action: 'getCoupons' }),
                    get({ action: 'getDashboardStats' }),
                    get({ action: 'getActivityLog', limit: 50 })
                ]);

                if (pRes.status !== 'error') setProducts(pRes);
                if (uRes.status !== 'error') setUsers(uRes.map(u => ({ ...u, status: u.status || 'active' })));
                if (oRes.status !== 'error') setOrders(oRes.filter(o => o.orderId));
                if (tRes.status !== 'error') setTickets(tRes);
                if (cRes.status !== 'error') setCoupons(cRes);
                if (statsRes.status !== 'error' && statsRes.data) setDashboardStats(statsRes.data);
                if (activityRes.status !== 'error' && activityRes.data) setActivityLog(activityRes.data);
                setIsLoading(false);
            };

            const fetchSalesReport = async (period) => {
                const res = await get({ action: 'getSalesReport', period });
                if (res.status !== 'error' && res.data) {
                    setSalesReport(res.data);
                }
            };

            const fetchLowStockProducts = async () => {
                const res = await get({ action: 'getLowStockProducts', threshold: lowStockThreshold });
                if (res.status !== 'error' && res.data) {
                    setLowStockProducts(res.data);
                }
            };

            const fetchOrderStats = async () => {
                const res = await get({ action: 'getOrderStats' });
                if (res.status !== 'error' && res.data) {
                    setOrderStats(res.data);
                }
            };

            useEffect(() => {
                if (getRole(user) === 'admin') {
                    fetchData();
                    fetchSalesReport(salesPeriod);
                    fetchLowStockProducts();
                    fetchOrderStats();
                }
            }, [user]);

            useEffect(() => {
                if (getRole(user) === 'admin') {
                    fetchSalesReport(salesPeriod);
                }
            }, [salesPeriod]);

            const handleAddProduct = async (e) => {
                e.preventDefault();
                const res = await post({ action: 'addProduct', ...newProduct, price: parseFloat(newProduct.price) || 0 });
                if (res.status === 'success') {
                    showToast('Product Added!', 'success');
                    setNewProduct({ id: '', name: '', price: '', category: '', image: '', description: '' });
                    fetchData();
                } else showToast(res.message, 'error');
            };

            const handleUpdateProduct = async (productData) => {
                const res = await post({ action: 'updateProduct', ...productData, price: parseFloat(productData.price) || 0 });
                if (res.status === 'success') {
                    showToast('Product Updated!', 'success');
                    setProductToEdit(null);
                    fetchData();
                    return { status: 'success' };
                } else return { status: 'error', message: res.message };
            };

            const handleDeleteProduct = async (id) => {
                if (window.confirm(`Are you sure you want to delete product ID: ${id}?`)) {
                    const res = await post({ action: 'deleteProduct', id });
                    if (res.status === 'success') {
                        showToast('Product Deleted', 'success');
                        fetchData();
                    } else showToast('Deletion Failed', 'error');
                }
            };

            const handleToggleUserStatus = async (email, currentStatus) => {
                const newStatus = currentStatus === 'active' ? 'banned' : 'active';
                const actionVerb = newStatus === 'banned' ? 'Ban' : 'Unban';
                if (window.confirm(`Are you sure you want to ${actionVerb} user: ${email}? This will send a notification email.`)) {
                    const res = await post({
                        action: 'updateUserStatus',
                        email,
                        status: newStatus,
                        notifyUser: true
                    });
                    if(res.status==='success') {
                        showToast(`User ${actionVerb}ned. Notification email sent.`, 'success');
                        fetchData();
                    } else showToast('Update Failed', 'error');
                }
            };

            const handleReplyTicket = async (ticketId) => {
                const reply = prompt("Enter your reply for the ticket:");
                if (reply) {
                    const res = await post({
                        action: 'replyTicket',
                        ticketId,
                        adminReply: reply,
                        notifyCustomer: true
                    });
                    if(res.status==='success') {
                        showToast('Ticket Replied. Customer notified via email.', 'success');
                        fetchData();
                    } else showToast('Reply Failed', 'error');
                }
            };

            const handleSendOffer = async () => {
                const subject = document.getElementById('offerSubject')?.value;
                const message = document.getElementById('offerMessage')?.value;

                if (!subject || !message) return showToast("Subject and message are required.", 'error');

                const confirmSend = window.confirm(`Send the offer email blast to ALL ${users.filter(u=>u.role==='user' && u.status !== 'banned').length} registered active users?`);

                if (confirmSend) {
                    const res = await post({ action: 'sendOffer', subject, message });
                    if(res.status==='success') showToast(`Email sent to ${res.recipients} users.`, 'success');
                    else showToast(res.message, 'error');
                }
            };

            const handleAddCoupon = async (e) => {
                e.preventDefault();
                if (!newCoupon.code || !newCoupon.discountValue) return showToast('Code and Value are required.', 'error');
                if (parseFloat(newCoupon.discountValue) <= 0) return showToast('Discount value must be positive.', 'error');

                const couponData = {
                    action: 'addCoupon',
                    code: newCoupon.code.toUpperCase(),
                    value: parseFloat(newCoupon.discountValue),
                    type: newCoupon.discountType,
                    minOrder: parseFloat(newCoupon.minOrder) || 0
                };

                const res = await post(couponData);

                if (res.status === 'success') {
                    showToast('Coupon Added!', 'success');
                    setNewCoupon({ code: '', discountType: 'fixed', discountValue: '', minOrder: '0' });
                    fetchData();
                } else showToast(res.message || 'Failed to add coupon.', 'error');
            };

            const handleDeleteCoupon = async (code) => {
                if (window.confirm(`Are you sure you want to delete coupon code: ${code}?`)) {
                    const res = await post({ action: 'deleteCoupon', code });
                    if (res.status === 'success') {
                        showToast('Coupon Deleted', 'success');
                        fetchData();
                    } else showToast('Deletion Failed', 'error');
                }
            };

            const getCouponDisplayValue = (coupon) => {
                if (coupon.discountType === 'percentage') return `${parseFloat(coupon.value).toFixed(0)}% OFF`;
                if (coupon.discountType === 'fixed') return `${formatCurrency(coupon.value)} OFF`;
                return 'N/A';
            };

            // Stock Management Handlers
            const handleUpdateStock = async (productId, action, quantity) => {
                const res = await post({ action: 'updateStock', id: productId, stockAction: action, quantity: parseInt(quantity) });
                if (res.status === 'success') {
                    showToast(`Stock ${action === 'add' ? 'added' : 'removed'} successfully!`, 'success');
                    setProductToUpdateStock(null);
                    fetchData();
                    fetchLowStockProducts();
                } else showToast(res.message || 'Stock update failed', 'error');
            };

            const handleBulkUpdatePrices = async () => {
                if (bulkPriceUpdates.length === 0) return showToast('No price updates specified', 'error');
                const res = await post({ action: 'bulkUpdatePrices', updates: bulkPriceUpdates });
                if (res.status === 'success') {
                    showToast(`Prices updated for ${res.updated || bulkPriceUpdates.length} products!`, 'success');
                    setShowBulkPriceUpdate(false);
                    setBulkPriceUpdates([]);
                    fetchData();
                } else showToast(res.message || 'Bulk update failed', 'error');
            };

            // User Management Handlers
            const handleSearchUserByEmail = async () => {
                if (!userSearchEmail) return showToast('Enter an email to search', 'error');
                const res = await get({ action: 'getUserByEmail', email: userSearchEmail });
                if (res.status !== 'error' && res.data) {
                    setSearchedUser(res.data);
                } else {
                    setSearchedUser(null);
                    showToast('User not found', 'error');
                }
            };

            const handleDeleteUser = async (email) => {
                if (window.confirm(`Are you sure you want to DELETE user: ${email}? This action cannot be undone!`)) {
                    const res = await post({ action: 'deleteUser', email });
                    if (res.status === 'success') {
                        showToast('User deleted successfully', 'success');
                        setSearchedUser(null);
                        fetchData();
                    } else showToast(res.message || 'Delete failed', 'error');
                }
            };

            const handleAdminResetPassword = async (email, newPassword) => {
                if (!newPassword || newPassword.length < 6) return showToast('Password must be at least 6 characters', 'error');
                const res = await post({ action: 'resetPassword', email, newPassword });
                if (res.status === 'success') {
                    showToast('Password reset successfully! User notified via email.', 'success');
                    setUserToResetPassword(null);
                } else showToast(res.message || 'Password reset failed', 'error');
            };

            // Coupon Management Handlers
            const handleUpdateCoupon = async (couponData) => {
                const res = await post({ action: 'updateCoupon', ...couponData });
                if (res.status === 'success') {
                    showToast('Coupon updated successfully!', 'success');
                    setCouponToEdit(null);
                    fetchData();
                    return { status: 'success' };
                } else return { status: 'error', message: res.message };
            };

            const handleToggleCoupon = async (code) => {
                const res = await post({ action: 'toggleCoupon', code });
                if (res.status === 'success') {
                    showToast(`Coupon ${res.active ? 'activated' : 'deactivated'}!`, 'success');
                    fetchData();
                } else showToast(res.message || 'Toggle failed', 'error');
            };

            const handleValidateCoupon = async () => {
                if (!couponValidationTest.code || !couponValidationTest.amount) {
                    return showToast('Enter coupon code and amount', 'error');
                }
                const res = await post({
                    action: 'validateCoupon',
                    couponCode: couponValidationTest.code,
                    totalAmount: parseFloat(couponValidationTest.amount)
                });
                setValidationResult(res);
            };

            // Order Management Handlers
            const handleCancelOrder = async (orderId, reason) => {
                const res = await post({ action: 'cancelOrder', orderId, reason, email: user.email });
                if (res.status === 'success') {
                    showToast('Order cancelled successfully', 'success');
                    fetchData();
                    fetchOrderStats();
                } else showToast(res.message || 'Cannot cancel order', 'error');
            };

            const handleAssignDelivery = async (orderId, assignedTo) => {
                const res = await post({ action: 'assignDelivery', orderId, assignedTo });
                if (res.status === 'success') {
                    showToast(`Delivery assigned to ${assignedTo}`, 'success');
                    fetchData();
                } else showToast(res.message || 'Assignment failed', 'error');
            };

            // Ticket Management Handlers
            const handleCloseTicket = async (ticketId) => {
                const res = await post({ action: 'closeTicket', ticketId });
                if (res.status === 'success') {
                    showToast('Ticket closed successfully', 'success');
                    fetchData();
                } else showToast(res.message || 'Failed to close ticket', 'error');
            };

            const handleUpdateTicketPriority = async (ticketId, priority) => {
                const res = await post({ action: 'updateTicketPriority', ticketId, priority });
                if (res.status === 'success') {
                    showToast(`Priority updated to ${priority}`, 'success');
                    fetchData();
                } else showToast(res.message || 'Failed to update priority', 'error');
            };

            // Targeted Email Handler
            const handleSendTargetedEmail = async () => {
                const subject = document.getElementById('offerSubject')?.value;
                const message = document.getElementById('offerMessage')?.value;

                if (!subject || !message) return showToast("Subject and message are required.", 'error');
                if (!targetEmail) return showToast("Enter target email address.", 'error');

                const confirmSend = window.confirm(`Send email to ${targetEmail}?`);
                if (confirmSend) {
                    const res = await post({ action: 'sendTargetedEmail', email: targetEmail, subject, message });
                    if (res.status === 'success') {
                        showToast(`Email sent to ${targetEmail}!`, 'success');
                        setTargetEmail('');
                    } else showToast(res.message, 'error');
                }
            };

            // Filtered products for search
            const filteredAdminProducts = useMemo(() => {
                if (!productSearchTerm) return products;
                return products.filter(p =>
                    p.name.toLowerCase().includes(productSearchTerm.toLowerCase()) ||
                    p.id.toLowerCase().includes(productSearchTerm.toLowerCase()) ||
                    p.category.toLowerCase().includes(productSearchTerm.toLowerCase())
                );
            }, [products, productSearchTerm]);

            if (getRole(user) !== 'admin') return <div className="text-center py-20 text-gray-500 text-xl">Access Denied. Admin privileges required.</div>;
            if (isLoading) return <LoadingSpinner />;

            return (
                <div className="p-3 md:p-4 max-w-7xl mx-auto pb-20 md:pb-4">
                    <h1 className="text-2xl md:text-3xl font-extrabold text-danger mb-4 md:mb-6 border-b-2 border-danger/50 pb-2 flex items-center">
                        <i className="fa-solid fa-user-gear mr-2"></i>
                        <span className="hidden sm:inline">Admin Dashboard</span>
                        <span className="sm:hidden">Admin</span>
                    </h1>

                    {/* Mobile-friendly scrollable tabs */}
                    <div className="flex gap-2 mb-4 md:mb-6 pb-2 overflow-x-auto hide-scrollbar -mx-3 px-3 md:mx-0 md:px-0">
                        {['summary','products','orders','users','support','coupons','marketing','activity'].map(t => (
                            <button
                                key={t}
                                onClick={()=>setTab(t)}
                                className={`px-3 md:px-4 py-2 rounded-lg font-bold capitalize text-xs md:text-sm whitespace-nowrap transition shadow-md flex-shrink-0 touch-target ${tab===t?'bg-primary text-white':'bg-white text-gray-700 hover:bg-gray-100 active:bg-gray-200'}`}
                            >
                                <i className={`fa-solid ${t==='summary'?'fa-chart-pie':t==='products'?'fa-box':t==='orders'?'fa-receipt':t==='users'?'fa-users':t==='support'?'fa-headset':t==='coupons'?'fa-tags':t==='marketing'?'fa-bullhorn':'fa-clock-rotate-left'} mr-1 md:mr-2`}></i>
                                <span className="hidden xs:inline">{t==='marketing'?'offers':t==='activity'?'Activity':t}</span>
                                <span className="xs:hidden">{t==='summary'?'Stats':t==='products'?'Items':t==='orders'?'Orders':t==='users'?'Users':t==='support'?'Help':t==='coupons'?'Codes':t==='marketing'?'Offers':'Log'}</span>
                            </button>
                        ))}
                    </div>

                    {tab === 'summary' && (
                        <div className="space-y-6">
                            {/* Main Stats Grid */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-6">
                                <StatCard title="Total Products" value={dashboardStats?.totalProducts || products.length} icon="fa-cubes" color="info" />
                                <StatCard title="Total Users" value={dashboardStats?.totalUsers || users.length} icon="fa-users" color="primary" />
                                <StatCard title="Total Orders" value={dashboardStats?.totalOrders || orders.length} icon="fa-receipt" color="accent" />
                                <StatCard title="Open Tickets" value={dashboardStats?.openTickets || tickets.filter(t => t.status === 'Open').length} icon="fa-headset" color="danger" />
                                <StatCard title="Active Coupons" value={dashboardStats?.activeCoupons || coupons.length} icon="fa-tags" color="success" />
                                <StatCard title="Banned Users" value={dashboardStats?.bannedUsers || users.filter(u => u.status === 'banned').length} icon="fa-ban" color="danger" />
                                <StatCard title="UPI Orders" value={dashboardStats?.upiOrders || orders.filter(o => o.paymentMethod === 'upi').length} icon="fa-qrcode" color="upi" />
                                <StatCard title="COD Orders" value={dashboardStats?.codOrders || orders.filter(o => o.paymentMethod === 'cod' || !o.paymentMethod).length} icon="fa-hand-holding-dollar" color="success" />
                            </div>

                            {/* Order Statistics */}
                            {orderStats && (
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-md">
                                    <h3 className="text-lg font-bold text-primary-dark mb-4 flex items-center">
                                        <i className="fa-solid fa-chart-bar mr-2 text-primary"></i> Order Statistics
                                    </h3>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                                            <p className="text-sm text-yellow-700">Pending</p>
                                            <p className="text-2xl font-bold text-yellow-800">{orderStats.pending || 0}</p>
                                        </div>
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                            <p className="text-sm text-blue-700">Shipped</p>
                                            <p className="text-2xl font-bold text-blue-800">{orderStats.shipped || 0}</p>
                                        </div>
                                        <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                                            <p className="text-sm text-green-700">Delivered</p>
                                            <p className="text-2xl font-bold text-green-800">{orderStats.delivered || 0}</p>
                                        </div>
                                        <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                                            <p className="text-sm text-red-700">Cancelled</p>
                                            <p className="text-2xl font-bold text-red-800">{orderStats.cancelled || 0}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Sales Report Section */}
                            <div className="bg-white p-4 md:p-6 rounded-xl shadow-md">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-4">
                                    <h3 className="text-lg font-bold text-primary-dark flex items-center">
                                        <i className="fa-solid fa-chart-line mr-2 text-success"></i> Sales Report
                                    </h3>
                                    <div className="flex gap-2">
                                        {['today', 'week', 'month', 'year'].map(period => (
                                            <button
                                                key={period}
                                                onClick={() => setSalesPeriod(period)}
                                                className={`px-3 py-1.5 rounded-lg text-xs font-bold capitalize transition ${salesPeriod === period ? 'bg-success text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                                            >
                                                {period}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                {salesReport ? (
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div className="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-lg border border-green-200">
                                            <p className="text-sm text-green-700">Total Sales</p>
                                            <p className="text-2xl font-bold text-green-800">{formatCurrency(salesReport.totalSales || 0)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg border border-blue-200">
                                            <p className="text-sm text-blue-700">Orders</p>
                                            <p className="text-2xl font-bold text-blue-800">{salesReport.orderCount || 0}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-lg border border-purple-200">
                                            <p className="text-sm text-purple-700">Avg Order Value</p>
                                            <p className="text-2xl font-bold text-purple-800">{formatCurrency(salesReport.avgOrderValue || 0)}</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-lg border border-orange-200">
                                            <p className="text-sm text-orange-700">New Customers</p>
                                            <p className="text-2xl font-bold text-orange-800">{salesReport.newCustomers || 0}</p>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-500 py-8">
                                        <i className="fa-solid fa-spinner fa-spin mr-2"></i> Loading sales data...
                                    </div>
                                )}
                            </div>

                            {/* Low Stock Alert */}
                            {lowStockProducts.length > 0 && (
                                <div className="bg-red-50 p-4 md:p-6 rounded-xl shadow-md border-l-4 border-red-500">
                                    <h3 className="text-lg font-bold text-red-700 mb-4 flex items-center">
                                        <i className="fa-solid fa-triangle-exclamation mr-2"></i> Low Stock Alert ({lowStockProducts.length} items)
                                    </h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        {lowStockProducts.slice(0, 6).map(p => (
                                            <div key={p.id} className="bg-white p-3 rounded-lg border border-red-200 flex justify-between items-center">
                                                <div>
                                                    <p className="font-semibold text-sm text-gray-800 line-clamp-1">{p.name}</p>
                                                    <p className="text-xs text-red-600">Stock: {p.stock || 0}</p>
                                                </div>
                                                <button
                                                    onClick={() => { setProductToUpdateStock(p); setTab('products'); }}
                                                    className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-lg font-semibold hover:bg-red-200"
                                                >
                                                    Update
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {tab === 'products' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                {/* Add Product Form */}
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border-t-4 border-primary">
                                    <h2 className="text-lg md:text-xl font-bold mb-4 text-primary flex items-center">
                                        <i className="fa-solid fa-plus-circle mr-2"></i> Add New Product
                                    </h2>
                                    <form onSubmit={handleAddProduct} className="space-y-3">
                                        <input required className="text-input-style" placeholder="Product ID (Unique)" value={newProduct.id} onChange={e => setNewProduct({...newProduct, id:e.target.value})} />
                                        <input required className="text-input-style" placeholder="Product Name" value={newProduct.name} onChange={e => setNewProduct({...newProduct, name:e.target.value})} />
                                        <div className="grid grid-cols-2 gap-2">
                                            <input required type="number" step="0.01" className="text-input-style" placeholder="Price (₹)" value={newProduct.price} onChange={e => setNewProduct({...newProduct, price:e.target.value})} />
                                            <input required className="text-input-style" placeholder="Category" value={newProduct.category} onChange={e => setNewProduct({...newProduct, category:e.target.value})} />
                                        </div>
                                        <input className="text-input-style" placeholder="Image URL (Optional)" value={newProduct.image} onChange={e => setNewProduct({...newProduct, image:e.target.value})} />
                                        <textarea className="text-input-style" rows="2" placeholder="Description (Optional)" value={newProduct.description} onChange={e => setNewProduct({...newProduct, description:e.target.value})} />
                                        <button type="submit" className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition shadow-md touch-target">
                                            <i className="fa-solid fa-plus-circle mr-2"></i> Add Product
                                        </button>
                                    </form>
                                </div>

                                {/* Bulk Price Update */}
                                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-accent">
                                    <div className="flex justify-between items-center mb-3">
                                        <h3 className="font-bold text-accent flex items-center">
                                            <i className="fa-solid fa-tags mr-2"></i> Bulk Price Update
                                        </h3>
                                        <button
                                            onClick={() => setShowBulkPriceUpdate(!showBulkPriceUpdate)}
                                            className="text-xs text-primary hover:text-primary-dark font-semibold"
                                        >
                                            {showBulkPriceUpdate ? 'Cancel' : 'Open'}
                                        </button>
                                    </div>
                                    {showBulkPriceUpdate && (
                                        <div className="space-y-3">
                                            <p className="text-xs text-gray-600">Add products to update their prices in bulk.</p>
                                            {bulkPriceUpdates.map((item, idx) => (
                                                <div key={idx} className="flex gap-2 items-center">
                                                    <select
                                                        className="text-input-style flex-1 text-xs"
                                                        value={item.id}
                                                        onChange={e => {
                                                            const newUpdates = [...bulkPriceUpdates];
                                                            newUpdates[idx].id = e.target.value;
                                                            setBulkPriceUpdates(newUpdates);
                                                        }}
                                                    >
                                                        <option value="">Select Product</option>
                                                        {products.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                    </select>
                                                    <input
                                                        type="number"
                                                        step="0.01"
                                                        className="text-input-style w-24 text-xs"
                                                        placeholder="New Price"
                                                        value={item.price}
                                                        onChange={e => {
                                                            const newUpdates = [...bulkPriceUpdates];
                                                            newUpdates[idx].price = e.target.value;
                                                            setBulkPriceUpdates(newUpdates);
                                                        }}
                                                    />
                                                    <button onClick={() => setBulkPriceUpdates(bulkPriceUpdates.filter((_, i) => i !== idx))} className="text-danger text-xs">
                                                        <i className="fa-solid fa-times"></i>
                                                    </button>
                                                </div>
                                            ))}
                                            <button
                                                onClick={() => setBulkPriceUpdates([...bulkPriceUpdates, { id: '', price: '' }])}
                                                className="text-xs text-primary font-semibold"
                                            >
                                                <i className="fa-solid fa-plus mr-1"></i> Add Item
                                            </button>
                                            {bulkPriceUpdates.length > 0 && (
                                                <button
                                                    onClick={handleBulkUpdatePrices}
                                                    className="w-full bg-accent text-primary-dark p-2 rounded-lg font-bold text-sm hover:bg-accent-hover"
                                                >
                                                    Update {bulkPriceUpdates.length} Prices
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>

                                {/* Low Stock Threshold Setting */}
                                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-danger">
                                    <h3 className="font-bold text-danger mb-3 flex items-center">
                                        <i className="fa-solid fa-triangle-exclamation mr-2"></i> Low Stock Threshold
                                    </h3>
                                    <div className="flex gap-2">
                                        <input
                                            type="number"
                                            className="text-input-style flex-1"
                                            value={lowStockThreshold}
                                            onChange={e => setLowStockThreshold(parseInt(e.target.value) || 10)}
                                        />
                                        <button
                                            onClick={fetchLowStockProducts}
                                            className="bg-danger text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-danger/80"
                                        >
                                            Check
                                        </button>
                                    </div>
                                    {lowStockProducts.length > 0 && (
                                        <p className="text-xs text-danger mt-2">
                                            <i className="fa-solid fa-exclamation-circle mr-1"></i>
                                            {lowStockProducts.length} products below threshold
                                        </p>
                                    )}
                                </div>
                            </div>

                            <div className="lg:col-span-2 bg-white rounded-xl shadow-md">
                                <div className="p-4 border-b">
                                    <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
                                        <h2 className="text-lg md:text-xl font-bold text-primary flex items-center">
                                            <i className="fa-solid fa-box mr-2"></i> Products
                                            <span className="text-sm bg-primary/10 px-3 py-1 rounded-full ml-2">{filteredAdminProducts.length}</span>
                                        </h2>
                                        {/* Search Input */}
                                        <div className="relative flex-1 max-w-xs">
                                            <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                                            <input
                                                type="text"
                                                className="text-input-style pl-9 text-sm"
                                                placeholder="Search by name, ID, category..."
                                                value={productSearchTerm}
                                                onChange={e => setProductSearchTerm(e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Desktop Table View */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 uppercase"><tr><th className="p-3">ID</th><th className="p-3">Name</th><th className="p-3">Price</th><th className="p-3">Stock</th><th className="p-3">Category</th><th className="p-3">Actions</th></tr></thead>
                                        <tbody>
                                            {filteredAdminProducts.map(p => (
                                                <tr key={p.id} className={`border-b hover:bg-gray-50 ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-50' : ''}`}>
                                                    <td className="p-3 text-xs text-gray-500">{p.id}</td>
                                                    <td className="p-3 font-semibold">{p.name}</td>
                                                    <td className="p-3 font-bold text-danger">{formatCurrency(p.price)}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                            {p.stock || 0}
                                                        </span>
                                                    </td>
                                                    <td className="p-3">{p.category}</td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        <button onClick={() => setProductToUpdateStock(p)} className="text-success hover:text-success/80 text-xs font-semibold mr-2"><i className='fa-solid fa-boxes-stacked'></i> Stock</button>
                                                        <button onClick={() => setProductToEdit(p)} className="text-info hover:text-info/80 text-xs font-semibold mr-2"><i className='fa-solid fa-edit'></i> Edit</button>
                                                        <button onClick={() => handleDeleteProduct(p.id)} className="text-danger hover:text-danger/80 text-xs font-semibold"><i className='fa-solid fa-trash'></i> Del</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden p-3 space-y-3 max-h-[60vh] overflow-y-auto">
                                    {filteredAdminProducts.map(p => (
                                        <div key={p.id} className={`rounded-xl p-4 border ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'}`}>
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <h3 className="font-bold text-gray-800 text-sm line-clamp-2">{p.name}</h3>
                                                    <p className="text-xs text-gray-500 mt-1">ID: {p.id}</p>
                                                </div>
                                                <div className="text-right ml-2">
                                                    <span className="text-lg font-extrabold text-danger block">{formatCurrency(p.price)}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${(p.stock || 0) <= lowStockThreshold ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                        Stock: {p.stock || 0}
                                                    </span>
                                                </div>
                                            </div>
                                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                                <span className="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full font-medium">{p.category}</span>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setProductToUpdateStock(p)} className="bg-success text-white px-2 py-1.5 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-boxes-stacked'></i>
                                                    </button>
                                                    <button onClick={() => setProductToEdit(p)} className="bg-info text-white px-2 py-1.5 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-edit'></i>
                                                    </button>
                                                    <button onClick={() => handleDeleteProduct(p.id)} className="bg-danger text-white px-2 py-1.5 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-trash'></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'orders' && (
                        <div className="space-y-4">
                            {/* Delivery Portal Link Card */}
                            <div className="bg-gradient-to-r from-accent/10 to-accent/5 p-4 rounded-xl border border-accent/20">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-3">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-accent text-primary-dark p-3 rounded-full">
                                            <i className="fa-solid fa-motorcycle text-xl"></i>
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-primary-dark">Delivery Partner Portal</h3>
                                            <p className="text-sm text-gray-600">Share this link with delivery boys to access their orders</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button
                                            onClick={() => {
                                                const url = window.location.origin + window.location.pathname + '?view=delivery';
                                                navigator.clipboard.writeText(url);
                                                showToast('Delivery portal link copied!', 'success');
                                            }}
                                            className="bg-accent text-primary-dark px-4 py-2 rounded-lg font-semibold hover:bg-accent-hover transition text-sm"
                                        >
                                            <i className="fa-solid fa-copy mr-1"></i> Copy Link
                                        </button>
                                        <a
                                            href="?view=delivery"
                                            target="_blank"
                                            className="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark transition text-sm"
                                        >
                                            <i className="fa-solid fa-external-link mr-1"></i> Open
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-md">
                            <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                <span><i className="fa-solid fa-receipt mr-2"></i> Orders</span>
                                <div className="flex gap-2 items-center">
                                    {orderStats && (
                                        <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full">
                                            {orderStats.pending || 0} Pending
                                        </span>
                                    )}
                                    <span className="text-sm bg-primary/10 px-3 py-1 rounded-full">{orders.length}</span>
                                </div>
                            </h2>

                            {/* Desktop Table View */}
                            <div className="hidden md:block overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-100 uppercase"><tr><th className="p-3">Order ID</th><th className="p-3">Customer Email</th><th className="p-3">Date</th><th className="p-3">Total</th><th className="p-3">Payment</th><th className="p-3">Assigned To</th><th className="p-3">Status</th><th className="p-3">Actions</th></tr></thead>
                                    <tbody>
                                        {orders.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o => (
                                            <tr key={o.orderId} className="border-b hover:bg-gray-50">
                                                <td className="p-3 text-xs text-gray-500">#{o.orderId}</td>
                                                <td className="p-3">{o.userEmail}</td>
                                                <td className="p-3 text-xs">{o.date}</td>
                                                <td className="p-3 font-bold text-danger">{formatCurrency(o.total)}</td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 rounded-full text-xs font-bold ${o.paymentMethod === 'upi' ? 'bg-upi-light text-upi' : 'bg-green-100 text-green-800'}`}>
                                                        {o.paymentMethod === 'upi' ? 'UPI' : 'COD'}
                                                        {o.paymentStatus && ` (${o.paymentStatus})`}
                                                    </span>
                                                </td>
                                                <td className="p-3">
                                                    {o.status === 'Pending' || o.status === 'Shipped' ? (
                                                        <select
                                                            className="text-xs border rounded px-2 py-1"
                                                            value={o.assignedTo || ''}
                                                            onChange={e => handleAssignDelivery(o.orderId, e.target.value)}
                                                        >
                                                            <option value="">Assign...</option>
                                                            <option value="Delivery Boy 1">Delivery Boy 1</option>
                                                            <option value="Delivery Boy 2">Delivery Boy 2</option>
                                                            <option value="Delivery Boy 3">Delivery Boy 3</option>
                                                            <option value="Self Pickup">Self Pickup</option>
                                                        </select>
                                                    ) : (
                                                        <span className="text-xs text-gray-500">{o.assignedTo || '-'}</span>
                                                    )}
                                                </td>
                                                <td className="p-3">
                                                    <span className={`px-2 py-1 rounded-full text-white text-xs font-bold ${o.status==='Pending'?'bg-accent-hover':o.status==='Delivered'?'bg-success':o.status==='Cancelled'?'bg-danger':'bg-info'}`}>{o.status}</span>
                                                </td>
                                                <td className="p-3 whitespace-nowrap">
                                                    <button onClick={() => setOrderToView(o)} className="text-primary hover:text-primary-dark text-xs font-semibold"><i className='fa-solid fa-eye'></i> View</button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>

                            {/* Mobile Card View */}
                            <div className="md:hidden p-3 space-y-3 max-h-[70vh] overflow-y-auto">
                                {orders.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(o => (
                                    <div key={o.orderId} className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="font-bold text-primary">#{o.orderId}</span>
                                            <span className={`px-2 py-1 rounded-full text-white text-xs font-bold ${o.status==='Pending'?'bg-accent-hover':o.status==='Delivered'?'bg-success':o.status==='Cancelled'?'bg-danger':'bg-info'}`}>{o.status}</span>
                                        </div>
                                        <p className="text-xs text-gray-600 truncate mb-2">{o.userEmail}</p>
                                        <div className="flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-2">
                                                <span className="text-lg font-extrabold text-danger">{formatCurrency(o.total)}</span>
                                                <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold ${o.paymentMethod === 'upi' ? 'bg-upi-light text-upi' : 'bg-green-100 text-green-800'}`}>
                                                    {o.paymentMethod === 'upi' ? 'UPI' : 'COD'}
                                                </span>
                                            </div>
                                            <span className="text-xs text-gray-500">{o.date}</span>
                                        </div>
                                        {(o.status === 'Pending' || o.status === 'Shipped') && (
                                            <select
                                                className="w-full text-xs border rounded px-2 py-2 mb-2"
                                                value={o.assignedTo || ''}
                                                onChange={e => handleAssignDelivery(o.orderId, e.target.value)}
                                            >
                                                <option value="">Assign Delivery...</option>
                                                <option value="Delivery Boy 1">Delivery Boy 1</option>
                                                <option value="Delivery Boy 2">Delivery Boy 2</option>
                                                <option value="Delivery Boy 3">Delivery Boy 3</option>
                                                <option value="Self Pickup">Self Pickup</option>
                                            </select>
                                        )}
                                        <button onClick={() => setOrderToView(o)} className="w-full bg-primary/10 text-primary py-2 rounded-lg text-sm font-bold touch-target">
                                            <i className='fa-solid fa-eye mr-1'></i> View Details
                                        </button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        </div>
                    )}

                    {tab === 'users' && (
                        <div className="space-y-4">
                            {/* User Search Section */}
                            <div className="bg-white p-4 rounded-xl shadow-md">
                                <h3 className="font-bold text-primary mb-3 flex items-center">
                                    <i className="fa-solid fa-search mr-2"></i> Search User by Email
                                </h3>
                                <div className="flex gap-2">
                                    <input
                                        type="email"
                                        className="text-input-style flex-1"
                                        placeholder="Enter user email..."
                                        value={userSearchEmail}
                                        onChange={e => setUserSearchEmail(e.target.value)}
                                    />
                                    <button
                                        onClick={handleSearchUserByEmail}
                                        className="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark"
                                    >
                                        Search
                                    </button>
                                </div>
                                {/* Search Result */}
                                {searchedUser && (
                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-bold text-primary">Search Result</h4>
                                            <button onClick={() => setSearchedUser(null)} className="text-gray-500 text-sm">
                                                <i className="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-sm mb-3">
                                            <div><span className="text-gray-500">Name:</span> <strong>{searchedUser.name}</strong></div>
                                            <div><span className="text-gray-500">Email:</span> <strong className="text-xs">{searchedUser.email}</strong></div>
                                            <div><span className="text-gray-500">Role:</span> <strong className="capitalize">{searchedUser.role}</strong></div>
                                            <div><span className="text-gray-500">Status:</span> <strong className={searchedUser.status === 'banned' ? 'text-danger' : 'text-success'}>{searchedUser.status || 'active'}</strong></div>
                                            <div><span className="text-gray-500">Coins:</span> <strong className="text-success">{searchedUser.coins || 0}</strong></div>
                                            <div><span className="text-gray-500">Phone:</span> <strong>{searchedUser.phone || '-'}</strong></div>
                                        </div>
                                        {searchedUser.role !== 'admin' && (
                                            <div className="flex gap-2 flex-wrap">
                                                <button
                                                    onClick={() => handleToggleUserStatus(searchedUser.email, searchedUser.status)}
                                                    className={`text-xs font-bold px-3 py-2 rounded-lg ${searchedUser.status === 'banned' ? 'bg-success text-white' : 'bg-accent text-primary-dark'}`}
                                                >
                                                    <i className={`fa-solid ${searchedUser.status === 'banned' ? 'fa-circle-check' : 'fa-ban'} mr-1`}></i>
                                                    {searchedUser.status === 'banned' ? 'Unban' : 'Ban'}
                                                </button>
                                                <button
                                                    onClick={() => setUserToResetPassword(searchedUser)}
                                                    className="text-xs font-bold px-3 py-2 rounded-lg bg-info text-white"
                                                >
                                                    <i className="fa-solid fa-key mr-1"></i> Reset Password
                                                </button>
                                                <button
                                                    onClick={() => handleDeleteUser(searchedUser.email)}
                                                    className="text-xs font-bold px-3 py-2 rounded-lg bg-danger text-white"
                                                >
                                                    <i className="fa-solid fa-trash mr-1"></i> Delete User
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Users List */}
                            <div className="bg-white rounded-xl shadow-md">
                                <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                    <span><i className="fa-solid fa-users mr-2"></i> Users</span>
                                    <span className="text-sm bg-primary/10 px-3 py-1 rounded-full">{users.length}</span>
                                </h2>

                                {/* Desktop Table View */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 uppercase"><tr><th className="p-3">Name</th><th className="p-3">Email</th><th className="p-3">Role</th><th className="p-3">Coins</th><th className="p-3">Status</th><th className="p-3">Actions</th></tr></thead>
                                        <tbody>
                                            {users.map(u => (
                                                <tr key={u.email} className="border-b hover:bg-gray-50">
                                                    <td className="p-3 font-semibold">{u.name}</td>
                                                    <td className="p-3 text-xs">{u.email}</td>
                                                    <td className="p-3 capitalize">{u.role}</td>
                                                    <td className="p-3 text-success font-bold">{u.coins || 0}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${u.status === 'banned' ? 'bg-danger text-white' : 'bg-success/20 text-success'}`}>{u.status || 'active'}</span>
                                                    </td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        {u.role !== 'admin' && (
                                                            <div className="flex gap-1">
                                                                <button onClick={() => handleToggleUserStatus(u.email, u.status)} className={`text-xs font-semibold px-2 py-1 rounded-md transition ${u.status === 'banned' ? 'bg-success text-white hover:bg-success/80' : 'bg-accent text-primary-dark hover:bg-accent-hover'}`}>
                                                                    <i className={`fa-solid ${u.status === 'banned' ? 'fa-circle-check' : 'fa-ban'}`}></i>
                                                                </button>
                                                                <button onClick={() => setUserToResetPassword(u)} className="text-xs font-semibold px-2 py-1 rounded-md bg-info text-white hover:bg-info/80">
                                                                    <i className="fa-solid fa-key"></i>
                                                                </button>
                                                                <button onClick={() => handleDeleteUser(u.email)} className="text-xs font-semibold px-2 py-1 rounded-md bg-danger text-white hover:bg-danger/80">
                                                                    <i className="fa-solid fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden p-3 space-y-3 max-h-[70vh] overflow-y-auto">
                                    {users.map(u => (
                                        <div key={u.email} className="bg-gray-50 rounded-xl p-4 border border-gray-200">
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold ${u.role === 'admin' ? 'bg-danger' : u.status === 'banned' ? 'bg-gray-400' : 'bg-primary'}`}>
                                                        {u.name.charAt(0).toUpperCase()}
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-gray-800">{u.name}</h3>
                                                        <p className="text-xs text-gray-500 truncate max-w-[180px]">{u.email}</p>
                                                    </div>
                                                </div>
                                                <span className={`px-2 py-1 rounded-full text-xs font-bold ${u.status === 'banned' ? 'bg-danger text-white' : 'bg-success/20 text-success'}`}>{u.status || 'active'}</span>
                                            </div>
                                            <div className="flex items-center justify-between mt-3 pt-3 border-t border-gray-200">
                                                <div className="flex items-center gap-3">
                                                    <span className="text-xs bg-primary/10 text-primary px-2 py-1 rounded-full font-medium capitalize">{u.role}</span>
                                                    <span className="text-sm font-bold text-success flex items-center">
                                                        <i className="fa-solid fa-coins mr-1"></i> {u.coins || 0}
                                                    </span>
                                                </div>
                                                {u.role !== 'admin' && (
                                                    <div className="flex gap-1">
                                                        <button onClick={() => handleToggleUserStatus(u.email, u.status)} className={`text-xs font-bold px-3 py-2 rounded-lg touch-target ${u.status === 'banned' ? 'bg-success text-white' : 'bg-accent text-primary-dark'}`}>
                                                            <i className={`fa-solid ${u.status === 'banned' ? 'fa-circle-check' : 'fa-ban'}`}></i>
                                                        </button>
                                                        <button onClick={() => setUserToResetPassword(u)} className="text-xs font-bold px-3 py-2 rounded-lg bg-info text-white touch-target">
                                                            <i className="fa-solid fa-key"></i>
                                                        </button>
                                                        <button onClick={() => handleDeleteUser(u.email)} className="text-xs font-bold px-3 py-2 rounded-lg bg-danger text-white touch-target">
                                                            <i className="fa-solid fa-trash"></i>
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'coupons' && (
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
                            <div className="lg:col-span-1 space-y-4">
                                {/* Add Coupon Form */}
                                <div className="bg-white p-4 md:p-6 rounded-xl shadow-md border-t-4 border-success">
                                    <h2 className="text-lg md:text-xl font-bold mb-4 text-success flex items-center">
                                        <i className="fa-solid fa-tag mr-2"></i> Add Coupon
                                    </h2>
                                    <form onSubmit={handleAddCoupon} className="space-y-3">
                                        <input required className="text-input-style uppercase" placeholder="Coupon Code (e.g., SAVE20)" value={newCoupon.code} onChange={e => setNewCoupon({...newCoupon, code:e.target.value.toUpperCase()})} />

                                        <div className='grid grid-cols-2 gap-2'>
                                            <select required className="text-input-style" value={newCoupon.discountType} onChange={e => setNewCoupon({...newCoupon, discountType:e.target.value})}>
                                                <option value="fixed">Fixed (₹)</option>
                                                <option value="percentage">Percent (%)</option>
                                            </select>
                                            <input
                                                required
                                                type="number"
                                                step="0.01"
                                                className="text-input-style"
                                                placeholder="Value"
                                                value={newCoupon.discountValue}
                                                onChange={e => setNewCoupon({...newCoupon, discountValue:e.target.value})}
                                            />
                                        </div>

                                        <input type="number" step="0.01" className="text-input-style" placeholder="Min Order (₹0)" value={newCoupon.minOrder} onChange={e => setNewCoupon({...newCoupon, minOrder:e.target.value})} />

                                        <button type="submit" className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition shadow-md touch-target">
                                            <i className="fa-solid fa-plus-circle mr-2"></i> Add Coupon
                                        </button>
                                    </form>
                                </div>

                                {/* Coupon Validation Test */}
                                <div className="bg-white p-4 rounded-xl shadow-md border-t-4 border-info">
                                    <h3 className="font-bold text-info mb-3 flex items-center">
                                        <i className="fa-solid fa-check-double mr-2"></i> Test Coupon
                                    </h3>
                                    <div className="space-y-3">
                                        <input
                                            className="text-input-style uppercase"
                                            placeholder="Coupon Code"
                                            value={couponValidationTest.code}
                                            onChange={e => setCouponValidationTest({...couponValidationTest, code: e.target.value.toUpperCase()})}
                                        />
                                        <input
                                            type="number"
                                            className="text-input-style"
                                            placeholder="Order Amount (₹)"
                                            value={couponValidationTest.amount}
                                            onChange={e => setCouponValidationTest({...couponValidationTest, amount: e.target.value})}
                                        />
                                        <button
                                            type="button"
                                            onClick={handleValidateCoupon}
                                            className="w-full bg-info text-white p-2 rounded-lg font-bold hover:bg-info/80 transition text-sm"
                                        >
                                            Validate Coupon
                                        </button>
                                        {validationResult && (
                                            <div className={`p-3 rounded-lg text-sm ${validationResult.status === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                                {validationResult.status === 'success' ? (
                                                    <>
                                                        <p className="font-bold"><i className="fa-solid fa-check-circle mr-1"></i> Valid!</p>
                                                        <p>Discount: {formatCurrency(validationResult.discountAmount || 0)}</p>
                                                        <p>New Total: {formatCurrency(validationResult.newTotal || 0)}</p>
                                                    </>
                                                ) : (
                                                    <p><i className="fa-solid fa-times-circle mr-1"></i> {validationResult.message}</p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>

                            <div className="lg:col-span-2 bg-white rounded-xl shadow-md">
                                <h2 className="text-lg md:text-xl font-bold p-4 border-b text-success flex items-center justify-between">
                                    <span><i className="fa-solid fa-tags mr-2"></i> Coupons</span>
                                    <span className="text-sm bg-success/10 px-3 py-1 rounded-full">{coupons.length}</span>
                                </h2>

                                {/* Desktop Table View */}
                                <div className="hidden md:block overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-100 uppercase"><tr><th className="p-3">Code</th><th className="p-3">Type</th><th className="p-3">Discount</th><th className="p-3">Min Order</th><th className="p-3">Status</th><th className="p-3">Actions</th></tr></thead>
                                        <tbody>
                                            {coupons.map(coupon => (
                                                <tr key={coupon.code} className={`border-b hover:bg-gray-50 ${coupon.active === false ? 'bg-gray-100 opacity-60' : ''}`}>
                                                    <td className="p-3 font-semibold text-primary">{coupon.code}</td>
                                                    <td className="p-3 capitalize">{coupon.discountType}</td>
                                                    <td className="p-3 font-bold text-danger">{getCouponDisplayValue(coupon)}</td>
                                                    <td className="p-3">{formatCurrency(coupon.minOrder)}</td>
                                                    <td className="p-3">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${coupon.active === false ? 'bg-gray-300 text-gray-600' : 'bg-success/20 text-success'}`}>
                                                            {coupon.active === false ? 'Inactive' : 'Active'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 whitespace-nowrap">
                                                        <button onClick={() => handleToggleCoupon(coupon.code)} className={`text-xs font-semibold mr-2 px-2 py-1 rounded ${coupon.active === false ? 'bg-success text-white' : 'bg-gray-400 text-white'}`}>
                                                            <i className={`fa-solid ${coupon.active === false ? 'fa-toggle-on' : 'fa-toggle-off'}`}></i>
                                                        </button>
                                                        <button onClick={() => setCouponToEdit({...coupon})} className="text-info hover:text-info/80 text-xs font-semibold mr-2"><i className='fa-solid fa-edit'></i></button>
                                                        <button onClick={() => handleDeleteCoupon(coupon.code)} className="text-danger hover:text-danger/80 text-xs font-semibold"><i className='fa-solid fa-trash'></i></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>

                                {/* Mobile Card View */}
                                <div className="md:hidden p-3 space-y-3 max-h-[60vh] overflow-y-auto">
                                    {coupons.length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">No coupons yet</div>
                                    ) : coupons.map(coupon => (
                                        <div key={coupon.code} className={`rounded-xl p-4 border-2 border-dashed ${coupon.active === false ? 'bg-gray-100 border-gray-300 opacity-60' : 'bg-gradient-to-r from-success/5 to-success/10 border-success/30'}`}>
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="flex items-center gap-2">
                                                    <span className="font-mono font-bold text-lg text-primary bg-white px-3 py-1 rounded-lg shadow-sm">{coupon.code}</span>
                                                    <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${coupon.active === false ? 'bg-gray-300 text-gray-600' : 'bg-success/20 text-success'}`}>
                                                        {coupon.active === false ? 'OFF' : 'ON'}
                                                    </span>
                                                </div>
                                                <span className="text-lg font-extrabold text-danger">{getCouponDisplayValue(coupon)}</span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="text-sm">
                                                    <span className="text-gray-500">Min: </span>
                                                    <span className="font-semibold">{formatCurrency(coupon.minOrder)}</span>
                                                </div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => handleToggleCoupon(coupon.code)} className={`px-3 py-2 rounded-lg text-xs font-bold touch-target ${coupon.active === false ? 'bg-success text-white' : 'bg-gray-400 text-white'}`}>
                                                        <i className={`fa-solid ${coupon.active === false ? 'fa-toggle-on' : 'fa-toggle-off'}`}></i>
                                                    </button>
                                                    <button onClick={() => setCouponToEdit({...coupon})} className="bg-info text-white px-3 py-2 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-edit'></i>
                                                    </button>
                                                    <button onClick={() => handleDeleteCoupon(coupon.code)} className="bg-danger text-white px-3 py-2 rounded-lg text-xs font-bold touch-target">
                                                        <i className='fa-solid fa-trash'></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'support' && (
                        <div className="bg-white rounded-xl shadow-md">
                            <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                <span><i className="fa-solid fa-headset mr-2"></i> Tickets</span>
                                <div className="flex gap-2 flex-wrap">
                                    <span className="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-full">{tickets.filter(t => t.priority === 'Urgent').length} Urgent</span>
                                    <span className="text-xs bg-danger/10 text-danger px-2 py-1 rounded-full">{tickets.filter(t => t.status === 'Open').length} Open</span>
                                    <span className="text-xs bg-success/10 text-success px-2 py-1 rounded-full">{tickets.filter(t => t.status !== 'Open').length} Closed</span>
                                </div>
                            </h2>
                            <div className="space-y-3 p-3 md:p-4 max-h-[70vh] overflow-y-auto">
                                {tickets.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">No support tickets</div>
                                ) : tickets.sort((a,b)=>{
                                    // Sort by priority first (Urgent > High > Medium > Low), then by date
                                    const priorityOrder = { 'Urgent': 0, 'High': 1, 'Medium': 2, 'Low': 3 };
                                    const aPriority = priorityOrder[a.priority] ?? 2;
                                    const bPriority = priorityOrder[b.priority] ?? 2;
                                    if (aPriority !== bPriority) return aPriority - bPriority;
                                    return new Date(b.dateCreated) - new Date(a.dateCreated);
                                }).map(t => (
                                    <div key={t.ticketId} className={`p-4 rounded-xl border shadow-sm ${t.priority === 'Urgent' ? 'bg-red-50 border-red-200' : t.priority === 'High' ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'}`}>
                                        <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 mb-2">
                                            <div className="flex items-center gap-2 flex-wrap">
                                                <span className='font-bold text-primary text-sm'>#{t.ticketId} - {t.subject}</span>
                                                {/* Priority Badge */}
                                                <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                                                    t.priority === 'Urgent' ? 'bg-red-500 text-white' :
                                                    t.priority === 'High' ? 'bg-orange-500 text-white' :
                                                    t.priority === 'Low' ? 'bg-gray-400 text-white' :
                                                    'bg-blue-500 text-white'
                                                }`}>
                                                    {t.priority || 'Medium'}
                                                </span>
                                            </div>
                                            <span className={`px-2 py-1 rounded-full text-white text-xs self-start sm:self-auto ${t.status==='Open'?'bg-danger':'bg-success'}`}>{t.status}</span>
                                        </div>
                                        <p className="text-xs text-gray-500 mb-2 break-all">
                                            <span className="block sm:inline">{t.email}</span>
                                            <span className="hidden sm:inline"> | </span>
                                            <span className="block sm:inline">{t.dateCreated}</span>
                                        </p>
                                        <p className="text-sm text-gray-700 my-2 italic bg-white p-2 rounded-lg">"{t.message}"</p>
                                        {t.adminReply && (
                                            <div className="bg-info/10 text-info p-3 text-sm rounded-lg mt-2 border-l-4 border-info">
                                                <span className="font-bold block mb-1">Admin Reply:</span>
                                                {t.adminReply}
                                            </div>
                                        )}
                                        {/* Admin Actions */}
                                        <div className="flex flex-wrap gap-2 mt-3 pt-3 border-t border-gray-200">
                                            {t.status === 'Open' && !t.adminReply && (
                                                <button onClick={() => handleReplyTicket(t.ticketId)} className="bg-primary text-white px-3 py-1.5 rounded-lg text-xs font-semibold touch-target">
                                                    <i className="fa-solid fa-reply mr-1"></i> Reply
                                                </button>
                                            )}
                                            {t.status === 'Open' && (
                                                <button onClick={() => handleCloseTicket(t.ticketId)} className="bg-success text-white px-3 py-1.5 rounded-lg text-xs font-semibold touch-target">
                                                    <i className="fa-solid fa-check-circle mr-1"></i> Close
                                                </button>
                                            )}
                                            {t.status === 'Open' && (
                                                <select
                                                    className="text-xs border rounded px-2 py-1.5 bg-white"
                                                    value={t.priority || 'Medium'}
                                                    onChange={e => handleUpdateTicketPriority(t.ticketId, e.target.value)}
                                                >
                                                    <option value="Low">Low Priority</option>
                                                    <option value="Medium">Medium Priority</option>
                                                    <option value="High">High Priority</option>
                                                    <option value="Urgent">Urgent</option>
                                                </select>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {tab === 'marketing' && (
                        <div className="max-w-xl mx-auto bg-white p-4 md:p-6 rounded-xl shadow-md border-t-4 border-accent">
                            <h2 className="text-xl md:text-2xl font-bold mb-2 text-primary-dark flex items-center">
                                <i className="fa-solid fa-bullhorn mr-2 text-accent"></i> Send Offer
                            </h2>

                            {/* Toggle between broadcast and targeted */}
                            <div className="flex gap-2 mb-4">
                                <button
                                    onClick={() => setIsTargetedEmail(false)}
                                    className={`flex-1 py-2 rounded-lg font-semibold text-sm transition ${!isTargetedEmail ? 'bg-accent text-primary-dark' : 'bg-gray-100 text-gray-700'}`}
                                >
                                    <i className="fa-solid fa-users mr-1"></i> Broadcast
                                </button>
                                <button
                                    onClick={() => setIsTargetedEmail(true)}
                                    className={`flex-1 py-2 rounded-lg font-semibold text-sm transition ${isTargetedEmail ? 'bg-accent text-primary-dark' : 'bg-gray-100 text-gray-700'}`}
                                >
                                    <i className="fa-solid fa-user mr-1"></i> Individual
                                </button>
                            </div>

                            {!isTargetedEmail ? (
                                <p className='text-sm text-gray-600 mb-4'>
                                    Email blast to <strong className="text-primary">{users.filter(u=>u.role==='user' && u.status !== 'banned').length}</strong> active users
                                </p>
                            ) : (
                                <div className="mb-4">
                                    <label className="text-sm font-bold block mb-1">Target Email</label>
                                    <input
                                        type="email"
                                        className="text-input-style"
                                        placeholder="customer@email.com"
                                        value={targetEmail}
                                        onChange={e => setTargetEmail(e.target.value)}
                                    />
                                </div>
                            )}

                            <div className="space-y-3">
                                <div>
                                    <label className="text-sm font-bold block mb-1">Subject</label>
                                    <input id="offerSubject" required className="text-input-style" placeholder="Big Winter Sale is Here!" />
                                </div>
                                <div>
                                    <label className="text-sm font-bold block mb-1">Message</label>
                                    <textarea id="offerMessage" required className="text-input-style" rows="4" placeholder="Dear Customer, use code WINTER20 for 20% off all items!"></textarea>
                                </div>
                                {isTargetedEmail ? (
                                    <button onClick={handleSendTargetedEmail} className="w-full bg-primary text-white p-3 rounded-lg font-bold hover:bg-primary-dark transition shadow-md touch-target">
                                        <i className="fa-solid fa-paper-plane mr-2"></i> Send to {targetEmail || 'User'}
                                    </button>
                                ) : (
                                    <button onClick={handleSendOffer} className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold hover:bg-accent-hover transition shadow-md touch-target">
                                        <i className="fa-solid fa-paper-plane mr-2"></i> Send to All Users
                                    </button>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Activity Log Tab */}
                    {tab === 'activity' && (
                        <div className="bg-white rounded-xl shadow-md">
                            <h2 className="text-lg md:text-xl font-bold p-4 border-b text-primary flex items-center justify-between">
                                <span><i className="fa-solid fa-clock-rotate-left mr-2"></i> Activity Log</span>
                                <button onClick={fetchData} className="text-sm bg-primary/10 text-primary px-3 py-1 rounded-lg hover:bg-primary/20">
                                    <i className="fa-solid fa-refresh mr-1"></i> Refresh
                                </button>
                            </h2>
                            <div className="p-4 space-y-3 max-h-[70vh] overflow-y-auto">
                                {activityLog.length === 0 ? (
                                    <div className="text-center text-gray-500 py-8">
                                        <i className="fa-solid fa-inbox fa-2x mb-2"></i>
                                        <p>No activity logged yet</p>
                                    </div>
                                ) : activityLog.map((activity, index) => (
                                    <div key={index} className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100">
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 ${
                                            activity.type === 'order' ? 'bg-green-100 text-green-600' :
                                            activity.type === 'user' ? 'bg-blue-100 text-blue-600' :
                                            activity.type === 'product' ? 'bg-purple-100 text-purple-600' :
                                            activity.type === 'ticket' ? 'bg-orange-100 text-orange-600' :
                                            'bg-gray-100 text-gray-600'
                                        }`}>
                                            <i className={`fa-solid ${
                                                activity.type === 'order' ? 'fa-receipt' :
                                                activity.type === 'user' ? 'fa-user' :
                                                activity.type === 'product' ? 'fa-box' :
                                                activity.type === 'ticket' ? 'fa-ticket' :
                                                'fa-circle-info'
                                            }`}></i>
                                        </div>
                                        <div className="flex-1 min-w-0">
                                            <p className="text-sm font-semibold text-gray-800">{activity.action || activity.message}</p>
                                            <p className="text-xs text-gray-500">{activity.details || ''}</p>
                                            <p className="text-xs text-gray-400 mt-1">{activity.timestamp || activity.date}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* Modals for Admin Actions */}
                    {productToEdit && (
                        <EditProductModal
                            product={productToEdit}
                            onClose={(success, message) => { setProductToEdit(null); if (success) showToast('Product updated successfully.', 'success'); else if (message) showToast(message, 'error'); }}
                            onSave={handleUpdateProduct}
                        />
                    )}
                    {orderToView && (
                        <OrderDetailModal
                            order={orderToView}
                            onClose={() => setOrderToView(null)}
                            onUpdateStatus={(id, status) => {
                                setOrderToView(prev => ({ ...prev, status }));
                                setOrders(orders.map(o => o.orderId === id ? { ...o, status } : o));
                                showToast(`Order #${id} status changed to ${status}.`, 'success');
                            }}
                            role={getRole(user)}
                        />
                    )}

                    {/* Stock Management Modal */}
                    {productToUpdateStock && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => setProductToUpdateStock(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>
                                <div className="p-6">
                                    <div className="flex justify-between items-start border-b pb-3 mb-4">
                                        <h2 className="text-xl font-bold text-primary-dark">Update Stock</h2>
                                        <button onClick={() => setProductToUpdateStock(null)} className="text-gray-500 hover:text-danger">
                                            <i className="fa-solid fa-xmark text-xl"></i>
                                        </button>
                                    </div>
                                    <div className="mb-4">
                                        <p className="font-semibold text-gray-800">{productToUpdateStock.name}</p>
                                        <p className="text-sm text-gray-500">Current Stock: <span className="font-bold text-primary">{productToUpdateStock.stock || 0}</span></p>
                                    </div>
                                    <div className="space-y-4">
                                        <div className="flex gap-3">
                                            <button
                                                onClick={() => {
                                                    const qty = prompt('Enter quantity to ADD:');
                                                    if (qty && parseInt(qty) > 0) handleUpdateStock(productToUpdateStock.id, 'add', qty);
                                                }}
                                                className="flex-1 bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition"
                                            >
                                                <i className="fa-solid fa-plus mr-2"></i> Add Stock
                                            </button>
                                            <button
                                                onClick={() => {
                                                    const qty = prompt('Enter quantity to REMOVE:');
                                                    if (qty && parseInt(qty) > 0) handleUpdateStock(productToUpdateStock.id, 'remove', qty);
                                                }}
                                                className="flex-1 bg-danger text-white p-3 rounded-lg font-bold hover:bg-danger/80 transition"
                                            >
                                                <i className="fa-solid fa-minus mr-2"></i> Remove Stock
                                            </button>
                                        </div>
                                        <div>
                                            <label className="text-sm font-bold block mb-1">Set Exact Stock</label>
                                            <div className="flex gap-2">
                                                <input
                                                    type="number"
                                                    id="exactStock"
                                                    className="text-input-style flex-1"
                                                    placeholder="Enter exact quantity"
                                                    defaultValue={productToUpdateStock.stock || 0}
                                                />
                                                <button
                                                    onClick={() => {
                                                        const qty = document.getElementById('exactStock').value;
                                                        if (qty) handleUpdateStock(productToUpdateStock.id, 'set', qty);
                                                    }}
                                                    className="bg-primary text-white px-4 py-2 rounded-lg font-semibold hover:bg-primary-dark"
                                                >
                                                    Set
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Edit Coupon Modal */}
                    {couponToEdit && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => setCouponToEdit(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const res = await handleUpdateCoupon(couponToEdit);
                                    if (res.status === 'success') setCouponToEdit(null);
                                }} className="p-6">
                                    <div className="flex justify-between items-start border-b pb-3 mb-4">
                                        <h2 className="text-xl font-bold text-primary-dark">Edit Coupon</h2>
                                        <button type="button" onClick={() => setCouponToEdit(null)} className="text-gray-500 hover:text-danger">
                                            <i className="fa-solid fa-xmark text-xl"></i>
                                        </button>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-sm font-bold block mb-1">Coupon Code</label>
                                            <input className="text-input-style bg-gray-100" value={couponToEdit.code} disabled />
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-sm font-bold block mb-1">Discount Type</label>
                                                <select
                                                    className="text-input-style"
                                                    value={couponToEdit.discountType}
                                                    onChange={e => setCouponToEdit({...couponToEdit, discountType: e.target.value})}
                                                >
                                                    <option value="fixed">Fixed (₹)</option>
                                                    <option value="percentage">Percent (%)</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-sm font-bold block mb-1">Value</label>
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    className="text-input-style"
                                                    value={couponToEdit.value}
                                                    onChange={e => setCouponToEdit({...couponToEdit, value: e.target.value})}
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="text-sm font-bold block mb-1">Minimum Order (₹)</label>
                                            <input
                                                type="number"
                                                step="0.01"
                                                className="text-input-style"
                                                value={couponToEdit.minOrder}
                                                onChange={e => setCouponToEdit({...couponToEdit, minOrder: e.target.value})}
                                            />
                                        </div>
                                        <button type="submit" className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition">
                                            Save Changes
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* User Reset Password Modal */}
                    {userToResetPassword && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-[60] flex justify-center items-end md:items-center p-0 md:p-4" onClick={() => setUserToResetPassword(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl shadow-2xl max-w-md w-full" onClick={e => e.stopPropagation()}>
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>
                                <div className="p-6">
                                    <div className="flex justify-between items-start border-b pb-3 mb-4">
                                        <h2 className="text-xl font-bold text-primary-dark">Reset Password</h2>
                                        <button onClick={() => setUserToResetPassword(null)} className="text-gray-500 hover:text-danger">
                                            <i className="fa-solid fa-xmark text-xl"></i>
                                        </button>
                                    </div>
                                    <div className="mb-4">
                                        <p className="text-gray-600">Reset password for:</p>
                                        <p className="font-bold text-primary">{userToResetPassword.email}</p>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-sm font-bold block mb-1">New Password</label>
                                            <input
                                                type="password"
                                                id="adminResetPassword"
                                                className="text-input-style"
                                                placeholder="At least 6 characters"
                                            />
                                        </div>
                                        <button
                                            onClick={() => {
                                                const newPass = document.getElementById('adminResetPassword').value;
                                                handleAdminResetPassword(userToResetPassword.email, newPass);
                                            }}
                                            className="w-full bg-danger text-white p-3 rounded-lg font-bold hover:bg-danger/80 transition"
                                        >
                                            <i className="fa-solid fa-key mr-2"></i> Reset Password
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 17. SUPPORT VIEW
        // =======================================================

        const SupportView = ({ user, get, post, showToast, setView }) => {
            const [form, setForm] = useState({ subject: '', message: '', priority: 'Medium' });
            const [tickets, setTickets] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [showDeliveryModal, setShowDeliveryModal] = useState(false);

            const fetchTickets = async () => {
                const res = await get({ action: 'getTickets', email: user.email });
                setIsLoading(false);
                if (res.status !== 'error') setTickets(res);
            };

            useEffect(() => {
                if (getRole(user) !== 'guest') fetchTickets();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (isUserBanned(user)) return showToast('Restricted accounts cannot create new tickets.', 'error');
                const res = await post({
                    action: 'createTicket',
                    email: user.email,
                    subject: form.subject,
                    message: form.message,
                    priority: form.priority,
                    sendConfirmation: true
                });
                if (res.status === 'success') {
                    showToast('Ticket created! We will respond shortly.', 'success');

                    if (res.confirmationSent) {
                        setTimeout(() => {
                            showToast('Ticket confirmation email sent to your inbox.', 'info');
                        }, 1000);
                    }

                    setForm({ subject: '', message: '', priority: 'Medium' });
                    fetchTickets();
                } else showToast(res.message, 'error');
            };

            if (getRole(user) === 'guest') return <div className="text-center py-10 text-lg md:text-xl text-gray-600 pb-24 md:pb-10">Please <button onClick={() => setView('login')} className="text-primary font-bold hover:underline">sign in</button> to contact support.</div>;
            if (isLoading) return <LoadingSpinner />;

            return (
                <div className="p-3 md:p-4 max-w-3xl mx-auto pb-24 md:pb-4">
                    <h1 className="text-xl md:text-3xl font-bold mb-4 md:mb-6 text-primary-dark border-b-2 border-primary/50 pb-2 flex items-center flex-wrap gap-2">
                        <i className="fa-solid fa-headset mr-2"></i>
                        <span>Support</span>
                        <a href="tel:9047878046" className="text-sm md:text-base bg-success text-white px-3 py-1 rounded-full ml-auto">
                            <i className="fa-solid fa-phone mr-1"></i> Call
                        </a>
                    </h1>

                    {/* Delivery Policy Notice */}
                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck-fast text-blue-500 text-xl mr-3"></i>
                                <div>
                                    <p className="font-semibold text-gray-800">Delivery Policy</p>
                                    <p className="text-sm text-gray-600">Minimum order: ₹{DELIVERY_POLICY.minimumOrder} • Free delivery in select areas</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowDeliveryModal(true)}
                                className="text-sm text-primary hover:text-primary-dark font-semibold"
                            >
                                View Areas
                            </button>
                        </div>
                    </div>

                    <form onSubmit={handleSubmit} className="bg-white p-6 rounded-xl shadow-md mb-6 border-t-4 border-success">
                        <h2 className="text-xl font-bold mb-3 text-success">Create New Ticket</h2>
                        {isUserBanned(user) && <p className='text-danger mb-3'><i className='fa-solid fa-triangle-exclamation mr-1'></i> Restricted accounts cannot create new tickets.</p>}
                        <input className="text-input-style mb-3" placeholder="Subject" value={form.subject} onChange={e => setForm({...form, subject:e.target.value})} required disabled={isUserBanned(user)} />
                        <textarea className="text-input-style mb-3" rows="3" placeholder="Describe your issue in detail..." value={form.message} onChange={e => setForm({...form, message:e.target.value})} required disabled={isUserBanned(user)} />

                        {/* Priority Selector */}
                        <div className="mb-3">
                            <label className="text-sm font-bold block mb-1 text-gray-700">Priority Level</label>
                            <select
                                className="text-input-style"
                                value={form.priority}
                                onChange={e => setForm({...form, priority: e.target.value})}
                                disabled={isUserBanned(user)}
                            >
                                <option value="Low">Low - General inquiry</option>
                                <option value="Medium">Medium - Need assistance</option>
                                <option value="High">High - Important issue</option>
                                <option value="Urgent">Urgent - Requires immediate attention</option>
                            </select>
                        </div>

                        <div className="flex items-center text-xs text-gray-600 mb-3">
                            <i className="fa-solid fa-envelope mr-1"></i>
                            <span>You'll receive a confirmation email with your ticket details</span>
                        </div>
                        <button className="bg-success text-white px-4 py-2 rounded-lg hover:bg-success/80 transition font-bold disabled:opacity-50" disabled={isUserBanned(user)}>
                            <i className="fa-solid fa-ticket mr-2"></i> Submit Ticket
                        </button>
                    </form>

                    <div className="bg-white rounded-xl shadow-md overflow-hidden">
                        <h2 className="text-xl font-bold p-4 border-b text-primary">Your Past Tickets ({tickets.length})</h2>
                        <div className="space-y-4 p-4">
                            {tickets.sort((a,b)=>new Date(b.dateCreated)-new Date(a.dateCreated)).map(t => (
                                <div key={t.ticketId} className={`p-4 rounded-xl border shadow-sm ${t.priority === 'Urgent' ? 'bg-red-50 border-red-200' : t.priority === 'High' ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'}`}>
                                    <div className="flex flex-wrap justify-between items-center gap-2 mb-1">
                                        <div className="flex items-center gap-2 flex-wrap">
                                            <span className='font-bold text-primary'>#{t.ticketId} - {t.subject}</span>
                                            <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${
                                                t.priority === 'Urgent' ? 'bg-red-500 text-white' :
                                                t.priority === 'High' ? 'bg-orange-500 text-white' :
                                                t.priority === 'Low' ? 'bg-gray-400 text-white' :
                                                'bg-blue-500 text-white'
                                            }`}>
                                                {t.priority || 'Medium'}
                                            </span>
                                        </div>
                                        <span className={`px-2 py-1 rounded-full text-white text-xs ${t.status==='Open'?'bg-danger':'bg-success'}`}>{t.status}</span>
                                    </div>
                                    <p className="text-xs text-gray-500 mb-2">Created: {t.dateCreated}</p>
                                    <p className="text-sm text-gray-700 my-2 italic">"{t.message}"</p>
                                    {t.adminReply && (
                                        <div className="bg-info/10 text-info p-2 text-xs rounded mt-2 border-l-2 border-info font-semibold">Admin Reply: {t.adminReply}</div>
                                    )}
                                </div>
                            ))}
                            {tickets.length === 0 && <div className='text-center text-gray-500 py-4'>No tickets found.</div>}
                        </div>
                    </div>

                    {/* Delivery Areas Modal */}
                    <DeliveryAreasModal
                        isOpen={showDeliveryModal}
                        onClose={() => setShowDeliveryModal(false)}
                    />
                </div>
            );
        };

        // =======================================================
        // 18. DELIVERY BOY VIEW
        // =======================================================

        const DeliveryBoyView = ({ user, get, post, showToast }) => {
            const [orders, setOrders] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [deliveryBoyName, setDeliveryBoyName] = useState('');
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [stats, setStats] = useState({ pending: 0, delivered: 0, total: 0 });

            // Delivery boy names (same as in admin panel)
            const deliveryBoyOptions = ['Delivery Boy 1', 'Delivery Boy 2', 'Delivery Boy 3'];

            const fetchOrders = async () => {
                if (!deliveryBoyName) return;
                setIsLoading(true);
                const res = await get({ action: 'getAllOrders' });
                setIsLoading(false);

                if (res.status !== 'error') {
                    // Filter orders assigned to this delivery boy
                    const myOrders = res.filter(o => o.assignedTo === deliveryBoyName && o.orderId);
                    setOrders(myOrders);

                    // Calculate stats
                    setStats({
                        pending: myOrders.filter(o => o.status === 'Pending' || o.status === 'Shipped').length,
                        delivered: myOrders.filter(o => o.status === 'Delivered').length,
                        total: myOrders.length
                    });
                }
            };

            useEffect(() => {
                if (isLoggedIn && deliveryBoyName) {
                    fetchOrders();
                    // Auto refresh every 30 seconds
                    const interval = setInterval(fetchOrders, 30000);
                    return () => clearInterval(interval);
                }
            }, [isLoggedIn, deliveryBoyName]);

            const handleLogin = () => {
                if (!deliveryBoyName) {
                    showToast('Please select your name', 'error');
                    return;
                }
                setIsLoggedIn(true);
                localStorage.setItem('deliveryBoyName', deliveryBoyName);
                showToast(`Welcome, ${deliveryBoyName}!`, 'success');
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                setDeliveryBoyName('');
                setOrders([]);
                localStorage.removeItem('deliveryBoyName');
                showToast('Logged out successfully', 'info');
            };

            // Check for saved delivery boy session
            useEffect(() => {
                const savedName = localStorage.getItem('deliveryBoyName');
                if (savedName && deliveryBoyOptions.includes(savedName)) {
                    setDeliveryBoyName(savedName);
                    setIsLoggedIn(true);
                }
            }, []);

            const handleUpdateStatus = async (orderId, newStatus) => {
                const confirm = window.confirm(`Mark order #${orderId} as "${newStatus}"?`);
                if (!confirm) return;

                const res = await post({
                    action: 'updateOrderStatus',
                    orderId,
                    status: newStatus,
                    notifyCustomer: true,
                    updatedBy: deliveryBoyName
                });

                if (res.status === 'success') {
                    showToast(`Order #${orderId} marked as ${newStatus}!`, 'success');
                    fetchOrders();
                    setSelectedOrder(null);
                } else {
                    showToast(res.message || 'Failed to update status', 'error');
                }
            };

            const getStatusColor = (status) => {
                if (status === 'Delivered') return 'bg-success text-white';
                if (status === 'Cancelled') return 'bg-danger text-white';
                if (status === 'Shipped') return 'bg-info text-white';
                return 'bg-accent-hover text-white';
            };

            // Login Screen
            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-primary-dark to-primary flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                            <div className="text-center mb-6">
                                <div className="w-20 h-20 bg-accent rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i className="fa-solid fa-truck text-3xl text-primary-dark"></i>
                                </div>
                                <h1 className="text-2xl font-bold text-primary-dark">Delivery Portal</h1>
                                <p className="text-gray-500 mt-2">Maddur Murugan Super Store</p>
                            </div>

                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-gray-700 mb-2">Select Your Name</label>
                                    <select
                                        className="text-input-style"
                                        value={deliveryBoyName}
                                        onChange={(e) => setDeliveryBoyName(e.target.value)}
                                    >
                                        <option value="">-- Select --</option>
                                        {deliveryBoyOptions.map(name => (
                                            <option key={name} value={name}>{name}</option>
                                        ))}
                                    </select>
                                </div>

                                <button
                                    onClick={handleLogin}
                                    className="w-full bg-accent text-primary-dark p-3 rounded-lg font-bold text-lg hover:bg-accent-hover transition shadow-md"
                                >
                                    <i className="fa-solid fa-sign-in-alt mr-2"></i> Login
                                </button>
                            </div>

                            <div className="mt-6 text-center text-sm text-gray-500">
                                <i className="fa-solid fa-phone mr-1"></i> Contact: +91 9047878046
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <header className="bg-primary-dark text-white p-4 sticky top-0 z-50 shadow-lg">
                        <div className="max-w-4xl mx-auto flex items-center justify-between">
                            <div className="flex items-center">
                                <i className="fa-solid fa-truck text-accent text-xl mr-3"></i>
                                <div>
                                    <h1 className="font-bold text-lg">Delivery Portal</h1>
                                    <p className="text-xs text-gray-300">{deliveryBoyName}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={fetchOrders}
                                    className="bg-primary p-2 rounded-lg hover:bg-primary/80 transition"
                                    title="Refresh"
                                >
                                    <i className="fa-solid fa-refresh"></i>
                                </button>
                                <button
                                    onClick={handleLogout}
                                    className="bg-danger p-2 rounded-lg hover:bg-danger/80 transition"
                                    title="Logout"
                                >
                                    <i className="fa-solid fa-sign-out-alt"></i>
                                </button>
                            </div>
                        </div>
                    </header>

                    <div className="max-w-4xl mx-auto p-4 space-y-4">
                        {/* Stats Cards */}
                        <div className="grid grid-cols-3 gap-3">
                            <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                <i className="fa-solid fa-clock text-accent text-2xl mb-2"></i>
                                <p className="text-2xl font-bold text-primary-dark">{stats.pending}</p>
                                <p className="text-xs text-gray-500">Pending</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                <i className="fa-solid fa-check-circle text-success text-2xl mb-2"></i>
                                <p className="text-2xl font-bold text-primary-dark">{stats.delivered}</p>
                                <p className="text-xs text-gray-500">Delivered</p>
                            </div>
                            <div className="bg-white p-4 rounded-xl shadow-md text-center">
                                <i className="fa-solid fa-box text-info text-2xl mb-2"></i>
                                <p className="text-2xl font-bold text-primary-dark">{stats.total}</p>
                                <p className="text-xs text-gray-500">Total</p>
                            </div>
                        </div>

                        {/* Orders List */}
                        <div className="bg-white rounded-xl shadow-md overflow-hidden">
                            <div className="p-4 border-b bg-primary/5">
                                <h2 className="font-bold text-primary-dark flex items-center">
                                    <i className="fa-solid fa-list-check mr-2"></i>
                                    My Deliveries
                                    <span className="ml-2 text-sm bg-primary text-white px-2 py-0.5 rounded-full">{orders.length}</span>
                                </h2>
                            </div>

                            {isLoading ? (
                                <div className="p-8 text-center">
                                    <i className="fa-solid fa-spinner fa-spin text-3xl text-primary"></i>
                                    <p className="mt-2 text-gray-500">Loading orders...</p>
                                </div>
                            ) : orders.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">
                                    <i className="fa-solid fa-inbox text-4xl mb-3"></i>
                                    <p>No orders assigned to you yet.</p>
                                    <button onClick={fetchOrders} className="mt-3 text-primary font-semibold">
                                        <i className="fa-solid fa-refresh mr-1"></i> Refresh
                                    </button>
                                </div>
                            ) : (
                                <div className="divide-y">
                                    {orders.sort((a, b) => {
                                        // Sort: Pending/Shipped first, then by date
                                        const statusOrder = { 'Pending': 0, 'Shipped': 1, 'Delivered': 2, 'Cancelled': 3 };
                                        const statusDiff = (statusOrder[a.status] || 0) - (statusOrder[b.status] || 0);
                                        if (statusDiff !== 0) return statusDiff;
                                        return new Date(b.date) - new Date(a.date);
                                    }).map(order => (
                                        <div
                                            key={order.orderId}
                                            className={`p-4 hover:bg-gray-50 transition cursor-pointer ${order.status === 'Pending' || order.status === 'Shipped' ? 'bg-yellow-50' : ''}`}
                                            onClick={() => setSelectedOrder(order)}
                                        >
                                            <div className="flex items-start justify-between">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="font-bold text-primary">#{order.orderId}</span>
                                                        <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${getStatusColor(order.status)}`}>
                                                            {order.status}
                                                        </span>
                                                        {order.paymentMethod && (
                                                            <span className={`px-2 py-0.5 rounded-full text-xs ${order.paymentMethod === 'upi' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                                {order.paymentMethod === 'upi' ? 'UPI' : 'COD'}
                                                            </span>
                                                        )}
                                                    </div>
                                                    <p className="text-sm text-gray-600 truncate">{order.address}</p>
                                                    <p className="text-xs text-gray-400 mt-1">{order.date}</p>
                                                </div>
                                                <div className="text-right ml-3">
                                                    <p className="font-bold text-danger text-lg">{formatCurrency(order.total)}</p>
                                                    <p className="text-xs text-gray-500">{order.items?.length || 0} items</p>
                                                </div>
                                            </div>

                                            {/* Quick Action Buttons for Pending/Shipped orders */}
                                            {(order.status === 'Pending' || order.status === 'Shipped') && (
                                                <div className="flex gap-2 mt-3 pt-3 border-t">
                                                    {order.status === 'Pending' && (
                                                        <button
                                                            onClick={(e) => { e.stopPropagation(); handleUpdateStatus(order.orderId, 'Shipped'); }}
                                                            className="flex-1 bg-info text-white py-2 rounded-lg text-sm font-bold hover:bg-info/80 transition"
                                                        >
                                                            <i className="fa-solid fa-truck mr-1"></i> Mark Shipped
                                                        </button>
                                                    )}
                                                    <button
                                                        onClick={(e) => { e.stopPropagation(); handleUpdateStatus(order.orderId, 'Delivered'); }}
                                                        className="flex-1 bg-success text-white py-2 rounded-lg text-sm font-bold hover:bg-success/80 transition"
                                                    >
                                                        <i className="fa-solid fa-check-circle mr-1"></i> Mark Delivered
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        {/* Contact Support */}
                        <div className="bg-white p-4 rounded-xl shadow-md">
                            <h3 className="font-bold text-gray-700 mb-3">Need Help?</h3>
                            <div className="flex gap-3">
                                <a
                                    href="tel:9047878046"
                                    className="flex-1 bg-success text-white p-3 rounded-lg text-center font-bold hover:bg-success/80 transition"
                                >
                                    <i className="fa-solid fa-phone mr-2"></i> Call Store
                                </a>
                                <a
                                    href="https://wa.me/919047878046"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="flex-1 bg-[#25D366] text-white p-3 rounded-lg text-center font-bold hover:bg-[#25D366]/80 transition"
                                >
                                    <i className="fa-brands fa-whatsapp mr-2"></i> WhatsApp
                                </a>
                            </div>
                        </div>
                    </div>

                    {/* Order Detail Modal */}
                    {selectedOrder && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex items-end md:items-center justify-center p-0 md:p-4" onClick={() => setSelectedOrder(null)}>
                            <div className="bg-white rounded-t-2xl md:rounded-xl w-full max-w-lg max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                                {/* Mobile swipe handle */}
                                <div className="md:hidden flex justify-center py-2">
                                    <div className="w-10 h-1 bg-gray-300 rounded-full"></div>
                                </div>

                                <div className="p-4 border-b sticky top-0 bg-white z-10">
                                    <div className="flex items-center justify-between">
                                        <h2 className="text-xl font-bold text-primary-dark">Order #{selectedOrder.orderId}</h2>
                                        <button onClick={() => setSelectedOrder(null)} className="text-gray-500 hover:text-danger p-2">
                                            <i className="fa-solid fa-times text-xl"></i>
                                        </button>
                                    </div>
                                </div>

                                <div className="p-4 space-y-4">
                                    {/* Status */}
                                    <div className="flex items-center justify-between">
                                        <span className="text-gray-600">Status:</span>
                                        <span className={`px-3 py-1 rounded-full text-sm font-bold ${getStatusColor(selectedOrder.status)}`}>
                                            {selectedOrder.status}
                                        </span>
                                    </div>

                                    {/* Payment Info */}
                                    <div className="bg-gray-50 p-3 rounded-lg">
                                        <div className="flex items-center justify-between mb-2">
                                            <span className="text-gray-600">Payment:</span>
                                            <span className={`px-2 py-1 rounded text-sm font-bold ${selectedOrder.paymentMethod === 'upi' ? 'bg-purple-100 text-purple-700' : 'bg-green-100 text-green-700'}`}>
                                                {selectedOrder.paymentMethod === 'upi' ? 'UPI' : 'Cash on Delivery'}
                                                {selectedOrder.paymentStatus && ` (${selectedOrder.paymentStatus})`}
                                            </span>
                                        </div>
                                        <div className="flex items-center justify-between">
                                            <span className="text-gray-600">Total Amount:</span>
                                            <span className="text-xl font-bold text-danger">{formatCurrency(selectedOrder.total)}</span>
                                        </div>
                                        {selectedOrder.paymentMethod === 'cod' && selectedOrder.status !== 'Delivered' && (
                                            <div className="mt-2 p-2 bg-yellow-100 rounded text-yellow-800 text-sm">
                                                <i className="fa-solid fa-exclamation-triangle mr-1"></i>
                                                Collect {formatCurrency(selectedOrder.total)} on delivery
                                            </div>
                                        )}
                                    </div>

                                    {/* Customer & Address */}
                                    <div className="space-y-2">
                                        <h3 className="font-bold text-gray-700">Delivery Address</h3>
                                        <div className="bg-blue-50 p-3 rounded-lg">
                                            <p className="text-sm font-semibold text-gray-800">{selectedOrder.userEmail}</p>
                                            <p className="text-sm text-gray-600 mt-1">{selectedOrder.address}</p>
                                            {selectedOrder.deliveryArea && (
                                                <p className="text-xs text-blue-600 mt-1">
                                                    <i className="fa-solid fa-map-marker-alt mr-1"></i> {selectedOrder.deliveryArea}
                                                </p>
                                            )}
                                        </div>

                                        {/* Call/WhatsApp Customer */}
                                        <div className="flex gap-2">
                                            <a
                                                href={`mailto:${selectedOrder.userEmail}`}
                                                className="flex-1 bg-primary text-white p-2 rounded-lg text-center text-sm font-semibold"
                                            >
                                                <i className="fa-solid fa-envelope mr-1"></i> Email
                                            </a>
                                        </div>
                                    </div>

                                    {/* Order Items */}
                                    <div>
                                        <h3 className="font-bold text-gray-700 mb-2">Order Items ({selectedOrder.items?.length || 0})</h3>
                                        <div className="bg-gray-50 rounded-lg divide-y">
                                            {selectedOrder.items?.map((item, idx) => (
                                                <div key={idx} className="p-3 flex items-center justify-between">
                                                    <div>
                                                        <p className="font-semibold text-sm">{item.name}</p>
                                                        <p className="text-xs text-gray-500">Qty: {item.qty} × {formatCurrency(item.price)}</p>
                                                    </div>
                                                    <p className="font-bold text-danger">{formatCurrency(item.price * item.qty)}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Order Date */}
                                    <div className="text-center text-sm text-gray-500">
                                        <i className="fa-solid fa-calendar mr-1"></i> Ordered: {selectedOrder.date}
                                    </div>

                                    {/* Action Buttons */}
                                    {(selectedOrder.status === 'Pending' || selectedOrder.status === 'Shipped') && (
                                        <div className="space-y-2 pt-4 border-t">
                                            {selectedOrder.status === 'Pending' && (
                                                <button
                                                    onClick={() => handleUpdateStatus(selectedOrder.orderId, 'Shipped')}
                                                    className="w-full bg-info text-white p-3 rounded-lg font-bold hover:bg-info/80 transition"
                                                >
                                                    <i className="fa-solid fa-truck mr-2"></i> Mark as Shipped
                                                </button>
                                            )}
                                            <button
                                                onClick={() => handleUpdateStatus(selectedOrder.orderId, 'Delivered')}
                                                className="w-full bg-success text-white p-3 rounded-lg font-bold hover:bg-success/80 transition"
                                            >
                                                <i className="fa-solid fa-check-circle mr-2"></i> Mark as Delivered
                                            </button>
                                        </div>
                                    )}

                                    {selectedOrder.status === 'Delivered' && (
                                        <div className="bg-green-50 p-4 rounded-lg text-center">
                                            <i className="fa-solid fa-check-circle text-success text-3xl mb-2"></i>
                                            <p className="font-bold text-success">Order Delivered Successfully!</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =======================================================
        // 19. MAIN APP COMPONENT
        // =======================================================

        const App = () => {
            // Check URL parameters for initial view (e.g., ?view=delivery)
            const getInitialView = () => {
                const urlParams = new URLSearchParams(window.location.search);
                const viewParam = urlParams.get('view');
                if (viewParam === 'delivery') return 'delivery';
                return 'home';
            };

            const [view, setView] = useState(getInitialView());
            const [products, setProducts] = useState([]);
            const [cart, setCart] = useState(JSON.parse(localStorage.getItem('muruganCart') || '[]'));
            const [user, setUser] = useState(JSON.parse(localStorage.getItem('muruganUser') || 'null'));
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [selectedOrder, setSelectedOrder] = useState(null);
            const [loadingProducts, setLoadingProducts] = useState(true);
            const [toast, setToast] = useState({ message: '', type: '' });
            const [openTicketCount, setOpenTicketCount] = useState(0);

            const totalCartItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const isDeliveryView = view === 'delivery';

            // Fetch products and check user status on load
            useEffect(() => {
                const fetchProducts = async () => {
                    const res = await get({ action: 'getProducts' });
                    if (res.status !== 'error') setProducts(res);
                    setLoadingProducts(false);
                };
                fetchProducts();

                const checkUserStatus = () => {
                    if (user && isUserBanned(user)) {
                        setToast({ message: "Your account is restricted. Logging out.", type: 'error' });
                        setUser(null);
                        localStorage.removeItem('muruganUser');
                    }
                };
                checkUserStatus();
            }, []);

            // Fetch open ticket count for admin
            useEffect(() => {
                const fetchOpenTicketCount = async () => {
                    if (getRole(user) === 'admin') {
                        const res = await get({ action: 'getOpenTicketsCount' });
                        if (res.status !== 'error' && res.count !== undefined) {
                            setOpenTicketCount(res.count);
                        } else if (res.status !== 'error') {
                            // Fallback: fetch all tickets and count open ones
                            const ticketsRes = await get({ action: 'getTickets' });
                            if (ticketsRes.status !== 'error') {
                                setOpenTicketCount(ticketsRes.filter(t => t.status === 'Open').length);
                            }
                        }
                    }
                };
                fetchOpenTicketCount();
                // Refresh every 30 seconds
                const interval = setInterval(fetchOpenTicketCount, 30000);
                return () => clearInterval(interval);
            }, [user]);

            // Sync cart to local storage
            useEffect(() => {
                localStorage.setItem('muruganCart', JSON.stringify(cart));
            }, [cart]);

            // Handle order detail view state change
            useEffect(() => {
                if (selectedOrder) setView('orders');
            }, [selectedOrder]);

            const showToast = (msg, type) => setToast({ message: msg, type });

            const addToCart = (p, qty = 1) => {
                if (isUserBanned(user)) {
                    return showToast('Account is restricted. Cannot add items to cart.', 'error');
                }
                const exist = cart.find(i => i.id === p.id);
                if (exist) setCart(cart.map(i => i.id === p.id ? { ...i, quantity: i.quantity + qty } : i));
                else setCart([...cart, { ...p, quantity: qty }]);
                showToast(`${p.name} added to cart!`, 'success');
            };

            const isAuth = view === 'login' || view === 'register';

            const renderView = () => {
                if (loadingProducts) return <LoadingSpinner />;

                switch (view) {
                    case 'login':
                    case 'register':
                        return <AuthView mode={view} setView={setView} setUser={setUser} showToast={showToast} />;
                    case 'home':
                        return <HomeView products={products} setView={setView} setSelectedProduct={setSelectedProduct} onQuickAddToCart={addToCart} />;
                    case 'products':
                        return <ProductsView products={products} setView={setView} setSelectedProduct={setSelectedProduct} onQuickAddToCart={addToCart} />;
                    case 'cart':
                        return <CartView cart={cart} setCart={setCart} setView={setView} showToast={showToast} />;
                    case 'checkout':
                        return <CheckoutView user={user} cart={cart} setView={setView} setCart={setCart} post={post} showToast={showToast} />;
                    case 'profile':
                        return <ProfileView user={user} setUser={setUser} setView={setView} post={post} showToast={showToast} />;
                    case 'orders':
                        return <OrdersView user={user} get={get} post={post} showToast={showToast} setSelectedOrder={setSelectedOrder} />;
                    case 'admin':
                        return <AdminView user={user} post={post} get={get} showToast={showToast} />;
                    case 'support':
                        return <SupportView user={user} get={get} post={post} showToast={showToast} setView={setView} />;
                    case 'delivery':
                        return <DeliveryBoyView user={user} get={get} post={post} showToast={showToast} />;
                    default:
                        return <HomeView products={products} setView={setView} setSelectedProduct={setSelectedProduct} onQuickAddToCart={addToCart} />;
                }
            };

            const shouldRenderMobileNav = !isAuth && !isDeliveryView && (view !== 'admin') && (view !== 'checkout') && !selectedOrder;

            // If delivery view, render only the delivery component (it has its own layout)
            if (isDeliveryView) {
                return (
                    <>
                        <DeliveryBoyView user={user} get={get} post={post} showToast={showToast} />
                        <ToastNotification message={toast.message} type={toast.type} onClose={() => setToast({ message: '', type: '' })} />
                    </>
                );
            }

            return (
                <div className="min-h-screen flex flex-col">
                    {!isAuth && <Header user={user} setView={setView} totalCartItems={totalCartItems} openTicketCount={openTicketCount} />}

                    <main className={`flex-grow ${isAuth || selectedOrder || view==='admin' ? '' : 'pt-4 pb-16 md:pb-0'}`}>
                        {renderView()}

                        {/* Order Detail Modal for Admin/Orders View */}
                        {selectedOrder && (
                            <OrderDetailModal
                                order={selectedOrder}
                                onClose={() => setSelectedOrder(null)}
                                onUpdateStatus={(id, status) => {
                                    setSelectedOrder(prev => ({ ...prev, status }));
                                    showToast(`Order #${id} status changed to ${status}.`, 'success');
                                }}
                                role={getRole(user)}
                            />
                        )}
                    </main>

                    {/* Mobile Bottom Navigation Bar */}
                    {shouldRenderMobileNav && <MobileNavBar view={view} setView={setView} totalCartItems={totalCartItems} user={user} />}

                    {/* Product Quick View Modal */}
                    <ProductDetailModal
                        product={selectedProduct}
                        onClose={() => setSelectedProduct(null)}
                        onAddToCart={addToCart}
                    />

                    {/* Toast Notification Popup */}
                    <ToastNotification message={toast.message} type={toast.type} onClose={() => setToast({ message: '', type: '' })} />

                    <footer className="bg-primary-dark text-white text-center py-6 mt-8 flex-shrink-0 shadow-inner">
                        <div className="mb-2 font-bold text-lg tracking-wider text-accent">MADDUR MURUGAN SUPER STORE</div>
                        <div className="text-xs text-gray-400">Powered by samcm | © 2026. All rights reserved.</div>
                        <div className="text-xs text-gray-400 mt-2">
                            UPI ID: {UPI_CONFIG.upiId} | Accepts all UPI payments
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                            <i className="fa-solid fa-envelope mr-1"></i> Email Notifications: Login alerts, order updates, and offers
                        </div>
                        <div className="text-xs text-gray-400 mt-1">
                            <i className="fa-solid fa-truck mr-1"></i> Minimum Order: ₹{DELIVERY_POLICY.minimumOrder} • Free delivery in select areas
                        </div>
                        <div className="mt-3 pt-3 border-t border-gray-600">
                            <a
                                href="?view=delivery"
                                className="text-xs text-gray-400 hover:text-accent transition"
                            >
                                <i className="fa-solid fa-motorcycle mr-1"></i> Delivery Partner Portal
                            </a>
                        </div>
                    </footer>
                </div>
            );
        }

        // Render the main App component
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
